# Univer Sandbox Debug Worklog (2026-02-14)

## Overview
This document tracks step-by-step testing results and forensic analysis for the Univer Sandbox (0.15.5) implementation.

---

## Step 1: Initial Page Load (Unified Mode)
**Status**: ❌ FAILED
**Symptom**: Console Error during `setupSheets` initialization.

### Error Trace
```text
univer-BWMlbbXg.js:1  Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'Symbol($$DEPENDENCIES)')
    at vM (univer-BWMlbbXg.js:1:2021)
    at av._resolveClassImpl (univer-BWMlbbXg.js:1:10392)
    at av.createInstance (univer-BWMlbbXg.js:1:9408)
    at Jv._createHandler (univer-BWMlbbXg.js:12:89770)
    at Jv.createUnit (univer-BWMlbbXg.js:12:46646)
```

### Forensic Analysis (Preliminary)
1. **DI Container Failure**: `Symbol($$DEPENDENCIES)` is the internal marker for Univer's Dependency Injection system. The error "Cannot read properties of undefined" on this symbol typically means the DI container is trying to instantiate a class (likely a `Workbook` or `SheetUnit`) whose constructor metadata is missing or whose "Injected" dependencies are not available in the current context.
2. **Instance Type Mismatch**: In `UnifiedHub.ts`, I used a custom enum `DocType.SHEET = 'SHEET'`. In Univer 0.15.x, the `createUnit` method expects an `UniverInstanceType` constant (e.g., `UniverInstanceType.UNIVER_SHEET` which is integer `2`, or `UniverInstanceType.UNIVER_DOC` which is `1`). Passing the string `'SHEET'` likely causes the unit-handler lookup to fail or fall into an uninitialized path.
3. **Missing Registration**: While `UniverSheetsPlugin` was registered, the unit creation attempt happened before the plugin was fully "started" by the lifecycle, or the dependency "Owner" of the unit was not correctly scoped.

---

## Current Testing Queue
- [x] Step 2: Switch to Spreadsheets & Toggle Shortcut Panel
    - **Status**: ❌ FAILED
    - **Findings**: Reproduced `Symbol($$DEPENDENCIES)` and uncovered a missing command registration error.

### Error Trace (Step 2 - Shortcut Panel)
```text
univer-BWMlbbXg.js:7  Uncaught (in promise) Error: [CommandService]: command "base-ui.operation.toggle-shortcut-panel" is not registered.
    at pv.executeCommand (univer-BWMlbbXg.js:7:42339)
```

### Forensic Analysis (Step 2)
1. **Command Orphanage**: The "Toggle Shortcut Panel" is a UI operation. The error indicates that while the UI button exists, the plugin responsible for handling that command (`UniverUIPlugin` + specific shortcut handlers) failed to register its handler with the `CommandService`. This happens when the DI container is in a "broken" state due to the previous `createUnit` failure.
2. **Cascading Failure**: Once a `Symbol($$DEPENDENCIES)` error occurs, the internal state of the Univer instance is compromised. Subsequent UI interactions will likely fail because the dependency graph is incomplete.

---

## Step 3: Documents Sandbox (`docs.html`)
**Status**: ⚠️ PARTIAL SUCCESS
**Findings**: UI loads and renders correctly. Basic editing works, but critical keyboard and menu bugs found.

### Issue A: Enter Key Malfunction
- **Status**: ✅ FIXED & DEPLOYED
- **Forensic Diagnosis**: **(TECHNICAL ROOT CAUSE)**
    - The `IDocumentBody` provided to `createUnit` contains `\r\n` in the `dataStream` but was missing the `paragraphs: IParagraph[]` array in the metadata.
    - **Fix**: Added paragraph markers pointing to the newline positions.

### Issue B: Page Setup Crash
- **Status**: ✅ FIXED & DEPLOYED
- **Forensic Diagnosis**: **(TECHNICAL ROOT CAUSE)**
    - The `IDocumentData` interface requires a `documentStyle` property.
    - **Fix**: Provided a default `documentStyle` with A4 dimensions (595.27 x 841.89 points).

---

## Step 4: Sheets Sandbox (`sheets.html`)
**Status**: ✅ FIXED & DEPLOYED
**Findings**: Successfully satisfied the `univer.editor.service` dependency.

### Issue A: Dependency Missing (`univer.editor.service`)
- **Status**: ✅ FIXED
- **Fix**: Registered `UniverDocsPlugin` and `UniverDocsUIPlugin` inside the Sheets environment. This provides the Doc engine required for cell editing.

### Issue B: Selection Render Service Error
- **Status**: ✅ FIXED
- **Fix**: Resolved by fixing the DI failure in Issue A.

---

## Current Status Summary
- **Index/Hub**: Fixed (Multi-page landing).
- **Documents**: Fixed (Metadata alignment + Style).
---

## Step 5: Slides Sandbox (`slides.html`)
**Status**: ❌ FAILED
**Findings**: Initialization crash. Missing editor service and DI parameter mismatch.

### Issue A: Dependency Missing (`univer.editor.service`)
- **Symptom**: `Uncaught Wx: [redi]: Cannot find "univer.editor.service" registered by any injector.`
- **Forensic Diagnosis**: Exactly like Sheets, the **Slides** module in 0.15.x requires the **Docs engine** to handle text elements within slides. 
- **Fix**: Register `UniverDocsPlugin` and `UniverDocsUIPlugin` inside `setupSlides`.

### Issue B: Custom Parameter Mismatch (`redi`)
- **Symptom**: `[redi]: Expect 2 custom parameter(s) of d7 but get 0.`
- **Forensic Diagnosis**: This usually occurs when a plugin constructor expects a specific configuration object that was provided as `null` or omitted. In Slides, the `UniverSlidesUIPlugin` often requires a configuration object for its canvas renderer.

---

## Final Global Fix Strategy
The "Law of Dependencies" for Univer 0.15.x is now clear:
1. **Core Engines**: All Sandbox environments (`sheets`, `docs`, `slides`) MUST register `UniverRenderEnginePlugin` and `UniverFormulaEnginePlugin`.
2. **The Doc Prerequisite**: Both **Sheets** and **Slides** require the **Doc Plugin** to exist for their respective editors (cell editor and text-shape editor).
3. **Metadata Hygiene**: Documents must have `documentStyle` and `paragraphs` initialized even for empty states.

---
**Next Action**: Apply "The Doc Prerequisite" to the Slides module and verify the full suite.
