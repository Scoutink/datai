import{U as C,$ as ue}from"./facade-bHpds0ZF.js";import{g8 as y,gi as Z,g4 as ee,g5 as A,ga as te,gj as V,gk as de,gh as le,aB as re,f$ as S,fB as se,gl as X,gg as he,dT as ne,c5 as pe,fk as me,ca as ve,bC as ge,fA as fe,fm as ye,aC as Te,bc as O,bm as P,bo as $,b7 as _e,da as F,d6 as we,co as be,al as Se,bi as Ee,b6 as Ie,bf as xe}from"./index-BI8deSNo.js";import{s as R}from"./shareReplay-DR2HpNHE.js";import{InsertCommand as Re,DocSelectionRenderService as Pe}from"./index-C5GuqOxb.js";import{aa as qe}from"./index-DnxWP_AP.js";function Ue(e,t){var r=Z(e)?e:function(){return e},s=function(n){return n.error(r())};return new y(s)}function oe(e){return ee(function(t,r){var s=null,n=!1,o;s=t.subscribe(A(r,void 0,void 0,function(a){o=te(e(a,oe(e)(t))),s?(s.unsubscribe(),s=null,o.subscribe(r)):n=!0})),n&&(s.unsubscribe(),s=null,o.subscribe(r))})}function J(e,t){return Z(t)?V(e,t,1):V(e,1)}function Ce(e){e===void 0&&(e=1/0);var t;e&&typeof e=="object"?t=e:t={count:e};var r=t.count,s=r===void 0?1/0:r,n=t.delay,o=t.resetOnSuccess,a=o===void 0?!1:o;return s<=0?de:ee(function(d,u){var l=0,i,c=function(){var v=!1;i=d.subscribe(A(u,function(h){a&&(l=0),u.next(h)},void 0,function(h){if(l++<s){var p=function(){i?(i.unsubscribe(),i=null,c()):v=!0};if(n!=null){var f=typeof n=="number"?le(n):te(n(h,l)),m=A(u,function(){m.unsubscribe(),p()},function(){u.complete()});f.subscribe(m)}else p()}else u.error(h)})),v&&(i.unsubscribe(),i=null,c())};c()})}var Ne=Object.defineProperty,Le=(e,t,r)=>t in e?Ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,g=(e,t,r)=>Le(e,typeof t!="symbol"?t+"":t,r);const He="network.config",W={},j="application/json";function ke(e){return Array.isArray(e)?e.some(t=>t.includes(j)):e.includes(j)}class I{constructor(t){g(this,"_headers",new Map),typeof t=="string"?this._handleHeadersString(t):t instanceof Headers?this._handleHeaders(t):t&&this._handleHeadersConstructorProps(t)}forEach(t){this._headers.forEach((r,s)=>t(s,r))}has(t){return!!this._headers.has(t.toLowerCase())}get(t){const r=t.toLowerCase();return this._headers.has(r)?this._headers.get(r):null}set(t,r){this._setHeader(t,r)}toHeadersInit(t){const r={};return this._headers.forEach((s,n)=>{r[n]=s.join(",")}),r.accept!=null||(r.accept="application/json, text/plain, */*"),t instanceof FormData||r["content-type"]!=null||(r["content-type"]="application/json;charset=UTF-8"),r}_setHeader(t,r){const s=t.toLowerCase();this._headers.has(s)?this._headers.get(s).push(r.toString()):this._headers.set(s,[r.toString()])}_handleHeadersString(t){t.split(`
`).forEach(r=>{const[s,n]=r.split(":");s&&n&&this._setHeader(s,n)})}_handleHeadersConstructorProps(t){Object.entries(t).forEach(([r,s])=>this._setHeader(r,s))}_handleHeaders(t){t.forEach((r,s)=>this._setHeader(s,r))}}const ae=ne("network.http-implementation");class z{constructor(t){this.params=t}toString(){return this.params?Object.keys(this.params).map(t=>{const r=this.params[t];return Array.isArray(r)?r.map(s=>`${t}=${s}`).join("&"):`${t}=${r}`}).join("&"):""}}let Ae=0;class K{constructor(t,r,s){g(this,"uid",Ae++),this.method=t,this.url=r,this.requestParams=s}get headers(){return this.requestParams.headers}get withCredentials(){return this.requestParams.withCredentials}get responseType(){return this.requestParams.responseType}getUrlWithParams(){var t,r;const s=(r=(t=this.requestParams)==null?void 0:t.params)==null?void 0:r.toString();return s?`${this.url}${this.url.includes("?")?"&":"?"}${s}`:this.url}getBody(){var t,r;const s=(t=this.headers.get("Content-Type"))!=null?t:j,n=(r=this.requestParams)==null?void 0:r.body;return n instanceof FormData?n:ke(s)&&n&&typeof n=="object"?JSON.stringify(n):n?`${n}`:null}getHeadersInit(){var t;return this.headers.toHeadersInit((t=this.requestParams)==null?void 0:t.body)}}var Fe=(e,t,r,s)=>{for(var n=t,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},je=(e,t)=>(r,s)=>t(r,s,e);let x=class extends re{constructor(e){super(),g(this,"_interceptors",[]),g(this,"_pipe"),this._http=e}registerHTTPInterceptor(e){if(this._interceptors.indexOf(e)!==-1)throw new Error("[HTTPService]: The interceptor has already been registered!");return this._interceptors.push(e),this._interceptors=this._interceptors.sort((t,r)=>{var s,n;return((s=t.priority)!=null?s:0)-((n=r.priority)!=null?n:0)}),this._pipe=null,S(()=>se(this._interceptors,e))}get(e,t){return this.request("GET",e,t)}post(e,t){return this.request("POST",e,t)}put(e,t){return this.request("PUT",e,t)}delete(e,t){return this.request("DELETE",e,t)}patch(e,t){return this.request("PATCH",e,t)}async request(e,t,r){var s,n;const o=new I(r?.headers),a=new z(r?.params),d=new K(e,t,{headers:o,params:a,withCredentials:(s=r?.withCredentials)!=null?s:!1,responseType:(n=r?.responseType)!=null?n:"json",body:["GET","DELETE"].includes(e)||r==null?void 0:r.body}),u=X(d).pipe(J(l=>this._runInterceptorsAndImplementation(l)));return await he(u)}stream(e,t,r){return this.getSSE(e,t,r)}getSSE(e,t,r){var s,n;const o=new I(r?.headers),a=new z(r?.params),d=new K(e,t,{headers:o,params:a,withCredentials:(s=r?.withCredentials)!=null?s:!1,reportProgress:!0,responseType:(n=r?.responseType)!=null?n:"json",body:["GET","DELETE"].includes(e)||r==null?void 0:r.body});return X(d).pipe(J(u=>this._runInterceptorsAndImplementation(u)))}_runInterceptorsAndImplementation(e){return this._pipe||(this._pipe=this._interceptors.map(t=>t.interceptor).reduceRight((t,r)=>Me(t,r),(t,r)=>r(t))),this._pipe(e,t=>this._http.send(t))}};x=Fe([je(0,ae)],x);function Me(e,t){return(r,s)=>t(r,n=>e(n,s))}const De=200,Oe=300;var q=(e=>(e[e.Continue=100]="Continue",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.Processing=102]="Processing",e[e.EarlyHints=103]="EarlyHints",e[e.Ok=200]="Ok",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.ImUsed=226]="ImUsed",e[e.MultipleChoices=300]="MultipleChoices",e[e.MovedPermanently=301]="MovedPermanently",e[e.Found=302]="Found",e[e.SeeOther=303]="SeeOther",e[e.NotModified=304]="NotModified",e[e.UseProxy=305]="UseProxy",e[e.Unused=306]="Unused",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.PaymentRequired=402]="PaymentRequired",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.NotAcceptable=406]="NotAcceptable",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.LengthRequired=411]="LengthRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.PayloadTooLarge=413]="PayloadTooLarge",e[e.UriTooLong=414]="UriTooLong",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.RangeNotSatisfiable=416]="RangeNotSatisfiable",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.ImATeapot=418]="ImATeapot",e[e.MisdirectedRequest=421]="MisdirectedRequest",e[e.UnprocessableEntity=422]="UnprocessableEntity",e[e.Locked=423]="Locked",e[e.FailedDependency=424]="FailedDependency",e[e.TooEarly=425]="TooEarly",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.PreconditionRequired=428]="PreconditionRequired",e[e.TooManyRequests=429]="TooManyRequests",e[e.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",e[e.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented",e[e.BadGateway=502]="BadGateway",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",e[e.InsufficientStorage=507]="InsufficientStorage",e[e.LoopDetected=508]="LoopDetected",e[e.NotExtended=510]="NotExtended",e[e.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired",e))(q||{}),ie=(e=>(e[e.DownloadProgress=0]="DownloadProgress",e[e.Response=1]="Response",e))(ie||{});class B{constructor({body:t,headers:r,status:s,statusText:n}){g(this,"type",1),g(this,"body"),g(this,"headers"),g(this,"status"),g(this,"statusText"),this.body=t,this.headers=r,this.status=s,this.statusText=n}}class $e{constructor(t,r,s){g(this,"type",0),this.total=t,this.loaded=r,this.partialText=s}}class Be{constructor(t,r,s){this.headers=t,this.status=r,this.statusText=s}}let T=class{constructor({request:t,headers:r,status:s,statusText:n,error:o}){g(this,"request"),g(this,"headers"),g(this,"status"),g(this,"statusText"),g(this,"error"),this.request=t,this.headers=r,this.status=s,this.statusText=n,this.error=o}};function ce(e){return{method:e.method,headers:e.getHeadersInit(),body:e.getBody(),credentials:e.withCredentials?"include":void 0}}var Ge=(e,t,r,s)=>{for(var n=t,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},Ve=(e,t)=>(r,s)=>t(r,s,e);let U=class{constructor(e){this._logService=e}send(e){return new y(t=>{const r=new AbortController;return this._send(e,t,r).catch(s=>{t.error(new T({error:s,request:e}))}),()=>r.abort()})}async _send(e,t,r){var s,n;let o;try{const i=ce(e),c=e.getUrlWithParams(),v=fetch(c,{signal:r.signal,...i});this._logService.debug(`[FetchHTTPImplementation]: sending request to url ${c} with params ${i}`),o=await v}catch(i){const c=new T({request:e,error:i,status:(s=i.status)!=null?s:0,statusText:(n=i.statusText)!=null?n:"Unknown Error",headers:i.headers});this._logService.error("[FetchHTTPImplementation]: network error",c),t.error(c);return}const a=new I(o.headers),d=o.status,u=o.statusText;let l=null;if(o.body&&(l=await this._readBody(e,o,t)),d>=q.Ok&&d<q.MultipleChoices)t.next(new B({body:l,headers:a,status:d,statusText:u}));else{const i=new T({request:e,error:l,status:d,statusText:u,headers:a});this._logService.error("[FetchHTTPImplementation]: network error",i),t.error(i)}t.complete()}async _readBody(e,t,r){var s,n;const o=[],a=t.body.getReader(),d=t.headers.get("content-length");let u=0;const l=(s=e.requestParams)==null?void 0:s.reportProgress,i=e.responseType;let c,v;for(;;){const{done:p,value:f}=await a.read();if(p)break;o.push(f),u+=f.length,l&&i==="text"&&(c=(c??"")+(v??(v=new TextDecoder)).decode(f,{stream:!0}),r.next(new $e(d?Number.parseInt(d,10):void 0,u,c)))}const h=Xe(o,u);try{const p=(n=t.headers.get("content-type"))!=null?n:"";return We(e,h,p)}catch(p){const f=new T({request:e,error:p,status:t.status,statusText:t.statusText,headers:new I(t.headers)});return this._logService.error("[FetchHTTPImplementation]: network error",f),r.error(f),null}}};U=Ge([Ve(0,O)],U);function Xe(e,t){const r=new Uint8Array(t);let s=0;for(const n of e)r.set(n,s),s+=n.length;return r}const Je=/^\)\]\}',?\n/;function We(e,t,r){switch(e.responseType){case"json":const s=new TextDecoder().decode(t).replace(Je,"");return s===""?null:JSON.parse(s);case"text":return new TextDecoder().decode(t);case"blob":return new Blob([t.buffer],{type:r});case"arraybuffer":return t.buffer;default:throw new Error(`[FetchHTTPImplementation]: unknown response type: ${e.responseType}.`)}}var ze=(e,t,r,s)=>{for(var n=t,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},Ke=(e,t)=>(r,s)=>t(r,s,e);let M=class{constructor(e){this._logService=e}send(e){return new y(t=>{const r=new XMLHttpRequest,s=e.getUrlWithParams(),n=ce(e),{responseType:o}=e;r.open(e.method,s),e.withCredentials&&(r.withCredentials=!0),n.headers&&Object.entries(n.headers).forEach(([i,c])=>r.setRequestHeader(i,c));const a=()=>{const i=r.statusText||"OK",c=new I(r.getAllResponseHeaders());return new Be(c,r.status,i)},d=()=>{const{headers:i,statusText:c,status:v}=a();let h=null,p=null;v!==q.NoContent&&(h=typeof r.response>"u"?r.responseText:r.response);let f=v>=De&&v<Oe;if(o==="json"&&typeof h=="string"){const m=h;try{h=h?JSON.parse(h):null}catch(_){f=!1,h=m,p=_}}if(o==="blob"&&!(h instanceof Blob)&&(f=!1,p=new Error("Response is not a Blob object")),f)t.next(new B({body:h,headers:i,status:v,statusText:c}));else{const m=new T({request:e,error:p,headers:i,status:v,statusText:c});this._logService.error("[XHRHTTPImplementation]: network error",m),t.error(m)}},u=i=>{const c=new T({request:e,error:i,status:r.status||0,statusText:r.statusText||"Unknown Error",headers:a().headers});this._logService.error("[XHRHTTPImplementation]: network error",c),t.error(c)};r.responseType=o||"",r.addEventListener("load",d),r.addEventListener("error",u),r.addEventListener("abort",u),r.addEventListener("timeout",u);const l=e.getBody();return r.send(l),this._logService.debug("[XHRHTTPImplementation]",`sending request to url ${s} with params ${n}`),()=>{r.readyState!==r.DONE&&r.abort(),r.removeEventListener("load",d),r.removeEventListener("error",u),r.removeEventListener("abort",u),r.removeEventListener("timeout",u)}})}};M=ze([Ke(0,O)],M);var Ye=(e,t,r,s)=>{for(var n=t,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},H=(e,t)=>(r,s)=>t(r,s,e),k;let Y=(k=class extends pe{constructor(e=W,t,r,s){super(),this._config=e,this._logger=t,this._injector=r,this._configService=s;const{...n}=me({},W,this._config);this._configService.setConfig(He,n)}onStarting(){var e,t,r;if(this._injector.get(x,ve.OPTIONAL,ge.SKIP_SELF)&&!((e=this._config)!=null&&e.forceUseNewInstance)){this._logger.warn("[UniverNetworkPlugin]",'HTTPService is already registered in an ancestor interceptor. Skipping registration. If you want to force a new instance, set "forceUseNewInstance" to true in the plugin configuration.');return}const s=(t=this._config)!=null&&t.useFetchImpl?U:typeof window<"u"?M:U;fe(this._injector,ye([[x],[ae,{useClass:s}]],(r=this._config)==null?void 0:r.override))}},g(k,"pluginName","UNIVER_NETWORK_PLUGIN"),k);Y=Ye([H(1,O),H(2,P($)),H(3,_e)],Y);const gt=e=>{const{errorStatusCodes:t,onAuthError:r}=e;return(s,n)=>n(s).pipe(oe(o=>(o instanceof T&&t.some(a=>a===o.status)&&r(),Ue(()=>o))))},Qe=(e=300)=>{let t=()=>{};return r=>new Promise(s=>{t();const n=setTimeout(()=>{s(!0)},e);t=()=>{clearTimeout(n),s(!1)}})},Ze=()=>(e,t)=>t.map(r=>({config:r,result:e})),ft=(e,t={})=>{const{isMatch:r,getParamsFromRequest:s,mergeParamsToRequest:n}=e,{fetchCheck:o=Qe(300),distributeResult:a=Ze()}=t,d=[],u=l=>l.map(i=>i.config);return(l,i)=>r(l)?new y(c=>{const v=s(l);d.push({next:p=>c.next(p),error:p=>c.error(p),config:v});const h=u(d);o(l).then(p=>{if(p){const f=[];h.forEach(m=>{const _=d.findIndex(w=>w.config===m);if(_>=0){const[w]=d.splice(_,1);f.push(w)}}),i(n(h,l)).subscribe({next:m=>{if(m.type===ie.Response){const _=m.body,w=a(_,h);f.forEach(N=>{const G=w.find(L=>L.config===N.config);if(G){const L=new B({body:G.result,headers:m.headers,status:m.status,statusText:m.statusText});N.next(L)}else N.error("batch error")})}},complete:()=>c.complete(),error:m=>c.error(m)})}})}):i(l)},et=3,tt=1e3,yt=e=>{var t,r;const s=(t=e?.maxRetryAttempts)!=null?t:et,n=(r=e?.delayInterval)!=null?r:tt;return(o,a)=>a(o).pipe(Ce({delay:n,count:s}))},Tt=e=>{const t=[],r=new Set,s=()=>{for(var n;r.size<((n=e?.maxParallel)!=null?n:1)&&t.length>0;){const o=t.shift();r.add(o),o()}};return(n,o)=>new y(a=>{const d=()=>o(n).subscribe({next:l=>a.next(l),error:l=>a.error(l),complete:()=>a.complete()}),u=()=>{r.delete(d),se(t,d),s()};return t.push(d),s(),u})},_t=ne("univer.network.socket.service");class rt extends re{createSocket(t){try{const r=new WebSocket(t),s=new Te;return{URL:t,close:(n,o)=>{r.close(n,o),s.dispose()},send:n=>{r.send(n)},open$:new y(n=>{const o=a=>n.next(a);r.addEventListener("open",o),s.add(S(()=>r.removeEventListener("open",o)))}).pipe(R()),close$:new y(n=>{const o=a=>n.next(a);r.addEventListener("close",o),s.add(S(()=>r.removeEventListener("close",o)))}).pipe(R()),error$:new y(n=>{const o=a=>n.next(a);r.addEventListener("error",o),s.add(S(()=>r.removeEventListener("error",o)))}).pipe(R()),message$:new y(n=>{const o=a=>n.next(a);r.addEventListener("message",o),s.add(S(()=>r.removeEventListener("message",o)))}).pipe(R())}}catch(r){return console.error(r),null}}}var st=(e,t,r,s)=>{for(var n=t,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},Q=(e,t)=>(r,s)=>t(r,s,e);let D=class extends ue{constructor(e,t){super(),this._injector=e,this._httpService=t}get(e,t){return this._httpService.get(e,t)}post(e,t){return this._httpService.post(e,t)}put(e,t){return this._httpService.put(e,t)}delete(e,t){return this._httpService.delete(e,t)}patch(e,t){return this._httpService.patch(e,t)}getSSE(e,t,r){return this._httpService.getSSE(e,t,r)}};D=st([Q(0,P($)),Q(1,P(x))],D);class nt extends C{getNetwork(){return this._injector.createInstance(D)}createSocket(t){const r=this._injector.createInstance(rt).createSocket(t);if(!r)throw new Error("[WebSocketService]: failed to create socket!");return r}}C.extend(nt);var ot=Object.defineProperty,at=(e,t,r)=>t in e?ot(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,it=(e,t,r)=>at(e,t+"",r),ct=(e,t,r,s)=>{for(var n=t,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},b=(e,t)=>(r,s)=>t(r,s,e);let E=class{constructor(e,t,r,s,n,o){it(this,"id"),this._documentDataModel=e,this._injector=t,this._univerInstanceService=r,this._commandService=s,this._resourceManagerService=n,this._renderManagerService=o,this.id=this._documentDataModel.getUnitId()}getId(){return this._documentDataModel.getUnitId()}getName(){return this.getSnapshot().title||""}getSnapshot(){const e=this._resourceManagerService.getResourcesByType(this.id,F.UNIVER_DOC),t=this._documentDataModel.getSnapshot();return t.resources=e,t}undo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(we.id)}redo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(be.id)}appendText(e){const t=this.id,{body:r}=this.getSnapshot();if(!r)throw new Error("The document body is empty");const s=r.dataStream.length-2,n={startOffset:s,endOffset:s,collapsed:!0,segmentId:""},{segmentId:o}=n;return this._commandService.executeCommand(Re.id,{unitId:t,body:{dataStream:e},range:n,segmentId:o})}setSelection(e,t){var r;const s=(r=this._renderManagerService.getRenderById(this.getId()))==null?void 0:r.with(Pe);s?.removeAllRanges(),s?.addDocRanges([{startOffset:e,endOffset:t,rangeType:Se.TEXT}],!0)}};E=ct([b(1,P($)),b(2,Ee),b(3,Ie),b(4,xe),b(5,qe)],E);class ut extends C{createUniverDoc(t){const r=this._univerInstanceService.createUnit(F.UNIVER_DOC,t);return this._injector.createInstance(E,r)}getActiveDocument(){const t=this._univerInstanceService.getCurrentUnitForType(F.UNIVER_DOC);return t?this._injector.createInstance(E,t):null}getUniverDoc(t){const r=this._univerInstanceService.getUniverDocInstance(t);return r?this._injector.createInstance(E,r):null}}C.extend(ut);export{M as D,Be as E,I,yt as J,Tt as K,q as L,U as N,ie as Q,Y as V,gt as X,ae as Y,$e as _,K as a,ft as b,rt as c,B as q,T as v,x,_t as z};
