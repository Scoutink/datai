import{g4 as Ze,g5 as We,c5 as Se,fk as we,L as k,da as v,aB as M,E as L,bm as m,bf as Ye,bi as S,bo as be,b7 as Le,b6 as w,g6 as pe,g7 as ze,aj as Ge,ai as Je,bB as Re,d5 as qe,Q as ve,ed as Ee,ea as Qe,g8 as Xe,g9 as et,aw as tt}from"./index-BI8deSNo.js";import{aa as nt}from"./index-DnxWP_AP.js";import{SetTextSelectionsOperation as it,DOC_INTERCEPTOR_POINT as rt,DocSelectionManagerService as O,addCustomRangeBySelectionFactory as st,replaceSelectionFactory as ot,deleteCustomRangeFactory as at,DocSkeletonManagerService as dt,DocInterceptorService as lt}from"./index-GTTB9Gpg.js";import{whenDocAndEditorFocused as ct,DocCanvasPopManagerService as ut,DocEventManagerService as gt,DocRenderController as ht}from"./index-C5GuqOxb.js";import{aj as I,ak as l,z as fe,Y as me,Z as Ie,a4 as Me,T as Oe,E as $,i as pt}from"./index-BmfxE5KL.js";import{bt as x,bw as Pe,an as te,ae as vt,ar as ft,U as mt,l as It,aH as _t,ao as Ct,ba as xt,w as yt,ad as kt,ai as St}from"./index-BeEHzc6r.js";import"./shareReplay-DR2HpNHE.js";import"./takeUntil-BWepI5Pd.js";import"./index-u4QJ_A0o.js";import"./bufferTime-Dc1Jgi3q.js";import"./isObservable-DLg0_x3m.js";function wt(){return Ze(function(e,t){var n,i=!1;e.subscribe(We(t,function(r){var s=n;n=r,i&&t.next([s,r]),i=!0}))})}var bt=Object.defineProperty,Lt=(e,t,n)=>t in e?bt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,_e=(e,t,n)=>Lt(e,typeof t!="symbol"?t+"":t,n);const Rt={id:"docs.mutation.add-hyper-link",type:k.MUTATION,handler:()=>!0},Et={id:"docs.mutation.update-hyper-link",type:k.MUTATION,handler:()=>!0},Mt={id:"docs.mutation.delete-hyper-link",type:k.MUTATION,handler:()=>!0},Ot="docs-hyper-link.config",Ce={};var Pt=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},xe=(e,t)=>(n,i)=>t(n,i,e);const Ne="DOC_HYPER_LINK_PLUGIN";let H=class extends M{constructor(e,t){super(),this._resourceManagerService=e,this._univerInstanceService=t,this._init()}_init(){this._resourceManagerService.registerPluginResource({pluginName:Ne,businesses:[v.UNIVER_DOC],onLoad:(e,t)=>{const n=this._univerInstanceService.getUnit(e,v.UNIVER_DOC);if(!n)return;const i=new Map,r=s=>{var o,a;return(a=(o=s.getBody())==null?void 0:o.customRanges)==null||a.forEach(d=>{d.rangeType===L.HYPERLINK&&i.set(d.rangeId,d)}),i};n.headerModelMap.forEach(s=>{r(s)}),n.footerModelMap.forEach(s=>{r(s)}),r(n),t.links.forEach(s=>{const o=i.get(s.id);o&&(o.properties={...o.properties,url:s.payload})})},onUnLoad:e=>{},toJson:e=>{const t=this._univerInstanceService.getUnit(e,v.UNIVER_DOC),n=[];if(t){const i=r=>{var s,o;(o=(s=r.getBody())==null?void 0:s.customRanges)==null||o.forEach(a=>{var d;a.rangeType===L.HYPERLINK&&n.push({id:a.rangeId,payload:((d=a.properties)==null?void 0:d.url)||""})})};t.headerModelMap.forEach(r=>{i(r)}),t.footerModelMap.forEach(r=>{i(r)}),i(t)}return JSON.stringify({links:n})},parseJson(e){return JSON.parse(e)}})}};H=Pt([xe(0,m(Ye)),xe(1,S)],H);var Nt=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},J=(e,t)=>(n,i)=>t(n,i,e),D;let A=(D=class extends Se{constructor(e=Ce,t,n,i){super(),this._config=e,this._injector=t,this._configService=n,this._commandService=i;const{...r}=we({},Ce,this._config);this._configService.setConfig(Ot,r)}onStarting(){[[H]].forEach(e=>this._injector.add(e)),[Rt,Mt,Et].forEach(e=>{this.disposeWithMe(this._commandService.registerCommand(e))}),this._injector.get(H)}},_e(D,"pluginName",Ne),_e(D,"type",v.UNIVER_DOC),D);A=Nt([J(1,m(be)),J(2,Le),J(3,w)],A);var jt=Object.defineProperty,Ut=(e,t,n)=>t in e?jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,R=(e,t,n)=>Ut(e,typeof t!="symbol"?t+"":t,n);const $t="docs-hyper-link-ui.config",ye={},je={type:k.COMMAND,id:"docs.command.add-hyper-link",async handler(e,t){if(!t)return!1;const{payload:n,unitId:i,selections:r}=t,s=e.get(w),o=Qe(),a=st(e,{rangeId:o,rangeType:L.HYPERLINK,properties:{url:n},unitId:i,selections:r});return a?s.syncExecuteCommand(a.id,a.params):!1}},Ue={id:"docs.command.update-hyper-link",type:k.COMMAND,handler(e,t){var n;if(!t)return!1;const{unitId:i,payload:r,segmentId:s,linkId:o}=t,a=e.get(w),d=e.get(S),c=e.get(O).getActiveTextRange(),g=d.getUnit(i,v.UNIVER_DOC);if(!c||!g)return!1;const h=(n=Ee(g.getSelfOrHeaderFooterModel(s).getBody(),c.startOffset,c.endOffset).textRuns)==null?void 0:n[0];h&&(h.ed=t.label.length+1);const f=ot(e,{unitId:i,body:{dataStream:`${t.label}`,customRanges:[{rangeId:o,rangeType:L.HYPERLINK,startIndex:0,endIndex:t.label.length+1,properties:{url:r}}],textRuns:h?[h]:void 0},selection:{startOffset:c.startOffset,endOffset:c.endOffset,collapsed:!1,segmentId:s}});return f?a.syncExecuteCommand(f.id,f.params):!1}};function Dt(e){return/^[a-zA-Z]+:\/\//.test(e)}function Tt(e){return/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(e)}function Ht(e){return Dt(e)?e:Tt(e)?`mailto://${e}`:`https://${e}`}const V=()=>{const e=x(y),t=x(Re),n=Pe(e.editingLink$),i=x(w),r=x(S),s=x(O),[o,a]=I.useState(""),[d,c]=I.useState(""),[g,h]=I.useState(!1),f=qe.isLegalUrl(o),p=n?r.getUnit(n.unitId,v.UNIVER_DOC):r.getCurrentUnitForType(v.UNIVER_DOC);I.useEffect(()=>{var u,b,oe,ae,de,le,ce,ue,ge;const Z=s.getActiveTextRange();if(!Z)return;if(n){const z=(u=p?.getSelfOrHeaderFooterModel(n.segmentId))==null?void 0:u.getBody(),U=(b=z?.customRanges)==null?void 0:b.find(G=>n?.linkId===G.rangeId&&G.startIndex===n.startIndex&&G.endIndex===n.endIndex);p&&U&&(a((ae=(oe=U.properties)==null?void 0:oe.url)!=null?ae:""),c(ve.transform.getPlainText(Ee(z,U.startIndex,U.endIndex+1).dataStream)));return}const W=(de=p?.getSelfOrHeaderFooterModel(Z.segmentId))==null?void 0:de.getBody(),he=W?Z:null,Y=he&&((ce=ve.customRange.getCustomRangesInterestsWithSelection(he,(le=W?.customRanges)!=null?le:[]))==null?void 0:ce[0]);p&&Y&&a((ge=(ue=Y?.properties)==null?void 0:ue.url)!=null?ge:"")},[p,n,s,r]);const C=()=>{e.hideEditPopup()},_=()=>{if(h(!0),!f||!p)return;const u=Ht(o);if(!n)i.executeCommand(je.id,{unitId:p.getUnitId(),payload:u});else{if(!d)return;i.executeCommand(Ue.id,{unitId:p.getUnitId(),payload:u,linkId:n.linkId,label:d,segmentId:n.segmentId})}e.hideEditPopup()};if(p)return l.jsxs("div",{className:Me("univer-box-border univer-w-[328px] univer-rounded-xl univer-bg-white univer-px-6 univer-py-5 univer-shadow dark:!univer-bg-gray-900",Oe),children:[l.jsxs("div",{children:[n?l.jsx(fe,{label:t.t("docLink.edit.label"),error:g&&!d?t.t("docLink.edit.labelError"):"",children:l.jsx(me,{value:d,onChange:c,autoFocus:!0,onKeyDown:u=>{u.keyCode===te.ENTER&&_()}})}):null,l.jsx(fe,{label:t.t("docLink.edit.address"),error:g&&!f?t.t("docLink.edit.addressError"):"",children:l.jsx(me,{value:o,onChange:a,autoFocus:!0,onKeyDown:u=>{u.keyCode===te.ENTER&&_()}})})]}),l.jsxs("div",{className:"univer-flex univer-justify-end univer-gap-3",children:[l.jsx(Ie,{onClick:C,children:t.t("docLink.edit.cancel")}),l.jsx(Ie,{variant:"primary",disabled:!o,onClick:_,children:t.t("docLink.edit.confirm")})]})]})};V.componentKey="docs-hyper-link-edit";function j({ref:e,...t}){const{icon:n,id:i,className:r,extend:s,...o}=t,a=`univerjs-icon univerjs-icon-${i} ${r||""}`.trim(),d=I.useRef(`_${Kt()}`);return $e(n,`${i}`,{defIds:n.defIds,idSuffix:d.current},{ref:e,className:a,...o},s)}function $e(e,t,n,i,r){return I.createElement(e.tag,{key:t,...At(e,n,r),...i},(Vt(e,n).children||[]).map((s,o)=>$e(s,`${t}-${e.tag}-${o}`,n,void 0,r)))}function At(e,t,n){const i={...e.attrs};n!=null&&n.colorChannel1&&i.fill==="colorChannel1"&&(i.fill=n.colorChannel1),e.tag==="mask"&&i.id&&(i.id=i.id+t.idSuffix),Object.entries(i).forEach(([s,o])=>{s==="mask"&&typeof o=="string"&&(i[s]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))});const{defIds:r}=t;return!r||r.length===0||(e.tag==="use"&&i["xlink:href"]&&(i["xlink:href"]=i["xlink:href"]+t.idSuffix),Object.entries(i).forEach(([s,o])=>{typeof o=="string"&&(i[s]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))})),i}function Vt(e,t){var n;const{defIds:i}=t;return!i||i.length===0?e:e.tag==="defs"&&(n=e.children)!=null&&n.length?{...e,children:e.children.map(r=>typeof r.attrs.id=="string"&&i&&i.includes(r.attrs.id)?{...r,attrs:{...r.attrs,id:r.attrs.id+t.idSuffix}}:r)}:e}function Kt(){return Math.random().toString(36).substring(2,8)}j.displayName="UniverIcon";const Bt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.1302 12.4251C4.25802 13.7417 5.36779 14.7708 6.71792 14.7708H11.7179C13.1539 14.7708 14.3179 13.6067 14.3179 12.1708V6.1708C14.3179 4.78586 13.2351 3.65383 11.8698 3.57517C11.742 2.25858 10.6323 1.22949 9.28213 1.22949H4.28213C2.84619 1.22949 1.68213 2.39355 1.68213 3.82949V9.82949C1.68213 11.2144 2.76497 12.3465 4.1302 12.4251ZM10.6583 3.5708H6.71792C5.28198 3.5708 4.11792 4.73486 4.11792 6.1708V11.22C3.4221 11.1387 2.88213 10.5471 2.88213 9.82949V3.82949C2.88213 3.05629 3.50893 2.42949 4.28213 2.42949H9.28213C9.96695 2.42949 10.5369 2.92119 10.6583 3.5708ZM13.1179 6.1708C13.1179 5.3976 12.4911 4.7708 11.7179 4.7708H6.71792C5.94472 4.7708 5.31792 5.3976 5.31792 6.1708V12.1708C5.31792 12.944 5.94472 13.5708 6.71792 13.5708H11.7179C12.4911 13.5708 13.1179 12.944 13.1179 12.1708V6.1708Z",fillRule:"evenodd",clipRule:"evenodd"}}]},De=I.forwardRef(function(e,t){return I.createElement(j,Object.assign({},e,{id:"copy-icon",ref:t,icon:Bt}))});De.displayName="CopyIcon";const Ft={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M9.8816 1.97978C11.0177 0.843607 12.862 0.884962 14.0004 2.02342C15.1389 3.16188 15.1803 5.00612 14.0441 6.14228L11.399 8.78737C11.1608 9.02559 10.7746 9.02559 10.5363 8.78737C10.2981 8.54915 10.2981 8.16292 10.5363 7.9247L13.1814 5.2796C13.8195 4.64155 13.8217 3.57006 13.1378 2.8861C12.4538 2.20211 11.3823 2.20438 10.7443 2.84245L7.6976 5.88911L7.69317 5.89349C7.05959 6.53211 7.05894 7.60014 7.74132 8.28252C7.97954 8.52074 7.97954 8.90697 7.74132 9.14519C7.5031 9.38341 7.11687 9.38341 6.87865 9.14519C5.74016 8.00671 5.69884 6.16251 6.83497 5.02633L6.84021 5.02116L9.8816 1.97978Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.61426 7.2364C4.85248 6.99818 5.23871 6.99818 5.47693 7.2364C5.71515 7.47462 5.71515 7.86085 5.47693 8.09907L2.83183 10.7442C2.19375 11.3823 2.1915 12.4537 2.87547 13.1377C3.55945 13.8217 4.6309 13.8194 5.26899 13.1813L8.31566 10.1347C8.32262 10.1277 8.32971 10.121 8.33691 10.1144C8.34408 10.1064 8.3515 10.0986 8.35916 10.091C8.99721 9.45291 8.99949 8.38145 8.3155 7.69746C8.07728 7.45924 8.07728 7.07301 8.3155 6.83479C8.55372 6.59657 8.93995 6.59657 9.17817 6.83479C10.3166 7.97327 10.358 9.81748 9.22183 10.9536C9.21487 10.9606 9.20779 10.9673 9.20058 10.9739C9.19341 10.9819 9.18599 10.9897 9.17833 10.9973L6.13166 14.044C4.99548 15.1802 3.15127 15.1389 2.01279 14.0004C0.874362 12.8619 0.83297 11.0177 1.96916 9.8815L4.61426 7.2364Z"}}]},se=I.forwardRef(function(e,t){return I.createElement(j,Object.assign({},e,{id:"link-icon",ref:t,icon:Ft}))});se.displayName="LinkIcon";const Zt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.5935 3.47302C11.6354 2.51492 10.082 2.51492 9.12388 3.47302L7.83534 4.76157C7.60102 4.99588 7.22112 4.99588 6.98681 4.76157C6.75249 4.52725 6.75249 4.14735 6.98681 3.91304L8.27535 2.62449C9.70209 1.19776 12.0153 1.19776 13.442 2.62449C14.8688 4.05123 14.8688 6.36442 13.442 7.79116L12.1535 9.0797C11.9192 9.31402 11.5393 9.31402 11.3049 9.0797C11.0706 8.84539 11.0706 8.46549 11.3049 8.23117L12.5935 6.94263C13.5516 5.98452 13.5516 4.43113 12.5935 3.47302Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.40637 12.6606C2.44827 11.7025 2.44827 10.1491 3.40637 9.19102L4.69492 7.90248C4.92923 7.66816 4.92923 7.28826 4.69492 7.05395C4.4606 6.81963 4.0807 6.81963 3.84639 7.05395L2.55784 8.34249C1.13111 9.76923 1.13111 12.0824 2.55784 13.5092C3.98458 14.9359 6.29777 14.9359 7.72451 13.5092L9.01305 12.2206C9.24737 11.9863 9.24737 11.6064 9.01305 11.3721C8.77874 11.1378 8.39884 11.1378 8.16452 11.3721L6.87598 12.6606C5.91787 13.6187 4.36448 13.6187 3.40637 12.6606Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.5852 2.80332C3.35088 2.569 2.97098 2.569 2.73667 2.80332C2.50235 3.03763 2.50235 3.41753 2.73667 3.65185L12.4151 13.3302C12.6494 13.5646 13.0293 13.5646 13.2636 13.3302C13.4979 13.0959 13.4979 12.716 13.2636 12.4817L3.5852 2.80332Z"}}]},Te=I.forwardRef(function(e,t){return I.createElement(j,Object.assign({},e,{id:"unlink-icon",ref:t,icon:Zt}))});Te.displayName="UnlinkIcon";const Wt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.6551 1.98906C11.7476 1.08113 10.2757 1.08149 9.3686 1.98987L4.82542 6.53955C4.75087 6.61421 4.69336 6.70411 4.65682 6.80309L3.2461 10.625C3.16506 10.8446 3.21909 11.0912 3.3845 11.2568C3.54991 11.4224 3.79651 11.4767 4.01616 11.3959L7.85031 9.98517C7.94979 9.94856 8.04014 9.89077 8.11508 9.81579L12.6552 5.27327C13.5618 4.36621 13.5618 2.89607 12.6551 1.98906ZM10.2177 2.83779C10.6562 2.39869 11.3677 2.39851 11.8064 2.8374C12.2447 3.27584 12.2447 3.9865 11.8065 4.42497L7.3392 8.89457L4.82213 9.82068L5.74706 7.31487L10.2177 2.83779Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.79238 13.2999C1.46101 13.2999 1.19238 13.5685 1.19238 13.8999C1.19238 14.2313 1.46101 14.4999 1.79238 14.4999H14.4924C14.8238 14.4999 15.0924 14.2313 15.0924 13.8999C15.0924 13.5685 14.8238 13.2999 14.4924 13.2999H1.79238Z"}}]},He=I.forwardRef(function(e,t){return I.createElement(j,Object.assign({},e,{id:"write-icon",ref:t,icon:Wt}))});He.displayName="WriteIcon";const Ae={type:k.COMMAND,id:"docs.command.delete-hyper-link",async handler(e,t){if(!t)return!1;const{unitId:n,linkId:i,segmentId:r}=t,s=e.get(w),o=at(e,{unitId:n,rangeId:i,segmentId:r});return o?await s.syncExecuteCommand(o.id,o.params):!1}},Ve=e=>{const t=e.get(O),n=e.get(S),i=t.getTextRanges();if(!(i!=null&&i.length))return!0;const r=i[0];return!!(!n.getCurrentUnitForType(v.UNIVER_DOC)||!r||r.collapsed)},E={type:k.OPERATION,id:"doc.operation.show-hyper-link-edit-popup",handler(e,t){var n;const i=t?.link,r=e.get(S);if(Ve(e)&&!i)return!1;const s=e.get(y),o=i?.unitId||((n=r.getCurrentUnitForType(v.UNIVER_DOC))==null?void 0:n.getUnitId());return o?(s.showEditPopup(o,i),!0):!1}},ne={type:k.OPERATION,id:"doc.operation.toggle-hyper-link-info-popup",handler(e,t){const n=e.get(y);return t?(n.showInfoPopup(t),!0):(n.hideInfoPopup(),!0)}},Ke={type:k.OPERATION,id:"doc.operation.click-hyper-link",handler(e,t){var n,i,r;if(!t)return!1;const{unitId:s,linkId:o,segmentId:a}=t,d=e.get(S).getUnit(s,v.UNIVER_DOC),c=d?.getSelfOrHeaderFooterModel(a).getBody(),g=(r=(i=(n=c?.customRanges)==null?void 0:n.find(h=>h.rangeId===o&&h.rangeType===L.HYPERLINK))==null?void 0:i.properties)==null?void 0:r.url;return g&&window.open(g,"_blank","noopener noreferrer"),!0}},K=()=>{var e,t;const n=x(y),i=x(w),r=x(vt),s=x(Re),o=Pe(n.showingLink$),a=x(S);if(!o)return null;const{unitId:d,linkId:c,segmentId:g,startIndex:h,endIndex:f}=o,p=a.getUnit(d,v.UNIVER_DOC),C=p?.getSelfOrHeaderFooterModel(g).getBody(),_=(e=C?.customRanges)==null?void 0:e.find(b=>b.rangeId===c&&b.rangeType===L.HYPERLINK&&b.startIndex===h&&b.endIndex===f);if(!_)return null;const u=(t=_.properties)==null?void 0:t.url;return l.jsxs("div",{className:Me("univer-box-border univer-flex univer-max-w-80 univer-items-center univer-justify-between univer-overflow-hidden univer-rounded-lg univer-bg-white univer-p-3 univer-shadow dark:!univer-bg-gray-900",Oe),onClick:()=>{n.hideInfoPopup()},children:[l.jsxs("div",{className:"univer-flex univer-h-6 univer-flex-1 univer-cursor-pointer univer-items-center univer-truncate univer-text-sm univer-leading-5 univer-text-primary-500",onClick:()=>window.open(u,void 0,"noopener noreferrer"),children:[l.jsx("div",{className:"univer-mr-2 univer-flex univer-size-5 univer-flex-[0_0_auto] univer-items-center univer-justify-center univer-text-base univer-text-gray-900 dark:!univer-text-white",children:l.jsx(se,{})}),l.jsx($,{showIfEllipsis:!0,title:u,children:l.jsx("span",{className:"univer-flex-1 univer-truncate",children:u})})]}),l.jsxs("div",{className:"univer-flex univer-h-6 univer-flex-[0_0_auto] univer-items-center univer-justify-center",children:[l.jsx("div",{className:"univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded univer-text-base",onClick:()=>{navigator.clipboard.writeText(u),r.show({content:s.t("docLink.info.coped"),type:pt.Info})},children:l.jsx($,{placement:"bottom",title:s.t("docLink.info.copy"),children:l.jsx(De,{})})}),l.jsx("div",{className:"univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded univer-text-base",onClick:()=>{i.executeCommand(E.id,{link:o})},children:l.jsx($,{placement:"bottom",title:s.t("docLink.info.edit"),children:l.jsx(He,{})})}),l.jsx("div",{className:"univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded univer-text-base",onClick:()=>{i.executeCommand(Ae.id,{unitId:d,linkId:_.rangeId,segmentId:g})},children:l.jsx($,{placement:"bottom",title:s.t("docLink.info.cancel"),children:l.jsx(Te,{})})})]})]})};K.componentKey="univer.doc.link-info-popup";var Yt=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},q=(e,t)=>(n,i)=>t(n,i,e);let y=class extends M{constructor(e,t,n){super(),R(this,"_editingLink$",new pe(null)),R(this,"_showingLink$",new pe(null)),R(this,"editingLink$",this._editingLink$.asObservable()),R(this,"showingLink$",this._showingLink$.asObservable()),R(this,"_editPopup",null),R(this,"_infoPopup",null),this._docCanvasPopupManagerService=e,this._textSelectionManagerService=t,this._univerInstanceService=n,this.disposeWithMe(()=>{this._editingLink$.complete(),this._showingLink$.complete()})}get editing(){return this._editingLink$.value}get showing(){return this._showingLink$.value}showEditPopup(e,t){this._editPopup&&this._editPopup.dispose(),this._editingLink$.next(t);const n=this._textSelectionManagerService.getTextRanges({unitId:e,subUnitId:e});let i=n?.[n.length-1];if(t){const{segmentId:r,segmentPage:s,startIndex:o,endIndex:a}=t;i={collapsed:!1,startOffset:o,endOffset:a+1,segmentId:r,segmentPage:s},this._textSelectionManagerService.replaceDocRanges([{startOffset:o,endOffset:a+1}])}return i?(this._editPopup=this._docCanvasPopupManagerService.attachPopupToRange(i,{componentKey:V.componentKey,direction:"bottom"},e),this._editPopup):null}hideEditPopup(){var e;this._editingLink$.next(null),(e=this._editPopup)==null||e.dispose()}showInfoPopup(e){var t,n,i,r,s,o;const{linkId:a,unitId:d,segmentId:c,segmentPage:g,startIndex:h,endIndex:f}=e;if(!(((t=this.showing)==null?void 0:t.linkId)===a&&((n=this.showing)==null?void 0:n.unitId)===d&&((i=this.showing)==null?void 0:i.segmentId)===c&&((r=this.showing)==null?void 0:r.segmentPage)===g&&((s=this.showing)==null?void 0:s.startIndex)===h&&((o=this.showing)==null?void 0:o.endIndex)===f||(this._infoPopup&&this._infoPopup.dispose(),!this._univerInstanceService.getUnit(d,v.UNIVER_DOC))))return this._showingLink$.next({unitId:d,linkId:a,segmentId:c,segmentPage:g,startIndex:h,endIndex:f}),this._infoPopup=this._docCanvasPopupManagerService.attachPopupToRange({collapsed:!1,startOffset:h,endOffset:f+1,segmentId:c,segmentPage:g},{componentKey:K.componentKey,direction:"top-center",multipleDirection:"top",onClickOutside:()=>{this.hideInfoPopup()}},d),this._infoPopup}hideInfoPopup(){var e;this._showingLink$.next(null),(e=this._infoPopup)==null||e.dispose()}};y=Yt([q(0,m(ut)),q(1,m(O)),q(2,S)],y);var zt=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},Q=(e,t)=>(n,i)=>t(n,i,e);let B=class extends M{constructor(e,t,n){super(),this._commandService=e,this._univerInstanceService=t,this._docHyperLinkService=n,this._initSelectionChange()}_initSelectionChange(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var t,n,i;if(e.id===it.id){const r=e.params,{unitId:s,ranges:o,segmentId:a}=r,d=this._univerInstanceService.getUnit(s,v.UNIVER_DOC),c=o[0];if(c&&d){const{startOffset:g,endOffset:h,collapsed:f,segmentPage:p}=c,C=(n=(t=d.getSelfOrHeaderFooterModel(a))==null?void 0:t.getBody())==null?void 0:n.customRanges;if(f){const _=(i=C?.findIndex(u=>u.startIndex<g&&u.endIndex>h-1))!=null?i:-1;if(_>-1){const u=C[_];this._docHyperLinkService.showInfoPopup({unitId:s,linkId:u.rangeId,segmentId:a,segmentPage:p,startIndex:u.startIndex,endIndex:u.endIndex});return}}else if(C?.find(_=>_.startIndex<=g&&_.endIndex>=h-1))return}this._docHyperLinkService.hideInfoPopup(),this._docHyperLinkService.hideEditPopup()}}))}};B=zt([Q(0,w),Q(1,S),Q(2,m(y))],B);var Gt=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},P=(e,t)=>(n,i)=>t(n,i,e);let ie=class extends M{constructor(e,t,n,i,r,s){super(),this._context=e,this._docEventManagerService=t,this._commandService=n,this._hyperLinkPopupService=i,this._docSkeletonManagerService=r,this._docSelectionManagerService=s,!(this._context.unitId===Ge||this._context.unitId===Je)&&(this._initHover(),this._initClick())}get _skeleton(){return this._docSkeletonManagerService.getSkeleton()}_hideInfoPopup(){this._hyperLinkPopupService.showing&&this._commandService.executeCommand(ne.id)}_initHover(){this.disposeWithMe(this._docEventManagerService.hoverCustomRanges$.subscribe(e=>{var t;const n=e.find(s=>s.range.rangeType===L.HYPERLINK),i=this._docSelectionManagerService.getTextRanges(),r=i?.[0].segmentId;if(((t=n?.segmentId)!=null?t:"")!==r){this._hideInfoPopup();return}n?this._commandService.executeCommand(ne.id,{unitId:this._context.unitId,linkId:n.range.rangeId,segmentId:n.segmentId,segmentPage:n.segmentPageIndex,rangeId:n.range.rangeId,startIndex:n.range.startIndex,endIndex:n.range.endIndex}):this._hideInfoPopup()}))}_initClick(){this.disposeWithMe(this._docEventManagerService.clickCustomRanges$.subscribe(e=>{const t=e.range;t&&this._commandService.executeCommand(Ke.id,{unitId:this._context.unitId,linkId:t.rangeId,segmentId:e.segmentId})}))}};ie=Gt([P(1,m(gt)),P(2,w),P(3,m(y)),P(4,m(dt)),P(5,m(O))],ie);var Jt=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},X=(e,t)=>(n,i)=>t(n,i,e);let re=class extends M{constructor(e,t,n,i){super(),this._context=e,this._docInterceptorService=t,this._hyperLinkService=n,this._docRenderController=i,this._init(),this._initReRender()}_init(){this._docInterceptorService.intercept(rt.CUSTOM_RANGE,{handler:(e,t,n)=>{if(!e)return n(e);const{unitId:i,index:r}=t,s=this._hyperLinkService.showing;if(!s)return n({...e,active:!1});const{linkId:o,unitId:a,startIndex:d,endIndex:c}=s,g=a===i&&e.rangeId===o&&r>=d&&r<=c;return n({...e,active:g})}})}_initReRender(){this.disposeWithMe(this._hyperLinkService.showingLink$.pipe(ze((e,t)=>e?.linkId===t?.linkId&&e?.unitId===t?.unitId&&e?.startIndex===t?.startIndex),wt()).subscribe(([e,t])=>{t?t.unitId===this._context.unitId&&this._docRenderController.reRender(t.unitId):e&&e.unitId===this._context.unitId&&this._docRenderController.reRender(e.unitId)}))}};re=Jt([X(1,m(lt)),X(2,m(y)),X(3,m(ht))],re);const Be="doc-hyper-link-icon";function ke(e){return{id:E.id,type:Ct.BUTTON,icon:Be,title:"docLink.menu.tooltip",tooltip:"docLink.menu.tooltip",hidden$:xt(e,v.UNIVER_DOC),disabled$:new Xe(function(t){const n=e.get(O).textSelection$.pipe(et(16)).subscribe(()=>{t.next(Ve(e))});return()=>{n.unsubscribe()}})}}const qt={id:E.id,binding:ft.CTRL_COMMAND|te.K,description:"docLink.menu.tooltip",preconditions:ct},Qt={[_t.MEDIA]:{[E.id]:{order:1,menuItemFactory:ke}},[mt.MAIN_AREA]:{[It.DATA]:{[E.id]:{order:0,menuItemFactory:ke}}}};var Xt=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},T=(e,t)=>(n,i)=>t(n,i,e);let F=class extends M{constructor(e,t,n,i){super(),this._componentManager=e,this._commandService=t,this._menuManagerService=n,this._shortcutService=i,this._initComponents(),this._initCommands(),this._initMenus(),this._initShortcut()}_initComponents(){[[V.componentKey,V],[K.componentKey,K],[Be,se]].forEach(([e,t])=>{this.disposeWithMe(this._componentManager.register(e,t))})}_initCommands(){[je,Ue,Ae,E,ne,Ke].forEach(e=>{this._commandService.registerCommand(e)})}_initShortcut(){[qt].forEach(e=>{this._shortcutService.registerShortcut(e)})}_initMenus(){this._menuManagerService.mergeMenu(Qt)}};F=Xt([T(0,m(yt)),T(1,w),T(2,kt),T(3,St)],F);const en="DOC_HYPER_LINK_UI_PLUGIN";var tn=Object.defineProperty,nn=(e,t,n)=>t in e?tn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,rn=(e,t,n,i)=>{for(var r=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(r=o(r)||r);return r},ee=(e,t)=>(n,i)=>t(n,i,e),Fe=(e,t,n)=>nn(e,typeof t!="symbol"?t+"":t,n);let N=class extends Se{constructor(e=ye,t,n,i){super(),this._config=e,this._injector=t,this._renderManagerSrv=n,this._configService=i;const{menu:r,...s}=we({},ye,this._config);r&&this._configService.setConfig("menu",r,{merge:!0}),this._configService.setConfig($t,s)}onStarting(){[[y],[F],[B]].forEach(e=>{this._injector.add(e)}),this._injector.get(F)}onReady(){this._injector.get(B)}onRendered(){this._initRenderModule()}_initRenderModule(){[[re],[ie]].forEach(e=>{this._renderManagerSrv.registerRenderModule(v.UNIVER_DOC,e)})}};Fe(N,"pluginName",en);Fe(N,"type",v.UNIVER_DOC);N=rn([tt(A),ee(1,m(be)),ee(2,nt),ee(3,Le)],N);function fn(){return{plugins:[A,N].filter(e=>!!e)}}export{A as UniverDocsHyperLinkPlugin,fn as UniverDocsHyperLinkPreset,N as UniverDocsHyperLinkUIPlugin};
