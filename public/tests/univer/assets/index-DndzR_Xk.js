import{L as ie,ar as m,aB as ae,gm as Zt,g9 as Ni,d5 as Z,da as $,g6 as Si,f$ as Ue,c5 as Wr,fk as Pr,bc as Bt,b6 as H,i as Le,bf as fn,bi as q,bm as S,bo as Me,b7 as dr,bB as Ne,fM as $t,au as C,e_ as F,di as Ve,bP as Ze,er as ma,cl as je,cm as fe,fy as ke,as as Re,at as re,gf as lt,dr as pa,ea as ut,et as _n,dZ as qt,cf as In,d_ as va,cz as Gr,j as fa,f6 as _a,aw as Ia,bx as Wi,bd as Sn,bw as En,g7 as Rn,aC as wn,bp as Sa,fz as Ei,ap as Ye,gl as Ea,d6 as yn,co as bn,fb as Cn,dd as Oe,b5 as Ke,a1 as Ce,fQ as Pi,d4 as Ra,k as Vn,bS as Mn,h as ft}from"./index-BI8deSNo.js";import{ay as wa,bi as Tn,as as Je,cp as Un,i as An,bP as ya,bZ as Nn,bh as ba,bW as Dn,aF as Ca,b_ as Va,b$ as xn}from"./index-BBqjqAkl.js";import{hm as cr,X as Kt,cr as Ma,gp as kn,K as Yr,aj as On,cp as Ln,am as Fn,hz as Bn,dM as Ta,c9 as $n,Y as hr,N as Qt,d4 as pr,x as jn,R as Ua,bz as Aa,p as Jt,z as Ri,h as wi,b as yi,$ as bi,ab as Gi,hW as Hn,bW as vr,i4 as Ci,hj as Yi,fF as Wn,n as Wt,m as Pn,a2 as Gn,gB as Yn,b5 as Qn,ee as Xn,b7 as qn,i as Na,c as zn,t as Zn,b0 as Kn,b8 as Jn,f3 as eo,a4 as Da,f as Di,E as xa,i7 as ka}from"./facade-BslPbXnu.js";import{f as to,v as Oa,N as La,d as ro}from"./index-Dd27tKdG.js";import{aa as gt,x as fr,bD as Qi,bf as io,m as ao,bK as Ct,c as Vt,bO as at,D as Pt,be as Xi,aG as Fa,a_ as no,a3 as oo}from"./index-DnxWP_AP.js";import{an as _r,aj as Ba,aF as so,ao as xi,ba as lo,bt as W,bw as Qe,bz as $a,bu as Vi,w as ki,a6 as uo,am as ja,ad as co}from"./index-BeEHzc6r.js";import{s as ho}from"./index-DYW2pYtY.js";import{aj as A,Z as Mt,ak as I,z as ne,J as Oi,o as ot,u as Qr,a4 as dt,T as Vr,Y as st,L as go,p as qi,c as mo}from"./index-BmfxE5KL.js";import{b as Ha}from"./bufferTime-Dc1Jgi3q.js";import{U as Wa,j as po}from"./facade-bHpds0ZF.js";import"./takeUntil-BWepI5Pd.js";import"./isObservable-DLg0_x3m.js";import"./shareReplay-DR2HpNHE.js";import"./index-C5GuqOxb.js";import"./index-GTTB9Gpg.js";import"./index-u4QJ_A0o.js";var vo=Object.defineProperty,fo=(t,e,r)=>e in t?vo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,_e=(t,e,r)=>fo(t,typeof e!="symbol"?e+"":e,r);function er(t){return{type:t.type,operator:t.operator,formula1:t.formula1,formula2:t.formula2,allowBlank:t.allowBlank}}function Tt(t){return{error:t.error,errorStyle:t.errorStyle,errorTitle:t.errorTitle,imeMode:t.imeMode,prompt:t.prompt,promptTitle:t.promptTitle,showDropDown:t.showDropDown,showErrorMessage:t.showErrorMessage,showInputMessage:t.showInputMessage,renderMode:t.renderMode,bizInfo:t.bizInfo}}var Q=(t=>(t[t.SETTING=0]="SETTING",t[t.RANGE=1]="RANGE",t[t.OPTIONS=2]="OPTIONS",t[t.ALL=3]="ALL",t))(Q||{}),_o=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Io=(t,e)=>(r,a)=>e(r,a,t);let ee=class extends ae{constructor(t){super(),_e(this,"_model",new Map),_e(this,"_ruleChange$",new Zt),_e(this,"ruleChange$",this._ruleChange$.asObservable()),_e(this,"ruleChangeDebounce$",this.ruleChange$.pipe(Ni(20))),this._logService=t,this.disposeWithMe({dispose:()=>{this._ruleChange$.complete()}})}_ensureMap(t,e){this._model.has(t)||this._model.set(t,new Map);const r=this._model.get(t);if(r.has(e))return r.get(e);const a={map:new Map,list:[]};return r.set(e,a),a}_addSubUnitRule(t,e,r){const{map:a,list:i}=t,n=(Array.isArray(e)?e:[e]).filter(o=>!a.has(o.uid));typeof r=="number"&&r<i.length?i.splice(r,0,...n):i.push(...n),n.forEach(o=>{a.set(o.uid,o)})}_removeSubUnitRule(t,e){const{map:r,list:a}=t,i=a.findIndex(n=>n.uid===e);i>-1&&(a.splice(i,1),r.delete(e))}_updateSubUnitRule(t,e,r){const{map:a,list:i}=t,n=a.get(e),o=i.findIndex(l=>e===l.uid);if(!n)throw new Error(`Data validation rule is not found, ruleId: ${e}.`);const s={...n};switch(r.type){case Q.RANGE:{s.ranges=r.payload;break}case Q.SETTING:{Object.assign(s,er(r.payload));break}case Q.OPTIONS:{Object.assign(s,Tt(r.payload));break}case Q.ALL:{Object.assign(s,r.payload);break}}return i[o]=s,a.set(e,s),s}_addRuleSideEffect(t,e,r,a){if(!this._ensureMap(t,e).map.get(r.uid))return{rule:r,type:"add",unitId:t,subUnitId:e,source:a}}addRule(t,e,r,a,i){try{const n=this._ensureMap(t,e),o=(Array.isArray(r)?r:[r]).map(s=>this._addRuleSideEffect(t,e,s,a));this._addSubUnitRule(n,r,i),o.forEach(s=>{s&&this._ruleChange$.next(s)})}catch(n){this._logService.error(n)}}updateRule(t,e,r,a,i){try{const n=this._ensureMap(t,e),o=Z.deepClone(n.map.get(r));if(!o)throw new Error(`Data validation rule is not found, ruleId: ${r}.`);const s=this._updateSubUnitRule(n,r,a);this._ruleChange$.next({rule:s,type:"update",unitId:t,subUnitId:e,source:i,updatePayload:a,oldRule:o})}catch(n){this._logService.error(n)}}removeRule(t,e,r,a){try{const i=this._ensureMap(t,e),n=i.map.get(r);n&&(this._removeSubUnitRule(i,r),this._ruleChange$.next({rule:n,type:"remove",unitId:t,subUnitId:e,source:a}))}catch(i){this._logService.error(i)}}getRuleById(t,e,r){return this._ensureMap(t,e).map.get(r)}getRuleIndex(t,e,r){return this._ensureMap(t,e).list.findIndex(a=>a.uid===r)}getRules(t,e){return[...this._ensureMap(t,e).list]}getUnitRules(t){const e=this._model.get(t);if(!e)return[];const r=[];return e.forEach((a,i)=>{r.push([i,a.list])}),r}deleteUnitRules(t){this._model.delete(t)}getSubUnitIds(t){var e,r;return Array.from((r=(e=this._model.get(t))==null?void 0:e.keys())!=null?r:[])}getAll(){return Array.from(this._model.keys()).map(t=>[t,this.getUnitRules(t)])}};ee=_o([Io(0,Bt)],ee);const Ie={type:ie.MUTATION,id:"data-validation.mutation.addRule",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,rule:i,index:n,source:o="command"}=e;return t.get(ee).addRule(r,a,i,o,n),!0}},ce={type:ie.MUTATION,id:"data-validation.mutation.removeRule",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ruleId:i,source:n="command"}=e,o=t.get(ee);return Array.isArray(i)?i.forEach(s=>{o.removeRule(r,a,s,n)}):o.removeRule(r,a,i,n),!0}},J={type:ie.MUTATION,id:"data-validation.mutation.updateRule",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ruleId:i,payload:n,source:o="command"}=e;return t.get(ee).updateRule(r,a,i,n,o),!0}};var So=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},ei=(t,e)=>(r,a)=>e(r,a,t);const Eo="SHEET_DATA_VALIDATION_PLUGIN";let Mr=class extends ae{constructor(t,e,r){super(),this._resourceManagerService=t,this._univerInstanceService=e,this._dataValidationModel=r,this._initSnapshot()}_initSnapshot(){const t=r=>{const a=this._dataValidationModel.getUnitRules(r),i={};return a?(a.forEach(([n,o])=>{i[n]=o}),JSON.stringify(i)):""},e=r=>{if(!r)return{};try{return JSON.parse(r)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:Eo,businesses:[$.UNIVER_SHEET],toJson:r=>t(r),parseJson:r=>e(r),onUnLoad:r=>{this._dataValidationModel.deleteUnitRules(r)},onLoad:(r,a)=>{Object.keys(a).forEach(i=>{a[i].forEach(n=>{this._dataValidationModel.addRule(r,i,n,"patched")})})}}))}};Mr=So([ei(0,fn),ei(1,q),ei(2,S(ee))],Mr);var Pa=(t=>(t.SHEET="sheet",t))(Pa||{});let he=class{constructor(){_e(this,"_validatorByScopes",new Map),_e(this,"_validatorMap",new Map),_e(this,"_validatorsChange$",new Si(void 0)),_e(this,"validatorsChange$",this._validatorsChange$.asObservable())}_addValidatorToScope(e,r){this._validatorByScopes.has(r)||this._validatorByScopes.set(r,[]);const a=this._validatorByScopes.get(r);if(a.findIndex(i=>i.id===e.id)>-1)throw new Error(`Validator item with the same id ${e.id} has already been added!`);a.push(e)}_removeValidatorFromScope(e,r){const a=this._validatorByScopes.get(r);if(!a)return;const i=a.findIndex(n=>n.id===e.id);i>-1&&a.splice(i,1)}register(e){return this._validatorMap.set(e.id,e),Array.isArray(e.scopes)?e.scopes.forEach(r=>{this._addValidatorToScope(e,r)}):this._addValidatorToScope(e,e.scopes),this._validatorsChange$.next(),Ue(()=>{this._validatorMap.delete(e.id),Array.isArray(e.scopes)?e.scopes.forEach(r=>{this._removeValidatorFromScope(e,r)}):this._removeValidatorFromScope(e,e.scopes),this._validatorsChange$.next()})}getValidatorItem(e){return this._validatorMap.get(e)}getValidatorsByScope(e){return this._validatorByScopes.get(e)}};const Ro={type:ie.COMMAND,id:"data-validation.command.addRule",async handler(t,e){if(t.get(Bt).error("[Deprecated]: `AddDataValidationCommand` is deprecated, please use `AddSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!e)return!1;const{rule:r,unitId:a,subUnitId:i}=e,n=t.get(H),o=t.get(Le),s={...e,rule:{...e.rule,ranges:[e.rule.range]}},l=[{id:Ie.id,params:s}],u=[{id:ce.id,params:{unitId:a,subUnitId:i,ruleId:r.uid}}];return o.pushUndoRedo({unitID:a,redoMutations:l,undoMutations:u}),await n.executeCommand(Ie.id,s),!0}},wo={type:ie.COMMAND,id:"data-validation.command.removeRule",handler(t,e){if(t.get(Bt).error("[Deprecated]: `RemoveDataValidationCommand` is deprecated, please use `RemoveSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!e)return!1;const{unitId:r,subUnitId:a,ruleId:i}=e,n=t.get(H),o=t.get(Le),s=t.get(ee),l=[{id:ce.id,params:e}],u=[{id:Ie.id,params:{unitId:r,subUnitId:a,rule:{...s.getRuleById(r,a,i)},index:s.getRuleIndex(r,a,i)}}];return o.pushUndoRedo({undoMutations:u,redoMutations:l,unitID:e.unitId}),n.executeCommand(ce.id,e),!0}},yo={type:ie.COMMAND,id:"data-validation.command.updateDataValidationSetting",handler(t,e){if(t.get(Bt).warn("[Deprecated]: `UpdateDataValidationOptionsCommand` is deprecated, please use `UpdateSheetDataValidationOptionsCommand` in `@univerjs/sheets-data-validation` instead!"),!e)return!1;const r=t.get(H),a=t.get(Le),i=t.get(ee),{unitId:n,subUnitId:o,ruleId:s,options:l}=e,u=i.getRuleById(n,o,s);if(!u)return!1;const d={unitId:n,subUnitId:o,ruleId:s,payload:{type:Q.OPTIONS,payload:l}},c=[{id:J.id,params:d}],h={unitId:n,subUnitId:o,ruleId:s,payload:{type:Q.OPTIONS,payload:Tt(u)}},g=[{id:J.id,params:h}];return a.pushUndoRedo({unitID:n,redoMutations:c,undoMutations:g}),r.executeCommand(J.id,d),!0}},bo={type:ie.COMMAND,id:"data-validation.command.updateDataValidationOptions",handler(t,e){if(t.get(Bt).error("[Deprecated]: `UpdateDataValidationSettingCommand` is deprecated, please use `UpdateSheetDataValidationSettingCommand` in `@univerjs/sheets-data-validation` instead!"),!e)return!1;const r=t.get(H),a=t.get(Le),i=t.get(ee),n=t.get(he),{unitId:o,subUnitId:s,ruleId:l,setting:u}=e,d=n.getValidatorItem(u.type);if(!d)return!1;const c=i.getRuleById(o,s,l);if(!c)return!1;const h={...c,...u};if(!d.validatorFormula(h,o,s).success)return!1;const g={unitId:o,subUnitId:s,ruleId:l,payload:{type:Q.SETTING,payload:{...u,...d.normalizeFormula(h,o,s)}}},v=[{id:J.id,params:g}],f={unitId:o,subUnitId:s,ruleId:l,payload:{type:Q.SETTING,payload:er(c)}},R=[{id:J.id,params:f}];return a.pushUndoRedo({unitID:o,redoMutations:v,undoMutations:R}),r.executeCommand(J.id,g),!0}},Co={type:ie.COMMAND,id:"data-validation.command.removeAll",handler(t,e){if(t.get(Bt).error("[Deprecated]: `RemoveAllDataValidationCommand` is deprecated, please use `RemoveSheetAllDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!e)return!1;const{unitId:r,subUnitId:a}=e,i=t.get(H),n=t.get(ee),o=t.get(Le),s=[...n.getRules(r,a)],l={unitId:r,subUnitId:a,ruleId:s.map(c=>c.uid)},u=[{id:ce.id,params:l}],d=[{id:Ie.id,params:{unitId:r,subUnitId:a,rule:s}}];return o.pushUndoRedo({redoMutations:u,undoMutations:d,unitID:r}),i.executeCommand(ce.id,l),!0}},Vo="data-validation.config",zi={};var Mo=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},ti=(t,e)=>(r,a)=>e(r,a,t);const To="UNIVER_DATA_VALIDATION_PLUGIN";var Ir;let Tr=(Ir=class extends Wr{constructor(t=zi,e,r,a){super(),this._config=t,this._injector=e,this._commandService=r,this._configService=a;const{...i}=Pr({},zi,this._config);this._configService.setConfig(Vo,i)}onStarting(){[[ee],[he],[Mr]].forEach(t=>this._injector.add(t)),[Ro,Co,yo,bo,wo,Ie,J,ce].forEach(t=>{this._commandService.registerCommand(t)})}onReady(){this._injector.get(Mr)}},_e(Ir,"pluginName",To),_e(Ir,"type",$.UNIVER_SHEET),Ir);Tr=Mo([ti(1,S(Me)),ti(2,H),ti(3,dr)],Tr);m.BETWEEN+"",m.EQUAL+"",m.GREATER_THAN+"",m.GREATER_THAN_OR_EQUAL+"",m.LESS_THAN+"",m.LESS_THAN_OR_EQUAL+"",m.NOT_BETWEEN+"",m.NOT_EQUAL+"";const Zi={[m.BETWEEN]:"dataValidation.ruleName.between",[m.EQUAL]:"dataValidation.ruleName.equal",[m.GREATER_THAN]:"dataValidation.ruleName.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.ruleName.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.ruleName.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.ruleName.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.ruleName.notBetween",[m.NOT_EQUAL]:"dataValidation.ruleName.notEqual",NONE:"dataValidation.ruleName.legal"},Ki={[m.BETWEEN]:"dataValidation.errorMsg.between",[m.EQUAL]:"dataValidation.errorMsg.equal",[m.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.errorMsg.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[m.NOT_EQUAL]:"dataValidation.errorMsg.notEqual",NONE:"dataValidation.errorMsg.legal"},Uo={[m.BETWEEN]:"dataValidation.textLength.errorMsg.between",[m.EQUAL]:"dataValidation.textLength.errorMsg.equal",[m.GREATER_THAN]:"dataValidation.textLength.errorMsg.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.textLength.errorMsg.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.textLength.errorMsg.notBetween",[m.NOT_EQUAL]:"dataValidation.textLength.errorMsg.notEqual"},Ao=[m.BETWEEN,m.NOT_BETWEEN];var No=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Ji=(t,e)=>(r,a)=>e(r,a,t);const ea="{FORMULA1}",ta="{FORMULA2}",ra="{TYPE}",Do={[m.BETWEEN]:"dataValidation.operators.between",[m.EQUAL]:"dataValidation.operators.equal",[m.GREATER_THAN]:"dataValidation.operators.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.operators.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.operators.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.operators.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.operators.notBetween",[m.NOT_EQUAL]:"dataValidation.operators.notEqual"};var xe=(t=>(t.DATE="date",t.TIME="time",t.DATETIME="datetime",t.LIST="list",t.MULTIPLE_LIST="multipleList",t.COLOR="color",t.CASCADE="cascade",t))(xe||{});let He=class{constructor(e,r){_e(this,"offsetFormulaByRange",!0),_e(this,"formulaInput"),_e(this,"canvasRender",null),_e(this,"dropdownType"),_e(this,"optionsInput"),_e(this,"skipDefaultFontRender"),this.localeService=e,this.injector=r}get operatorNames(){return this.operators.map(e=>this.localeService.t(Do[e]))}get titleStr(){return this.localeService.t(this.title)}generateRuleName(e){var r,a;if(!e.operator)return this.localeService.t(Zi.NONE).replace(ra,this.titleStr);const i=this.localeService.t(Zi[e.operator]).replace(ea,(r=e.formula1)!=null?r:"").replace(ta,(a=e.formula2)!=null?a:"");return`${this.titleStr} ${i}`}generateRuleErrorMessage(e,r){var a,i;return e.operator?`${this.localeService.t(Ki[e.operator]).replace(ea,(a=e.formula1)!=null?a:"").replace(ta,(i=e.formula2)!=null?i:"")}`:this.localeService.t(Ki.NONE).replace(ra,this.titleStr)}getExtraStyle(e,r,a,i,n){}getRuleFinalError(e,r){return e.showErrorMessage&&e.error?e.error:this.generateRuleErrorMessage(e,r)}isEmptyCellValue(e){return e===""||e===void 0||e===null}normalizeFormula(e,r,a){return{formula1:e.formula1,formula2:e.formula2}}async isValidType(e,r,a){return!0}transform(e,r,a){return e}async validatorIsEqual(e,r,a){const{formula1:i}=r,{value:n}=e;return Number.isNaN(i)?!0:n===i}async validatorIsNotEqual(e,r,a){const{formula1:i}=r;return Number.isNaN(i)?!0:e.value!==i}async validatorIsBetween(e,r,a){const{formula1:i,formula2:n}=r;if(Number.isNaN(i)||Number.isNaN(n))return!0;const o=Math.min(i,n),s=Math.max(i,n);return e.value>=o&&e.value<=s}async validatorIsNotBetween(e,r,a){const{formula1:i,formula2:n}=r;if(Number.isNaN(i)||Number.isNaN(n))return!0;const o=Math.min(i,n),s=Math.max(i,n);return e.value<o||e.value>s}async validatorIsGreaterThan(e,r,a){const{formula1:i}=r;return Number.isNaN(i)?!0:e.value>i}async validatorIsGreaterThanOrEqual(e,r,a){const{formula1:i}=r;return Number.isNaN(i)?!0:e.value>=i}async validatorIsLessThan(e,r,a){const{formula1:i}=r;return Number.isNaN(i)?!0:e.value<i}async validatorIsLessThanOrEqual(e,r,a){const{formula1:i}=r;return Number.isNaN(i)?!0:e.value<=i}async validator(e,r){const{value:a,unitId:i,subUnitId:n}=e,o=this.isEmptyCellValue(a),{allowBlank:s=!0,operator:l}=r;if(o)return s;const u=await this.parseFormula(r,i,n,e.row,e.column);if(!u.isFormulaValid||!await this.isValidType(e,u,r))return!1;if(!l)return!0;const d=this.transform(e,u,r);switch(l){case m.BETWEEN:return this.validatorIsBetween(d,u,r);case m.EQUAL:return this.validatorIsEqual(d,u,r);case m.GREATER_THAN:return this.validatorIsGreaterThan(d,u,r);case m.GREATER_THAN_OR_EQUAL:return this.validatorIsGreaterThanOrEqual(d,u,r);case m.LESS_THAN:return this.validatorIsLessThan(d,u,r);case m.LESS_THAN_OR_EQUAL:return this.validatorIsLessThanOrEqual(d,u,r);case m.NOT_BETWEEN:return this.validatorIsNotBetween(d,u,r);case m.NOT_EQUAL:return this.validatorIsNotEqual(d,u,r);default:throw new Error("Unknown operator.")}}};He=No([Ji(0,S(Ne)),Ji(1,S(Me))],He);var xo=Object.defineProperty,ko=(t,e,r)=>e in t?xo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,E=(t,e,r)=>ko(t,typeof e!="symbol"?e+"":e,r),Oo=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},ri=(t,e)=>(r,a)=>e(r,a,t);let We=class extends ae{constructor(t,e,r){super(),E(this,"_cacheMatrix",new Map),E(this,"_dirtyRanges$",new Zt),E(this,"dirtyRanges$",this._dirtyRanges$.asObservable()),this._commandService=t,this._univerInstanceService=e,this._sheetDataValidationModel=r,this._initDirtyRanges(),this._initSheetRemove()}_initDirtyRanges(){this.disposeWithMe(this._commandService.onCommandExecuted((t,e)=>{if(t.id===Kt.id&&!(e!=null&&e.onlyLocal)){const{cellValue:r,unitId:a,subUnitId:i}=t.params;if(r){const n=new Ze(r).getDataRange();if(n.endRow===-1)return;const o=this._sheetDataValidationModel.getRules(a,i).map(s=>s.ranges).flat().map(s=>ma(s,n)).filter(Boolean);o.length&&this.markRangeDirty(a,i,o,!0)}}}))}_initSheetRemove(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{var e;if(t.id===Ma.id){const{unitId:r,subUnitId:a}=t.params;(e=this._cacheMatrix.get(r))==null||e.delete(a)}})),this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(t=>{t.type===$.UNIVER_SHEET&&this._cacheMatrix.delete(t.getUnitId())}))}_ensureCache(t,e){let r=this._cacheMatrix.get(t);r||(r=new Map,this._cacheMatrix.set(t,r));let a=r.get(e);return a||(a=new Ze,r.set(e,a)),a}ensureCache(t,e){return this._ensureCache(t,e)}addRule(t,e,r){this.markRangeDirty(t,e,r.ranges)}removeRule(t,e,r){this._deleteRange(t,e,r.ranges)}markRangeDirty(t,e,r,a){const i=this._ensureCache(t,e);r.forEach(n=>{je.foreach(n,(o,s)=>{i.getValue(o,s)!==void 0&&i.setValue(o,s,void 0)})}),this._dirtyRanges$.next({unitId:t,subUnitId:e,ranges:r,isSetRange:a})}_deleteRange(t,e,r){const a=this._ensureCache(t,e);r.forEach(i=>{je.foreach(i,(n,o)=>{a.realDeleteValue(n,o)})}),this._dirtyRanges$.next({unitId:t,subUnitId:e,ranges:r})}getValue(t,e,r,a){return this._ensureCache(t,e).getValue(r,a)}};We=Oo([ri(0,S(H)),ri(1,S(q)),ri(2,S(ee))],We);function ze(t){var e,r;return(r=(e=t?.[0])==null?void 0:e[0])==null?void 0:r.v}function Sr(t){var e;return(e=t?.[0])==null?void 0:e[0]}function oe(t){return!An.has(t)}function gr(t,e){var r;const a=e.getValidatorItem(t);return(r=a?.offsetFormulaByRange)!=null?r:!1}var Lo=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Gt=(t,e)=>(r,a)=>e(r,a,t);let Xe=class extends ae{constructor(t,e,r,a,i){super(),E(this,"_ruleFormulaMap",new Map),E(this,"_ruleFormulaMap2",new Map),this._instanceSrv=t,this._registerOtherFormulaService=e,this._dataValidationModel=r,this._dataValidationCacheService=a,this._validatorRegistryService=i,this._initFormulaResultHandler(),this._initDirtyRanges()}dispose(){super.dispose(),this._ruleFormulaMap.clear(),this._ruleFormulaMap2.clear()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(t=>{for(const e in t){const r=t[e];if(this._instanceSrv.getUnitType(e)===$.UNIVER_SHEET)for(const a in r){const i=r[a],{ruleFormulaMap:n}=this._ensureMaps(e,a);i.forEach(o=>{var s,l;const u=n.get((s=o.extra)==null?void 0:s.ruleId),d=this._dataValidationModel.getRuleById(e,a,(l=o.extra)==null?void 0:l.ruleId);d&&u&&this._dataValidationCacheService.markRangeDirty(e,a,d.ranges)})}}}))}_ensureMaps(t,e){let r=this._ruleFormulaMap.get(t),a=this._ruleFormulaMap2.get(t);r||(r=new Map,this._ruleFormulaMap.set(t,r)),a||(a=new Map,this._ruleFormulaMap2.set(t,a));let i=r.get(e);i||(i=new Map,r.set(e,i));let n=a.get(e);return n||(n=new Map,a.set(e,n)),{ruleFormulaMap:i,ruleFormulaMap2:n}}_registerFormula(t,e,r,a,i){return this._registerOtherFormulaService.registerFormulaWithRange(t,e,a,i,{ruleId:r},wa.DATA_VALIDATION_CUSTOM,r)}_handleDirtyRanges(t,e,r){this._dataValidationModel.getRules(t,e).forEach(a=>{const i=a.ranges;fe.doAnyRangesIntersect(i,r)&&this.makeRuleDirty(t,e,a.uid)})}_initDirtyRanges(){this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.subscribe(t=>{t.isSetRange&&this._handleDirtyRanges(t.unitId,t.subUnitId,t.ranges)}))}deleteByRuleId(t,e,r){const{ruleFormulaMap:a,ruleFormulaMap2:i}=this._ensureMaps(t,e),n=this._dataValidationModel.getRuleById(t,e,r),o=a.get(r);if(!n||!o)return;const s=a.get(r);s&&(a.delete(r),this._registerOtherFormulaService.deleteFormula(t,e,[s.formulaId]));const l=i.get(r);l&&(i.delete(r),this._registerOtherFormulaService.deleteFormula(t,e,[l.formulaId]))}_addFormulaByRange(t,e,r,a,i,n){const{ruleFormulaMap:o,ruleFormulaMap2:s}=this._ensureMaps(t,e),l=n[0].startRow,u=n[0].startColumn;if(a&&F(a)){const d=this._registerFormula(t,e,r,a,n);o.set(r,{formula:a,originCol:u,originRow:l,formulaId:d})}if(i&&F(i)){const d=this._registerFormula(t,e,r,i,n);s.set(r,{formula:i,originCol:u,originRow:l,formulaId:d})}}addRule(t,e,r){if(gr(r.type,this._validatorRegistryService)){const{ranges:a,formula1:i,formula2:n,uid:o}=r;this._addFormulaByRange(t,e,o,i,n,a)}}async getCellFormulaValue(t,e,r,a,i){var n,o;const{ruleFormulaMap:s}=this._ensureMaps(t,e),l=s.get(r);if(!l)return Promise.resolve(void 0);const u=await this._registerOtherFormulaService.getFormulaValue(t,e,l.formulaId),{originRow:d,originCol:c}=l,h=a-d,g=i-c;return Sr((o=(n=u?.result)==null?void 0:n[h])==null?void 0:o[g])}async getCellFormula2Value(t,e,r,a,i){var n,o;const{ruleFormulaMap2:s}=this._ensureMaps(t,e),l=s.get(r);if(!l)return Promise.resolve(void 0);const u=await this._registerOtherFormulaService.getFormulaValue(t,e,l.formulaId),{originRow:d,originCol:c}=l,h=a-d,g=i-c;return Sr((o=(n=u?.result)==null?void 0:n[h])==null?void 0:o[g])}getCellFormulaValueSync(t,e,r,a,i){var n,o;const{ruleFormulaMap:s}=this._ensureMaps(t,e),l=s.get(r);if(!l)return;const u=this._registerOtherFormulaService.getFormulaValueSync(t,e,l.formulaId),{originRow:d,originCol:c}=l,h=a-d,g=i-c;return Sr((o=(n=u?.result)==null?void 0:n[h])==null?void 0:o[g])}getCellFormula2ValueSync(t,e,r,a,i){var n,o;const{ruleFormulaMap2:s}=this._ensureMaps(t,e),l=s.get(r);if(!l)return;const u=this._registerOtherFormulaService.getFormulaValueSync(t,e,l.formulaId),{originRow:d,originCol:c}=l,h=a-d,g=i-c;return Sr((o=(n=u?.result)==null?void 0:n[h])==null?void 0:o[g])}getRuleFormulaInfo(t,e,r){const{ruleFormulaMap:a}=this._ensureMaps(t,e);return a.get(r)}makeRuleDirty(t,e,r){var a,i,n,o;const s=(i=(a=this._ruleFormulaMap.get(t))==null?void 0:a.get(e))==null?void 0:i.get(r),l=(o=(n=this._ruleFormulaMap2.get(t))==null?void 0:n.get(e))==null?void 0:o.get(r);s&&this._registerOtherFormulaService.markFormulaDirty(t,e,s.formulaId),l&&this._registerOtherFormulaService.markFormulaDirty(t,e,l.formulaId)}};Xe=Lo([Gt(0,q),Gt(1,S(Ca)),Gt(2,S(ee)),Gt(3,S(We)),Gt(4,S(he))],Xe);function se(t){return _n(t)}function Ga(t){var e;return String((e=se(t))!=null?e:"")}function Ya(t){return t.filter(Boolean).join(",")}function zt(t){return t.split(",").filter(Boolean)}function ii(t){const e=se(t);return e==null?"":e.toString()}function Xr(t,e,r){const{formula1:a,formula2:i}=e,n=e.ranges[0].startRow,o=e.ranges[0].startColumn,s=r.row-n,l=r.col-o,u=F(a)?t.moveFormulaRefOffset(a,l,s,!0):a,d=F(i)?t.moveFormulaRefOffset(i,l,s,!0):i;return{transformedFormula1:u,transformedFormula2:d}}var Fo=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},ia=(t,e)=>(r,a)=>e(r,a,t);let tr=class extends ae{constructor(t,e){super(),E(this,"_cache",new Map),this._injector=t,this._dataValidationModel=e,this._initRuleChangeListener()}_initRuleChangeListener(){this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(t=>{(t.type==="remove"||t.type==="update")&&this.markRuleDirty(t.unitId,t.subUnitId,t.rule.uid)}))}getOrCompute(t,e,r){const a=this.getCache(t,e,r.uid);if(a)return a;const i=this._injector.get(qe).getRuleFormulaResultSync(t,e,r.uid);return this.computeAndCache(t,e,r,i)}_ensureCache(t,e){let r=this._cache.get(t);r||(r=new Map,this._cache.set(t,r));let a=r.get(e);return a||(a=new Map,r.set(e,a)),a}getCache(t,e,r){var a,i;return(i=(a=this._cache.get(t))==null?void 0:a.get(e))==null?void 0:i.get(r)}setCache(t,e,r,a){this._ensureCache(t,e).set(r,a)}markRuleDirty(t,e,r){var a,i;(i=(a=this._cache.get(t))==null?void 0:a.get(e))==null||i.delete(r)}clear(){this._cache.clear()}computeAndCache(t,e,r,a){var i,n,o;const{formula1:s="",formula2:l=""}=r,u=F(s)?this._getRuleFormulaResultSet((o=(n=(i=a?.[0])==null?void 0:i.result)==null?void 0:n[0])==null?void 0:o[0]):zt(s),d=l.split(","),c=u.map((f,R)=>({label:f,color:d[R]||""})),h={};for(const f of c)f.color&&(h[f.label]=f.color);const g=new Set(u),v={list:u,listWithColor:c,colorMap:h,set:g};return this.setCache(t,e,r.uid,v),v}_getRuleFormulaResultSet(t){var e,r;if(!t)return[];const a=new Set;for(let i=0,n=t.length;i<n;i++){const o=t[i];if(o)for(let s=0,l=o.length;s<l;s++){const u=o[s],d=se(u);if(d!=null){if(typeof d!="string"&&typeof u?.s=="object"&&(r=(e=u.s)==null?void 0:e.n)!=null&&r.pattern){a.add(ke.format(u.s.n.pattern,d,{throws:!1}));continue}const c=typeof d=="string"?d:String(d);oe(c)&&a.add(c)}}}return[...a]}};tr=Fo([ia(0,S(Me)),ia(1,S(ee))],tr);var Bo=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},_t=(t,e)=>(r,a)=>e(r,a,t);let qe=class extends ae{constructor(t,e,r,a,i,n){super(),E(this,"_formulaRuleMap",new Map),this._instanceService=t,this._registerOtherFormulaService=e,this._dataValidationCacheService=r,this._dataValidationModel=a,this._validatorRegistryService=i,this._listCacheService=n,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(t=>{for(const e in t){const r=t[e];if(this._instanceService.getUnitType(e)===$.UNIVER_SHEET)for(const a in r){const i=r[a],n=this._ensureRuleFormulaMap(e,a);i.forEach(o=>{var s;const l=(s=o.extra)==null?void 0:s.ruleId;if(l&&n.get(l)){const u=this._dataValidationModel.getRuleById(e,a,l);u&&(this._listCacheService.markRuleDirty(e,a,l),this._dataValidationCacheService.markRangeDirty(e,a,u.ranges))}})}}}))}_ensureRuleFormulaMap(t,e){let r=this._formulaRuleMap.get(t);r||(r=new Map,this._formulaRuleMap.set(t,r));let a=r.get(e);return a||(a=new Map,r.set(e,a)),a}_registerSingleFormula(t,e,r,a){const i=[{startColumn:0,endColumn:0,startRow:0,endRow:0}];return this._registerOtherFormulaService.registerFormulaWithRange(t,e,r,i,{ruleId:a},wa.DATA_VALIDATION,a)}addRule(t,e,r){if(!gr(r.type,this._validatorRegistryService)&&r.type!==C.CHECKBOX){const{formula1:a,formula2:i,uid:n}=r,o=F(a),s=F(i);if(!o&&!s)return;const l=this._ensureRuleFormulaMap(t,e),u=[void 0,void 0];if(o){const d=this._registerSingleFormula(t,e,a,n);u[0]={id:d,text:a}}if(s){const d=this._registerSingleFormula(t,e,i,n);u[1]={id:d,text:i}}l.set(n,u)}}removeRule(t,e,r){const a=this._ensureRuleFormulaMap(t,e).get(r);if(!a)return;const[i,n]=a,o=[i?.id,n?.id].filter(Boolean);o.length&&this._registerOtherFormulaService.deleteFormula(t,e,o)}getRuleFormulaResult(t,e,r){const a=this._ensureRuleFormulaMap(t,e).get(r);if(!a)return Promise.resolve(null);const i=async n=>n&&this._registerOtherFormulaService.getFormulaValue(t,e,n.id);return Promise.all([i(a[0]),i(a[1])])}getRuleFormulaResultSync(t,e,r){const a=this._ensureRuleFormulaMap(t,e).get(r);if(a)return a.map(i=>{if(i)return this._registerOtherFormulaService.getFormulaValueSync(t,e,i.id)})}getRuleFormulaInfo(t,e,r){return this._ensureRuleFormulaMap(t,e).get(r)}};qe=Bo([_t(0,q),_t(1,S(Ca)),_t(2,S(We)),_t(3,S(ee)),_t(4,S(he)),_t(5,S(tr))],qe);let $o=class Qa{constructor(e,r,a,i,n=!1){E(this,"_map"),E(this,"_tree",new In),E(this,"_dirty",!0),E(this,"_buildTree",()=>{if(!this._dirty||this._disableTree)return;this._tree.clear();const o=[];this._map.forEach((s,l)=>{s.forEach(u=>{o.push({minX:u.startRow,maxX:u.endRow,minY:u.startColumn,maxY:u.endColumn,ruleId:l})})}),this._tree.load(o),this._dirty=!1}),E(this,"_debonceBuildTree",va(this._buildTree,0)),this._unitId=r,this._subUnitId=a,this._univerInstanceService=i,this._disableTree=n,this._map=e,this._buildTree()}get _worksheet(){var e;return(e=this._univerInstanceService.getUnit(this._unitId,$.UNIVER_SHEET))==null?void 0:e.getSheetBySheetId(this._subUnitId)}_addRule(e,r){if(!this._worksheet)return;const a=fe.mergeRanges(r.map(i=>je.transformRange(i,this._worksheet)));this._map.forEach((i,n)=>{const o=fe.subtractMulti(i,a);o.length===0?this._map.delete(n):this._map.set(n,o)}),this._dirty=!0,this._map.set(e,a),this._debonceBuildTree()}addRule(e){this._addRule(e.uid,e.ranges)}removeRange(e){if(!this._worksheet)return;const r=e.map(a=>je.transformRange(a,this._worksheet));this._map.forEach((a,i)=>{const n=fe.subtractMulti(a,r);n.length===0?this._map.delete(i):this._map.set(i,n)}),this._dirty=!0,this._debonceBuildTree()}_removeRule(e){this._map.delete(e),this._dirty=!0,this._debonceBuildTree()}removeRule(e){this._removeRule(e.uid)}updateRange(e,r){this._removeRule(e),this._addRule(e,r)}addRangeRules(e){e.forEach(({id:r,ranges:a})=>{if(!a.length)return;let i=this._map.get(r);i?(this._map.set(r,fe.mergeRanges([...i,...a])),i=this._map.get(r)):(i=a,this._map.set(r,i)),this._map.forEach((n,o)=>{if(o===r)return;const s=fe.subtractMulti(n,a);s.length===0?this._map.delete(o):this._map.set(o,s)})}),this._dirty=!0,this._debonceBuildTree()}diff(e){const r=[];let a=0;return e.forEach((i,n)=>{var o;const s=(o=this._map.get(i.uid))!=null?o:[],l=i.ranges;s.length!==0&&(s.length!==l.length||s.some((u,d)=>!fe.equals(u,l[d])))&&r.push({type:"update",ruleId:i.uid,oldRanges:l,newRanges:fe.sort(s),rule:i}),s.length===0&&(r.push({type:"delete",rule:i,index:n-a}),a++)}),r}diffWithAddition(e,r){const a=[];let i=0;return e.forEach((n,o)=>{var s;const l=(s=this._map.get(n.uid))!=null?s:[],u=n.ranges;l.length!==0&&(l.length!==u.length||l.some((d,c)=>!fe.equals(d,u[c])))&&a.push({type:"update",ruleId:n.uid,oldRanges:u,newRanges:fe.sort(l),rule:n}),l.length===0&&(a.push({type:"delete",rule:n,index:o-i}),i++)}),Array.from(r).forEach(n=>{var o;const s=(o=this._map.get(n.uid))!=null?o:[];a.push({type:"add",rule:{...n,ranges:fe.sort(s)}})}),a}clone(){return new Qa(new Map(Z.deepClone(Array.from(this._map.entries()))),this._unitId,this._subUnitId,this._univerInstanceService,!0)}getValue(e,r){this._dirty&&this._buildTree();const a=this._tree.search({minX:e,maxX:e,minY:r,maxY:r});return a.length>0?a[0].ruleId:void 0}};var jo=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},tt=(t,e)=>(r,a)=>e(r,a,t);let j=class extends ae{constructor(t,e,r,a,i,n,o){super(),E(this,"_ruleMatrixMap",new Map),E(this,"_validStatusChange$",new Zt),E(this,"_ruleChange$",new Zt),E(this,"ruleChange$",this._ruleChange$.asObservable()),E(this,"validStatusChange$",this._validStatusChange$.asObservable()),this._dataValidationModel=t,this._univerInstanceService=e,this._dataValidatorRegistryService=r,this._dataValidationCacheService=a,this._dataValidationFormulaService=i,this._dataValidationCustomFormulaService=n,this._commandService=o,this._initRuleUpdateListener(),this.disposeWithMe(()=>{this._ruleChange$.complete(),this._validStatusChange$.complete()}),this._initUniverInstanceListener()}_initUniverInstanceListener(){this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(t=>{this._ruleMatrixMap.delete(t.getUnitId())})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===Ma.id){const{unitId:e,subUnitId:r}=t.params,a=this._ruleMatrixMap.get(e);a&&a.delete(r)}}))}_initRuleUpdateListener(){const t=this._dataValidationModel.getAll();for(const[e,r]of t)for(const[a,i]of r)for(const n of i)this._addRule(e,a,n),this._ruleChange$.next({type:"add",unitId:e,subUnitId:a,rule:n,source:"patched"});this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":this._addRule(e.unitId,e.subUnitId,e.rule);break;case"update":this._updateRule(e.unitId,e.subUnitId,e.rule.uid,e.oldRule,e.updatePayload);break;case"remove":this._removeRule(e.unitId,e.subUnitId,e.rule);break}this._ruleChange$.next(e)}))}_ensureRuleMatrix(t,e){let r=this._ruleMatrixMap.get(t);r||(r=new Map,this._ruleMatrixMap.set(t,r));let a=r.get(e);return a||(a=new $o(new Map,t,e,this._univerInstanceService),r.set(e,a)),a}_addRuleSideEffect(t,e,r){this._ensureRuleMatrix(t,e).addRule(r),this._dataValidationCacheService.addRule(t,e,r),this._dataValidationFormulaService.addRule(t,e,r),this._dataValidationCustomFormulaService.addRule(t,e,r)}_addRule(t,e,r){(Array.isArray(r)?r:[r]).forEach(a=>{this._addRuleSideEffect(t,e,a)})}_updateRule(t,e,r,a,i){const n=this._ensureRuleMatrix(t,e),o={...a,...i.payload};i.type===Q.RANGE?n.updateRange(r,i.payload):i.type===Q.ALL&&n.updateRange(r,i.payload.ranges),this._dataValidationCacheService.removeRule(t,e,a),this._dataValidationCacheService.addRule(t,e,o),this._dataValidationFormulaService.removeRule(t,e,a.uid),this._dataValidationFormulaService.addRule(t,e,o),this._dataValidationCustomFormulaService.deleteByRuleId(t,e,r),this._dataValidationCustomFormulaService.addRule(t,e,o)}_removeRule(t,e,r){this._ensureRuleMatrix(t,e).removeRule(r),this._dataValidationCacheService.removeRule(t,e,r),this._dataValidationCustomFormulaService.deleteByRuleId(t,e,r.uid)}getValidator(t){return this._dataValidatorRegistryService.getValidatorItem(t)}getRuleIdByLocation(t,e,r,a){return this._ensureRuleMatrix(t,e).getValue(r,a)}getRuleByLocation(t,e,r,a){const i=this.getRuleIdByLocation(t,e,r,a);if(i)return this._dataValidationModel.getRuleById(t,e,i)}validator(t,e,r){const{col:a,row:i,unitId:n,subUnitId:o,worksheet:s}=e,l=(g,v)=>{r&&r(g,v),v&&this._validStatusChange$.next({unitId:n,subUnitId:o,ruleId:t.uid,status:g,row:i,col:a})},u=s.getCellValueOnly(i,a),d=this.getValidator(t.type),c=s.getCellRaw(i,a),h=se(c);if(d){const g=this._dataValidationCacheService.ensureCache(n,o),v=g.getValue(i,a);return v==null?(g.setValue(i,a,re.VALIDATING),d.validator({value:h,unitId:n,subUnitId:o,row:i,column:a,worksheet:e.worksheet,workbook:e.workbook,interceptValue:se(u),t:c?.t},t).then(f=>{const R=f?re.VALID:re.INVALID,p=g.getValue(i,a);R===re.VALID?g.realDeleteValue(i,a):g.setValue(i,a,R),l(R,v!==p)}),re.VALIDATING):(l(v??re.VALID,!1),v??re.VALID)}else return l(re.VALID,!1),re.VALID}getRuleObjectMatrix(t,e){return this._ensureRuleMatrix(t,e)}getRuleById(t,e,r){return this._dataValidationModel.getRuleById(t,e,r)}getRuleIndex(t,e,r){return this._dataValidationModel.getRuleIndex(t,e,r)}getRules(t,e){return[...this._dataValidationModel.getRules(t,e)]}getUnitRules(t){return this._dataValidationModel.getUnitRules(t)}deleteUnitRules(t){return this._dataValidationModel.deleteUnitRules(t)}getSubUnitIds(t){return this._dataValidationModel.getSubUnitIds(t)}getAll(){return this._dataValidationModel.getAll()}};j=jo([tt(0,S(ee)),tt(1,q),tt(2,S(he)),tt(3,S(We)),tt(4,S(qe)),tt(5,S(Xe)),tt(6,H)],j);const rr=1,ir=0;function aa(t,e){return Z.isBlank(t)?e.t("dataValidation.validFail.value"):F(t)?e.t("dataValidation.validFail.primitive"):""}const Xt=t=>Z.isDefine(t)&&String(t).toLowerCase()==="true"?"1":String(t).toLowerCase()==="false"?"0":t;class Ho extends He{constructor(){super(...arguments),E(this,"id",C.CHECKBOX),E(this,"title","dataValidation.checkbox.title"),E(this,"operators",[]),E(this,"scopes",["sheet"]),E(this,"order",41),E(this,"offsetFormulaByRange",!1),E(this,"_formulaService",this.injector.get(qe)),E(this,"skipDefaultFontRender",(e,r,a)=>{const{unitId:i,subUnitId:n}=a,{formula1:o,formula2:s}=this.parseFormulaSync(e,i,n),l=`${r??""}`;return!l||l===`${o}`||l===`${s}`})}validatorFormula(e,r,a){const{formula1:i,formula2:n}=e,o=i===n;if(Z.isBlank(i)&&Z.isBlank(n))return{success:!0};if(o)return{success:!1,formula1:this.localeService.t("dataValidation.validFail.checkboxEqual"),formula2:this.localeService.t("dataValidation.validFail.checkboxEqual")};const s=aa(i,this.localeService),l=aa(n,this.localeService);return{success:!s&&!l,formula1:s,formula2:l}}async parseFormula(e,r,a){var i,n,o,s;const{formula1:l=rr,formula2:u=ir}=e,d=await this._formulaService.getRuleFormulaResult(r,a,e.uid),c=F(l)?ze((n=(i=d?.[0])==null?void 0:i.result)==null?void 0:n[0][0]):l,h=F(u)?ze((s=(o=d?.[1])==null?void 0:o.result)==null?void 0:s[0][0]):u,g=oe(String(c))&&oe(String(h));return{formula1:Xt(c),formula2:Xt(h),originFormula1:c,originFormula2:h,isFormulaValid:g}}getExtraStyle(e,r){return{tb:Ve.CLIP}}parseFormulaSync(e,r,a){var i,n,o,s;const{formula1:l=rr,formula2:u=ir}=e,d=this._formulaService.getRuleFormulaResultSync(r,a,e.uid),c=F(l)?ze((n=(i=d?.[0])==null?void 0:i.result)==null?void 0:n[0][0]):l,h=F(u)?ze((s=(o=d?.[1])==null?void 0:o.result)==null?void 0:s[0][0]):u,g=oe(String(c))&&oe(String(h));return{formula1:Xt(c),formula2:Xt(h),originFormula1:c,originFormula2:h,isFormulaValid:g}}async isValidType(e,r,a){const{value:i,unitId:n,subUnitId:o}=e,{formula1:s,formula2:l,originFormula1:u,originFormula2:d}=await this.parseFormula(a,n,o);return!Z.isDefine(s)||!Z.isDefine(l)?!0:Z.isDefine(i)&&(String(i)===String(s)||String(i)===String(l)||String(i)===String(u??"")||String(i)===String(d??""))}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.checkbox.error")}generateRuleName(e){return this.titleStr}}const Wo={[m.BETWEEN]:"dataValidation.date.operators.between",[m.EQUAL]:"dataValidation.date.operators.equal",[m.GREATER_THAN]:"dataValidation.date.operators.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.date.operators.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.date.operators.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.date.operators.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.date.operators.notBetween",[m.NOT_EQUAL]:"dataValidation.date.operators.notEqual"};m.BETWEEN+"",m.EQUAL+"",m.GREATER_THAN+"",m.GREATER_THAN_OR_EQUAL+"",m.LESS_THAN+"",m.LESS_THAN_OR_EQUAL+"",m.NOT_BETWEEN+"",m.NOT_EQUAL+"";const na={[m.BETWEEN]:"dataValidation.date.ruleName.between",[m.EQUAL]:"dataValidation.date.ruleName.equal",[m.GREATER_THAN]:"dataValidation.date.ruleName.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.date.ruleName.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.date.ruleName.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.date.ruleName.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.date.ruleName.notBetween",[m.NOT_EQUAL]:"dataValidation.date.ruleName.notEqual",NONE:"dataValidation.date.ruleName.legal"},Po={[m.BETWEEN]:"dataValidation.date.errorMsg.between",[m.EQUAL]:"dataValidation.date.errorMsg.equal",[m.GREATER_THAN]:"dataValidation.date.errorMsg.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.date.errorMsg.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.date.errorMsg.notBetween",[m.NOT_EQUAL]:"dataValidation.date.errorMsg.notEqual",NONE:"dataValidation.date.errorMsg.legal"},qr=[m.BETWEEN,m.NOT_BETWEEN],ar="{FORMULA1}",nr="{FORMULA2}",ai=t=>{var e,r;if(t==null||typeof t=="boolean")return;if(typeof t=="number"||!Number.isNaN(+t))return+t;const a=(e=ke.parseDate(t))==null?void 0:e.v;return Z.isDefine(a)?a:(r=ke.parseDate(qt(t).format("YYYY-MM-DD HH:mm:ss")))==null?void 0:r.v};class Go extends He{constructor(){super(...arguments),E(this,"id",C.DATE),E(this,"title","dataValidation.date.title"),E(this,"order",40),E(this,"operators",[m.BETWEEN,m.EQUAL,m.GREATER_THAN,m.GREATER_THAN_OR_EQUAL,m.LESS_THAN,m.LESS_THAN_OR_EQUAL,m.NOT_BETWEEN,m.NOT_EQUAL]),E(this,"scopes",["sheet"]),E(this,"_customFormulaService",this.injector.get(Xe)),E(this,"_lexerTreeBuilder",this.injector.get(Je))}async parseFormula(e,r,a,i,n){const o=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,n),s=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,n),{formula1:l,formula2:u}=e,d=oe(String(o?.v))&&oe(String(s?.v));return{formula1:ai(F(l)?o?.v:l),formula2:ai(F(u)?s?.v:u),isFormulaValid:d}}async isValidType(e){const{interceptValue:r,value:a}=e;return typeof a=="number"&&typeof r=="string"?!!ke.parseDate(r):typeof r=="string"?!!ke.parseDate(r):!1}_validatorSingleFormula(e){return!Z.isBlank(e)&&(F(e)||!Number.isNaN(+e)||!!(e&&ke.parseDate(e)))}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!0};const n=this._validatorSingleFormula(e.formula1),o=this.localeService.t("dataValidation.validFail.date");if(qr.includes(i)){const s=this._validatorSingleFormula(e.formula2);return{success:n&&s,formula1:n?void 0:o,formula2:s?void 0:o}}return{success:n,formula1:n?void 0:o}}normalizeFormula(e,r,a){const{formula1:i,formula2:n,bizInfo:o}=e,s=l=>{var u;if(!l)return l;let d;if(!Number.isNaN(+l))d=ke.dateFromSerial(+l);else{const c=(u=ke.parseDate(l))==null?void 0:u.v;if(c==null)return"";d=ke.dateFromSerial(c)}return qt(`${d[0]}/${d[1]}/${d[2]} ${d[3]}:${d[4]}:${d[5]}`).format(o!=null&&o.showTime?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD")};return{formula1:F(i)?i:s(`${i}`),formula2:F(n)?n:s(`${n}`)}}transform(e,r,a){const{value:i}=e;return{...e,value:ai(i)}}get operatorNames(){return this.operators.map(e=>this.localeService.t(Wo[e]))}generateRuleName(e){var r,a;if(!e.operator)return this.localeService.t(na.NONE);const i=this.localeService.t(na[e.operator]).replace(ar,(r=e.formula1)!=null?r:"").replace(nr,(a=e.formula2)!=null?a:"");return`${this.titleStr} ${i}`}generateRuleErrorMessage(e,r){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Xr(this._lexerTreeBuilder,e,r);return`${this.localeService.t(Po[e.operator]).replace(ar,a??"").replace(nr,i??"")}`}}m.BETWEEN+"",m.EQUAL+"",m.GREATER_THAN+"",m.GREATER_THAN_OR_EQUAL+"",m.LESS_THAN+"",m.LESS_THAN_OR_EQUAL+"",m.NOT_BETWEEN+"",m.NOT_EQUAL+"";m.BETWEEN+"",m.EQUAL+"",m.GREATER_THAN+"",m.GREATER_THAN_OR_EQUAL+"",m.LESS_THAN+"",m.LESS_THAN_OR_EQUAL+"",m.NOT_BETWEEN+"",m.NOT_EQUAL+"";const Ur={[m.BETWEEN]:"dataValidation.errorMsg.between",[m.EQUAL]:"dataValidation.errorMsg.equal",[m.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[m.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[m.LESS_THAN]:"dataValidation.errorMsg.lessThan",[m.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[m.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[m.NOT_EQUAL]:"dataValidation.errorMsg.notEqual",NONE:"dataValidation.errorMsg.legal"};function Ar(t){return+t}class Yo extends He{constructor(){super(...arguments),E(this,"_customFormulaService",this.injector.get(Xe)),E(this,"id",C.DECIMAL),E(this,"_lexerTreeBuilder",this.injector.get(Je)),E(this,"title","dataValidation.decimal.title"),E(this,"order",20),E(this,"operators",[m.BETWEEN,m.EQUAL,m.GREATER_THAN,m.GREATER_THAN_OR_EQUAL,m.LESS_THAN,m.LESS_THAN_OR_EQUAL,m.NOT_BETWEEN,m.NOT_EQUAL]),E(this,"scopes",["sheet"])}_isFormulaOrNumber(e){return!Z.isBlank(e)&&(F(e)||!Number.isNaN(+e))}async isValidType(e,r,a){const{value:i}=e;return!Number.isNaN(Ar(i))}transform(e,r,a){const{value:i}=e;return{...e,value:Ar(i)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,r,a,i,n){const o=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,n),s=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,n),{formula1:l,formula2:u}=e,d=oe(String(o?.v))&&oe(String(s?.v));return{formula1:this._parseNumber(F(l)?o?.v:l),formula2:this._parseNumber(F(u)?s?.v:u),isFormulaValid:d}}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!0};const n=Z.isDefine(e.formula1)&&this._isFormulaOrNumber(e.formula1),o=Z.isDefine(e.formula2)&&this._isFormulaOrNumber(e.formula2),s=qr.includes(i),l=this.localeService.t("dataValidation.validFail.number");return s?{success:n&&o,formula1:n?void 0:l,formula2:o?void 0:l}:{success:n,formula1:n?"":l}}generateRuleErrorMessage(e,r){if(!e.operator)return this.localeService.t(Ur.NONE).replace("{TYPE}",this.titleStr);const{transformedFormula1:a,transformedFormula2:i}=Xr(this._lexerTreeBuilder,e,r);return`${this.localeService.t(Ur[e.operator]).replace(ar,a??"").replace(nr,i??"")}`}}function Qo(t){var e,r;if(!t)return[];const a=new Set;for(let i=0,n=t.length;i<n;i++){const o=t[i];if(o)for(let s=0,l=o.length;s<l;s++){const u=o[s],d=se(u);if(d!=null){if(typeof d!="string"&&typeof u?.s=="object"&&(r=(e=u.s)==null?void 0:e.n)!=null&&r.pattern){a.add(ke.format(u.s.n.pattern,d,{throws:!1}));continue}const c=typeof d=="string"?d:String(d);oe(c)&&a.add(c)}}}return[...a]}const Xo=["if","indirect","choose","offset"];function qo(t,e){if(!F(t)||ya(t.slice(1)))return!0;const r=e.sequenceNodesBuilder(t);return r&&r.some(a=>typeof a=="object"&&a.nodeType===Nn.FUNCTION&&Xo.indexOf(a.token.toLowerCase())>-1)}function zo(t,e){const{formula1:r="",ranges:a}=t;if(ya(r.slice(1))){const i=ba(r.slice(1));if((!i.sheetName||i.sheetName===e)&&a.some(n=>fe.intersects(n,i.range)))return!0}return!1}class Xa extends He{constructor(){super(...arguments),E(this,"formulaService",this.injector.get(qe)),E(this,"_lexer",this.injector.get(Je)),E(this,"_univerInstanceService",this.injector.get(q)),E(this,"_listCacheService",this.injector.get(tr)),E(this,"order",50),E(this,"offsetFormulaByRange",!1),E(this,"id",C.LIST),E(this,"title","dataValidation.list.title"),E(this,"operators",[]),E(this,"scopes",["sheet"]),E(this,"skipDefaultFontRender",e=>e.renderMode!==Re.TEXT)}validatorFormula(e,r,a){var i,n,o;const s=!Z.isBlank(e.formula1),l=qo((i=e.formula1)!=null?i:"",this._lexer),u=(o=(n=this._univerInstanceService.getUnit(r,$.UNIVER_SHEET))==null?void 0:n.getSheetBySheetId(a))==null?void 0:o.getName(),d=zo(e,u??"");return{success:!!(s&&l&&!d),formula1:s?l?d?this.localeService.t("dataValidation.validFail.listIntersects"):void 0:this.localeService.t("dataValidation.validFail.listInvalid"):this.localeService.t("dataValidation.validFail.list")}}getExtraStyle(e,r,{style:a}){var i;const n=(i=a.tb!==Ve.OVERFLOW?a.tb:Ve.CLIP)!=null?i:Ve.WRAP;if(e.type===C.LIST&&(e.renderMode===Re.ARROW||e.renderMode===Re.TEXT)){const o=this.getListWithColorMap(e),s=`${r??""}`,l=o[s];if(l)return{bg:{rgb:l},tb:n}}return{tb:n}}parseCellValue(e){const r=e.toString();return zt(r)}async parseFormula(e,r,a){var i,n;const o=await this.formulaService.getRuleFormulaResult(r,a,e.uid),s=ze((n=(i=o?.[0])==null?void 0:i.result)==null?void 0:n[0][0]);return{formula1:void 0,formula2:void 0,isFormulaValid:oe(String(s))}}async isValidType(e,r,a){const{value:i,unitId:n,subUnitId:o}=e,{formula1:s=""}=a,l=F(s)?this._listCacheService.getOrCompute(n,o,a).list:zt(s);return this.parseCellValue(i).every(u=>l.includes(u))}generateRuleName(){return this.localeService.t("dataValidation.list.name")}generateRuleErrorMessage(){return this.localeService.t("dataValidation.list.error")}_getUnitAndSubUnit(e,r){var a,i;const n=(a=e?this._univerInstanceService.getUniverSheetInstance(e):void 0)!=null?a:this._univerInstanceService.getCurrentUnitForType($.UNIVER_SHEET);if(!n)return null;const o=(i=r?n.getSheetBySheetId(r):void 0)!=null?i:n.getActiveSheet();return o?{unitId:n.getUnitId(),subUnitId:o.getSheetId()}:null}getList(e,r,a){const i=this._getUnitAndSubUnit(r,a);if(!i)return[];const{unitId:n,subUnitId:o}=i;return this._listCacheService.getOrCompute(n,o,e).list}async getListAsync(e,r,a){var i,n;const{formula1:o=""}=e,s=this._getUnitAndSubUnit(r,a);if(!s)return[];const{unitId:l,subUnitId:u}=s,d=await this.formulaService.getRuleFormulaResult(l,u,e.uid);return F(o)?Qo((n=(i=d?.[0])==null?void 0:i.result)==null?void 0:n[0][0]):zt(o)}getListWithColor(e,r,a){const i=this._getUnitAndSubUnit(r,a);if(!i)return[];const{unitId:n,subUnitId:o}=i;return this._listCacheService.getOrCompute(n,o,e).listWithColor}getListWithColorMap(e,r,a){const i=this._getUnitAndSubUnit(r,a);if(!i)return{};const{unitId:n,subUnitId:o}=i;return this._listCacheService.getOrCompute(n,o,e).colorMap}}class Zo extends He{constructor(){super(...arguments),E(this,"id",C.TEXT_LENGTH),E(this,"title","dataValidation.textLength.title"),E(this,"_lexerTreeBuilder",this.injector.get(Je)),E(this,"order",30),E(this,"operators",[m.BETWEEN,m.EQUAL,m.GREATER_THAN,m.GREATER_THAN_OR_EQUAL,m.LESS_THAN,m.LESS_THAN_OR_EQUAL,m.NOT_BETWEEN,m.NOT_EQUAL]),E(this,"scopes",["sheet"]),E(this,"_customFormulaService",this.injector.get(Xe))}_isFormulaOrInt(e){return!Z.isBlank(e)&&(F(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!1};const n=Z.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),o=Z.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),s=qr.includes(i),l=this.localeService.t("dataValidation.validFail.number");return s?{success:n&&o,formula1:n?void 0:l,formula2:o?void 0:l}:{success:n,formula1:l}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,r,a,i,n){const o=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,n),s=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,n),{formula1:l,formula2:u}=e,d=oe(String(o?.v))&&oe(String(s?.v));return{formula1:this._parseNumber(F(l)?o?.v:l),formula2:this._parseNumber(F(u)?s?.v:u),isFormulaValid:d}}transform(e,r,a){return{...e,value:e.value.toString().length}}async isValidType(e,r,a){const{value:i}=e;return typeof i=="string"||typeof i=="number"}generateRuleErrorMessage(e,r){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Xr(this._lexerTreeBuilder,e,r);return`${this.localeService.t(Uo[e.operator]).replace(ar,a??"").replace(nr,i??"")}`}}function qa(t){var e,r;return t?t.p?!((r=(e=t.p.body)==null?void 0:e.dataStream)!=null?r:"").slice(0,-2).trim():Z.isBlank(t.v):!0}function ct(t,e,r,a,i="command",n=!0){const o=a.get(Je),s=a.get(he),l=[],u=[],d=a.get(j),c=a.get(q),h=cr(c,{unitId:t,subUnitId:e});if(!h)return{redoMutations:l,undoMutations:u};const{worksheet:g}=h,v=new Ze;let f=!1;function R(p,_){n&&p.forEach(M=>{je.foreach(M,(w,b)=>{const y=g.getCellRaw(w,b),U=Ga(y);(qa(y)||U===_)&&!(y!=null&&y.p)&&(f=!0,v.setValue(w,b,{v:_,p:null}))})})}if(r.forEach(p=>{switch(p.type){case"delete":l.push({id:ce.id,params:{unitId:t,subUnitId:e,ruleId:p.rule.uid,source:i}}),u.unshift({id:Ie.id,params:{unitId:t,subUnitId:e,rule:p.rule,index:p.index,source:i}});break;case"update":{if(gr(p.rule.type,s)){const M=p.oldRanges[0].startRow,w=p.oldRanges[0].startColumn,b=p.newRanges[0].startRow,y=p.newRanges[0].startColumn,U=b-M,x=y-w,D=F(p.rule.formula1)?o.moveFormulaRefOffset(p.rule.formula1,x,U):p.rule.formula1,L=F(p.rule.formula2)?o.moveFormulaRefOffset(p.rule.formula2,x,U):p.rule.formula2;D!==p.rule.formula1||L!==p.rule.formula2||!_a(p.newRanges,p.oldRanges)?(l.push({id:J.id,params:{unitId:t,subUnitId:e,ruleId:p.ruleId,payload:{type:Q.ALL,payload:{formula1:D,formula2:L,ranges:p.newRanges}}}}),u.unshift({id:J.id,params:{unitId:t,subUnitId:e,ruleId:p.ruleId,payload:{type:Q.ALL,payload:{formula1:p.rule.formula1,formula2:p.rule.formula2,ranges:p.oldRanges}}}})):(l.push({id:J.id,params:{unitId:t,subUnitId:e,ruleId:p.ruleId,payload:{type:Q.RANGE,payload:p.newRanges},source:i}}),u.unshift({id:J.id,params:{unitId:t,subUnitId:e,ruleId:p.ruleId,payload:{type:Q.RANGE,payload:p.oldRanges},source:i}}))}else l.push({id:J.id,params:{unitId:t,subUnitId:e,ruleId:p.ruleId,payload:{type:Q.RANGE,payload:p.newRanges},source:i}}),u.unshift({id:J.id,params:{unitId:t,subUnitId:e,ruleId:p.ruleId,payload:{type:Q.RANGE,payload:p.oldRanges},source:i}});const _=d.getRuleById(t,e,p.ruleId);if(_&&_.type===C.CHECKBOX){const M=d.getValidator(C.CHECKBOX).parseFormulaSync(_,t,e);R(p.newRanges,M.formula2)}break}case"add":{if(l.push({id:Ie.id,params:{unitId:t,subUnitId:e,rule:p.rule,source:i}}),u.unshift({id:ce.id,params:{unitId:t,subUnitId:e,ruleId:p.rule.uid,source:i}}),p.rule.type===C.CHECKBOX){const _=d.getValidator(C.CHECKBOX).parseFormulaSync(p.rule,t,e);R(p.rule.ranges,_.originFormula2)}break}}}),f){const p={id:Kt.id,params:{unitId:t,subUnitId:e,cellValue:v.getData()}},_={id:Kt.id,params:Ta(a,p.params)};l.push(p),u.push(_)}return{redoMutations:l,undoMutations:u}}const jt={type:ie.COMMAND,id:"sheet.command.updateDataValidationRuleRange",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ranges:i,ruleId:n}=e,o=t.get(j),s=t.get(H),l=t.get(Le);if(!o.getRuleById(r,a,n))return!1;const u=o.getRuleObjectMatrix(r,a).clone();u.updateRange(n,i);const d=u.diff(o.getRules(r,a)),{redoMutations:c,undoMutations:h}=ct(r,a,d,t);return l.pushUndoRedo({undoMutations:h,redoMutations:c,unitID:r}),$t(c,s),!0}},mt={type:ie.COMMAND,id:"sheet.command.addDataValidation",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,rule:i}=e,n=t.get(j),o=t.get(H),s=t.get(Le),l=n.getRuleObjectMatrix(r,a).clone();l.addRule(i);const u=l.diff(n.getRules(r,a)),d=n.getValidator(i.type),c={unitId:r,subUnitId:a,rule:{...i,...d?.normalizeFormula(i,r,a)}},{redoMutations:h,undoMutations:g}=ct(r,a,u,t);return h.push({id:Ie.id,params:c}),g.unshift({id:ce.id,params:{unitId:r,subUnitId:a,ruleId:i.uid}}),s.pushUndoRedo({unitID:r,redoMutations:h,undoMutations:g}),$t(h,o),!0}},Ut={type:ie.COMMAND,id:"sheets.command.update-data-validation-setting",handler(t,e){if(!e)return!1;const r=t.get(H),a=t.get(Le),i=t.get(j),n=t.get(he),{unitId:o,subUnitId:s,ruleId:l,setting:u}=e,d=n.getValidatorItem(u.type);if(!d)return!1;const c=i.getRuleById(o,s,l);if(!c)return!1;const h={...c,...u};if(!d.validatorFormula(h,o,s).success)return!1;const g={unitId:o,subUnitId:s,ruleId:l,payload:{type:Q.SETTING,payload:{...u,...d.normalizeFormula(h,o,s)}}},v=[{id:J.id,params:g}],f={unitId:o,subUnitId:s,ruleId:l,payload:{type:Q.SETTING,payload:er(c)}},R=[{id:J.id,params:f}];if(u.type===C.CHECKBOX){const p=c.ranges,_=t.get(q),M=cr(_,{unitId:o,subUnitId:s});if(M){const w=new Ze,{worksheet:b}=M,{formula2:y=ir,formula1:U=rr}=c,{formula2:x=ir,formula1:D=rr}=u;let L=!1;if(p.forEach(V=>{je.foreach(V,(k,B)=>{const X=b.getCellRaw(k,B),G=Ga(X);(qa(X)||G===String(y))&&!(X!=null&&X.p)?(w.setValue(k,B,{v:x,p:null}),L=!0):G===String(U)&&!(X!=null&&X.p)&&(w.setValue(k,B,{v:D,p:null}),L=!0)})}),L){const V={id:Kt.id,params:{unitId:o,subUnitId:s,cellValue:w.getData()}},k={id:Kt.id,params:Ta(t,V.params)};v.push(V),R.push(k)}}}return $t(v,r).result?(a.pushUndoRedo({unitID:o,redoMutations:v,undoMutations:R}),!0):!1}},mr={type:ie.COMMAND,id:"sheets.command.update-data-validation-options",handler(t,e){if(!e)return!1;const r=t.get(H),a=t.get(Le),i=t.get(j),{unitId:n,subUnitId:o,ruleId:s,options:l}=e,u=i.getRuleById(n,o,s);if(!u)return!1;const d={unitId:n,subUnitId:o,ruleId:s,payload:{type:Q.OPTIONS,payload:l}},c=[{id:J.id,params:d}],h={unitId:n,subUnitId:o,ruleId:s,payload:{type:Q.OPTIONS,payload:Tt(u)}},g=[{id:J.id,params:h}];return a.pushUndoRedo({unitID:n,redoMutations:c,undoMutations:g}),r.executeCommand(J.id,d),!0}},za={type:ie.COMMAND,id:"sheets.command.clear-range-data-validation",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ranges:i}=e,n=t.get(H),o=t.get(q),s=cr(o,{unitId:r,subUnitId:a}),l=t.get(j);if(!s)return!1;const u=t.get(Le),d=l.getRuleObjectMatrix(r,a).clone();d.removeRange(i);const c=d.diff(l.getRules(r,a)),{redoMutations:h,undoMutations:g}=ct(r,a,c,t);return u.pushUndoRedo({unitID:r,redoMutations:h,undoMutations:g}),$t(h,n).result}},zr={type:ie.COMMAND,id:"sheet.command.remove-all-data-validation",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a}=e,i=t.get(H),n=t.get(j),o=t.get(Le),s=[...n.getRules(r,a)],l={unitId:r,subUnitId:a,ruleId:s.map(c=>c.uid)},u=[{id:ce.id,params:l}],d=[{id:Ie.id,params:{unitId:r,subUnitId:a,rule:s}}];return o.pushUndoRedo({redoMutations:u,undoMutations:d,unitID:r}),i.executeCommand(ce.id,l),!0}},Ko=(t,e)=>{const r=t.get(j),{unitId:a,subUnitId:i,ruleId:n,source:o}=e;if(Array.isArray(n)){const s=n.map(l=>r.getRuleById(a,i,l)).filter(Boolean);return[{id:Ie.id,params:{unitId:a,subUnitId:i,rule:s,source:o}}]}return[{id:Ie.id,params:{unitId:a,subUnitId:i,rule:{...r.getRuleById(a,i,n)},index:r.getRuleIndex(a,i,n)}}]},Ht={type:ie.COMMAND,id:"sheet.command.remove-data-validation-rule",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ruleId:i}=e,n=t.get(H),o=t.get(Le),s=t.get(j),l=[{id:ce.id,params:e}],u=[{id:Ie.id,params:{unitId:r,subUnitId:a,rule:{...s.getRuleById(r,a,i)},index:s.getRuleIndex(r,a,i)}}];return o.pushUndoRedo({undoMutations:u,redoMutations:l,unitID:e.unitId}),n.executeCommand(ce.id,e),!0}},Li="SHEET_DATA_VALIDATION_PLUGIN";var Za=(t=>(t[t.View=0]="View",t[t.Edit=1]="Edit",t[t.ManageCollaborator=2]="ManageCollaborator",t[t.Print=3]="Print",t[t.Duplicate=4]="Duplicate",t[t.Comment=5]="Comment",t[t.Copy=6]="Copy",t[t.Share=7]="Share",t[t.Export=8]="Export",t[t.MoveWorksheet=9]="MoveWorksheet",t[t.DeleteWorksheet=10]="DeleteWorksheet",t[t.HideWorksheet=11]="HideWorksheet",t[t.RenameWorksheet=12]="RenameWorksheet",t[t.CreateWorksheet=13]="CreateWorksheet",t[t.SetWorksheetStyle=14]="SetWorksheetStyle",t[t.EditWorksheetCell=15]="EditWorksheetCell",t[t.InsertHyperlink=16]="InsertHyperlink",t[t.Sort=17]="Sort",t[t.Filter=18]="Filter",t[t.PivotTable=19]="PivotTable",t[t.FloatImg=20]="FloatImg",t[t.History=21]="History",t[t.RwHgtClWdt=22]="RwHgtClWdt",t[t.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",t[t.ViewFilter=24]="ViewFilter",t[t.MoveSheet=25]="MoveSheet",t[t.DeleteSheet=26]="DeleteSheet",t[t.HideSheet=27]="HideSheet",t[t.CopySheet=28]="CopySheet",t[t.RenameSheet=29]="RenameSheet",t[t.CreateSheet=30]="CreateSheet",t[t.SelectProtectedCells=31]="SelectProtectedCells",t[t.SelectUnProtectedCells=32]="SelectUnProtectedCells",t[t.SetCellStyle=33]="SetCellStyle",t[t.SetCellValue=34]="SetCellValue",t[t.SetRowStyle=35]="SetRowStyle",t[t.SetColumnStyle=36]="SetColumnStyle",t[t.InsertRow=37]="InsertRow",t[t.InsertColumn=38]="InsertColumn",t[t.DeleteRow=39]="DeleteRow",t[t.DeleteColumn=40]="DeleteColumn",t[t.EditExtraObject=41]="EditExtraObject",t[t.Delete=42]="Delete",t[t.RecoverHistory=43]="RecoverHistory",t[t.ViewHistory=44]="ViewHistory",t[t.CreatePermissionObject=45]="CreatePermissionObject",t[t.UNRECOGNIZED=-1]="UNRECOGNIZED",t))(Za||{}),Jo=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},ni=(t,e)=>(r,a)=>e(r,a,t);let or=class extends ae{constructor(t,e,r){super(),this._univerInstanceService=t,this._permissionService=e,this._lexerTreeBuilder=r}getFormulaRefCheck(t){var e,r;const a=this._lexerTreeBuilder.sequenceNodesBuilder(t);if(!a)return!0;for(let i=0;i<a.length;i++){const n=a[i];if(typeof n=="string")continue;const{token:o}=n,s=Tn(o),l=this._univerInstanceService.getCurrentUnitForType($.UNIVER_SHEET);let u=l.getActiveSheet();const d=l.getUnitId();if(s.sheetName){if(u=l.getSheetBySheetName(s.sheetName),!u)return!1;const f=u?.getSheetId();if(!this._permissionService.getPermissionPoint(new kn(d,f).id))return!1}if(!u)return!1;const{startRow:c,endRow:h,startColumn:g,endColumn:v}=s.range;for(let f=c;f<=h;f++)for(let R=g;R<=v;R++){const p=(r=(e=u.getCell(f,R))==null?void 0:e.selectionProtection)==null?void 0:r[0];if(p?.[Za.View]===!1)return!1}}return!0}};or=Jo([ni(0,q),ni(1,Sn),ni(2,S(Je))],or);const es="sheets-data-validation.config",oa={};var ts=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},oi=(t,e)=>(r,a)=>e(r,a,t);let Nr=class extends ae{constructor(t,e,r){super(),E(this,"_disposableMap",new Map),E(this,"registerRule",(a,i,n)=>{gr(n.type,this._validatorRegistryService)&&this.register(a,i,n)}),this._dataValidationModel=t,this._formulaRefRangeService=e,this._validatorRegistryService=r,this._initRefRange()}_getIdWithUnitId(t,e,r){return`${t}_${e}_${r}`}register(t,e,r){const a=r.ranges,i=r.formula1,n=r.formula2,o=this._formulaRefRangeService.registerRangeFormula(t,e,a,[i??"",n??""],l=>{if(l.length===0)return{undos:[{id:Ie.id,params:{unitId:t,subUnitId:e,rule:r,source:"patched"}}],redos:[{id:ce.id,params:{unitId:t,subUnitId:e,ruleId:r.uid,source:"patched"}}]};const u=[],d=[],c=l[0];u.push({id:J.id,params:{unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:Q.ALL,payload:{ranges:c.ranges,formula1:c.formulas[0],formula2:c.formulas[1]}},source:"patched"}}),d.push({id:J.id,params:{unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:Q.ALL,payload:{ranges:a,formula1:i,formula2:n}},source:"patched"}});for(let h=1;h<l.length;h++){const g=l[h],v=ut();u.push({id:Ie.id,params:{unitId:t,subUnitId:e,rule:{...r,uid:v,formula1:g.formulas[0],formula2:g.formulas[1],ranges:g.ranges},source:"patched"}}),d.push({id:ce.id,params:{unitId:t,subUnitId:e,ruleId:v,source:"patched"}})}return{undos:d,redos:u}}),s=this._getIdWithUnitId(t,e,r.uid);this._disposableMap.set(s,o)}_initRefRange(){const t=this._dataValidationModel.getAll();for(const[e,r]of t)for(const[a,i]of r)for(const n of i)this.registerRule(e,a,n);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{const{unitId:r,subUnitId:a,rule:i}=e;switch(e.type){case"add":{const n=e.rule;this.registerRule(e.unitId,e.subUnitId,n);break}case"remove":{const n=this._disposableMap.get(this._getIdWithUnitId(r,a,i.uid));n&&n.dispose();break}case"update":{const n=e.rule,o=this._disposableMap.get(this._getIdWithUnitId(r,a,n.uid));o&&o.dispose(),this.registerRule(e.unitId,e.subUnitId,n);break}}})),this.disposeWithMe(Ue(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}};Nr=ts([oi(0,S(j)),oi(1,S(Oa)),oi(2,S(he))],Nr);var rs=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},It=(t,e)=>(r,a)=>e(r,a,t);let Dr=class extends ae{constructor(e,r,a,i,n,o){super(),E(this,"_disposableMap",new Map),E(this,"registerRule",(s,l,u)=>{gr(u.type,this._validatorRegistryService)||(this.register(s,l,u),this.registerFormula(s,l,u))}),this._dataValidationModel=e,this._injector=r,this._refRangeService=a,this._dataValidationFormulaService=i,this._formulaRefRangeService=n,this._validatorRegistryService=o,this._initRefRange()}_getIdWithUnitId(e,r,a){return`${e}_${r}_${a}`}registerFormula(e,r,a){var i;const n=a.uid,o=this._getIdWithUnitId(e,r,n),s=(i=this._disposableMap.get(o))!=null?i:new Set,l=(d,c)=>{const h=this._dataValidationModel.getRuleById(e,r,n);if(!h)return{redos:[],undos:[]};const g=h[d];if(!g||g===c)return{redos:[],undos:[]};const v={unitId:e,subUnitId:r,ruleId:a.uid,payload:{type:Q.SETTING,payload:{type:h.type,formula1:h.formula1,formula2:h.formula2,[d]:c}},source:"patched"},f={unitId:e,subUnitId:r,ruleId:a.uid,payload:{type:Q.SETTING,payload:{type:h.type,formula1:h.formula1,formula2:h.formula2}},source:"patched"},R=[{id:J.id,params:v}],p=[{id:J.id,params:f}];return{redos:R,undos:p}},u=this._dataValidationFormulaService.getRuleFormulaInfo(e,r,n);if(u){const[d,c]=u;if(d){const h=this._formulaRefRangeService.registerFormula(e,r,d.text,g=>l("formula1",g));s.add(()=>h.dispose())}if(c){const h=this._formulaRefRangeService.registerFormula(e,r,c.text,g=>l("formula2",g));s.add(()=>h.dispose())}}}register(e,r,a){var i;const n=u=>{const d=[...a.ranges],c=d.map(h=>Bn(h,u)).filter(h=>!!h).flat();if(_a(c,d))return{redos:[],undos:[]};if(c.length){const h={unitId:e,subUnitId:r,ruleId:a.uid,payload:{type:Q.RANGE,payload:c},source:"patched"},g=[{id:J.id,params:h}],v=[{id:J.id,params:{unitId:e,subUnitId:r,ruleId:a.uid,payload:{type:Q.RANGE,payload:d},source:"patched"}}];return{redos:g,undos:v}}else{const h={unitId:e,subUnitId:r,ruleId:a.uid},g=[{id:ce.id,params:h}],v=Ko(this._injector,h);return{redos:g,undos:v}}},o=[];a.ranges.forEach(u=>{const d=this._refRangeService.registerRefRange(u,n,e,r);o.push(()=>d.dispose())});const s=this._getIdWithUnitId(e,r,a.uid),l=(i=this._disposableMap.get(s))!=null?i:new Set;l.add(()=>o.forEach(u=>u())),this._disposableMap.set(s,l)}_initRefRange(){const e=this._dataValidationModel.getAll();for(const[r,a]of e)for(const[i,n]of a)for(const o of n)this.registerRule(r,i,o);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(r=>{const{unitId:a,subUnitId:i,rule:n}=r;switch(r.type){case"add":{const o=r.rule;this.registerRule(r.unitId,r.subUnitId,o);break}case"remove":{const o=this._disposableMap.get(this._getIdWithUnitId(a,i,n.uid));o&&o.forEach(s=>s());break}case"update":{const o=r.rule,s=this._disposableMap.get(this._getIdWithUnitId(a,i,o.uid));s&&s.forEach(l=>l()),this.registerRule(r.unitId,r.subUnitId,o);break}}})),this.disposeWithMe(Ue(()=>{this._disposableMap.forEach(r=>{r.forEach(a=>a())}),this._disposableMap.clear()}))}};Dr=rs([It(0,S(j)),It(1,S(Me)),It(2,S($n)),It(3,S(qe)),It(4,S(Oa)),It(5,S(he))],Dr);var is=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},si=(t,e)=>(r,a)=>e(r,a,t);let xr=class extends ae{constructor(e,r,a){super(),this._sheetInterceptorService=e,this._univerInstanceService=r,this._sheetDataValidationModel=a,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:e=>{var r;if(e.id===Ln.id){const a=e.params,i=a.unitId||this._univerInstanceService.getCurrentUnitForType($.UNIVER_SHEET).getUnitId(),n=this._univerInstanceService.getUniverSheetInstance(i);if(!n)return{redos:[],undos:[]};const o=a.subUnitId||((r=n.getActiveSheet())==null?void 0:r.getSheetId());if(!o)return{redos:[],undos:[]};const s=this._sheetDataValidationModel.getRules(i,o);if(s.length===0)return{redos:[],undos:[]};const l=s.map(c=>c.uid),u={unitId:i,subUnitId:o,ruleId:l,source:"patched"},d={unitId:i,subUnitId:o,rule:[...s],source:"patched"};return{redos:[{id:ce.id,params:u}],undos:[{id:Ie.id,params:d}]}}else if(e.id===Fn.id){const a=e.params,{unitId:i,subUnitId:n,targetSubUnitId:o}=a;if(!i||!n||!o)return{redos:[],undos:[]};const s=this._sheetDataValidationModel.getRules(i,n);if(s.length===0)return{redos:[],undos:[]};const l=s.map(u=>({...u,uid:ut(6)}));return{redos:[{id:Ie.id,params:{unitId:i,subUnitId:o,rule:l,source:"patched"}}],undos:[{id:ce.id,params:{unitId:i,subUnitId:o,ruleId:l.map(u=>u.uid),source:"patched"}}]}}return{redos:[],undos:[]}}}))}};xr=is([si(0,S(hr)),si(1,S(q)),si(2,S(j))],xr);class as extends He{constructor(){super(...arguments),E(this,"id",C.ANY),E(this,"title","dataValidation.any.title"),E(this,"operators",[]),E(this,"scopes",["sheet"]),E(this,"order",0),E(this,"offsetFormulaByRange",!1)}async parseFormula(e,r,a){return{formula1:e.formula1,formula2:e.formula2,isFormulaValid:!0}}validatorFormula(e,r,a){return{success:!0}}async isValidType(e,r,a){return!0}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.any.error")}}class ns extends He{constructor(){super(...arguments),E(this,"id",C.CUSTOM),E(this,"title","dataValidation.custom.title"),E(this,"operators",[]),E(this,"scopes",["sheet"]),E(this,"order",60),E(this,"_customFormulaService",this.injector.get(Xe)),E(this,"_lexerTreeBuilder",this.injector.get(Je))}validatorFormula(e,r,a){var i;const n=F(e.formula1),o=(i=e.formula1)!=null?i:"",s=this._lexerTreeBuilder.checkIfAddBracket(o)===0&&o.startsWith(Dn.EQUALS);return{success:n&&s,formula1:n&&s?"":this.localeService.t("dataValidation.validFail.formula")}}async parseFormula(e,r,a){return{formula1:void 0,formula2:void 0,isFormulaValid:!0}}async isValidType(e,r,a){const{column:i,row:n,unitId:o,subUnitId:s}=e,l=await this._customFormulaService.getCellFormulaValue(o,s,a.uid,n,i),u=l?.v;return oe(String(u))&&Z.isDefine(u)&&u!==""?l.t===fa.BOOLEAN?!!u:typeof u=="boolean"?u:typeof u=="number"?!!u:typeof u=="string"?oe(u):!!u:!1}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.custom.error")}generateRuleName(e){var r;return this.localeService.t("dataValidation.custom.ruleName").replace("{FORMULA1}",(r=e.formula1)!=null?r:"")}}class os extends Xa{constructor(){super(...arguments),E(this,"id",C.LIST_MULTIPLE),E(this,"title","dataValidation.listMultiple.title"),E(this,"offsetFormulaByRange",!1),E(this,"skipDefaultFontRender",()=>!0)}}class ss extends He{constructor(){super(...arguments),E(this,"_customFormulaService",this.injector.get(Xe)),E(this,"_lexerTreeBuilder",this.injector.get(Je)),E(this,"id",C.WHOLE),E(this,"title","dataValidation.whole.title"),E(this,"order",10),E(this,"operators",[m.BETWEEN,m.EQUAL,m.GREATER_THAN,m.GREATER_THAN_OR_EQUAL,m.LESS_THAN,m.LESS_THAN_OR_EQUAL,m.NOT_BETWEEN,m.NOT_EQUAL]),E(this,"scopes",["sheet"])}_isFormulaOrInt(e){return!Z.isBlank(e)&&(F(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}async isValidType(e,r,a){const{value:i}=e,n=Ar(i);return!Number.isNaN(n)&&Number.isInteger(n)}transform(e,r,a){const{value:i}=e;return{...e,value:Ar(i)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,r,a,i,n){const o=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,n),s=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,n),{formula1:l,formula2:u}=e,d=F(l)?o?.v:l,c=F(u)?s?.v:u,h=oe(`${d}`)&&oe(`${c}`);return{formula1:this._parseNumber(d),formula2:this._parseNumber(c),isFormulaValid:h}}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!0};const n=Z.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),o=Z.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),s=qr.includes(i),l=this.localeService.t("dataValidation.validFail.number");return s?{success:n&&o,formula1:n?void 0:l,formula2:o?void 0:l}:{success:n,formula1:l}}generateRuleErrorMessage(e,r){if(!e.operator)return this.localeService.t(Ur.NONE).replace("{TYPE}",this.titleStr);const{transformedFormula1:a,transformedFormula2:i}=Xr(this._lexerTreeBuilder,e,r);return`${this.localeService.t(Ur[e.operator]).replace(ar,a??"").replace(nr,i??"")}`}}var ls=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},St=(t,e)=>(r,a)=>e(r,a,t);let kr=class extends Gr{constructor(e,r,a,i,n,o){super(),this._univerInstanceService=e,this._dataValidatorRegistryService=r,this._injector=a,this._selectionManagerService=i,this._sheetInterceptorService=n,this._sheetDataValidationModel=o,this._init()}_init(){this._registerValidators(),this._initCommandInterceptor()}_registerValidators(){[as,Yo,ss,Zo,Go,Ho,Xa,os,ns].forEach(e=>{const r=this._injector.createInstance(e);this.disposeWithMe(this._dataValidatorRegistryService.register(r)),this.disposeWithMe(Ue(()=>this._injector.delete(e)))})}_initCommandInterceptor(){this._sheetInterceptorService.interceptCommand({getMutations:e=>{var r;if(e.id===On.id){const a=this._univerInstanceService.getCurrentUnitForType($.UNIVER_SHEET),i=a.getUnitId(),n=a.getActiveSheet();if(!n)throw new Error("No active sheet found");const o=n.getSheetId(),s=(r=this._selectionManagerService.getCurrentSelections())==null?void 0:r.map(h=>h.range),l=this._sheetDataValidationModel.getRuleObjectMatrix(i,o).clone();s&&l.removeRange(s);const u=l.diff(this._sheetDataValidationModel.getRules(i,o)),{redoMutations:d,undoMutations:c}=ct(i,o,u,this._injector,"patched");return{undos:c,redos:d}}return{undos:[],redos:[]}}})}};kr=ls([St(0,q),St(1,S(he)),St(2,S(Me)),St(3,S(Yr)),St(4,S(hr)),St(5,S(j))],kr);var us=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Er=(t,e)=>(r,a)=>e(r,a,t);let Ae=class extends ae{constructor(t,e,r,a){super(),this._univerInstanceService=t,this._sheetDataValidationModel=e,this._dataValidationCacheService=r,this._lifecycleService=a,this._initRecalculate()}_initRecalculate(){const t=e=>{if(e.length===0)return;const r=this._univerInstanceService.getCurrentUnitForType($.UNIVER_SHEET),a=r?.getActiveSheet(),i={};e.flat().forEach(n=>{i[n.unitId]||(i[n.unitId]={}),i[n.unitId][n.subUnitId]||(i[n.unitId][n.subUnitId]=[]);const o=this._univerInstanceService.getUnit(n.unitId,$.UNIVER_SHEET),s=o?.getSheetBySheetId(n.subUnitId);s&&i[n.unitId][n.subUnitId].push(...n.ranges.map(l=>je.transformRange(l,s)))}),Object.entries(i).forEach(([n,o])=>{Object.entries(o).forEach(([s,l])=>{r?.getUnitId()===n&&a?.getSheetId()===s?this.validatorRanges(n,s,l):requestIdleCallback(()=>{this.validatorRanges(n,s,l)})})})};this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(Un(()=>this._lifecycleService.lifecycle$.pipe(lt(e=>e===Wi.Rendered)))).subscribe(t)),this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(lt(()=>this._lifecycleService.stage>=Wi.Rendered),pa(20)).subscribe(t))}async _validatorByCell(t,e,r,a){const i=t.getUnitId(),n=e.getSheetId();if(!Z.isDefine(r)||!Z.isDefine(a))throw new Error(`row or col is not defined, row: ${r}, col: ${a}`);let o=r,s=a;const l=e.getMergedCell(r,a);l&&(o=l.startRow,s=l.startColumn);const u=this._sheetDataValidationModel.getRuleByLocation(i,n,o,s);return u?new Promise(d=>{this._sheetDataValidationModel.validator(u,{unitId:i,subUnitId:n,row:o,col:s,worksheet:e,workbook:t},c=>{d(c)})}):re.VALID}async validatorCell(t,e,r,a){const i=this._univerInstanceService.getUnit(t,$.UNIVER_SHEET);if(!i)throw new Error(`cannot find current workbook, unitId: ${t}`);const n=i.getSheetBySheetId(e);if(!n)throw new Error(`cannot find current worksheet, sheetId: ${e}`);return this._validatorByCell(i,n,r,a)}async validatorRanges(t,e,r){if(!r.length)return Promise.resolve([]);const a=this._univerInstanceService.getUnit(t,$.UNIVER_SHEET);if(!a)throw new Error(`cannot find current workbook, unitId: ${t}`);const i=a.getSheetBySheetId(e);if(!i)throw new Error(`cannot find current worksheet, sheetId: ${e}`);const n=this._sheetDataValidationModel.getRules(t,e).map(u=>u.ranges).flat(),o=r.map(u=>n.map(d=>ma(u,d))).flat().filter(Boolean),s=[],l=await Promise.all(o.map((u,d)=>{const c=[];for(let h=u.startRow;h<=u.endRow;h++)for(let g=u.startColumn;g<=u.endColumn;g++){c.push(this._validatorByCell(a,i,h,g));const v=i.getMergedCell(h,g);v&&s.push({resultRowIndex:d,resultColIndex:c.length-1,row:v.startRow,col:v.startColumn})}return Promise.all(c)}));return s.length&&s.forEach(({resultRowIndex:u,resultColIndex:d,row:c,col:h})=>{var g;l[u][d]===re.VALIDATING&&(l[u][d]=(g=this._dataValidationCacheService.getValue(t,e,c,h))!=null?g:re.VALID)}),l}async validatorWorksheet(t,e){const r=this._univerInstanceService.getUnit(t,$.UNIVER_SHEET);if(!r)throw new Error(`cannot find current workbook, unitId: ${t}`);const a=r.getSheetBySheetId(e);if(!a)throw new Error(`cannot find current worksheet, sheetId: ${e}`);const i=this._sheetDataValidationModel.getRules(t,e);return await Promise.all(i.map(n=>Promise.all(n.ranges.map(o=>{const s=[];return je.foreach(o,(l,u)=>{s.push(this._validatorByCell(r,a,l,u))}),Promise.all(s)})))),this._dataValidationCacheService.ensureCache(t,e)}async validatorWorkbook(t){const e=this._sheetDataValidationModel.getSubUnitIds(t),r=await Promise.all(e.map(i=>this.validatorWorksheet(t,i))),a={};return r.forEach((i,n)=>{a[e[n]]=i}),a}getDataValidations(t,e,r){const a=this._sheetDataValidationModel.getRuleObjectMatrix(t,e),i=new Set;return r.forEach(n=>{je.foreach(n,(o,s)=>{const l=a.getValue(o,s);l&&i.add(l)})}),Array.from(i).map(n=>this._sheetDataValidationModel.getRuleById(t,e,n)).filter(Boolean)}getDataValidation(t,e,r){return this.getDataValidations(t,e,r)[0]}};Ae=us([Er(0,q),Er(1,S(j)),Er(2,S(We)),Er(3,S(En))],Ae);var ds=Object.defineProperty,cs=(t,e,r)=>e in t?ds(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,hs=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},li=(t,e)=>(r,a)=>e(r,a,t),Ka=(t,e,r)=>cs(t,typeof e!="symbol"?e+"":e,r);let At=class extends Wr{constructor(t=oa,e,r,a){super(),this._config=t,this._injector=e,this._commandService=r,this._configService=a;const{...i}=Pr({},oa,this._config);this._configService.setConfig(es,i)}onStarting(){[[We],[tr],[qe],[Xe],[Ae],[j],[kr],[or],[xr],[Dr],[Nr]].forEach(t=>{this._injector.add(t)}),[mt,jt,Ut,mr,Ht,zr,za].forEach(t=>{this._commandService.registerCommand(t)}),this._injector.get(We),this._injector.get(Ae),this._injector.get(kr),this._injector.get(Nr),this._injector.get(Dr)}onReady(){this._injector.get(xr)}onRendered(){this._injector.get(or)}};Ka(At,"pluginName",Li);Ka(At,"type",$.UNIVER_SHEET);At=hs([Ia(to,Tr),li(1,S(Me)),li(2,H),li(3,dr)],At);function Ja(t){const e=t.get(Yr).getCurrentSelections().map(r=>r.range);return{uid:ut(6),type:C.DECIMAL,operator:m.EQUAL,formula1:"100",ranges:e??[{startColumn:0,endColumn:0,startRow:0,endRow:0}]}}const en="data-validation.custom-formula-input",Zr="data-validation.formula-input",Fi="data-validation.list-formula-input",tn="data-validation.checkbox-formula-input";var gs=Object.defineProperty,ms=(t,e,r)=>e in t?gs(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,O=(t,e,r)=>ms(t,typeof e!="symbol"?e+"":e,r),ps=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},sa=(t,e)=>(r,a)=>e(r,a,t);let $e=class extends ae{constructor(t,e){super(),O(this,"_open$",new Si(!1)),O(this,"open$",this._open$.pipe(Rn())),O(this,"_activeRule"),O(this,"_activeRule$",new Si(void 0)),O(this,"activeRule$",this._activeRule$.asObservable()),O(this,"_closeDisposable",null),O(this,"_focusFormulaEditorActiveRuleSubUnitId",null),this._univerInstanceService=t,this._sidebarService=e,this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$($.UNIVER_SHEET).pipe(lt(r=>!r)).subscribe(()=>{this.close()})),this.disposeWithMe(this._sidebarService.sidebarOptions$.subscribe(r=>{r.id===Fr&&(r.visible||setTimeout(()=>{this._sidebarService.sidebarOptions$.next({visible:!1})}))}))}get activeRule(){return this._activeRule}get isOpen(){return this._open$.getValue()}dispose(){var t;super.dispose(),this._open$.next(!1),this._open$.complete(),this._activeRule$.complete(),(t=this._closeDisposable)==null||t.dispose()}open(){this._open$.next(!0)}close(){var t;this._open$.next(!1),(t=this._closeDisposable)==null||t.dispose()}setCloseDisposable(t){this._closeDisposable=Ue(()=>{t.dispose(),this._closeDisposable=null})}setActiveRule(t){this._activeRule=t,this._activeRule$.next(t)}setFocusFormulaEditorActiveRuleSubUnitId(t){this._focusFormulaEditorActiveRuleSubUnitId=t}getFocusFormulaEditorActiveRuleSubUnitId(){return this._focusFormulaEditorActiveRuleSubUnitId}};$e=ps([sa(0,q),sa(1,Ba)],$e);const nt="#ECECEC",Or="sheets-data-validation-ui.config",Lr={};var vs=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Et=(t,e)=>(r,a)=>e(r,a,t);let Nt=class extends ae{constructor(t,e,r,a,i,n){super(),this._sheetInterceptorService=t,this._dataValidationModel=e,this._dataValidatorRegistryService=r,this._dialogService=a,this._localeService=i,this._sheetsDataValidationValidatorService=n,this._initEditorBridgeInterceptor()}_initEditorBridgeInterceptor(){this.disposeWithMe(this._sheetInterceptorService.writeCellInterceptor.intercept(Wn,{handler:async(t,e,r)=>{const a=await t,{row:i,col:n,unitId:o,subUnitId:s}=e,l=this._dataValidationModel.getRuleIdByLocation(o,s,i,n),u=l?this._dataValidationModel.getRuleById(o,s,l):void 0;if(a===!1)return r(Promise.resolve(!1));if(!u||u.errorStyle!==Ye.STOP)return r(Promise.resolve(!0));const d=this._dataValidatorRegistryService.getValidatorItem(u.type);return!d||await this._sheetsDataValidationValidatorService.validatorCell(o,s,i,n)===re.VALID?r(Promise.resolve(!0)):(this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:d.getRuleFinalError(u,{row:i,col:n,unitId:o,subUnitId:s})},footer:{title:A.createElement(Mt,{variant:"primary",onClick:()=>this._dialogService.close("reject-input-dialog")},this._localeService.t("dataValidation.alert.ok"))},onClose:()=>{this._dialogService.close("reject-input-dialog")}}),r(Promise.resolve(!1)))}}))}showReject(t){this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:t},footer:{title:A.createElement(Mt,{variant:"primary",onClick:()=>this._dialogService.close("reject-input-dialog")},this._localeService.t("dataValidation.alert.ok"))},onClose:()=>{this._dialogService.close("reject-input-dialog")}})}};Nt=vs([Et(0,S(hr)),Et(1,S(j)),Et(2,S(he)),Et(3,uo),Et(4,S(Ne)),Et(5,S(Ae))],Nt);var fs=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Fe=(t,e)=>(r,a)=>e(r,a,t);const ui=t=>{if(t==null||typeof t=="boolean")return;if(t==="")return qt();if(typeof t=="number"||!Number.isNaN(+t))return qt(ke.format("yyyy-MM-dd HH:mm:ss",Number(t)));const e=qt(t);if(e.isValid())return e};function _s(t,e){const r=ho(e);if(t===r)return e;switch(t){case"datetime":return"yyyy-MM-dd hh:mm:ss";case"date":return"yyyy-MM-dd";case"time":return"HH:mm:ss"}}let ht=class extends ae{constructor(t,e,r,a,i,n,o,s,l,u,d){super(),O(this,"_activeDropdown"),O(this,"_activeDropdown$",new Zt),O(this,"_currentPopup",null),O(this,"activeDropdown$",this._activeDropdown$.asObservable()),O(this,"_zenVisible",!1),this._univerInstanceService=t,this._dataValidatorRegistryService=e,this._zenZoneService=r,this._dataValidationModel=a,this._sheetsSelectionsService=i,this._cellDropdownManagerService=n,this._sheetDataValidationModel=o,this._commandService=s,this._editorBridgeService=l,this._injector=u,this._configService=d,this._init(),this._initSelectionChange(),this.disposeWithMe(()=>{this._activeDropdown$.complete()})}get activeDropdown(){return this._activeDropdown}_init(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(t=>{this._zenVisible=t,t&&this.hideDropdown()}))}_getDropdownByCell(t,e,r,a){const i=t?this._univerInstanceService.getUnit(t,$.UNIVER_SHEET):this._univerInstanceService.getCurrentUnitForType($.UNIVER_SHEET);if(!i)return;const n=e?i.getSheetBySheetId(e):i.getActiveSheet();if(!n)return;const o=this._dataValidationModel.getRuleByLocation(i.getUnitId(),n.getSheetId(),r,a);if(!o)return;const s=this._dataValidatorRegistryService.getValidatorItem(o.type);return s?.dropdownType}_initSelectionChange(){this.disposeWithMe(this._sheetsSelectionsService.selectionMoveEnd$.subscribe(t=>{t&&t.every(e=>!(e.primary&&this._getDropdownByCell(e.primary.unitId,e.primary.sheetId,e.primary.actualRow,e.primary.actualColumn)))&&this.hideDropdown()}))}showDropdown(t){var e,r,a,i,n,o;const{location:s}=t,{row:l,col:u,unitId:d,subUnitId:c,workbook:h,worksheet:g}=s;if(this._currentPopup&&this._currentPopup.dispose(),this._zenVisible)return;this._activeDropdown=t,this._activeDropdown$.next(this._activeDropdown);const v=this._sheetDataValidationModel.getRuleByLocation(d,c,l,u);if(!v)return;const f=this._dataValidatorRegistryService.getValidatorItem(v.type);if(!(f!=null&&f.dropdownType))return;let R;const p=async(w,b)=>{var y,U,x;if(!w)return!0;const D=w,L=g.getCell(l,u),V=D.format(b==="date"?"YYYY-MM-DD 00:00:00":"YYYY-MM-DD HH:mm:ss"),k=(y=ke.parseDate(V))==null?void 0:y.v,B=b==="time"?k%1:k,X=h.getStyles().getStyleByCell(L),G=(x=(U=X?.n)==null?void 0:U.pattern)!=null?x:"";return v.errorStyle!==Ye.STOP||await f.validator({value:B,unitId:d,subUnitId:c,row:l,column:u,worksheet:g,workbook:h,interceptValue:V.replace("Z","").replace("T"," "),t:fa.NUMBER},v)?(await this._commandService.executeCommand(Qt.id,{unitId:d,subUnitId:c,range:{startColumn:u,endColumn:u,startRow:l,endRow:l},value:{v:B,t:2,p:null,f:null,si:null,s:{n:{pattern:_s(b,G)}}}}),await this._commandService.executeCommand(pr.id,{visible:!1,eventType:fr.Keyboard,unitId:d,keycode:_r.ESC}),!0):(this._injector.has(Nt)&&this._injector.get(Nt).showReject(f.getRuleFinalError(v,{row:l,col:u,unitId:d,subUnitId:c})),!1)};let _;switch(f.dropdownType){case xe.DATE:{const w=se(g.getCellRaw(l,u)),b=ui(w),y=!!((e=v.bizInfo)!=null&&e.showTime);_={location:s,type:"datepicker",props:{showTime:y,onChange:U=>p(U,y?"datetime":"date"),defaultValue:b,patternType:"date"}};break}case xe.TIME:{const w=se(g.getCellRaw(l,u)),b=ui(w);_={location:s,type:"datepicker",props:{onChange:y=>p(y,"time"),defaultValue:b,patternType:"time"}};break}case xe.DATETIME:{const w=se(g.getCellRaw(l,u)),b=ui(w);_={location:s,type:"datepicker",props:{onChange:y=>p(y,"datetime"),defaultValue:b,patternType:"datetime"}};break}case xe.LIST:case xe.MULTIPLE_LIST:{const w=f.dropdownType===xe.MULTIPLE_LIST,b=async V=>{const k=Ya(V),B={unitId:d,subUnitId:c,range:{startColumn:u,endColumn:u,startRow:l,endRow:l},value:{v:k,p:null,f:null,si:null}};return this._commandService.executeCommand(Qt.id,B),this._editorBridgeService.isVisible().visible&&await this._commandService.executeCommand(pr.id,{visible:!1,eventType:fr.Keyboard,unitId:d,keycode:_r.ESC}),!w},y=v?.renderMode===Re.CUSTOM||v?.renderMode===void 0,U=f.getListWithColor(v,d,c),x=ii(g.getCellRaw(l,u)),D=()=>{this._commandService.executeCommand(pt.id,{ruleId:v.uid}),R?.dispose()},L=U.map(V=>({label:V.label,value:V.label,color:y||V.color?V.color||nt:"transparent"}));_={location:s,type:"list",props:{onChange:V=>b(V),options:L,onEdit:D,defaultValue:x,multiple:w,showEdit:(a=(r=this._configService.getConfig(Or))==null?void 0:r.showEditOnDropdown)!=null?a:!0,showSearch:(n=(i=this._configService.getConfig(Or))==null?void 0:i.showSearchOnDropdown)!=null?n:!0}};break}case xe.CASCADE:{_={type:"cascader",props:{onChange:w=>{const b={unitId:d,subUnitId:c,range:{startColumn:u,endColumn:u,startRow:l,endRow:l},value:{v:w.join("/"),p:null,f:null,si:null}};return this._commandService.syncExecuteCommand(Qt.id,b),this._editorBridgeService.isVisible().visible&&this._commandService.syncExecuteCommand(pr.id,{visible:!1,eventType:fr.Keyboard,unitId:d,keycode:_r.ESC}),!0},defaultValue:ii(g.getCellRaw(l,u)).split("/"),options:JSON.parse((o=v.formula1)!=null?o:"[]")},location:s};break}case xe.COLOR:{_={type:"color",props:{onChange:w=>{const b={unitId:d,subUnitId:c,range:{startColumn:u,endColumn:u,startRow:l,endRow:l},value:{v:w,p:null,f:null,si:null}};return this._commandService.syncExecuteCommand(Qt.id,b),this._editorBridgeService.isVisible().visible&&this._commandService.syncExecuteCommand(pr.id,{visible:!1,eventType:fr.Keyboard,unitId:d,keycode:_r.ESC}),!0},defaultValue:ii(g.getCellRaw(l,u))},location:s};break}default:throw new Error("[DataValidationDropdownManagerService]: unknown type!")}if(R=this._cellDropdownManagerService.showDropdown({..._,onHide:()=>{this._activeDropdown=null,this._activeDropdown$.next(null)}}),!R)throw new Error("[DataValidationDropdownManagerService]: cannot show dropdown!");const M=new wn;M.add(R),M.add({dispose:()=>{var w,b;(b=(w=this._activeDropdown)==null?void 0:w.onHide)==null||b.call(w)}}),this._currentPopup=M}hideDropdown(){this._activeDropdown&&(this._currentPopup&&this._currentPopup.dispose(),this._currentPopup=null,this._activeDropdown=null,this._activeDropdown$.next(null))}showDataValidationDropdown(t,e,r,a,i){const n=this._univerInstanceService.getUnit(t,$.UNIVER_SHEET);if(!n)return;const o=n.getSheetBySheetId(e);if(!o)return;const s=this._dataValidationModel.getRuleByLocation(n.getUnitId(),o.getSheetId(),r,a);if(!s)return;const l=this._dataValidatorRegistryService.getValidatorItem(s.type);if(!l||!l.dropdownType){this.hideDropdown();return}this.showDropdown({location:{workbook:n,worksheet:o,row:r,col:a,unitId:t,subUnitId:e},onHide:i})}};ht=fs([Fe(0,q),Fe(1,S(he)),Fe(2,ja),Fe(3,S(j)),Fe(4,S(Yr)),Fe(5,S(qn)),Fe(6,S(j)),Fe(7,H),Fe(8,Na),Fe(9,S(Me)),Fe(10,dr)],ht);const Fr="DataValidationPanel",pt={id:"data-validation.operation.open-validation-panel",type:ie.OPERATION,handler(t,e){if(!e)return!1;const{ruleId:r,isAdd:a}=e,i=t.get($e),n=t.get(ee),o=t.get(q),s=t.get(Ba),l=cr(o);if(!l)return!1;const{unitId:u,subUnitId:d}=l,c=r?n.getRuleById(u,d,r):void 0;i.open(),i.setActiveRule(c&&{unitId:u,subUnitId:d,rule:c});const h=s.open({id:Fr,header:{title:a?"dataValidation.panel.addTitle":"dataValidation.panel.title"},children:{label:Fr},width:312,onClose:()=>i.close()});return i.setCloseDisposable(h),!0}},Bi={id:"data-validation.operation.close-validation-panel",type:ie.OPERATION,handler(t){return t.get($e).close(),!0}},rn={id:"data-validation.operation.toggle-validation-panel",type:ie.OPERATION,handler(t){const e=t.get(H),r=t.get($e);return r.open(),r.isOpen?e.executeCommand(Bi.id):e.executeCommand(pt.id),!0}},Kr={type:ie.OPERATION,id:"sheet.operation.show-data-validation-dropdown",handler(t,e){if(!e)return!1;const r=t.get(ht),{unitId:a,subUnitId:i,row:n,column:o}=e,s=r.activeDropdown,l=s?.location;return l&&l.unitId===a&&l.subUnitId===i&&l.row===n&&l.col===o||r.showDataValidationDropdown(a,i,n,o),!0}},an={type:ie.OPERATION,id:"sheet.operation.hide-data-validation-dropdown",handler(t,e){return e?(t.get(ht).hideDropdown(),!0):!1}},Jr={type:ie.COMMAND,id:"data-validation.command.addRuleAndOpen",handler(t){const e=t.get(q),r=cr(e);if(!r)return!1;const{workbook:a,worksheet:i}=r,n=Ja(t),o=t.get(H),s=a.getUnitId(),l=i.getSheetId(),u={rule:n,unitId:s,subUnitId:l};return o.syncExecuteCommand(mt.id,u)?(o.syncExecuteCommand(pt.id,{ruleId:n.uid,isAdd:!0}),!0):!1}};var Is=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Rt=(t,e)=>(r,a)=>e(r,a,t);const rt="SHEET_DATA_VALIDATION_ALERT";let sr=class extends ae{constructor(t,e,r,a,i,n){super(),this._hoverManagerService=t,this._cellAlertManagerService=e,this._univerInstanceService=r,this._localeService=a,this._zenZoneService=i,this._dataValidationModel=n,this._init()}_init(){this._initCellAlertPopup(),this._initZenService()}_initCellAlertPopup(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe(Ni(100)).subscribe(t=>{var e;if(t){const r=this._univerInstanceService.getUnit(t.location.unitId,$.UNIVER_SHEET),a=r.getSheetBySheetId(t.location.subUnitId);if(!a)return;const i=this._dataValidationModel.getRuleByLocation(t.location.unitId,t.location.subUnitId,t.location.row,t.location.col);if(!i){this._cellAlertManagerService.removeAlert(rt);return}if(this._dataValidationModel.validator(i,{...t.location,workbook:r,worksheet:a})===re.INVALID){const n=this._cellAlertManagerService.currentAlert.get(rt),o=(e=n?.alert)==null?void 0:e.location;if(o&&o.row===t.location.row&&o.col===t.location.col&&o.subUnitId===t.location.subUnitId&&o.unitId===t.location.unitId){this._cellAlertManagerService.removeAlert(rt);return}const s=this._dataValidationModel.getValidator(i.type);if(!s){this._cellAlertManagerService.removeAlert(rt);return}this._cellAlertManagerService.showAlert({type:jn.ERROR,title:this._localeService.t("dataValidation.error.title"),message:s?.getRuleFinalError(i,t.location),location:t.location,width:200,height:74,key:rt});return}}this._cellAlertManagerService.removeAlert(rt)}))}_initZenService(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(t=>{t&&this._cellAlertManagerService.removeAlert(rt)}))}};sr=Is([Rt(0,S(zn)),Rt(1,S(Zn)),Rt(2,q),Rt(3,S(Ne)),Rt(4,ja),Rt(5,S(j))],sr);var Ss=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},di=(t,e)=>(r,a)=>e(r,a,t);let Dt=class extends ae{constructor(t,e,r){super(),this._autoFillService=t,this._sheetDataValidationModel=e,this._injector=r,this._initAutoFill()}_initAutoFill(){const t=()=>({redos:[],undos:[]}),e=(a,i)=>{const{source:n,target:o,unitId:s,subUnitId:l}=a,u=this._sheetDataValidationModel.getRuleObjectMatrix(s,l).clone(),d=Ci([n,o]),[c,h]=d.ranges,{mapFunc:g}=d,v={row:c.startRow,col:c.startColumn},f=Gn.getAutoFillRepeatRange(c,h),R=new Ze,p=new Set;f.forEach(y=>{const U=y.repeatStartCell,x=y.relativeRange,D={startRow:v.row,startColumn:v.col,endColumn:v.col,endRow:v.row},L={startRow:U.row,startColumn:U.col,endColumn:U.col,endRow:U.row};je.foreach(x,(V,k)=>{const B=fe.getPositionRange({startRow:V,startColumn:k,endColumn:k,endRow:V},D),{row:X,col:G}=g(B.startRow,B.startColumn),z=this._sheetDataValidationModel.getRuleIdByLocation(s,l,X,G)||"",me=fe.getPositionRange({startRow:V,startColumn:k,endColumn:k,endRow:V},L),{row:Se,col:we}=g(me.startRow,me.startColumn);R.setValue(Se,we,z),p.add(z)})});const _=Array.from(p).map(y=>({id:y,ranges:Ei(R,U=>U===y)}));u.addRangeRules(_);const M=u.diff(this._sheetDataValidationModel.getRules(s,l)),{redoMutations:w,undoMutations:b}=ct(s,l,M,this._injector,"patched",i===Wt.ONLY_FORMAT);return{undos:b,redos:w}},r={id:Li,onBeforeFillData:a=>{const{source:i,unitId:n,subUnitId:o}=a;for(const s of i.rows)for(const l of i.cols){const u=this._sheetDataValidationModel.getRuleByLocation(n,o,s,l);if(u&&u.type===C.CHECKBOX){this._autoFillService.setDisableApplyType(Wt.SERIES,!0);return}}},onFillData:(a,i,n)=>n===Wt.COPY||n===Wt.ONLY_FORMAT||n===Wt.SERIES?e(a,n):t(),onAfterFillData:()=>{}};this.disposeWithMe(this._autoFillService.addHook(r))}};Dt=Ss([di(0,Kn),di(1,S(j)),di(2,S(Me))],Dt);var Es=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},ci=(t,e)=>(r,a)=>e(r,a,t);let xt=class extends ae{constructor(t,e,r){super(),O(this,"_copyInfo"),this._sheetClipboardService=t,this._sheetDataValidationModel=e,this._injector=r,this._initCopyPaste()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:Li,onBeforeCopy:(t,e,r)=>this._collect(t,e,r),onPasteCells:(t,e,r,a)=>{const{copyType:i=Gi.COPY,pasteType:n}=a,{range:o}=t||{},{range:s,unitId:l,subUnitId:u}=e;return this._generateMutations(s,{copyType:i,pasteType:n,copyRange:o,unitId:l,subUnitId:u})}})}_collect(t,e,r){const a=new Ze;this._copyInfo={unitId:t,subUnitId:e,matrix:a};const i=this._injector.invoke(s=>Hn(r,s,t,e));if(!i)return;const{rows:n,cols:o}=i;n.forEach((s,l)=>{o.forEach((u,d)=>{const c=this._sheetDataValidationModel.getRuleIdByLocation(t,e,s,u);a.setValue(l,d,c??"")})})}_generateMutations(t,e){if(!this._copyInfo)return{redos:[],undos:[]};if(e.copyType===Gi.CUT)return this._copyInfo=null,{redos:[],undos:[]};if(!this._copyInfo||!this._copyInfo.matrix.getSizeOf()||!e.copyRange)return{redos:[],undos:[]};if([vr.SPECIAL_PASTE_COL_WIDTH,vr.SPECIAL_PASTE_VALUE,vr.SPECIAL_PASTE_FORMAT,vr.SPECIAL_PASTE_FORMULA].includes(e.pasteType))return{redos:[],undos:[]};const{unitId:r,subUnitId:a}=this._copyInfo;if(e.unitId!==r||a!==e.subUnitId){const i=this._sheetDataValidationModel.getRuleObjectMatrix(e.unitId,e.subUnitId).clone(),n=new Ze,o=new Set,{ranges:[s,l],mapFunc:u}=Ci([e.copyRange,t]),d=Yi(s,l,!0),c=new Map;d.forEach(({startRange:f})=>{var R;(R=this._copyInfo)==null||R.matrix.forValue((p,_,M)=>{const w=fe.getPositionRange({startRow:p,endRow:p,startColumn:_,endColumn:_},f),b=`${a}-${M}`,y=this._sheetDataValidationModel.getRuleById(r,a,M);!this._sheetDataValidationModel.getRuleById(e.unitId,e.subUnitId,b)&&y&&c.set(b,{...y,uid:b});const{row:U,col:x}=u(w.startRow,w.startColumn);o.add(b),n.setValue(U,x,b)})});const h=Array.from(o).map(f=>({id:f,ranges:Ei(n,R=>R===f)}));i.addRangeRules(h);const{redoMutations:g,undoMutations:v}=ct(e.unitId,e.subUnitId,i.diffWithAddition(this._sheetDataValidationModel.getRules(e.unitId,e.subUnitId),c.values()),this._injector,"patched",!1);return{redos:g,undos:v}}else{const i=this._sheetDataValidationModel.getRuleObjectMatrix(r,a).clone(),n=new Ze,o=new Set,{ranges:[s,l],mapFunc:u}=Ci([e.copyRange,t]);Yi(s,l,!0).forEach(({startRange:g})=>{var v;(v=this._copyInfo)==null||v.matrix.forValue((f,R,p)=>{const _=fe.getPositionRange({startRow:f,endRow:f,startColumn:R,endColumn:R},g),{row:M,col:w}=u(_.startRow,_.startColumn);n.setValue(M,w,p),o.add(p)})});const d=Array.from(o).map(g=>({id:g,ranges:Ei(n,v=>v===g)}));i.addRangeRules(d);const{redoMutations:c,undoMutations:h}=ct(r,a,i.diff(this._sheetDataValidationModel.getRules(r,a)),this._injector,"patched",!1);return{redos:c,undos:h}}}};xt=Es([ci(0,Jn),ci(1,S(j)),ci(2,S(Me))],xt);var Rs=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},hi=(t,e)=>(r,a)=>e(r,a,t);let kt=class extends ae{constructor(e,r,a){super(),this._localeService=e,this._commandService=r,this._sheetPermissionCheckController=a,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{if(e.id===mt.id){const{unitId:r,subUnitId:a,rule:{ranges:i}}=e.params;this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[bi],rangeTypes:[yi],worksheetTypes:[Ri,wi]},i,r,a)||this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.setStyleErr"))}if(e.id===jt.id){const{unitId:r,subUnitId:a,ranges:i}=e.params;this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[bi],rangeTypes:[yi],worksheetTypes:[Ri,wi]},i,r,a)||this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.setStyleErr"))}}))}};kt=Rs([hi(0,S(Ne)),hi(1,H),hi(2,S(eo))],kt);const nn="sheet.menu.data-validation";function ws(t){return{id:nn,type:xi.SUBITEMS,icon:"DataValidationIcon",tooltip:"dataValidation.title",hidden$:lo(t,$.UNIVER_SHEET),disabled$:Pn(t,{workbookTypes:[bi],worksheetTypes:[wi,Ri],rangeTypes:[yi]})}}function ys(t){return{id:pt.id,title:"dataValidation.panel.title",type:xi.BUTTON}}function bs(t){return{id:Jr.id,title:"dataValidation.panel.add",type:xi.BUTTON}}const Cs={[so.RULES]:{[nn]:{order:0,menuItemFactory:ws,[pt.id]:{order:0,menuItemFactory:ys},[Jr.id]:{order:1,menuItemFactory:bs}}}};var on=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},de=(t,e)=>(r,a)=>e(r,a,t);const sn={tr:{size:6,color:"#fe4b4b"}};let Ot=class extends Gr{constructor(t,e,r,a,i,n,o,s,l,u,d){super(),this._commandService=t,this._menuManagerService=e,this._renderManagerService=r,this._univerInstanceService=a,this._autoHeightController=i,this._dropdownManagerService=n,this._sheetDataValidationModel=o,this._dataValidatorRegistryService=s,this._sheetInterceptorService=l,this._dataValidationCacheService=u,this._editorBridgeService=d,this._initMenu(),this._initDropdown(),this._initViewModelIntercept(),this._initAutoHeight()}_initMenu(){this._menuManagerService.mergeMenu(Cs)}_initDropdown(){this._editorBridgeService&&this.disposeWithMe(this._editorBridgeService.visible$.subscribe(t=>{var e;if(!t.visible){((e=this._dropdownManagerService.activeDropdown)==null?void 0:e.trigger)==="editor-bridge"&&this._dropdownManagerService.hideDropdown();return}const r=this._editorBridgeService.getEditCellState();if(r){const{unitId:a,sheetId:i,row:n,column:o}=r,s=this._univerInstanceService.getUniverSheetInstance(a);if(!s)return;const l=this._sheetDataValidationModel.getRuleByLocation(a,i,n,o);if(!l)return;const u=this._dataValidatorRegistryService.getValidatorItem(l.type);if(!(u!=null&&u.dropdownType))return;const d=s.getActiveSheet();if(!d)return;const c=this._dropdownManagerService.activeDropdown,h=c?.location;if(h&&h.unitId===a&&h.subUnitId===i&&h.row===n&&h.col===o)return;this._dropdownManagerService.showDropdown({location:{unitId:a,subUnitId:i,row:n,col:o,workbook:s,worksheet:d},trigger:"editor-bridge",closeOnOutSide:!1})}}))}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(Ua.CELL_CONTENT,{effect:Sa.Style,priority:Aa.DATA_VALIDATION,handler:(t,e,r)=>{var a,i,n,o,s;const{row:l,col:u,unitId:d,subUnitId:c,workbook:h,worksheet:g}=e,v=this._sheetDataValidationModel.getRuleIdByLocation(d,c,l,u);if(!v)return r(t);const f=this._sheetDataValidationModel.getRuleById(d,c,v);if(!f)return r(t);const R=(a=this._dataValidationCacheService.getValue(d,c,l,u))!=null?a:re.VALID,p=this._dataValidatorRegistryService.getValidatorItem(f.type),_=e.rawData;let M;const w={get value(){var y;return M!==void 0||(M=(y=se(_))!=null?y:null),M}},b={get value(){var y;return`${(y=w.value)!=null?y:""}`}};return(!t||t===e.rawData)&&(t={...e.rawData}),t.markers={...t?.markers,...R===re.INVALID?sn:null},t.customRender=[...(i=t?.customRender)!=null?i:[],...p!=null&&p.canvasRender?[p.canvasRender]:[]],t.fontRenderExtension={...t?.fontRenderExtension,isSkip:((n=t?.fontRenderExtension)==null?void 0:n.isSkip)||((o=p?.skipDefaultFontRender)==null?void 0:o.call(p,f,w.value,e))},t.interceptorStyle={...t?.interceptorStyle,...p?.getExtraStyle(f,b.value,{get style(){const y=h.getStyles();return(typeof t?.s=="string"?y.get(t?.s):t?.s)||{}}},l,u)},t.interceptorAutoHeight=()=>{var y,U,x,D,L,V;const k=(U=(y=this._renderManagerService.getRenderById(d))==null?void 0:y.with(Jt).getSkeletonParam(c))==null?void 0:U.skeleton;if(!k)return;const B=k.worksheet.getMergedCell(l,u),X={data:t,style:k.getStyles().getStyleByCell(t),primaryWithCoord:k.getCellWithCoordByIndex((x=B?.startRow)!=null?x:l,(D=B?.startColumn)!=null?D:u),unitId:d,subUnitId:c,row:l,col:u,workbook:h,worksheet:g};return(V=(L=p?.canvasRender)==null?void 0:L.calcCellAutoHeight)==null?void 0:V.call(L,X)},t.interceptorAutoWidth=()=>{var y,U,x,D,L,V;const k=(U=(y=this._renderManagerService.getRenderById(d))==null?void 0:y.with(Jt).getSkeletonParam(c))==null?void 0:U.skeleton;if(!k)return;const B=k.worksheet.getMergedCell(l,u),X={data:t,style:k.getStyles().getStyleByCell(t),primaryWithCoord:k.getCellWithCoordByIndex((x=B?.startRow)!=null?x:l,(D=B?.startColumn)!=null?D:u),unitId:d,subUnitId:c,row:l,col:u,workbook:h,worksheet:g};return(V=(L=p?.canvasRender)==null?void 0:L.calcCellAutoWidth)==null?void 0:V.call(L,X)},t.coverable=((s=t?.coverable)!=null?s:!0)&&!(f.type===C.LIST||f.type===C.LIST_MULTIPLE),r(t)}}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe(lt(t=>t.source==="command"),Ha(100)).subscribe(t=>{if(t.length===0)return;const e=[];if(t.forEach(r=>{var a;(r.rule.type===C.LIST_MULTIPLE||r.rule.type===C.LIST)&&(a=r.rule)!=null&&a.ranges&&e.push(...r.rule.ranges)}),e.length){const r=this._autoHeightController.getUndoRedoParamsOfAutoHeight(e);$t(r.redos,this._commandService)}})}};Ot=on([de(0,H),de(1,co),de(2,gt),de(3,q),de(4,S(Da)),de(5,S(ht)),de(6,S(j)),de(7,S(he)),de(8,S(hr)),de(9,S(We)),de(10,Mn(Na))],Ot);let la=class extends Gr{constructor(t,e,r,a,i,n,o){super(),this._commandService=t,this._renderManagerService=e,this._autoHeightController=r,this._dataValidatorRegistryService=a,this._sheetInterceptorService=i,this._sheetDataValidationModel=n,this._dataValidationCacheService=o,this._initViewModelIntercept(),this._initAutoHeight()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(Ua.CELL_CONTENT,{effect:Sa.Style,priority:Aa.DATA_VALIDATION,handler:(t,e,r)=>{var a,i,n,o,s;const{row:l,col:u,unitId:d,subUnitId:c,workbook:h,worksheet:g}=e,v=this._sheetDataValidationModel.getRuleIdByLocation(d,c,l,u);if(!v)return r(t);const f=this._sheetDataValidationModel.getRuleById(d,c,v);if(!f)return r(t);const R=(a=this._dataValidationCacheService.getValue(d,c,l,u))!=null?a:re.VALID,p=this._dataValidatorRegistryService.getValidatorItem(f.type),_=g.getCellRaw(l,u),M=se(_),w=`${M??""}`;return(!t||t===e.rawData)&&(t={...e.rawData}),t.markers={...t?.markers,...R===re.INVALID?sn:null},t.customRender=[...(i=t?.customRender)!=null?i:[],...p!=null&&p.canvasRender?[p.canvasRender]:[]],t.fontRenderExtension={...t?.fontRenderExtension,isSkip:((n=t?.fontRenderExtension)==null?void 0:n.isSkip)||((o=p?.skipDefaultFontRender)==null?void 0:o.call(p,f,M,e))},t.interceptorStyle={...t?.interceptorStyle,...p?.getExtraStyle(f,w,{get style(){const b=h.getStyles();return(typeof t?.s=="string"?b.get(t?.s):t?.s)||{}}},l,u)},t.interceptorAutoHeight=()=>{var b,y,U,x,D,L;const V=(y=(b=this._renderManagerService.getRenderById(d))==null?void 0:b.with(Jt).getSkeletonParam(c))==null?void 0:y.skeleton;if(!V)return;const k=V.worksheet.getMergedCell(l,u),B={data:t,style:V.getStyles().getStyleByCell(t),primaryWithCoord:V.getCellWithCoordByIndex((U=k?.startRow)!=null?U:l,(x=k?.startColumn)!=null?x:u),unitId:d,subUnitId:c,row:l,col:u,workbook:h,worksheet:g};return(L=(D=p?.canvasRender)==null?void 0:D.calcCellAutoHeight)==null?void 0:L.call(D,B)},t.interceptorAutoWidth=()=>{var b,y,U,x,D,L;const V=(y=(b=this._renderManagerService.getRenderById(d))==null?void 0:b.with(Jt).getSkeletonParam(c))==null?void 0:y.skeleton;if(!V)return;const k=V.worksheet.getMergedCell(l,u),B={data:t,style:V.getStyles().getStyleByCell(t),primaryWithCoord:V.getCellWithCoordByIndex((U=k?.startRow)!=null?U:l,(x=k?.startColumn)!=null?x:u),unitId:d,subUnitId:c,row:l,col:u,workbook:h,worksheet:g};return(L=(D=p?.canvasRender)==null?void 0:D.calcCellAutoWidth)==null?void 0:L.call(D,B)},t.coverable=((s=t?.coverable)!=null?s:!0)&&!(f.type===C.LIST||f.type===C.LIST_MULTIPLE),r(t)}}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe(lt(t=>t.source==="command"),Ha(16)).subscribe(t=>{const e=[];if(t.forEach(r=>{var a;(r.rule.type===C.LIST_MULTIPLE||r.rule.type===C.LIST)&&(a=r.rule)!=null&&a.ranges&&e.push(...r.rule.ranges)}),e.length){const r=this._autoHeightController.getUndoRedoParamsOfAutoHeight(e);$t(r.redos,this._commandService)}})}};la=on([de(0,H),de(1,gt),de(2,S(Da)),de(3,S(he)),de(4,S(hr)),de(5,S(j)),de(6,S(We))],la);var Vs=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},ua=(t,e)=>(r,a)=>e(r,a,t);let Br=class extends ae{constructor(t,e,r){super(),this._context=t,this._sheetDataValidationModel=e,this._sheetSkeletonManagerService=r,this._initSkeletonChange()}_initSkeletonChange(){const t=e=>{var r;if(!e.length)return;const a=new Set;e.forEach(i=>{a.add(i.subUnitId)}),a.forEach(i=>{var n;(n=this._sheetSkeletonManagerService.getSkeletonParam(i))==null||n.skeleton.makeDirty(!0)}),(r=this._context.mainComponent)==null||r.makeForceDirty()};this.disposeWithMe(this._sheetDataValidationModel.validStatusChange$.pipe(pa(16)).subscribe(t))}};Br=Vs([ua(1,S(j)),ua(2,S(Jt))],Br);function vt({ref:t,...e}){const{icon:r,id:a,className:i,extend:n,...o}=e,s=`univerjs-icon univerjs-icon-${a} ${i||""}`.trim(),l=A.useRef(`_${Us()}`);return ln(r,`${a}`,{defIds:r.defIds,idSuffix:l.current},{ref:t,className:s,...o},n)}function ln(t,e,r,a,i){return A.createElement(t.tag,{key:e,...Ms(t,r,i),...a},(Ts(t,r).children||[]).map((n,o)=>ln(n,`${e}-${t.tag}-${o}`,r,void 0,i)))}function Ms(t,e,r){const a={...t.attrs};r!=null&&r.colorChannel1&&a.fill==="colorChannel1"&&(a.fill=r.colorChannel1),t.tag==="mask"&&a.id&&(a.id=a.id+e.idSuffix),Object.entries(a).forEach(([n,o])=>{n==="mask"&&typeof o=="string"&&(a[n]=o.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))});const{defIds:i}=e;return!i||i.length===0||(t.tag==="use"&&a["xlink:href"]&&(a["xlink:href"]=a["xlink:href"]+e.idSuffix),Object.entries(a).forEach(([n,o])=>{typeof o=="string"&&(a[n]=o.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))})),a}function Ts(t,e){var r;const{defIds:a}=e;return!a||a.length===0?t:t.tag==="defs"&&(r=t.children)!=null&&r.length?{...t,children:t.children.map(i=>typeof i.attrs.id=="string"&&a&&a.includes(i.attrs.id)?{...i,attrs:{...i.attrs,id:i.attrs.id+e.idSuffix}}:i)}:t}function Us(){return Math.random().toString(36).substring(2,8)}vt.displayName="UniverIcon";const As={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.4917 3.07803C1.4917 2.19437 2.20804 1.47803 3.0917 1.47803H5.6917C6.57536 1.47803 7.2917 2.19437 7.2917 3.07803V5.67803C7.2917 6.56168 6.57535 7.27803 5.6917 7.27803H3.0917C2.20804 7.27803 1.4917 6.56168 1.4917 5.67803V3.07803ZM3.0917 2.67803C2.87078 2.67803 2.6917 2.85711 2.6917 3.07803V5.67803C2.6917 5.89894 2.87079 6.07803 3.0917 6.07803H5.6917C5.91261 6.07803 6.0917 5.89894 6.0917 5.67803V3.07803C6.0917 2.85711 5.91261 2.67803 5.6917 2.67803H3.0917Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.6175 2.45279C14.8518 2.68711 14.8518 3.06701 14.6175 3.30132L11.6151 6.30365C11.3957 6.52307 11.0451 6.53897 10.8067 6.34031L8.80915 4.67566C8.55458 4.46352 8.52019 4.08518 8.73233 3.83062C8.94447 3.57605 9.32281 3.54166 9.57737 3.7538L11.154 5.06767L13.769 2.45278C14.0033 2.21847 14.3832 2.21848 14.6175 2.45279Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.1175 9.19746C14.3518 9.43178 14.3518 9.81168 14.1175 10.046L12.5418 11.6217L14.1175 13.1975C14.3518 13.4318 14.3518 13.8117 14.1175 14.046C13.8832 14.2803 13.5033 14.2803 13.269 14.046L11.6933 12.4703L10.1175 14.046C9.88321 14.2803 9.50331 14.2803 9.269 14.046C9.03468 13.8117 9.03468 13.4318 9.269 13.1975L10.8447 11.6217L9.269 10.046C9.03468 9.81168 9.03468 9.43178 9.269 9.19746C9.50331 8.96315 9.88321 8.96315 10.1175 9.19746L11.6933 10.7732L13.269 9.19746C13.5033 8.96315 13.8832 8.96315 14.1175 9.19746Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.0917 8.72168C2.20804 8.72168 1.4917 9.43802 1.4917 10.3217V12.9217C1.4917 13.8053 2.20804 14.5217 3.0917 14.5217H5.6917C6.57535 14.5217 7.2917 13.8053 7.2917 12.9217V10.3217C7.2917 9.43802 6.57536 8.72168 5.6917 8.72168H3.0917ZM2.6917 10.3217C2.6917 10.1008 2.87078 9.92168 3.0917 9.92168H5.6917C5.91261 9.92168 6.0917 10.1008 6.0917 10.3217V12.9217C6.0917 13.1426 5.91261 13.3217 5.6917 13.3217H3.0917C2.87079 13.3217 2.6917 13.1426 2.6917 12.9217V10.3217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},un=A.forwardRef(function(t,e){return A.createElement(vt,Object.assign({},t,{id:"data-validation-icon",ref:e,icon:As}))});un.displayName="DataValidationIcon";const Ns={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993 0.866699 5.9313 0.866699H10.069C10.4004 0.866699 10.669 1.13533 10.669 1.4667C10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443C14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928L9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171C10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778L9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539C9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263L6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539C5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778L6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},$i=A.forwardRef(function(t,e){return A.createElement(vt,Object.assign({},t,{id:"delete-icon",ref:e,icon:Ns}))});$i.displayName="DeleteIcon";const Ds={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},dn=A.forwardRef(function(t,e){return A.createElement(vt,Object.assign({},t,{id:"increase-icon",ref:e,icon:Ds}))});dn.displayName="IncreaseIcon";const xs={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ji=A.forwardRef(function(t,e){return A.createElement(vt,Object.assign({},t,{id:"more-down-icon",ref:e,icon:xs}))});ji.displayName="MoreDownIcon";const ks={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.64645 9.85355C4.45118 9.65829 4.45118 9.34171 4.64645 9.14645L7.64645 6.14645C7.84171 5.95118 8.15829 5.95118 8.35355 6.14645L11.3536 9.14645C11.5488 9.34171 11.5488 9.65829 11.3536 9.85355C11.1583 10.0488 10.8417 10.0488 10.6464 9.85355L8 7.20711L5.35355 9.85355C5.15829 10.0488 4.84171 10.0488 4.64645 9.85355Z",fillRule:"evenodd",clipRule:"evenodd"}}]},cn=A.forwardRef(function(t,e){return A.createElement(vt,Object.assign({},t,{id:"more-up-icon",ref:e,icon:ks}))});cn.displayName="MoreUpIcon";const Os={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M6 5C6.55228 5 7 4.55228 7 4C7 3.44772 6.55228 3 6 3C5.44772 3 5 3.44772 5 4C5 4.55228 5.44772 5 6 5Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6 9C6.55228 9 7 8.55229 7 8C7 7.44772 6.55228 7 6 7C5.44772 7 5 7.44772 5 8C5 8.55229 5.44772 9 6 9Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M7 12C7 12.5523 6.55228 13 6 13C5.44772 13 5 12.5523 5 12C5 11.4477 5.44772 11 6 11C6.55228 11 7 11.4477 7 12Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M10 5C10.5523 5 11 4.55228 11 4C11 3.44772 10.5523 3 10 3C9.44771 3 9 3.44772 9 4C9 4.55228 9.44771 5 10 5Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M11 8C11 8.55229 10.5523 9 10 9C9.44771 9 9 8.55229 9 8C9 7.44772 9.44771 7 10 7C10.5523 7 11 7.44772 11 8Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M10 13C10.5523 13 11 12.5523 11 12C11 11.4477 10.5523 11 10 11C9.44771 11 9 11.4477 9 12C9 12.5523 9.44771 13 10 13Z"}}]},hn=A.forwardRef(function(t,e){return A.createElement(vt,Object.assign({},t,{id:"sequence-icon",ref:e,icon:Os}))});hn.displayName="SequenceIcon";function Ls(t){var e;const r=W(Ne),a=W(ki),{value:i,onChange:n,extraComponent:o}=t,[s,l]=A.useState(!1),u=o?a.get(o):null;return I.jsxs(I.Fragment,{children:[I.jsxs("div",{className:"univer-mb-3 univer-flex univer-cursor-pointer univer-items-center univer-text-sm univer-text-gray-900 dark:!univer-text-white",onClick:()=>l(!s),children:[r.t("dataValidation.panel.options"),s?I.jsx(cn,{className:"univer-ml-1"}):I.jsx(ji,{className:"univer-ml-1"})]}),s&&I.jsxs(I.Fragment,{children:[u?I.jsx(u,{value:i,onChange:n}):null,I.jsx(ne,{label:r.t("dataValidation.panel.invalid"),children:I.jsxs(Oi,{value:`${(e=i.errorStyle)!=null?e:Ye.WARNING}`,onChange:d=>n({...i,errorStyle:+d}),children:[I.jsx(ot,{value:`${Ye.WARNING}`,children:r.t("dataValidation.panel.showWarning")}),I.jsx(ot,{value:`${Ye.STOP}`,children:r.t("dataValidation.panel.rejectInput")})]})}),I.jsx(ne,{label:r.t("dataValidation.panel.messageInfo"),children:I.jsx(Qr,{checked:i.showErrorMessage,onChange:()=>n({...i,showErrorMessage:!i.showErrorMessage}),children:r.t("dataValidation.panel.showInfo")})}),i.showErrorMessage?I.jsx(ne,{children:I.jsx(st,{value:i.error,onChange:d=>n({...i,error:d})})}):null]})]})}const Fs=t=>va(async(e,r,a,i)=>{const n=await t.executeCommand(e,r,a);i?.(n)},1e3);function Bs(t,e,r){var a,i,n,o;return e?((i=(a=t.getUnit(e))==null?void 0:a.getSheetBySheetName(r))==null?void 0:i.getSheetId())||"":((o=(n=t.getCurrentUnitForType($.UNIVER_SHEET))==null?void 0:n.getSheetBySheetName(r))==null?void 0:o.getSheetId())||""}function $s(){var t,e;const[r,a]=A.useState(0),i=W($e),n=Qe(i.activeRule$,i.activeRule),{unitId:o,subUnitId:s,rule:l}=n||{},u=l.uid,d=W(he),c=W(q),h=W(ki),g=W(H),v=W(ee),f=W(Ne),R=Qe(()=>c.getCurrentTypeOfUnit$($.UNIVER_SHEET),void 0,void 0,[]),p=Qe(()=>{var T;return(T=R?.activeSheet$)!=null?T:Ea(null)},void 0,void 0,[]),[_,M]=A.useState(l),w=d.getValidatorItem(_.type),[b,y]=A.useState(!1),U=d.getValidatorsByScope(Pa.SHEET),[x,D]=A.useState(()=>_.ranges.map(T=>({unitId:"",sheetId:"",range:T}))),L=A.useMemo(()=>Fs(g),[g]),[V,k]=A.useState(!1),[B,X]=A.useState(!1),G=A.useRef(null),z=W(Yr);if(A.useEffect(()=>()=>{const T=z.getCurrentLastSelection();T&&z.setSelections([T])},[z]),A.useEffect(()=>{g.onCommandExecuted(T=>{(T.id===yn.id||T.id===bn.id)&&setTimeout(()=>{const K=v.getRuleById(o,s,u);a(ue=>ue+1),K&&(M(K),D(K.ranges.map(ue=>({unitId:"",sheetId:"",range:ue}))))},20)})},[g,v,u,s,o]),!w)return null;const me=w.operators,Se=w.operatorNames,we=_.operator?Ao.includes(_.operator):!1,te=()=>{p?.getSheetId()!==s&&g.syncExecuteCommand(Xn.id,{unitId:o,subUnitId:s})},ye=()=>{var T,K,ue;(K=(T=G.current)==null?void 0:T.editor)!=null&&K.isFocus()&&De((ue=G.current)==null?void 0:ue.getValue()),!(!_.ranges.length||V)&&(w.validatorFormula(_,o,s).success?i.setActiveRule(null):y(!0),te())},De=Vi(T=>{const K=T.split(",").filter(Boolean).map(ba).map(be=>{const Hi=be.sheetName;if(Hi){const vn=Bs(c,be.unitId,Hi);return{...be,sheetId:vn}}return{...be,sheetId:""}});if(Cn(K,x))return;D(K);const ue=K.filter(be=>(!be.unitId||be.unitId===o)&&(!be.sheetId||be.sheetId===s)).map(be=>be.range);if(M({..._,ranges:ue}),ue.length===0)return;const et={unitId:o,subUnitId:s,ruleId:u,ranges:ue};L(jt.id,et)}),pe=T=>{if(Pi(T,er(_)))return;M({..._,...T});const K={unitId:o,subUnitId:s,ruleId:u,setting:T};L(Ut.id,K,void 0)},ge=async()=>{await g.executeCommand(Ht.id,{ruleId:u,unitId:o,subUnitId:s}),i.setActiveRule(null),te()},Te={type:_.type,operator:_.operator,formula1:_.formula1,formula2:_.formula2,allowBlank:_.allowBlank},ve=T=>{const K=d.getValidatorItem(T);if(!K)return;const ue=K.operators,et=v.getRuleById(o,s,u),be=T===et?.type||T.includes("list")&&et!=null&&et.type.includes("list")?{...et,type:T}:{..._,type:T,operator:ue[0],formula1:void 0,formula2:void 0};M(be),g.executeCommand(Ut.id,{unitId:o,subUnitId:s,ruleId:_.uid,setting:er(be)})},le=h.get(w.formulaInput),N=A.useMemo(()=>x.map(T=>Va(T.range)).join(","),[]),P=Tt(_),Y=T=>{Pi(T,Tt(_))||(M({..._,...T}),L(mr.id,{unitId:o,subUnitId:s,ruleId:u,options:T}))},Ee=me.length&&!_.operator;return I.jsxs("div",{"data-u-comp":"data-validation-detail",className:"univer-py-2",children:[I.jsx(ne,{label:f.t("dataValidation.panel.range"),error:!_.ranges.length||V?f.t("dataValidation.panel.rangeError"):"",children:I.jsx(ro,{selectorRef:G,unitId:o,subUnitId:s,initialValue:N,onChange:(T,K)=>{var ue;!B&&(ue=G.current)!=null&&ue.verify()&&De(K)},onFocusChange:(T,K)=>{var ue;X(T),!T&&K&&(ue=G.current)!=null&&ue.verify()&&De(K)},onVerify:T=>k(!T)})}),I.jsx(ne,{label:f.t("dataValidation.panel.type"),children:I.jsx(qi,{className:"univer-w-full",value:_.type,options:(t=U?.sort((T,K)=>T.order-K.order))==null?void 0:t.map(T=>({label:f.t(T.title),value:T.id})),onChange:ve})}),me!=null&&me.length?I.jsx(ne,{label:f.t("dataValidation.panel.operator"),children:I.jsx(qi,{className:"univer-w-full",value:`${_.operator}`,options:[{value:"",label:f.t("dataValidation.operators.legal")},...me.map((T,K)=>({value:`${T}`,label:Se[K]}))],onChange:T=>{pe({...Te,operator:T})}})}):null,le&&!Ee?I.jsx(le,{isTwoFormula:we,value:{formula1:_.formula1,formula2:_.formula2},onChange:T=>{pe({...Te,...T})},showError:b,validResult:w.validatorFormula(_,o,s),unitId:o,subUnitId:s,ruleId:u},r+_.type):null,I.jsx(ne,{children:I.jsx(Qr,{checked:(e=_.allowBlank)!=null?e:!0,onChange:()=>{var T;return pe({...Te,allowBlank:!((T=_.allowBlank)==null||T)})},children:f.t("dataValidation.panel.allowBlank")})}),I.jsx(Ls,{value:P,onChange:Y,extraComponent:w.optionsInput}),I.jsxs("div",{className:"univer-mt-5 univer-flex univer-flex-row univer-justify-end",children:[I.jsx(Mt,{className:"univer-ml-3",onClick:ge,children:f.t("dataValidation.panel.removeRule")}),I.jsx(Mt,{className:"univer-ml-3",variant:"primary",onClick:ye,children:f.t("dataValidation.panel.done")})]})]})}const js=t=>{const{rule:e,onClick:r,unitId:a,subUnitId:i,disable:n}=t,o=W(he),s=W(H),l=W(Qn),u=o.getValidatorItem(e.type),d=A.useRef(void 0),[c,h]=A.useState(!1),g=W(Ra),v=Qe(g.currentTheme$),f=A.useMemo(()=>{var p;const _=g.getColorFromTheme("primary.600"),M=g.getColorFromTheme("loop-color.2"),w=(p=g.getColorFromTheme(M))!=null?p:_,b=new Vn(w).toRgb();return{fill:`rgba(${b.r}, ${b.g}, ${b.b}, 0.1)`,stroke:w}},[v]),R=p=>{s.executeCommand(Ht.id,{ruleId:e.uid,unitId:a,subUnitId:i}),p.stopPropagation()};return A.useEffect(()=>()=>{var p;d.current&&((p=d.current)==null||p.forEach(_=>{_&&l.removeShape(_)}))},[l]),I.jsxs("div",{className:dt(`
                  univer-bg-secondary univer-relative univer--mx-2 univer-box-border univer-flex univer-w-[287px]
                  univer-cursor-pointer univer-flex-col univer-justify-between univer-overflow-hidden univer-rounded-md
                  univer-p-2 univer-pr-9
                `,{"hover:univer-bg-gray-50 dark:hover:!univer-bg-gray-700":!n,"univer-opacity-50":n}),onClick:r,onMouseEnter:()=>{n||(h(!0),d.current=e.ranges.map(p=>l.addShape({range:p,style:f,primary:null})))},onMouseLeave:()=>{var p;h(!1),(p=d.current)==null||p.forEach(_=>{_&&l.removeShape(_)}),d.current=void 0},children:[I.jsx("div",{className:"univer-truncate univer-text-sm univer-font-medium univer-leading-[22px] univer-text-gray-900 dark:!univer-text-white",children:u?.generateRuleName(e)}),I.jsx("div",{className:"univer-text-secondary univer-truncate univer-text-xs univer-leading-[18px] dark:!univer-text-gray-300",children:e.ranges.map(p=>Va(p)).join(",")}),c?I.jsx("div",{className:"univer-absolute univer-right-2 univer-top-[19px] univer-flex univer-size-5 univer-items-center univer-justify-center univer-rounded hover:univer-bg-gray-200 dark:!univer-text-gray-300 dark:hover:!univer-bg-gray-700",onClick:R,children:I.jsx($i,{})}):null]})};function Hs(t){const e=W(j),r=W(q),a=W(H),i=W(Me),n=W($e),o=W(Ne),[s,l]=A.useState([]),{workbook:u}=t,d=Qe(u.activeSheet$,void 0,!0),c=u.getUnitId(),h=d?.getSheetId();A.useEffect(()=>{l(e.getRules(c,h));const p=e.ruleChange$.subscribe(_=>{_.unitId===c&&_.subUnitId===h&&l(e.getRules(c,h))});return()=>{p.unsubscribe()}},[c,h,e]);const g=async()=>{const p=Ja(i),_={unitId:c,subUnitId:h,rule:p};await a.executeCommand(mt.id,_),n.setActiveRule({unitId:c,subUnitId:h,rule:p})},v=()=>{a.executeCommand(zr.id,{unitId:c,subUnitId:h})},f=(p=>{const _=r.getCurrentUnitForType($.UNIVER_SHEET),M=_.getActiveSheet(),w=_.getUnitId(),b=M.getSheetId();return p.map(y=>Yn(i,w,b,y.ranges)?{...y}:{...y,disable:!0})})(s),R=f?.some(p=>p.disable);return I.jsxs("div",{className:"univer-pb-4",children:[f?.map(p=>{var _;return I.jsx(js,{unitId:c,subUnitId:h,onClick:()=>{p.disable||n.setActiveRule({unitId:c,subUnitId:h,rule:p})},rule:p,disable:(_=p.disable)!=null?_:!1},p.uid)}),I.jsxs("div",{className:"univer-mt-4 univer-flex univer-flex-row univer-justify-end univer-gap-2",children:[s.length&&!R?I.jsx(Mt,{onClick:v,children:o.t("dataValidation.panel.removeAll")}):null,I.jsx(Mt,{variant:"primary",onClick:g,children:o.t("dataValidation.panel.add")})]})]})}const Ws=()=>{const t=W($e),e=Qe(t.activeRule$,t.activeRule),r=W(q),a=Qe(()=>r.getCurrentTypeOfUnit$($.UNIVER_SHEET),void 0,void 0,[]),i=Qe(()=>{var n;return(n=a?.activeSheet$)!=null?n:Ea(null)},void 0,void 0,[]);return!a||!i?null:e&&(e.subUnitId===i.getSheetId()||e.subUnitId===t.getFocusFormulaEditorActiveRuleSubUnitId())?I.jsx($s,{},e.rule.uid):I.jsx(Hs,{workbook:a})},Ps=t=>{const{isTwoFormula:e=!1,value:r,onChange:a,showError:i,validResult:n}=t,o=W(Ne),s=i?n?.formula1:"",l=i?n?.formula2:"";return e?I.jsxs(I.Fragment,{children:[I.jsx(ne,{error:s,children:I.jsx(st,{className:"univer-w-full",placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:r?.formula1,onChange:u=>{a?.({...r,formula1:u})}})}),I.jsx("div",{className:"-univer-mt-2 univer-mb-1 univer-text-sm univer-text-gray-400",children:o.t("dataValidation.panel.formulaAnd")}),I.jsx(ne,{error:l,children:I.jsx(st,{className:"univer-w-full",placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:r?.formula2,onChange:u=>{a?.({...r,formula2:u})}})})]}):I.jsx(ne,{error:s,children:I.jsx(st,{className:"univer-w-full",placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:r?.formula1,onChange:u=>{a?.({formula1:u})}})})};function Gs(t){const{value:e,onChange:r,showError:a,validResult:i}=t,n=W(Ne),o=a?i?.formula1:"",s=a?i?.formula2:"",[l,u]=A.useState(!(e?.formula1===void 0&&e?.formula2===void 0));return I.jsxs(I.Fragment,{children:[I.jsx(ne,{children:I.jsx(Qr,{checked:l,onChange:d=>{d?u(!0):(u(!1),r?.({...e,formula1:void 0,formula2:void 0}))},children:n.t("dataValidation.checkbox.tips")})}),l?I.jsx(ne,{label:n.t("dataValidation.checkbox.checked"),error:o,children:I.jsx(st,{className:"univer-w-full",placeholder:n.t("dataValidation.panel.valuePlaceholder"),value:e?.formula1,onChange:d=>{r?.({...e,formula1:d||void 0})}})}):null,l?I.jsx(ne,{label:n.t("dataValidation.checkbox.unchecked"),error:s,children:I.jsx(st,{className:"univer-w-full",placeholder:n.t("dataValidation.panel.valuePlaceholder"),value:e?.formula2,onChange:d=>{r?.({...e,formula2:d||void 0})}})}):null]})}function Ys(t){var e;const{unitId:r,subUnitId:a,value:i,onChange:n,showError:o,validResult:s}=t,l=o?s?.formula1:void 0,u=A.useRef(null),[d,c]=A.useState(!1);return $a(h=>{var g;(g=u.current)!=null&&g.isClickOutSide(h)&&c(!1)}),I.jsx(ne,{error:l,children:I.jsx(La,{ref:u,className:dt("univer-box-border univer-h-8 univer-w-full univer-cursor-pointer univer-items-center univer-rounded-lg univer-bg-white univer-pt-2 univer-transition-colors hover:univer-border-primary-600 dark:!univer-bg-gray-700 dark:!univer-text-white [&>div:first-child]:univer-px-2.5 [&>div]:univer-h-5 [&>div]:univer-ring-transparent",Vr),initValue:(e=i?.formula1)!=null?e:"=",unitId:r,subUnitId:a,isFocus:d,isSupportAcrossSheet:!0,onChange:h=>{const g=(h??"").trim();g!==i?.formula1&&n?.({...i,formula1:g})},onFocus:()=>c(!0)})})}const Qs=["#FFFFFF","#FEE7E7","#FEF0E6","#EFFBD0","#E4F4FE","#E8ECFD","#F1EAFA","#FDE8F3","#E5E5E5","#FDCECE","#FDC49B","#DEF6A2","#9FDAFF","#D0D9FB","#E3D5F6","#FBD0E8","#656565","#FE4B4B","#FF8C51","#8BBB11","#0B9EFB","#3A60F7","#9E6DE3","#F248A6"],Xs=t=>{const{value:e,onChange:r,disabled:a}=t,[i,n]=A.useState(!1);return I.jsx(mo,{align:"start",disabled:a,open:i,onOpenChange:n,overlay:I.jsx("div",{className:"univer-box-border univer-grid univer-w-fit univer-grid-cols-6 univer-flex-wrap univer-gap-2 univer-p-1.5",children:Qs.map(o=>I.jsx("div",{className:dt("univer-box-border univer-size-4 univer-cursor-pointer univer-rounded",Vr),style:{background:o},onClick:()=>{r(o),n(!1)}},o))}),children:I.jsxs("div",{className:dt("univer-box-border univer-inline-flex univer-h-8 univer-w-16 univer-cursor-pointer univer-items-center univer-justify-between univer-gap-2 univer-rounded-lg univer-bg-white univer-px-2.5 univer-transition-colors univer-duration-200 hover:univer-border-primary-600 dark:!univer-bg-gray-700 dark:!univer-text-white",Vr),children:[I.jsx("div",{className:"univer-box-border univer-size-4 univer-rounded univer-text-base",style:{background:e}}),I.jsx(ji,{})]})})},da=t=>{const{item:e,commonProps:r,className:a}=t,{onItemChange:i,onItemDelete:n}=r;return I.jsxs("div",{className:dt("univer-flex univer-items-center univer-gap-2",a),children:[!e.isRef&&I.jsx("div",{className:dt("univer-cursor-move","draggableHandle"),children:I.jsx(hn,{})}),I.jsx(Xs,{value:e.color,onChange:o=>{i(e.id,e.label,o)}}),I.jsx(st,{disabled:e.isRef,value:e.label,onChange:o=>{i(e.id,o,e.color)}}),e.isRef?null:I.jsx("div",{className:"univer-ml-1 univer-cursor-pointer univer-rounded univer-text-base hover:univer-bg-gray-200",children:I.jsx($i,{onClick:()=>n(e.id)})})]})};function qs(t){const{value:e,onChange:r=()=>{},unitId:a,subUnitId:i,validResult:n,showError:o,ruleId:s}=t,{formula1:l="",formula2:u=""}=e||{},[d,c]=A.useState(()=>F(l)?"1":"0"),[h,g]=A.useState(d==="1"?l:"="),[v,f]=A.useState(d==="1"?l:"="),R=W(Ne),p=W(he),_=W(ee),M=W(or),w=W($e),[b,y]=A.useState(()=>u.split(",")),U=p.getValidatorItem(C.LIST),[x,D]=A.useState([]),[L,V]=A.useState(""),k=o?n?.formula1:"",B=A.useMemo(()=>_.ruleChange$.pipe(Ni(16)),[]),X=Qe(B),G=Vi(r);A.useEffect(()=>{(async()=>{await new Promise(Y=>{setTimeout(()=>Y(!0),100)});const N=_.getRuleById(a,i,s),P=N?.formula1;if(F(P)&&U&&N){const Y=await U.getListAsync(N,a,i);D(Y)}})()},[_,X,U,s,i,a]),A.useEffect(()=>{F(l)&&l!==v&&(g(l),f(v))},[v,l]);const[z,me]=A.useState(()=>{const N=d!=="1"?zt(l):[],P=u.split(",");return N.map((Y,Ee)=>({label:Y,color:P[Ee]||nt,isRef:!1,id:ut(4)}))}),Se=(N,P,Y)=>{const Ee=z.find(T=>T.id===N);Ee&&(Ee.label=P,Ee.color=Y,me([...z]))},we=N=>{const P=z.findIndex(Y=>Y.id===N);P!==-1&&(z.splice(P,1),me([...z]))},te=u.split(","),ye=A.useMemo(()=>x.map((N,P)=>({label:N,color:te[P]||nt,id:`${P}`,isRef:!0})),[te,x]),De=(N,P,Y)=>{const Ee=[...b];Ee[+N]=Y,y(Ee),G({formula1:l,formula2:Ee.join(",")})},pe=()=>{me([...z,{label:"",color:nt,isRef:!1,id:ut(4)}])};A.useEffect(()=>{if(d==="1")return;const N=new Set,P=[];z.map(Y=>({labelList:Y.label.split(","),item:Y})).forEach(({item:Y,labelList:Ee})=>{Ee.forEach(T=>{N.has(T)||(N.add(T),P.push({label:T,color:Y.color}))})}),G({formula1:Ya(P.map(Y=>Y.label)),formula2:P.map(Y=>Y.color===nt?"":Y.color).join(",")})},[z,G,d,v,b]);const ge=Vi(async N=>{if(!F(N)){G?.({formula1:"",formula2:u});return}M.getFormulaRefCheck(N)?(G?.({formula1:F(N)?N:"",formula2:u}),V("")):(G?.({formula1:"",formula2:u}),g("="),V(R.t("dataValidation.validFail.formulaError")))}),Te=A.useRef(null),[ve,le]=A.useState(!1);return $a(N=>{var P;(P=Te.current)!=null&&P.isClickOutSide(N)&&le(!1)}),A.useEffect(()=>{ve?w.setFocusFormulaEditorActiveRuleSubUnitId(i):w.setFocusFormulaEditorActiveRuleSubUnitId(null)},[ve,i,w]),I.jsxs(I.Fragment,{children:[I.jsx(ne,{label:R.t("dataValidation.list.options"),children:I.jsxs(Oi,{value:d,onChange:N=>{c(N),g(v),N==="1"&&G({formula1:v==="="?"":v,formula2:b.join(",")})},children:[I.jsx(ot,{value:"0",children:R.t("dataValidation.list.customOptions")}),I.jsx(ot,{value:"1",children:R.t("dataValidation.list.refOptions")})]})}),d==="1"?I.jsxs(ne,{error:k||L||void 0,children:[I.jsx(La,{ref:Te,className:dt("univer-box-border univer-h-8 univer-w-full univer-cursor-pointer univer-items-center univer-rounded-lg univer-bg-white univer-pt-2 univer-transition-colors hover:univer-border-primary-600 dark:!univer-bg-gray-700 dark:!univer-text-white [&>div:first-child]:univer-px-2.5 [&>div]:univer-h-5 [&>div]:univer-ring-transparent",Vr),initValue:h,unitId:a,subUnitId:i,isFocus:ve,isSupportAcrossSheet:!0,onFocus:()=>le(!0),onChange:(N="")=>{const P=(N??"").trim();f(P),ge(P)}}),ye.length>0&&I.jsx("div",{className:"univer-mt-3",children:ye.map(N=>I.jsx(da,{className:"univer-mb-3",item:N,commonProps:{onItemChange:De}},N.id))})]}):I.jsx(ne,{error:k,children:I.jsxs("div",{className:"-univer-mt-3",children:[I.jsx(go,{list:z,onListChange:me,rowHeight:28,margin:[0,12],draggableHandle:".draggableHandle",itemRender:N=>I.jsx(da,{item:N,commonProps:{onItemChange:Se,onItemDelete:we}},N.id),idKey:"id"}),I.jsxs("a",{className:"univer-text-primary univer-flex univer-w-fit univer-cursor-pointer univer-flex-row univer-items-center univer-rounded univer-p-1 univer-px-2 univer-text-sm hover:univer-bg-primary-50 dark:hover:!univer-bg-gray-800",onClick:pe,children:[I.jsx(dn,{className:"univer-mr-1"}),R.t("dataValidation.list.add")]})]})})]})}const zs=[[en,Ys],[Zr,Ps],[Fi,qs],[tn,Gs]],Zs="LIST_RENDER_MODE_OPTION_INPUT";function $r(t){var e;const{value:r,onChange:a}=t,i=W(Ne);return I.jsx(ne,{label:i.t("dataValidation.renderMode.label"),children:I.jsxs(Oi,{value:`${(e=r.renderMode)!=null?e:Re.CUSTOM}`,onChange:n=>a({...r,renderMode:+n}),children:[I.jsx(ot,{value:`${Re.CUSTOM}`,children:i.t("dataValidation.renderMode.chip")}),I.jsx(ot,{value:`${Re.ARROW}`,children:i.t("dataValidation.renderMode.arrow")}),I.jsx(ot,{value:`${Re.TEXT}`,children:i.t("dataValidation.renderMode.text")})]})})}$r.componentKey=Zs;const Ks="DATE_SHOW_TIME_OPTION";function jr(t){var e;const{value:r,onChange:a}=t,i=W(Ne);return I.jsx(ne,{children:I.jsx(Qr,{checked:(e=r.bizInfo)==null?void 0:e.showTime,onChange:n=>{a({...r,bizInfo:{...r.bizInfo,showTime:n}})},children:i.t("dataValidation.showTime.label")})})}jr.componentKey=Ks;var Js=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},wt=(t,e)=>(r,a)=>e(r,a,t);const Rr=6;let Mi=class{constructor(t,e,r,a,i,n){this._commandService=t,this._univerInstanceService=e,this._formulaService=r,this._themeService=a,this._renderManagerService=i,this._dataValidationModel=n}_calc(t,e){var r,a,i;const{vt:n,ht:o}=e||{},s=t.endX-t.startX-Rr*2,l=t.endY-t.startY,u=((r=e?.fs)!=null?r:10)*1.6;let d=0,c=0;switch(n){case Oe.TOP:c=0;break;case Oe.BOTTOM:c=0+(l-u);break;default:c=0+(l-u)/2;break}switch(o){case Ke.LEFT:d=Rr;break;case Ke.RIGHT:d=Rr+(s-u);break;default:d=Rr+(s-u)/2;break}return{left:t.startX+d,top:t.startY+c,width:((a=e?.fs)!=null?a:10)*1.6,height:((i=e?.fs)!=null?i:10)*1.6}}calcCellAutoHeight(t){var e;const{style:r}=t;return((e=r?.fs)!=null?e:10)*1.6}calcCellAutoWidth(t){var e;const{style:r}=t;return((e=r?.fs)!=null?e:10)*1.6}async _parseFormula(t,e,r){var a,i,n,o,s,l,u,d,c;const{formula1:h=rr,formula2:g=ir}=t,v=await this._formulaService.getRuleFormulaResult(e,r,t.uid),f=ze((n=(i=(a=v?.[0])==null?void 0:a.result)==null?void 0:i[0])==null?void 0:n[0]),R=ze((l=(s=(o=v?.[1])==null?void 0:o.result)==null?void 0:s[0])==null?void 0:l[0]),p=oe(String(f))&&oe(String(R));return{formula1:F(h)?ze((c=(d=(u=v?.[0])==null?void 0:u.result)==null?void 0:d[0])==null?void 0:c[0]):h,formula2:F(g)?R:g,isFormulaValid:p}}drawWith(t,e){var r,a,i,n;const{style:o,primaryWithCoord:s,unitId:l,subUnitId:u,worksheet:d,row:c,col:h}=e,g=s.isMergedMainCell?s.mergeInfo:s,v=se(d.getCellRaw(c,h)),f=this._dataValidationModel.getRuleByLocation(l,u,c,h);if(!f)return;const R=this._dataValidationModel.getValidator(f.type);if(!R||!((r=R.skipDefaultFontRender)!=null&&r.call(R,f,v,{unitId:l,subUnitId:u,row:c,column:h})))return;const p=R.parseFormulaSync(f,l,u),{formula1:_}=p,M=this._calc(g,o),{a:w,d:b}=t.getTransform(),y=Qi(M.left,w),U=Qi(M.top,b),x=io.create().composeMatrix({left:y,top:U,scaleX:1,scaleY:1,angle:0,skewX:0,skewY:0,flipX:!1,flipY:!1}),D=g.endX-g.startX,L=g.endY-g.startY;t.save(),t.beginPath(),t.rect(g.startX,g.startY,D,L),t.clip();const V=x.getMatrix();t.transform(V[0],V[1],V[2],V[3],V[4],V[5]);const k=((a=o?.fs)!=null?a:10)*1.6,B=String(v)===String(_),X=this._themeService.getColorFromTheme("primary.600");ao.drawWith(t,{checked:B,width:k,height:k,fill:(n=(i=o?.cl)==null?void 0:i.rgb)!=null?n:X}),t.restore()}isHit(t,e){const r=e.primaryWithCoord.isMergedMainCell?e.primaryWithCoord.mergeInfo:e.primaryWithCoord,a=this._calc(r,e.style),i=a.top,n=a.top+a.height,o=a.left,s=a.left+a.width,{x:l,y:u}=t;return l<=s&&l>=o&&u<=n&&u>=i}async onPointerDown(t,e){var r;if(e.button===2)return;const{primaryWithCoord:a,unitId:i,subUnitId:n,worksheet:o,row:s,col:l}=t,u=se(o.getCellRaw(s,l)),d=this._dataValidationModel.getRuleByLocation(i,n,s,l);if(!d)return;const c=this._dataValidationModel.getValidator(d.type);if(!c||!((r=c.skipDefaultFontRender)!=null&&r.call(c,d,u,{unitId:i,subUnitId:n,row:s,column:l})))return;const{formula1:h,formula2:g}=await this._parseFormula(d,i,n),v={range:{startColumn:a.actualColumn,endColumn:a.actualColumn,startRow:a.actualRow,endRow:a.actualRow},value:{v:String(u)===Xt(String(h))?g:h,p:null}};this._commandService.executeCommand(Qt.id,v)}onPointerEnter(t,e){var r,a;(a=(r=Ct($.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:r.mainComponent)==null||a.setCursor(Vt.POINTER)}onPointerLeave(t,e){var r,a;(a=(r=Ct($.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:r.mainComponent)==null||a.setCursor(Vt.DEFAULT)}};Mi=Js([wt(0,H),wt(1,q),wt(2,S(qe)),wt(3,S(Ra)),wt(4,S(gt)),wt(5,S(j))],Mi);var el=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},tl=(t,e)=>(r,a)=>e(r,a,t);let Pe=class{constructor(t){O(this,"canvasRender",null),O(this,"dropdownType"),O(this,"optionsInput"),O(this,"formulaInput",Fi),this.injector=t}};Pe=el([tl(0,S(Me))],Pe);class rl extends Pe{constructor(){super(...arguments),O(this,"id",C.CHECKBOX),O(this,"canvasRender",this.injector.createInstance(Mi)),O(this,"formulaInput",tn)}}class il extends Pe{constructor(){super(...arguments),O(this,"id",C.CUSTOM),O(this,"formulaInput",en)}}const al="data-validation.formula-input";class nl extends Pe{constructor(){super(...arguments),O(this,"id",C.DATE),O(this,"formulaInput",al),O(this,"optionsInput",jr.componentKey),O(this,"dropdownType",xe.DATE)}}class ol extends Pe{constructor(){super(...arguments),O(this,"id",C.DECIMAL),O(this,"formulaInput",Zr)}}const gn=4,sl=0,gi=4,mn=4,Ti=6,Hr=6,it=14;function ll(t,e){const r=oo.getTextSize(t,e),a=r.width+gn*2,{ba:i,bd:n}=r,o=i+n;return{width:a,height:o+sl*2,ba:i}}function mi(t,e,r,a){const i=it+Ti*2,n=r-i,o=a-Hr*2,s=t.map(h=>({layout:ll(h,e),text:h}));let l;const u=[];s.forEach(h=>{const{layout:g}=h,{width:v,height:f}=g;!l||l.width+v+gi>n?(l={width:v,height:f,items:[{...h,left:0}]},u.push(l)):(l.items.push({...h,left:l.width+gi}),l.width=l.width+v+gi)});let d=0,c=0;return u.forEach((h,g)=>{c=Math.max(c,h.width),g===u.length-1?d+=h.height:d+=h.height+mn}),{lines:u,totalHeight:d,contentWidth:n,contentHeight:o,cellAutoHeight:d+Hr*2,calcAutoWidth:c+i}}const ul=8;class dl extends no{static drawWith(e,r){const{fontString:a,info:i,fill:n,color:o}=r,{layout:s,text:l}=i;e.save(),Fa.drawWith(e,{width:s.width,height:s.height,radius:ul,fill:n||nt}),e.translateWithPrecision(gn,s.ba),e.font=a,e.fillStyle=o,e.fillText(l,0,0),e.restore()}}var cl=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},wr=(t,e)=>(r,a)=>e(r,a,t);const hl=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z");let Ui=class{constructor(t,e,r,a){O(this,"zIndex"),O(this,"_dropdownInfoMap",new Map),this._commandService=t,this._univerInstanceService=e,this._renderManagerService=r,this._dataValidationModel=a}_ensureMap(t){let e=this._dropdownInfoMap.get(t);return e||(e=new Map,this._dropdownInfoMap.set(t,e)),e}_generateKey(t,e){return`${t}.${e}`}_drawDownIcon(t,e,r,a,i){const n=r-it+4;let o=4;switch(i){case Oe.MIDDLE:o=(a-it)/2+4;break;case Oe.BOTTOM:o=a-it+4;break}t.save(),t.translateWithPrecision(e.startX+n,e.startY+o),t.fillStyle="#565656",t.fill(hl),t.restore()}drawWith(t,e,r,a){var i,n;const{primaryWithCoord:o,row:s,col:l,style:u,data:d,subUnitId:c}=e,h=o.isMergedMainCell?o.mergeInfo:o,g=d?.fontRenderExtension,{leftOffset:v=0,rightOffset:f=0,topOffset:R=0,downOffset:p=0}=g||{},_=this._ensureMap(c),M=this._generateKey(s,l),w=o.isMergedMainCell?o.mergeInfo.startRow:s,b=o.isMergedMainCell?o.mergeInfo.startColumn:l,y=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,w,b);if(!y)return;const U=this._dataValidationModel.getValidator(y.type);if(!U)return;const x={startX:h.startX+v,endX:h.endX-f,startY:h.startY+R,endY:h.endY-p},D=x.endX-x.startX,L=x.endY-x.startY,{cl:V}=u||{},k=(i=typeof V=="object"?V?.rgb:V)!=null?i:"#000",B=at(u??void 0),{vt:X,ht:G}=u||{},z=X??Oe.MIDDLE,me=(n=se(d))!=null?n:"",Se=U.parseCellValue(me),we=U.getListWithColorMap(y),te=mi(Se,B,D,L);this._drawDownIcon(t,x,D,L,z),t.save(),t.translateWithPrecision(x.startX,x.startY),t.beginPath(),t.rect(0,0,D-it,L),t.clip(),t.translateWithPrecision(Ti,Hr);let ye=0;switch(z){case Oe.MIDDLE:ye=(te.contentHeight-te.totalHeight)/2;break;case Oe.BOTTOM:ye=te.contentHeight-te.totalHeight;break}t.translateWithPrecision(0,ye),te.lines.forEach((De,pe)=>{t.save();const{width:ge,height:Te,items:ve}=De;let le=0;switch(G){case Ke.RIGHT:le=te.contentWidth-ge;break;case Ke.CENTER:le=(te.contentWidth-ge)/2;break}t.translate(le,pe*(Te+mn)),ve.forEach(N=>{t.save(),t.translateWithPrecision(N.left,0),dl.drawWith(t,{...B,info:N,color:k,fill:we[N.text]}),t.restore()}),t.restore()}),t.restore(),_.set(M,{left:x.startX,top:x.startY,width:te.contentWidth+Ti+it,height:te.contentHeight+Hr*2})}calcCellAutoHeight(t){var e;const{primaryWithCoord:r,style:a,data:i,row:n,col:o}=t,s=i?.fontRenderExtension,{leftOffset:l=0,rightOffset:u=0,topOffset:d=0,downOffset:c=0}=s||{},h=r.isMergedMainCell?r.mergeInfo:r,g={startX:h.startX+l,endX:h.endX-u,startY:h.startY+d,endY:h.endY-c},v=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,n,o);if(!v)return;const f=this._dataValidationModel.getValidator(v.type);if(!f)return;const R=g.endX-g.startX,p=g.endY-g.startY,_=(e=se(i))!=null?e:"",M=f.parseCellValue(_),w=at(a??void 0);return mi(M,w,R,p).cellAutoHeight}calcCellAutoWidth(t){var e;const{primaryWithCoord:r,style:a,data:i,row:n,col:o}=t,s=i?.fontRenderExtension,{leftOffset:l=0,rightOffset:u=0,topOffset:d=0,downOffset:c=0}=s||{},h=r.isMergedMainCell?r.mergeInfo:r,g={startX:h.startX+l,endX:h.endX-u,startY:h.startY+d,endY:h.endY-c},v=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,n,o);if(!v)return;const f=this._dataValidationModel.getValidator(v.type);if(!f)return;const R=g.endX-g.startX,p=g.endY-g.startY,_=(e=se(i))!=null?e:"",M=f.parseCellValue(_),w=at(a??void 0);return mi(M,w,R,p).calcAutoWidth}isHit(t,e){const{primaryWithCoord:r}=e,a=r.isMergedMainCell?r.mergeInfo:r,{endX:i}=a,{x:n}=t;return n>=i-it&&n<=i}onPointerDown(t,e){if(e.button===2)return;const{unitId:r,subUnitId:a,row:i,col:n}=t,o={unitId:r,subUnitId:a,row:i,column:n};this._commandService.executeCommand(Kr.id,o)}onPointerEnter(t,e){var r,a;return(a=(r=Ct($.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:r.mainComponent)==null?void 0:a.setCursor(Vt.POINTER)}onPointerLeave(t,e){var r,a;return(a=(r=Ct($.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:r.mainComponent)==null?void 0:a.setCursor(Vt.DEFAULT)}};Ui=cl([wr(0,H),wr(1,q),wr(2,S(gt)),wr(3,S(j))],Ui);class gl extends Pe{constructor(){super(...arguments),O(this,"id",C.LIST_MULTIPLE),O(this,"canvasRender",this.injector.createInstance(Ui)),O(this,"dropdownType",xe.MULTIPLE_LIST)}}var ml=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Yt=(t,e)=>(r,a)=>e(r,a,t);const yt=4,yr=4,Be=14,pi=1,Ge=6,bt=3,vi=8,pl="#565656",ca=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z");function ha(t,e,r,a,i,n,o=!0){let s=0;const l=o?bt:0;switch(i){case Oe.BOTTOM:s=e-a-l;break;case Oe.MIDDLE:s=(e-a)/2;break;default:s=l;break}s=Math.max(bt,s);let u=0;switch(n){case Ke.CENTER:u=(t-r)/2;break;case Ke.RIGHT:u=t-r;break}return u=Math.max(Ge,u),{paddingLeft:u,paddingTop:s}}let Ai=class{constructor(t,e,r,a,i){O(this,"_dropdownInfoMap",new Map),O(this,"zIndex"),this._univerInstanceService=t,this._localeService=e,this._commandService=r,this._renderManagerService=a,this._dataValidationModel=i}_ensureMap(t){let e=this._dropdownInfoMap.get(t);return e||(e=new Map,this._dropdownInfoMap.set(t,e)),e}_generateKey(t,e){return`${t}.${e}`}_drawDownIcon(t,e,r,a,i,n,o){const{t:s=Ce.pd.t,b:l=Ce.pd.b}=o,u=r-Be;let d;switch(n){case Oe.MIDDLE:d=(a-yr)/2;break;case Oe.BOTTOM:d=a-l-i-bt+(i/2-yr/2);break;default:d=s+bt+(i/2-yr/2);break}t.save(),t.translateWithPrecision(e.startX+u,e.startY+d),t.fillStyle="#565656",t.fill(ca),t.restore()}drawWith(t,e,r){var a,i,n,o,s,l;const{primaryWithCoord:u,row:d,col:c,style:h,data:g,subUnitId:v}=e,f=u.isMergedMainCell?u.mergeInfo:u,R=u.isMergedMainCell?u.mergeInfo.startRow:d,p=u.isMergedMainCell?u.mergeInfo.startColumn:c,_=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,R,p);if(!_)return;const M=this._dataValidationModel.getValidator(_.type);if(!M)return;const w=g?.fontRenderExtension,{leftOffset:b=0,rightOffset:y=0,topOffset:U=0,downOffset:x=0}=w||{};if(!_||!M||!M||M.id.indexOf(C.LIST)!==0||!M.skipDefaultFontRender(_))return;const D={startX:f.startX+b,endX:f.endX-y,startY:f.startY+U,endY:f.endY-x},L=D.endX-D.startX,V=D.endY-D.startY,k=this._ensureMap(v),B=this._generateKey(d,c),X=M.getListWithColorMap(_),G=se(g),z=`${G??""}`,me=X[z];let{tb:Se,vt:we,ht:te,pd:ye}=h||{};Se=Se??Ve.WRAP,we=we??Oe.BOTTOM,te=te??Ce.ht,ye=ye??Ce.pd;const De=at(h).fontCache;if(_.renderMode===Re.ARROW){const{l:pe=Ce.pd.l,t:ge=Ce.pd.t,r:Te=Ce.pd.r,b:ve=Ce.pd.b}=ye,le=L-pe-Te-Be-4,N=new Pt(z,De,Se===Ve.WRAP,le,1/0);N.calculate();const P=N.getTotalWidth(),Y=N.getTotalHeight(),{paddingTop:Ee,paddingLeft:T}=ha(le,V-ge-ve,P,Y,we,te,!0);this._drawDownIcon(t,D,L,V,Y,we,ye),t.save(),t.translateWithPrecision(D.startX+pe,D.startY+ge),t.beginPath(),t.rect(0,0,L-pe-Te,V-ge-ve),t.clip(),t.translateWithPrecision(0,Ee),t.save(),t.translateWithPrecision(T,0),t.beginPath(),t.rect(0,0,le,Y),t.clip(),Xi.drawWith(t,{text:z,fontStyle:De,width:le,height:Y,color:(a=h?.cl)==null?void 0:a.rgb,strokeLine:!!((i=h?.st)!=null&&i.s),underline:!!((n=h?.ul)!=null&&n.s),warp:Se===Ve.WRAP,hAlign:Ke.LEFT},N),t.restore(),t.restore(),k.set(B,{left:D.endX-Be+r.rowHeaderWidth,top:D.startY+ge+r.columnHeaderHeight,width:Be,height:V-ge-ve})}else{t.save(),t.translateWithPrecision(D.startX,D.startY),t.beginPath(),t.rect(0,0,L,V),t.clip();const pe=L-Ge*2-yt-Be-4,ge=new Pt(z,De,Se===Ve.WRAP,pe,1/0);ge.calculate();const Te=ge.getTotalWidth(),ve=ge.getTotalHeight(),le=ve+pi*2,N=Math.max(L-Ge*2,1),{paddingTop:P}=ha(N,V,Te,le,we,te);t.translateWithPrecision(Ge,P),Fa.drawWith(t,{width:N,height:le,fill:me||nt,radius:vi}),t.save(),t.translateWithPrecision(yt,pi),t.beginPath(),t.rect(0,0,pe,ve),t.clip(),Xi.drawWith(t,{text:z,fontStyle:De,width:pe,height:ve,color:(o=h?.cl)==null?void 0:o.rgb,strokeLine:!!((s=h?.st)!=null&&s.s),underline:!!((l=h?.ul)!=null&&l.s),warp:Se===Ve.WRAP,hAlign:Ke.LEFT},ge),t.restore(),t.translateWithPrecision(pe+yt+4,(ve-yr)/2),t.fillStyle=pl,t.fill(ca),t.restore(),k.set(B,{left:D.startX+Ge+r.rowHeaderWidth,top:D.startY+P+r.columnHeaderHeight,width:N,height:le})}}calcCellAutoHeight(t){const{primaryWithCoord:e,style:r,data:a,row:i,col:n}=t,o=e.isMergedMainCell?e.mergeInfo:e,s=a?.fontRenderExtension,{leftOffset:l=0,rightOffset:u=0,topOffset:d=0,downOffset:c=0}=s||{},h=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,i,n);if(!h||h.renderMode===Re.TEXT)return;const g={startX:o.startX+l,endX:o.endX-u,startY:o.startY+d,endY:o.endY-c},v=g.endX-g.startX,f=se(a),R=`${f??""}`;let{tb:p,pd:_}=r||{};const{t:M=Ce.pd.t,b:w=Ce.pd.b}=_??{};if(p=p??Ve.WRAP,h.renderMode===Re.ARROW){const{l:b=Ce.pd.l,r:y=Ce.pd.r}=_??{},U=v-b-y-Be-4,x=new Pt(R,at(r).fontCache,p===Ve.WRAP,U,1/0);return x.calculate(),x.getTotalHeight()+M+w+bt*2}else{const b=Math.max(v-Ge*2-yt-Be-4,10),y=new Pt(R,at(r).fontCache,p===Ve.WRAP,b,1/0);return y.calculate(),y.getTotalHeight()+bt*2+pi*2}}calcCellAutoWidth(t){const{primaryWithCoord:e,style:r,data:a,row:i,col:n}=t,o=e.isMergedMainCell?e.mergeInfo:e,s=a?.fontRenderExtension,{leftOffset:l=0,rightOffset:u=0,topOffset:d=0,downOffset:c=0}=s||{},h=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,i,n);if(!h||h.renderMode===Re.TEXT)return;const g={startX:o.startX+l,endX:o.endX-u,startY:o.startY+d,endY:o.endY-c},v=g.endX-g.startX,f=se(a),R=`${f??""}`;let{tb:p,pd:_}=r||{};const{l:M=Ce.pd.l,r:w=Ce.pd.r}=_??{};p=p??Ve.WRAP;let b=Ge*2+Be;switch(h.renderMode){case Re.ARROW:b=Be+4+w+M;break;case Re.CUSTOM:b=Be+Ge*2+yt*2+w+M+vi/2+1;break;default:b=Be+Ge*2+yt*2+w+M+vi/2+1}const y=v-b,U=new Pt(R,at(r).fontCache,p===Ve.WRAP,y,1/0);return U.calculate(),U.getTotalWidth()+b}isHit(t,e){const{subUnitId:r,row:a,col:i}=e,n=this._ensureMap(r).get(this._generateKey(a,i)),o=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,a,i);if(!o||!n||o.renderMode===Re.TEXT)return!1;const{top:s,left:l,width:u,height:d}=n,{x:c,y:h}=t;return c>=l&&c<=l+u&&h>=s&&h<=s+d}onPointerDown(t,e){if(e.button===2)return;const{unitId:r,subUnitId:a,row:i,col:n}=t,o={unitId:r,subUnitId:a,row:i,column:n};this._commandService.executeCommand(Kr.id,o)}onPointerEnter(t,e){var r,a;(a=(r=Ct($.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:r.mainComponent)==null||a.setCursor(Vt.POINTER)}onPointerLeave(t,e){var r,a;(a=(r=Ct($.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:r.mainComponent)==null||a.setCursor(Vt.DEFAULT)}};Ai=ml([Yt(0,q),Yt(1,S(Ne)),Yt(2,H),Yt(3,S(gt)),Yt(4,S(j))],Ai);class vl extends Pe{constructor(){super(...arguments),O(this,"id",C.LIST),O(this,"canvasRender",this.injector.createInstance(Ai)),O(this,"dropdownType",xe.LIST),O(this,"optionsInput",$r.componentKey),O(this,"formulaInput",Fi)}}class fl extends Pe{constructor(){super(...arguments),O(this,"id",C.TEXT_LENGTH),O(this,"formulaInput",Zr)}}class _l extends Pe{constructor(){super(...arguments),O(this,"id",C.WHOLE),O(this,"formulaInput",Zr)}}var Il=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},fi=(t,e)=>(r,a)=>e(r,a,t);let Lt=class extends Gr{constructor(t,e,r){super(),this._injector=t,this._componentManger=e,this._dataValidatorRegistryService=r,this._initComponents(),this._registerValidatorViews()}_initComponents(){[["DataValidationIcon",un],[Fr,Ws],[$r.componentKey,$r],[jr.componentKey,jr],...zs].forEach(([t,e])=>{this.disposeWithMe(this._componentManger.register(t,e))})}_registerValidatorViews(){[ol,_l,fl,nl,rl,vl,gl,il].forEach(t=>{const e=this._injector.createInstance(t),r=this._dataValidatorRegistryService.getValidatorItem(e.id);r&&(r.formulaInput=e.formulaInput,r.canvasRender=e.canvasRender,r.dropdownType=e.dropdownType,r.optionsInput=e.optionsInput)})}};Lt=Il([fi(0,S(Me)),fi(1,S(ki)),fi(2,S(he))],Lt);var Sl=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},_i=(t,e)=>(r,a)=>e(r,a,t);const El="SHEET_DATA_VALIDATION_UI_PLUGIN";var br;let ga=(br=class extends Wr{constructor(t=Lr,e,r,a){super(),this._config=t,this._injector=e,this._commandService=r,this._configService=a;const{menu:i,...n}=Pr({},Lr,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(Or,n)}onStarting(){[[$e],[ht],[sr],[Dt],[Ot],[kt],[xt],[Lt]].forEach(t=>{this._injector.add(t)}),[Jr,Kr,an,Bi,pt,rn].forEach(t=>{this._commandService.registerCommand(t)})}onReady(){this._injector.get(xt),this._injector.get(kt),this._injector.get(gt).registerRenderModule($.UNIVER_SHEET,[Br])}onRendered(){this._injector.get(Lt),this._injector.get(Ot)}onSteady(){this._injector.get(Dt)}},O(br,"pluginName",El),O(br,"type",$.UNIVER_SHEET),br);ga=Sl([_i(1,S(Me)),_i(2,H),_i(3,dr)],ga);var Rl=Object.defineProperty,wl=(t,e,r)=>e in t?Rl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,yl=(t,e,r,a)=>{for(var i=e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(i=o(i)||i);return i},Ii=(t,e)=>(r,a)=>e(r,a,t),pn=(t,e,r)=>wl(t,typeof e!="symbol"?e+"":e,r);const bl="SHEET_DATA_VALIDATION_UI_PLUGIN";let lr=class extends Wr{constructor(t=Lr,e,r,a){super(),this._config=t,this._injector=e,this._commandService=r,this._configService=a;const{menu:i,...n}=Pr({},Lr,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(Or,n)}onStarting(){[[$e],[ht],[sr],[Dt],[Ot],[kt],[xt],[Nt],[Lt]].forEach(t=>{this._injector.add(t)}),[Jr,Kr,an,Bi,pt,rn].forEach(t=>{this._commandService.registerCommand(t)})}onReady(){this._injector.get(xt),this._injector.get(kt),this._injector.get(Nt),this._injector.get(sr),this._injector.get(gt).registerRenderModule($.UNIVER_SHEET,[Br])}onRendered(){this._injector.get(Lt),this._injector.get(Ot)}onSteady(){this._injector.get(Dt)}};pn(lr,"pluginName",bl);pn(lr,"type",$.UNIVER_SHEET);lr=yl([Ia(At),Ii(1,S(Me)),Ii(2,H),Ii(3,dr)],lr);var Cl=Object.defineProperty,Vl=(t,e,r)=>e in t?Cl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Cr=(t,e,r)=>Vl(t,typeof e!="symbol"?e+"":e,r);class ur{constructor(e){Cr(this,"_rule"),this._rule=e??{uid:ut(),ranges:void 0,type:C.CUSTOM}}build(){return new Ft(this._rule)}copy(){return new ur({...this._rule,uid:ut()})}getAllowInvalid(){return this._rule.errorStyle!==Ye.STOP}getCriteriaType(){return this._rule.type}getCriteriaValues(){return[this._rule.operator,this._rule.formula1,this._rule.formula2]}getHelpText(){return this._rule.error}requireCheckbox(e,r){return this._rule.type=C.CHECKBOX,this._rule.formula1=e,this._rule.formula2=r,this}requireDateAfter(e){return this._rule.type=C.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.operator=m.GREATER_THAN,this}requireDateBefore(e){return this._rule.type=C.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=m.LESS_THAN,this}requireDateBetween(e,r){return this._rule.type=C.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=r.toLocaleDateString(),this._rule.operator=m.BETWEEN,this}requireDateEqualTo(e){return this._rule.type=C.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=m.EQUAL,this}requireDateNotBetween(e,r){return this._rule.type=C.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=r.toLocaleDateString(),this._rule.operator=m.NOT_BETWEEN,this}requireDateOnOrAfter(e){return this._rule.type=C.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=m.GREATER_THAN_OR_EQUAL,this}requireDateOnOrBefore(e){return this._rule.type=C.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=m.LESS_THAN_OR_EQUAL,this}requireFormulaSatisfied(e){return this._rule.type=C.CUSTOM,this._rule.formula1=e,this._rule.formula2=void 0,this}requireNumberBetween(e,r,a){return this._rule.formula1=`${e}`,this._rule.formula2=`${r}`,this._rule.operator=m.BETWEEN,this._rule.type=a?C.WHOLE:C.DECIMAL,this}requireNumberEqualTo(e,r){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=m.EQUAL,this._rule.type=r?C.WHOLE:C.DECIMAL,this}requireNumberGreaterThan(e,r){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=m.GREATER_THAN,this._rule.type=r?C.WHOLE:C.DECIMAL,this}requireNumberGreaterThanOrEqualTo(e,r){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=m.GREATER_THAN_OR_EQUAL,this._rule.type=r?C.WHOLE:C.DECIMAL,this}requireNumberLessThan(e,r){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=m.LESS_THAN,this._rule.type=r?C.WHOLE:C.DECIMAL,this}requireNumberLessThanOrEqualTo(e,r){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=m.LESS_THAN_OR_EQUAL,this._rule.type=r?C.WHOLE:C.DECIMAL,this}requireNumberNotBetween(e,r,a){return this._rule.formula1=`${e}`,this._rule.formula2=`${r}`,this._rule.operator=m.NOT_BETWEEN,this._rule.type=a?C.WHOLE:C.DECIMAL,this}requireNumberNotEqualTo(e,r){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=m.NOT_EQUAL,this._rule.type=r?C.WHOLE:C.DECIMAL,this}requireValueInList(e,r,a){return this._rule.type=r?C.LIST_MULTIPLE:C.LIST,this._rule.formula1=e.join(","),this._rule.formula2=void 0,this._rule.showDropDown=a??!0,this}requireValueInRange(e,r,a){return this._rule.type=r?C.LIST_MULTIPLE:C.LIST,this._rule.formula1=`=${xn({unitId:e.getUnitId(),sheetName:e.getSheetName(),range:e.getRange()})}`,this._rule.formula2=void 0,this._rule.showDropDown=a??!0,this}setAllowInvalid(e){return this._rule.errorStyle=e?Ye.WARNING:Ye.STOP,this}setAllowBlank(e){return this._rule.allowBlank=e,this}setOptions(e){return Object.assign(this._rule,e),this}}class Ft{constructor(e,r,a){Cr(this,"rule"),Cr(this,"_worksheet"),Cr(this,"_injector"),this._injector=a,this.rule=e,this._worksheet=r}getAllowInvalid(){return this.rule.errorStyle!==Ye.STOP}getCriteriaType(){return this.rule.type}getCriteriaValues(){return[this.rule.operator,this.rule.formula1,this.rule.formula2]}getHelpText(){return this.rule.error}copy(){return new ur(this.rule)}getApplied(){if(!this._worksheet)return!1;const e=this._injector.get(ee).getRuleById(this._worksheet.getUnitId(),this._worksheet.getSheetId(),this.rule.uid);return!!(e&&e.ranges.length)}getRanges(){if(!this.getApplied())return[];const e=this._injector.get(q).getUnit(this._worksheet.getUnitId());return this.rule.ranges.map(r=>this._injector.createInstance(Di,e,this._worksheet,r))}getUnitId(){var e;return(e=this._worksheet)==null?void 0:e.getUnitId()}getSheetId(){var e;return(e=this._worksheet)==null?void 0:e.getSheetId()}setCriteria(e,r,a=!0){if(this.getApplied()&&!this._injector.get(H).syncExecuteCommand(Ut.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,setting:{operator:r[0],formula1:r[1],formula2:r[2],type:this.rule.type,allowBlank:a}}))throw new Error("setCriteria failed");return this.rule.operator=r[0],this.rule.formula1=r[1],this.rule.formula2=r[2],this.rule.type=e,this.rule.allowBlank=a,this}setOptions(e){if(this.getApplied()&&!this._injector.get(H).syncExecuteCommand(mr.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,options:{...Tt(this.rule),...e}}))throw new Error("setOptions failed");return Object.assign(this.rule,e),this}setRanges(e){if(this.getApplied()&&!this._injector.get(H).syncExecuteCommand(jt.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,ranges:e.map(r=>r.getRange())}))throw new Error("setRanges failed");return this.rule.ranges=e.map(r=>r.getRange()),this}delete(){return this.getApplied()?this._injector.get(H).syncExecuteCommand(Ht.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid}):!1}}class Ml extends Di{setDataValidation(e){if(!e)return this._commandService.syncExecuteCommand(za.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),ranges:[this._range]}),this;const r={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),rule:{...e.rule,ranges:[this._range]}};return this._commandService.syncExecuteCommand(mt.id,r),this}getDataValidation(){const e=this._injector.get(Ae).getDataValidation(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]);return e&&new Ft(e,this._worksheet,this._injector)}getDataValidations(){return this._injector.get(Ae).getDataValidations(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]).map(e=>new Ft(e,this._worksheet,this._injector))}async getValidatorStatus(){return this._injector.get(Ae).validatorRanges(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range])}async getDataValidationErrorAsync(){const e=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return this._collectValidationErrorsForRange(e,r,[this._range])}async _collectValidationErrorsForRange(e,r,a){if(!a.length)return[];const i=this._injector.get(Ae),n=this._worksheet,o=n.getName(),s=[];for(const l of a){const u=[];for(let d=l.startRow;d<=l.endRow;d++)for(let c=l.startColumn;c<=l.endColumn;c++)u.push((async()=>{var h;try{if(await i.validatorCell(e,r,d,c)!==re.VALID){const g=this._injector.get(j).getRuleByLocation(e,r,d,c);if(g){const v=((h=n.getCell(d,c))==null?void 0:h.v)||null,f=this._createDataValidationError(o,d,c,g,v);s.push(f)}}}catch(g){console.warn(`Failed to validate cell [${d}, ${c}]:`,g)}})());await Promise.all(u)}return s}_createDataValidationError(e,r,a,i,n){return{sheetName:e,row:r,column:a,ruleId:i.uid,inputValue:n,rule:i}}}Di.extend(Ml);class Tl extends Wa{static newDataValidation(){return new ur}newDataValidation(){return new ur}_initialize(e){const r=e.get(H);this.disposeWithMe(this.registerEventHandler(this.Event.SheetDataValidationChanged,()=>e.has(j)?e.get(j).ruleChange$.subscribe(a=>{const{unitId:i,subUnitId:n,rule:o,oldRule:s,type:l}=a,u=this.getSheetTarget(i,n);if(!u)return;const{workbook:d,worksheet:c}=u,h=new Ft(o,c.getSheet(),this._injector);this.fireEvent(this.Event.SheetDataValidationChanged,{origin:a,worksheet:c,workbook:d,changeType:l,oldRule:s,rule:h})}):{dispose:()=>{}})),this.disposeWithMe(this.registerEventHandler(this.Event.SheetDataValidatorStatusChanged,()=>e.has(j)?e.get(j).validStatusChange$.subscribe(a=>{const{unitId:i,subUnitId:n,ruleId:o,status:s,row:l,col:u}=a,d=this.getSheetTarget(i,n);if(!d)return;const{workbook:c,worksheet:h}=d,g=h.getDataValidation(o);g&&this.fireEvent(this.Event.SheetDataValidatorStatusChanged,{workbook:c,worksheet:h,row:l,column:u,rule:g,status:s})}):{dispose:()=>{}})),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeSheetDataValidationAdd,()=>r.beforeCommandExecuted(a=>{if(a.id===mt.id){const i=a.params,n=this.getSheetTarget(i.unitId,i.subUnitId);if(!n)return;const{workbook:o,worksheet:s}=n,l={worksheet:s,workbook:o,rule:i.rule};if(this.fireEvent(this.Event.BeforeSheetDataValidationAdd,l),l.cancel)throw new ft}}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeSheetDataValidationCriteriaUpdate,()=>r.beforeCommandExecuted(a=>{if(a.id===Ut.id){const i=a.params,n=this.getSheetTarget(i.unitId,i.subUnitId);if(!n)return;const{workbook:o,worksheet:s}=n,l=s.getDataValidation(i.ruleId);if(!l)return;const u={worksheet:s,workbook:o,rule:l,ruleId:i.ruleId,newCriteria:i.setting};if(this.fireEvent(this.Event.BeforeSheetDataValidationCriteriaUpdate,u),u.cancel)throw new ft}}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeSheetDataValidationRangeUpdate,()=>r.beforeCommandExecuted(a=>{if(a.id===jt.id){const i=a.params,n=this.getSheetTarget(i.unitId,i.subUnitId);if(!n)return;const{workbook:o,worksheet:s}=n,l=s.getDataValidation(i.ruleId);if(!l)return;const u={worksheet:s,workbook:o,rule:l,ruleId:i.ruleId,newRanges:i.ranges};if(this.fireEvent(this.Event.BeforeSheetDataValidationRangeUpdate,u),u.cancel)throw new ft}}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeSheetDataValidationOptionsUpdate,()=>r.beforeCommandExecuted(a=>{if(a.id===mr.id){const i=a.params,n=this.getSheetTarget(i.unitId,i.subUnitId);if(!n)return;const{workbook:o,worksheet:s}=n,l=s.getDataValidation(i.ruleId);if(!l)return;const u={worksheet:s,workbook:o,rule:l,ruleId:i.ruleId,newOptions:i.options};if(this.fireEvent(this.Event.BeforeSheetDataValidationOptionsUpdate,u),u.cancel)throw new ft}}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeSheetDataValidationDelete,()=>r.beforeCommandExecuted(a=>{if(a.id===Ht.id){const i=a.params,n=this.getSheetTarget(i.unitId,i.subUnitId);if(!n)return;const{workbook:o,worksheet:s}=n,l=s.getDataValidation(i.ruleId);if(!l)return;const u={worksheet:s,workbook:o,rule:l,ruleId:i.ruleId};if(this.fireEvent(this.Event.BeforeSheetDataValidationDelete,u),u.cancel)throw new ft}}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeSheetDataValidationDeleteAll,()=>r.beforeCommandExecuted(a=>{if(a.id===zr.id){const i=a.params,n=this.getSheetTarget(i.unitId,i.subUnitId);if(!n)return;const{workbook:o,worksheet:s}=n,l={worksheet:s,workbook:o,rules:s.getDataValidations()};if(this.fireEvent(this.Event.BeforeSheetDataValidationDeleteAll,l),l.cancel)throw new ft}})))}}Wa.extend(Tl);class Ul extends xa{_initialize(){Object.defineProperty(this,"_dataValidationModel",{get(){return this._injector.get(j)}})}getValidatorStatus(){return this._injector.get(Ae).validatorWorkbook(this._workbook.getUnitId())}async getAllDataValidationErrorAsync(){const e=this._workbook.getUnitId(),r=this._dataValidationModel.getSubUnitIds(e),a=[];for(const i of r){const n=await this._collectValidationErrorsForSheet(e,i);a.push(...n)}return a}async _collectValidationErrorsForSheet(e,r){const a=this._dataValidationModel.getRules(e,r);if(!a.length)return[];const i=a.flatMap(n=>n.ranges);return this._collectValidationErrorsForRange(e,r,i)}async _collectValidationErrorsForRange(e,r,a){if(!a.length)return[];const i=this._injector.get(Ae),n=this._workbook.getSheetBySheetId(r);if(!n)throw new Error(`Cannot find worksheet with sheetId: ${r}`);const o=n.getName(),s=[];for(const l of a){const u=[];for(let d=l.startRow;d<=l.endRow;d++)for(let c=l.startColumn;c<=l.endColumn;c++)u.push((async()=>{var h;try{if(await i.validatorCell(e,r,d,c)!==re.VALID){const g=this._dataValidationModel.getRuleByLocation(e,r,d,c);if(g){const v=((h=n.getCell(d,c))==null?void 0:h.v)||null,f=this._createDataValidationError(o,d,c,g,v);s.push(f)}}}catch(g){console.warn(`Failed to validate cell [${d}, ${c}]:`,g)}})());await Promise.all(u)}return s}_createDataValidationError(e,r,a,i,n){return{sheetName:e,row:r,column:a,ruleId:i.uid,inputValue:n,rule:i}}onDataValidationChange(e){return Ue(this._dataValidationModel.ruleChange$.pipe(lt(r=>r.unitId===this._workbook.getUnitId())).subscribe(e))}onDataValidationStatusChange(e){return Ue(this._dataValidationModel.validStatusChange$.pipe(lt(r=>r.unitId===this._workbook.getUnitId())).subscribe(e))}onBeforeAddDataValidation(e){return Ue(this._commandService.beforeCommandExecuted((r,a)=>{const i=r.params;if(r.id===mt.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,a)===!1)throw new Error("Command is stopped by the hook onBeforeAddDataValidation")}}))}onBeforeUpdateDataValidationCriteria(e){return Ue(this._commandService.beforeCommandExecuted((r,a)=>{const i=r.params;if(r.id===Ut.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,a)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationCriteria")}}))}onBeforeUpdateDataValidationRange(e){return Ue(this._commandService.beforeCommandExecuted((r,a)=>{const i=r.params;if(r.id===jt.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,a)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationRange")}}))}onBeforeUpdateDataValidationOptions(e){return Ue(this._commandService.beforeCommandExecuted((r,a)=>{const i=r.params;if(r.id===mr.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,a)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationOptions")}}))}onBeforeDeleteDataValidation(e){return Ue(this._commandService.beforeCommandExecuted((r,a)=>{const i=r.params;if(r.id===Ht.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,a)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteDataValidation")}}))}onBeforeDeleteAllDataValidation(e){return Ue(this._commandService.beforeCommandExecuted((r,a)=>{const i=r.params;if(r.id===zr.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,a)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteAllDataValidation")}}))}}xa.extend(Ul);class Al extends ka{getDataValidations(){return this._injector.get(ee).getRules(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>new Ft(e,this._worksheet,this._injector))}getValidatorStatus(){return this._injector.get(Ae).validatorWorksheet(this._workbook.getUnitId(),this._worksheet.getSheetId())}getValidatorStatusAsync(){return this.getValidatorStatus()}getDataValidation(e){const r=this._injector.get(ee).getRuleById(this._workbook.getUnitId(),this._worksheet.getSheetId(),e);return r?new Ft(r,this._worksheet,this._injector):null}async getAllDataValidationErrorAsync(){const e=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return this._collectValidationErrorsForSheet(e,r)}async _collectValidationErrorsForSheet(e,r){const a=this._injector.get(ee).getRules(e,r);if(!a.length)return[];const i=a.flatMap(n=>n.ranges);return this._collectValidationErrorsForRange(e,r,i)}async _collectValidationErrorsForRange(e,r,a){if(!a.length)return[];const i=this._injector.get(Ae),n=this._worksheet,o=n.getName(),s=[];for(const l of a){const u=[];for(let d=l.startRow;d<=l.endRow;d++)for(let c=l.startColumn;c<=l.endColumn;c++)u.push((async()=>{var h;try{if(await i.validatorCell(e,r,d,c)!==re.VALID){const g=this._injector.get(j).getRuleByLocation(e,r,d,c);if(g){const v=((h=n.getCell(d,c))==null?void 0:h.v)||null,f=this._createDataValidationError(o,d,c,g,v);s.push(f)}}}catch(g){console.warn(`Failed to validate cell [${d}, ${c}]:`,g)}})());await Promise.all(u)}return s}_createDataValidationError(e,r,a,i,n){return{sheetName:e,row:r,column:a,ruleId:i.uid,inputValue:n,rule:i}}}ka.extend(Al);class Nl{get SheetDataValidationChanged(){return"SheetDataValidationChanged"}get SheetDataValidatorStatusChanged(){return"SheetDataValidatorStatusChanged"}get BeforeSheetDataValidationAdd(){return"BeforeSheetDataValidationAdd"}get BeforeSheetDataValidationDelete(){return"BeforeSheetDataValidationDelete"}get BeforeSheetDataValidationDeleteAll(){return"BeforeSheetDataValidationDeleteAll"}get BeforeSheetDataValidationCriteriaUpdate(){return"BeforeSheetDataValidationCriteriaUpdate"}get BeforeSheetDataValidationRangeUpdate(){return"BeforeSheetDataValidationRangeUpdate"}get BeforeSheetDataValidationOptionsUpdate(){return"BeforeSheetDataValidationOptionsUpdate"}}po.extend(Nl);function tu(t={}){const{showEditOnDropdown:e,showSearchOnDropdown:r}=t;return{plugins:[Tr,At,[lr,{showEditOnDropdown:e,showSearchOnDropdown:r}]].filter(a=>!!a)}}export{Ie as AddDataValidationMutation,mt as AddSheetDataValidationCommand,Zr as BASE_FORMULA_INPUT_NAME,He as BaseDataValidator,Pe as BaseSheetDataValidatorView,rr as CHECKBOX_FORMULA_1,ir as CHECKBOX_FORMULA_2,tn as CHECKBOX_FORMULA_INPUT_NAME,en as CUSTOM_FORMULA_INPUT_NAME,Ho as CheckboxValidator,za as ClearRangeDataValidationCommand,Li as DATA_VALIDATION_PLUGIN_NAME,We as DataValidationCacheService,Xe as DataValidationCustomFormulaService,or as DataValidationFormulaController,qe as DataValidationFormulaService,tr as DataValidationListCacheService,ee as DataValidationModel,Mr as DataValidationResourceController,xe as DataValidatorDropdownType,Pa as DataValidatorRegistryScope,he as DataValidatorRegistryService,Go as DateValidator,ea as FORMULA1,ta as FORMULA2,Fi as LIST_FORMULA_INPUT_NAME,os as ListMultipleValidator,Xa as ListValidator,ce as RemoveDataValidationMutation,zr as RemoveSheetAllDataValidationCommand,Ht as RemoveSheetDataValidationCommand,j as SheetDataValidationModel,Ae as SheetsDataValidationValidatorService,Ao as TWO_FORMULA_OPERATOR_COUNT,ra as TYPE,Uo as TextLengthErrorTitleMap,Tr as UniverDataValidationPlugin,ga as UniverSheetsDataValidationMobileUIPlugin,At as UniverSheetsDataValidationPlugin,tu as UniverSheetsDataValidationPreset,lr as UniverSheetsDataValidationUIPlugin,J as UpdateDataValidationMutation,Q as UpdateRuleType,mr as UpdateSheetDataValidationOptionsCommand,jt as UpdateSheetDataValidationRangeCommand,Ut as UpdateSheetDataValidationSettingCommand,Ja as createDefaultNewRule,zt as deserializeListOptions,Ar as getCellValueNumber,se as getCellValueOrigin,ii as getDataValidationCellValue,ct as getDataValidationDiffMutations,Sr as getFormulaCellData,ze as getFormulaResult,Tt as getRuleOptions,er as getRuleSetting,Xr as getTransformedFormula,oe as isLegalFormulaResult,Ya as serializeListOptions,Xt as transformCheckboxValue};
