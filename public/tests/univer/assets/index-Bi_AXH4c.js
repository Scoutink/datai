import{UniverDocsDrawingPlugin as _r,DocDrawingController as vi}from"./index-CFmm7TGw.js";import{DOCS_DRAWING_PLUGIN as va,DocDrawingService as _a,IDocDrawingService as Sa}from"./index-CFmm7TGw.js";import{IDrawingManagerService as X,UnitDrawingService as _i,UniverDrawingPlugin as xn,SetDrawingSelectedOperation as tt,getDrawingShapeKeyByDrawingSearch as xe,DRAWING_IMAGE_ALLOW_IMAGE_LIST as Yn,DRAWING_IMAGE_COUNT_LIMIT as Xn,DRAWING_IMAGE_ALLOW_SIZE as Hn,getImageSize as Bt,DRAWING_IMAGE_WIDTH_LIMIT as Vn,DRAWING_IMAGE_HEIGHT_LIMIT as zn}from"./index-u4QJ_A0o.js";import{DrawingManagerService as ya,ImageIoService as Ra,URLImageService as Da}from"./index-u4QJ_A0o.js";import{ImageCropperObject as Si,COMPONENT_IMAGE_POPUP_MENU as bi,OpenImageCropOperation as yi,ImageResetSizeOperation as Ri,DrawingCommonPanel as Di,UniverDrawingUIPlugin as Sr,DrawingRenderService as br}from"./index-CLJ8XlZf.js";import{AutoImageCropOperation as Ea,CloseImageCropOperation as Ta,ImagePopupMenu as Ua,SetDrawingAlignOperation as Ma,getCurrentUnitInfo as Aa,getUpdateParams as Oa,insertGroupObject as xa}from"./index-CLJ8XlZf.js";import{L as ie,dT as yr,c5 as Rr,fk as Dr,aB as oe,da as j,aG as P,ea as Te,aw as Cr,bm as O,bo as Re,b7 as Er,bi as me,b6 as H,bf as Ci,bk as re,i as st,fM as kn,aA as Ue,bB as We,u as Me,gm as an,gf as Ei,gn as Ti,aC as xt,g6 as ze,gd as ye,bl as Ge,dS as vn,bR as Kn,bQ as Jn,dj as Zn,c7 as Qn,e as qn,Q as _n,aN as qe,fA as Ui,g0 as dn,cz as Mi,d5 as Ke,bX as Ai,gc as mt,ai as ft,aj as Je,bp as Oi,bP as xi,ah as ki,cm as Pi,aV as Ni,aS as ji,aT as Wi,aU as $i,go as De,ge as er,g7 as tr,bx as Bi,gl as Sn,e8 as Fi,ba as Qt,b9 as Tr,bh as Pn,bd as Gi,dc as Li,bw as Yi,f$ as cn,h as ke}from"./index-BI8deSNo.js";import{cp as Xi,am as Hi,Y as ot,b9 as we,hm as he,p as z,eP as nr,dm as Vi,d$ as zi,eD as Ur,a8 as Ki,dW as Ji,N as rr,gv as Mr,gD as Ar,bW as Ze,ab as Pe,gN as ir,i4 as Zi,R as Qi,bz as qi,aK as es,d4 as sr,bt as Or,be as xr,cm as kr,cf as Pr,aq as Nr,as as jr,bm as Wr,bo as $r,aE as bn,dS as yn,aD as Br,dc as Fr,dT as Gr,e1 as Lr,e0 as Yr,d9 as Xr,bH as Hr,bM as Vr,bK as zr,ee as ts,dV as ns,dU as rs,db as is,da as ss,eI as os,eL as as,eg as ds,i1 as cs,K as vt,m as ls,g4 as or,gp as ar,$ as Rn,z as Dn,b as us,eR as hs,c as gs,i as ms,b0 as fs,b8 as ps,fa as ws,i7 as Kr,f as Jr,gC as Is}from"./facade-BslPbXnu.js";import{aa as Z,bK as qt,aG as Le,at as dr,t as ln,cG as kt,cY as vs,bP as _s,aD as Ye,c as Ss,aS as Zr}from"./index-DnxWP_AP.js";import{aj as J,ak as F,J as bs,o as un,a4 as ys,i as Ee,ae as Rs,ai as Ds,z as hn,P as Cs,u as cr,p as Es,Z as lr}from"./index-BmfxE5KL.js";import{docDrawingPositionToTransform as ur,ReplaceSnapshotCommand as Ts,InnerPasteCommand as Us}from"./index-C5GuqOxb.js";import{a6 as Nn,bE as be,bt as Ae,aj as Ms,an as nt,b8 as As,bF as Os,U as gn,l as mn,aH as xs,ba as en,ao as tn,ax as ks,ac as Ps,ae as Qr,a4 as Ns,n as js,w as pt,ad as Ws,ai as $s}from"./index-BeEHzc6r.js";import{O as qr,j as ei,U as ti,$ as Bs}from"./facade-bHpds0ZF.js";import{J as fn}from"./facade-BFb3hZLS.js";import"./bufferTime-Dc1Jgi3q.js";import"./index-GTTB9Gpg.js";import"./takeUntil-BWepI5Pd.js";import"./index-BBqjqAkl.js";import"./isObservable-DLg0_x3m.js";import"./shareReplay-DR2HpNHE.js";var k=(n=>(n.Position="0",n.Both="1",n.None="2",n))(k||{});class Fs extends _i{}const Y=yr("sheets-drawing.sheet-drawing.service");var M=(n=>(n[n.INSERT=0]="INSERT",n[n.REMOVE=1]="REMOVE",n[n.UPDATE=2]="UPDATE",n[n.ARRANGE=3]="ARRANGE",n[n.GROUP=4]="GROUP",n[n.UNGROUP=5]="UNGROUP",n))(M||{});const A={id:"sheet.mutation.set-drawing-apply",type:ie.MUTATION,handler:(n,e)=>{const t=n.get(X),r=n.get(Y),{op:i,unitId:s,subUnitId:o,type:d,objects:a}=e;switch(t.applyJson1(s,o,i),r.applyJson1(s,o,i),d){case 0:t.addNotification(a),r.addNotification(a);break;case 1:t.removeNotification(a),r.removeNotification(a);break;case 2:t.updateNotification(a),r.updateNotification(a);break;case 3:t.orderNotification(a),r.orderNotification(a);break;case 4:t.groupUpdateNotification(a);break;case 5:t.ungroupUpdateNotification(a);break}return!0}};var Gs=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Xe=(n,e)=>(t,r)=>e(t,r,n);const ni="SHEET_DRAWING_PLUGIN";let Ft=class extends oe{constructor(n,e,t,r,i,s){super(),this._sheetInterceptorService=n,this._univerInstanceService=e,this._commandService=t,this._sheetDrawingService=r,this._drawingManagerService=i,this._resourceManagerService=s,this._initSnapshot(),this._initSheetChange(),this.disposeWithMe(this._commandService.registerCommand(A))}_initSnapshot(){const n=(t,r)=>{const i=r||this._sheetDrawingService.getDrawingDataForUnit(t);return i?JSON.stringify(i):""},e=t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:ni,businesses:[j.UNIVER_SHEET],toJson:(t,r)=>n(t,r),parseJson:t=>e(t),onUnLoad:t=>{this._sheetDrawingService.removeDrawingDataForUnit(t),this._drawingManagerService.removeDrawingDataForUnit(t)},onLoad:(t,r)=>{this._sheetDrawingService.registerDrawingData(t,r),this._drawingManagerService.registerDrawingData(t,r)}}))}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:n=>{var e;if(n.id===Xi.id){const t=n.params,r=t.unitId||this._univerInstanceService.getCurrentUnitOfType(j.UNIVER_SHEET).getUnitId(),i=t.subUnitId||((e=this._univerInstanceService.getCurrentUnitOfType(j.UNIVER_SHEET).getActiveSheet())==null?void 0:e.getSheetId());if(!r||!i)return{redos:[],undos:[]};const s=this._sheetDrawingService.getDrawingData(r,i),o=Object.values(s).filter(h=>h.drawingType!==P.DRAWING_CHART);if(o.length===0)return{redos:[],undos:[]};const d=this._sheetDrawingService.getBatchRemoveOp(o),{unitId:a,subUnitId:c,undo:l,redo:u,objects:g}=d;return{redos:[{id:A.id,params:{op:u,unitId:a,subUnitId:c,objects:g,type:M.REMOVE}}],undos:[{id:A.id,params:{op:l,unitId:a,subUnitId:c,objects:g,type:M.INSERT}}]}}else if(n.id===Hi.id){const t=n.params,{unitId:r,subUnitId:i,targetSubUnitId:s}=t;if(!r||!i||!s)return{redos:[],undos:[]};const o=this._sheetDrawingService.getDrawingData(r,i),d=Object.values(o).filter(p=>p.drawingType!==P.DRAWING_CHART).map(p=>({...p,subUnitId:s,drawingId:Te(6)}));if(d.length===0)return{redos:[],undos:[]};const a=this._sheetDrawingService.getBatchAddOp(d),{unitId:c,subUnitId:l,undo:u,redo:g,objects:h}=a;return{redos:[{id:A.id,params:{op:g,unitId:c,subUnitId:l,objects:h,type:M.INSERT}}],undos:[{id:A.id,params:{op:u,unitId:c,subUnitId:l,objects:h,type:M.REMOVE}}]}}return{redos:[],undos:[]}}}))}};Ft=Gs([Xe(0,O(ot)),Xe(1,O(me)),Xe(2,H),Xe(3,Y),Xe(4,X),Xe(5,Ci)],Ft);const Ls="sheets-drawing.config",hr={};var Ys=Object.defineProperty,Xs=(n,e,t)=>e in n?Ys(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Hs=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},gr=(n,e)=>(t,r)=>e(t,r,n),ri=(n,e,t)=>Xs(n,typeof e!="symbol"?e+"":e,t);let rt=class extends Rr{constructor(n=hr,e,t){super(),this._config=n,this._injector=e,this._configService=t;const{...r}=Dr({},hr,this._config);this._configService.setConfig(Ls,r)}onStarting(){[[Ft],[Y,{useClass:Fs}]].forEach(n=>this._injector.add(n)),this._injector.get(Ft)}};ri(rt,"pluginName",ni);ri(rt,"type",j.UNIVER_SHEET);rt=Hs([Cr(xn),gr(1,O(Re)),gr(2,Er)],rt);var Vs=Object.defineProperty,zs=(n,e,t)=>e in n?Vs(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,fe=(n,e,t)=>zs(n,typeof e!="symbol"?e+"":e,t);function te(n,e,t){const{from:r,to:i,flipY:s=!1,flipX:o=!1,angle:d=0,skewX:a=0,skewY:c=0}=n,l=t.getCurrent();if(l==null)return;const u=Ar(l.unitId,l.sheetId,{from:r,to:i},t);let{left:g,top:h,width:p,height:m}=u;const f=t.getCurrentSkeleton(),w=f.rowHeaderWidth+f.columnTotalWidth,_=f.columnHeaderHeight+f.rowTotalHeight;return g+p>w&&(g=w-p),h+m>_&&(h=_-m),{flipY:s,flipX:o,angle:d,skewX:a,skewY:c,left:g,top:h,width:p,height:m}}function B(n,e){const{left:t=0,top:r=0,width:i=0,height:s=0,flipY:o=!1,flipX:d=!1,angle:a=0,skewX:c=0,skewY:l=0}=n,u=e.getCellWithCoordByOffset(t,r);if(u==null)return;const g={column:u.actualColumn,columnOffset:kt(t-u.startX,1),row:u.actualRow,rowOffset:kt(r-u.startY,1)},h=e.getCellWithCoordByOffset(t+i,r+s);if(h==null)return;const p={column:h.actualColumn,columnOffset:kt(t+i-h.startX,1),row:h.actualRow,rowOffset:kt(r+s-h.startY,1)};return{flipY:o,flipX:d,angle:a,skewX:c,skewY:l,from:g,to:p}}function W(n,e){const{left:t=0,top:r=0,width:i=0,height:s=0,angle:o=0}=n,d=(o%360+360)%360;if(!(d>=45&&d<135||d>=225&&d<315))return B(n,e);const a={...n,left:t+i/2-s/2,top:r+s/2-i/2,width:s,height:i};return B(a,e)}const V={id:"sheet.operation.clear-drawing-transformer",type:ie.MUTATION,handler:(n,e)=>{const t=n.get(Z);return e.forEach(r=>{var i,s;(s=(i=t.getRenderById(r))==null?void 0:i.scene.getTransformer())==null||s.debounceRefreshControls()}),!0}},ge={id:"sheet.command.remove-sheet-image",type:ie.COMMAND,handler:(n,e)=>{var t,r,i;const s=n.get(H),o=n.get(st),d=n.get(ot),a=n.get(Y);if(!e)return!1;const{drawings:c}=e,l=[];c.forEach(b=>{const{unitId:S}=b;l.push(S)});const u=a.getBatchRemoveOp(c),{unitId:g,subUnitId:h,undo:p,redo:m,objects:f}=u,w=d.onCommandExecute({id:ge.id,params:e}),_={id:A.id,params:{unitId:g,subUnitId:h,op:m,objects:f,type:M.REMOVE}},R={id:A.id,params:{unitId:g,subUnitId:h,op:p,objects:f,type:M.INSERT}};return kn([...(t=w.preRedos)!=null?t:[],_,...w.redos],s)?(o.pushUndoRedo({unitID:g,undoMutations:[...(r=w.preUndos)!=null?r:[],R,...w.undos,{id:V.id,params:l}],redoMutations:[...(i=w.preRedos)!=null?i:[],_,...w.redos,{id:V.id,params:l}]}),!0):!1}},ii={id:"sheet.command.delete-drawing",type:ie.COMMAND,handler:n=>{const e=n.get(H),t=n.get(Y).getFocusDrawings();if(t.length===0)return!1;const r=t[0].unitId,i=t.map(s=>{const{unitId:o,subUnitId:d,drawingId:a,drawingType:c}=s;return{unitId:o,subUnitId:d,drawingId:a,drawingType:c}});return e.executeCommand(ge.id,{unitId:r,drawings:i})}};function Ks(n){const e=[];return n.forEach(t=>{const{parent:r,children:i}=t,{unitId:s,subUnitId:o,drawingId:d}=r,a=_s(0,0,i.map(u=>u.transform||{})),c=i.map(u=>{const g=u.transform||{left:0,top:0},{unitId:h,subUnitId:p,drawingId:m}=u;return{unitId:h,subUnitId:p,drawingId:m,transform:{...g,left:g.left-a.left,top:g.top-a.top},groupId:d}}),l={unitId:s,subUnitId:o,drawingId:d,drawingType:P.DRAWING_GROUP,transform:a};e.push({parent:l,children:c})}),e}function Js(n){const e=[];return n.forEach(t=>{const{parent:r,children:i}=t,{unitId:s,subUnitId:o,drawingId:d,transform:a={width:0,height:0}}=r;if(a==null)return;const c=i.map(u=>{const{transform:g}=u,{unitId:h,subUnitId:p,drawingId:m}=u,f=vs(g||{},a,a.width||0,a.height||0);return{unitId:h,subUnitId:p,drawingId:m,transform:f,groupId:void 0}}),l={unitId:s,subUnitId:o,drawingId:d,drawingType:P.DRAWING_GROUP,transform:{left:0,top:0}};e.push({parent:l,children:c})}),e}const si={id:"sheet.command.group-sheet-image",type:ie.COMMAND,handler:(n,e)=>{const t=n.get(H),r=n.get(st),i=n.get(Y);if(!e)return!1;const s=[];e.forEach(({parent:g,children:h})=>{s.push(g.unitId),h.forEach(p=>{s.push(p.unitId)})});const o=i.getGroupDrawingOp(e),{unitId:d,subUnitId:a,undo:c,redo:l,objects:u}=o;return t.syncExecuteCommand(A.id,{op:l,unitId:d,subUnitId:a,objects:u,type:M.GROUP})?(r.pushUndoRedo({unitID:d,undoMutations:[{id:A.id,params:{op:c,unitId:d,subUnitId:a,objects:Js(u),type:M.UNGROUP}},{id:V.id,params:s}],redoMutations:[{id:A.id,params:{op:l,unitId:d,subUnitId:a,objects:u,type:M.GROUP}},{id:V.id,params:s}]}),!0):!1}},ve={id:"sheet.command.insert-sheet-image",type:ie.COMMAND,handler:(n,e)=>{var t,r,i;const s=n.get(H),o=n.get(st),d=n.get(Y),a=n.get(ot);if(!e)return!1;const c=e.drawings,l=c.map(b=>b.unitId),u=d.getBatchAddOp(c),{unitId:g,subUnitId:h,undo:p,redo:m,objects:f}=u,w=a.onCommandExecute({id:ve.id,params:e}),_={id:A.id,params:{op:m,unitId:g,subUnitId:h,objects:f,type:M.INSERT}},R={id:A.id,params:{op:p,unitId:g,subUnitId:h,objects:f,type:M.REMOVE}};return kn([...(t=w.preRedos)!=null?t:[],_,...w.redos],s)?(o.pushUndoRedo({unitID:g,undoMutations:[...(r=w.preUndos)!=null?r:[],R,...w.undos,{id:V.id,params:l}],redoMutations:[...(i=w.preRedos)!=null?i:[],_,...w.redos,{id:V.id,params:l}]}),!0):!1}},Qe={id:"sheet.command.set-drawing-arrange",type:ie.COMMAND,handler:(n,e)=>{const t=n.get(H),r=n.get(st);if(!e)return!1;const i=n.get(Y),{unitId:s,subUnitId:o,drawingIds:d,arrangeType:a}=e,c={unitId:s,subUnitId:o,drawingIds:d};let l;if(a===Me.forward?l=i.getForwardDrawingsOp(c):a===Me.backward?l=i.getBackwardDrawingOp(c):a===Me.front?l=i.getFrontDrawingsOp(c):a===Me.back&&(l=i.getBackDrawingsOp(c)),l==null)return!1;const{objects:u,redo:g,undo:h}=l;return t.syncExecuteCommand(A.id,{op:g,unitId:s,subUnitId:o,objects:u,type:M.ARRANGE})?(r.pushUndoRedo({unitID:s,undoMutations:[{id:A.id,params:{op:h,unitId:s,subUnitId:o,objects:u,type:M.ARRANGE}}],redoMutations:[{id:A.id,params:{op:g,unitId:s,subUnitId:o,objects:u,type:M.ARRANGE}}]}),!0):!1}},ee={id:"sheet.command.set-sheet-image",type:ie.COMMAND,handler:(n,e)=>{var t,r;const i=n.get(H),s=n.get(st),o=n.get(Y),d=n.get(ot);if(!e)return!1;const{drawings:a}=e,c=o.getBatchUpdateOp(a),{unitId:l,subUnitId:u,undo:g,redo:h,objects:p}=c,m=d.onCommandExecute({id:ee.id,params:e}),f=[...(t=m.preRedos)!=null?t:[],{id:A.id,params:{unitId:l,subUnitId:u,op:h,objects:p,type:M.UPDATE}},...m.redos,{id:V.id,params:[l]}],w=[...(r=m.preUndos)!=null?r:[],{id:A.id,params:{unitId:l,subUnitId:u,op:g,objects:p,type:M.UPDATE}},...m.undos,{id:V.id,params:[l]}];return kn(f,i)?(s.pushUndoRedo({unitID:l,undoMutations:w,redoMutations:f}),!0):!1}},oi={id:"sheet.command.ungroup-sheet-image",type:ie.COMMAND,handler:(n,e)=>{const t=n.get(H),r=n.get(st),i=n.get(Y);if(!e)return!1;const s=[];e.forEach(({parent:g,children:h})=>{s.push(g.unitId),h.forEach(p=>{s.push(p.unitId)})});const o=i.getUngroupDrawingOp(e),{unitId:d,subUnitId:a,undo:c,redo:l,objects:u}=o;return t.syncExecuteCommand(A.id,{op:l,unitId:d,subUnitId:a,objects:u,type:M.UNGROUP})?(r.pushUndoRedo({unitID:d,undoMutations:[{id:A.id,params:{op:c,unitId:d,subUnitId:a,objects:Ks(u),type:M.GROUP}},{id:V.id,params:s}],redoMutations:[{id:A.id,params:{op:l,unitId:d,subUnitId:a,objects:u,type:M.UNGROUP}},{id:V.id,params:s}]}),!0):!1}};var Zs=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},de=(n,e)=>(t,r)=>e(t,r,n);function Qs(n,e,t){const r=t*Math.PI/180,i=Math.abs(n*Math.cos(r))+Math.abs(e*Math.sin(r)),s=Math.abs(n*Math.sin(r))+Math.abs(e*Math.cos(r));return{rotatedWidth:i,rotatedHeight:s}}function Cn(n,e,t,r,i){var s;const{rotatedHeight:o,rotatedWidth:d}=Qs(t,r,i),a=n.get(Z).getRenderById(e.unitId);if(!a)return!1;const c=(s=a.with(z).getSkeletonParam(e.subUnitId))==null?void 0:s.skeleton;if(c==null)return!1;const l=c.getCellByIndex(e.row,e.col),u=l.mergeInfo.endX-l.mergeInfo.startX-2,g=l.mergeInfo.endY-l.mergeInfo.startY-2,h=d/o,p=Math.ceil(Math.min(u,g*h))/d,m=!p||Number.isNaN(p)?.001:p;return{width:t*m,height:r*m}}let it=class extends oe{constructor(n,e,t,r,i,s,o,d,a,c,l,u,g,h){super(),fe(this,"_workbookSelections"),this._context=n,this._skeletonManagerService=e,this._commandService=t,this._selectionRenderService=r,this._imageIoService=i,this._fileOpenerService=s,this._sheetDrawingService=o,this._drawingManagerService=d,this._contextService=a,this._messageService=c,this._localeService=l,this._injector=g,this._urlImageService=h,this._workbookSelections=u.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){const n=await this._fileOpenerService.openFile({multiple:!0,accept:Yn.map(t=>`.${t.replace("image/","")}`).join(",")}),e=n.length;return e>Xn?(this._messageService.show({type:Ee.Error,content:this._localeService.t("update-status.exceedMaxCount",String(Xn))}),!1):e===0?!1:(n.forEach(async t=>await this.insertFloatImageByFile(t)),!0)}async insertCellImage(){const n=(await this._fileOpenerService.openFile({multiple:!1,accept:Yn.map(e=>`.${e.replace("image/","")}`).join(",")}))[0];return n?(await this._insertCellImage(n),!0):!1}insertCellImageByFile(n,e){return this._insertCellImage(n,e)}async insertFloatImageByFile(n){var e;let t;try{t=await this._imageIoService.saveImage(n)}catch(R){const b=R.message;b===Ge.ERROR_EXCEED_SIZE?this._messageService.show({type:Ee.Error,content:this._localeService.t("update-status.exceedMaxSize",String(Hn/(1024*1024)))}):b===Ge.ERROR_IMAGE_TYPE?this._messageService.show({type:Ee.Error,content:this._localeService.t("update-status.invalidImageType")}):b===Ge.ERROR_IMAGE&&this._messageService.show({type:Ee.Error,content:this._localeService.t("update-status.invalidImage")})}if(t==null)return;const r=this._getUnitInfo(),{unitId:i,subUnitId:s}=r,{imageId:o,imageSourceType:d,source:a,base64Cache:c}=t,{width:l,height:u,image:g}=await Bt(c||""),{width:h,height:p}=this._context.scene;this._imageIoService.addImageSourceCache(a,d,g);let m=1;if(l>Vn||u>zn){const R=Vn/l,b=zn/u;m=Math.max(R,b)}const f=this._getImagePosition(l*m,u*m,h,p);if(f==null)return;const w=te(f,this._selectionRenderService,this._skeletonManagerService),_={unitId:i,subUnitId:s,drawingId:o,drawingType:P.DRAWING_IMAGE,imageSourceType:d,source:a,transform:w,sheetTransform:f,axisAlignSheetTransform:(e=W(w,this._selectionRenderService))!=null?e:f};return this._commandService.executeCommand(ve.id,{unitId:i,drawings:[_]})}async _insertCellImage(n,e){var t,r;let i;try{i=await this._imageIoService.saveImage(n)}catch(b){const S=b.message;S===Ge.ERROR_EXCEED_SIZE?this._messageService.show({type:Ee.Error,content:this._localeService.t("update-status.exceedMaxSize",String(Hn/(1024*1024)))}):S===Ge.ERROR_IMAGE_TYPE?this._messageService.show({type:Ee.Error,content:this._localeService.t("update-status.invalidImageType")}):S===Ge.ERROR_IMAGE&&this._messageService.show({type:Ee.Error,content:this._localeService.t("update-status.invalidImage")})}if(i==null)return!1;const{imageId:s,imageSourceType:o,source:d,base64Cache:a}=i,{width:c,height:l,image:u}=await Bt(a||"");this._imageIoService.addImageSourceCache(d,o,u);const g=this._workbookSelections.getCurrentLastSelection();if(!g)return!1;let h=g.primary.actualRow,p=g.primary.actualColumn;g.primary.isMerged&&(h=g.primary.startRow,p=g.primary.startColumn);const m=vn("",{}),f=Cn(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:h,col:p},c,l,0);if(!f)return!1;const w={size:{width:f.width,height:f.height},positionH:{relativeFrom:Jn.PAGE,posOffset:0},positionV:{relativeFrom:Kn.PARAGRAPH,posOffset:0},angle:0},_={unitId:m.getUnitId(),subUnitId:m.getUnitId(),drawingId:s,drawingType:P.DRAWING_IMAGE,imageSourceType:o,source:d,transform:ur(w),docTransform:w,behindDoc:qn.FALSE,title:"",description:"",layoutType:Qn.INLINE,wrapText:Zn.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},R=_n.drawing.add({documentDataModel:m,drawings:[_],selection:{collapsed:!0,startOffset:0,endOffset:0}});return R?(m.apply(R),this._commandService.syncExecuteCommand(rr.id,{value:{[(t=e?.row)!=null?t:h]:{[(r=e?.col)!=null?r:p]:{p:m.getSnapshot(),t:1}}},unitId:e?.unitId,subUnitId:e?.subUnitId})):!1}async insertCellImageByUrl(n,e){var t,r;let i=n;try{i=await this._urlImageService.getImage(n)}catch(p){console.error(`Failed to get image from URLImageService: ${n}`,p)}const{width:s,height:o,image:d}=await Bt(i||"");this._imageIoService.addImageSourceCache(n,re.URL,d);const a=this._workbookSelections.getCurrentLastSelection();if(!a)return!1;const c=vn("",{}),l=Cn(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:a.primary.actualRow,col:a.primary.actualColumn},s,o,0);if(!l)return!1;const u={size:{width:l.width,height:l.height},positionH:{relativeFrom:Jn.PAGE,posOffset:0},positionV:{relativeFrom:Kn.PARAGRAPH,posOffset:0},angle:0},g={unitId:c.getUnitId(),subUnitId:c.getUnitId(),drawingId:Te(),drawingType:P.DRAWING_IMAGE,imageSourceType:re.URL,source:n,transform:ur(u),docTransform:u,behindDoc:qn.FALSE,title:"",description:"",layoutType:Qn.INLINE,wrapText:Zn.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},h=_n.drawing.add({documentDataModel:c,drawings:[g],selection:{collapsed:!0,startOffset:0,endOffset:0}});return h?(c.apply(h),this._commandService.syncExecuteCommand(rr.id,{value:{[(t=e?.row)!=null?t:a.primary.actualRow]:{[(r=e?.col)!=null?r:a.primary.actualColumn]:{p:c.getSnapshot(),t:1}}},unitId:e?.unitId,subUnitId:e?.subUnitId})):!1}_getUnitInfo(){const n=this._context.unit,e=n.getActiveSheet(),t=n.getUnitId(),r=e.getSheetId();return{unitId:t,subUnitId:r}}_getImagePosition(n,e,t,r){const i=this._workbookSelections.getCurrentSelections();let s={startRow:0,endRow:0,startColumn:0,endColumn:0};i&&i.length>0&&(s=i[i.length-1].range);const o=Mr(this._skeletonManagerService.getCurrent().skeleton,s);if(o==null)return;let{startColumn:d,startRow:a,startX:c,startY:l}=o,u=!1;if(c+n>t&&(c=t-n,c<0&&(c=0,n=t),u=!0),l+e>r&&(l=r-e,l<0&&(l=0,e=r),u=!0),u){const m=this._selectionRenderService.getCellWithCoordByOffset(c,l);if(m==null)return;c=m.startX,l=m.startY,d=m.actualColumn,a=m.actualRow}const g={column:d,columnOffset:0,row:a,rowOffset:0},h=this._selectionRenderService.getCellWithCoordByOffset(c+n,l+e);if(h==null)return;const p={column:h.actualColumn,columnOffset:c+n-h.startX,row:h.actualRow,rowOffset:l+e-h.startY};return{from:g,to:p}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(n=>{const{unitId:e,subUnitId:t,drawingIds:r,arrangeType:i}=n;this._commandService.executeCommand(Qe.id,{unitId:e,subUnitId:t,drawingIds:r,arrangeType:i})}))}_updateImageListener(){this.disposeWithMe(this._drawingManagerService.featurePluginUpdate$.subscribe(n=>{const e=[];n.length!==0&&(n.forEach(t=>{const{unitId:r,subUnitId:i,drawingId:s,drawingType:o,transform:d}=t;if(d==null)return;const a=this._sheetDrawingService.getDrawingByParam({unitId:r,subUnitId:i,drawingId:s});if(a==null||a.unitId!==this._context.unitId)return;const c=B({...a.transform,...d},this._selectionRenderService),l=W({...a.transform,...d},this._selectionRenderService);if(c==null||l==null)return;const u={...t,transform:{...a.transform,...d,...te(c,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...c},axisAlignSheetTransform:{...l}};e.push(u)}),e.length>0&&this._commandService.executeCommand(ee.id,{unitId:n[0].unitId,drawings:e}))}))}_getSheetTransformByParam(n){const{unitId:e,subUnitId:t,drawingId:r,transform:i}=n;if(i==null)return null;const s=this._sheetDrawingService.getDrawingByParam({unitId:e,subUnitId:t,drawingId:r});if(s==null||s.unitId!==this._context.unitId)return null;const o=B({...s.transform,...i},this._selectionRenderService),d=W({...s.transform,...i},this._selectionRenderService);return o==null||d==null?null:{sheetTransform:o,axisAlignSheetTransform:d}}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(n=>{const e=[];for(const t of n){const r=this._getSheetTransformByParam(t.parent),i=[];for(const o of t.children){const d=this._getSheetTransformByParam(o);d!=null&&i.push({...o,sheetTransform:d.sheetTransform,axisAlignSheetTransform:d.axisAlignSheetTransform})}const s={parent:{...t.parent,sheetTransform:r},children:i};e.push(s)}if(e.length>0){this._commandService.executeCommand(si.id,e);const{unitId:t,subUnitId:r,drawingId:i}=n[0].parent;this._commandService.syncExecuteCommand(tt.id,[{unitId:t,subUnitId:r,drawingId:i}])}})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(n=>{const e=[];for(const t of n){const{children:r}=t,i=[];for(const s of r){const o=this._getSheetTransformByParam(s);o!=null&&i.push({...s,sheetTransform:o})}e.push({...t,children:i})}this._commandService.executeCommand(oi.id,e)}))}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(n=>{n==null||n.length===0?(this._contextService.setContextValue(qe,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(qe,!0),this._sheetDrawingService.focusDrawing(n))}))}};it=Zs([de(1,O(z)),de(2,H),de(3,we),de(4,Qt),de(5,Ps),de(6,Y),de(7,X),de(8,Tr),de(9,Qr),de(10,O(We)),de(11,O(vt)),de(12,O(Re)),de(13,Pn)],it);const nn={id:"sheet.command.insert-float-image",type:ie.COMMAND,handler:async(n,e)=>{var t,r;const i=n.get(me),s=n.get(Z),o=(t=qt(j.UNIVER_SHEET,i,s))==null?void 0:t.with(it);if(!o)return!1;const d=e?.files;if(d){const a=d.map(c=>o.insertFloatImageByFile(c));return(await Promise.all(a)).every(c=>c)}else return(r=o.insertFloatImage())!=null?r:!1}},jn={id:"sheet.command.insert-cell-image",type:ie.COMMAND,handler:n=>{var e,t;const r=n.get(me),i=n.get(Z);return(t=(e=qt(j.UNIVER_SHEET,r,i))==null?void 0:e.with(it).insertCellImage())!=null?t:!1}},_t={id:"sheet.command.move-drawing",type:ie.COMMAND,handler:(n,e)=>{const t=n.get(H),r=n.get(Y),i=n.get(we),{direction:s}=e,o=r.getFocusDrawings();if(o.length===0)return!1;const d=o[0].unitId,a=o.map(c=>{const{transform:l}=c;if(l==null)return null;const u={...l},{left:g=0,top:h=0}=l;return s===Ue.UP?u.top=h-1:s===Ue.DOWN?u.top=h+1:s===Ue.LEFT?u.left=g-1:s===Ue.RIGHT&&(u.left=g+1),{...c,transform:u,sheetTransform:B(u,i),axisAlignSheetTransform:W(u,i)}}).filter(c=>c!=null);return t.syncExecuteCommand(ee.id,{unitId:d,drawings:a})?(t.syncExecuteCommand(V.id,[d]),!0):!1}};var qs=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Pt=(n,e)=>(t,r)=>e(t,r,n),le=(n=>(n.CELL_ADDRESS="cellAddress",n.COLUMN_VALUE="columnValue",n))(le||{});const St=yr("sheets-drawing-ui.batch-save-images.service");function En(n){let e="",t=n;for(;t>=0;)e=String.fromCharCode(t%26+65)+e,t=Math.floor(t/26)-1;return e}function Gt(n,e){return`${En(e)}${n+1}`}function eo(n){const e=Gt(n.startRow,n.startColumn),t=Gt(n.endRow,n.endColumn);return e===t?e:`${e}:${t}`}function mr(n){var e,t,r,i;return!!((t=(e=n?.p)==null?void 0:e.drawingsOrder)!=null&&t.length&&((i=(r=n?.p)==null?void 0:r.drawingsOrder)==null?void 0:i.length)>0)}function fr(n){var e,t,r;if(!((t=(e=n.p)==null?void 0:e.drawingsOrder)!=null&&t.length)||!((r=n.p)!=null&&r.drawings))return null;const i=n.p.drawingsOrder[0],s=n.p.drawings[i];return!s||!("source"in s)||!("imageSourceType"in s)?null:s}function pn(n,e){if(e===re.BASE64){const t=n.match(/^data:image\/(\w+);/);if(t)return t[1]==="jpeg"?"jpg":t[1]}if(e===re.URL){const t=n.match(/\.(\w+)(?:\?|$)/);if(t)return t[1].toLowerCase()}return"png"}async function pr(n,e){if(e===re.BASE64)return(await fetch(n)).blob();if(e===re.URL)return(await fetch(n)).blob();throw new Error("UUID image type requires additional handling")}let Tn=class extends oe{constructor(n,e,t,r){super(),this._univerInstanceService=n,this._selectionService=e,this._imageIoService=t,this._urlImageService=r}registerURLImageDownloader(n){return this._urlImageService.registerURLImageDownloader(n)}getCellImagesInSelection(){const n=this._univerInstanceService.getCurrentUnitForType(j.UNIVER_SHEET);if(!n)return[];const e=n.getActiveSheet();if(!e)return[];const t=this._selectionService.getCurrentSelections();if(!t||t.length===0)return[];const r=e.getCellMatrix(),i=[];for(const s of t){const{startRow:o,endRow:d,startColumn:a,endColumn:c}=s.range;for(let l=o;l<=d;l++)for(let u=a;u<=c;u++){const g=r.getValue(l,u);if(mr(g)){const h=fr(g);h&&i.push({row:l,col:u,cellAddress:Gt(l,u),source:h.source,imageSourceType:h.imageSourceType,imageId:h.drawingId})}}}return i}getCellImagesFromRanges(n,e,t){const r=this._univerInstanceService.getUnit(n,j.UNIVER_SHEET);if(!r)return[];const i=r.getSheetBySheetId(e);if(!i)return[];const s=i.getCellMatrix(),o=[];for(const d of t){const{startRow:a,endRow:c,startColumn:l,endColumn:u}=d;for(let g=a;g<=c;g++)for(let h=l;h<=u;h++){const p=s.getValue(g,h);if(mr(p)){const m=fr(p);m&&o.push({row:g,col:h,cellAddress:Gt(g,h),source:m.source,imageSourceType:m.imageSourceType,imageId:m.drawingId})}}}return o}getDataColumns(){var n,e,t,r;const i=this._univerInstanceService.getCurrentUnitForType(j.UNIVER_SHEET);if(!i)return[];const s=i.getActiveSheet();if(!s)return[];const o=this._selectionService.getCurrentSelections();if(!o||o.length===0)return[];const d=s.getCellMatrix(),a=d.getDataRange();let c=1/0,l=-1/0;const u=new Set;for(const m of o){c=Math.min(c,m.range.startRow),l=Math.max(l,m.range.endRow);for(let f=m.range.startColumn;f<=m.range.endColumn;f++)u.add(f)}const g=new Set;for(let m=a.startColumn;m<=a.endColumn;m++)if(!u.has(m))for(let f=c;f<=l;f++){const w=d.getValue(f,m);if(w&&((n=w.v)!=null&&n.toString()||(r=(t=(e=w.p)==null?void 0:e.body)==null?void 0:t.dataStream)!=null&&r.trim())){g.add(m);break}}const h=[],p=Array.from(g).sort((m,f)=>m-f);for(const m of p)h.push({index:m,label:En(m)});return h}getDataColumnsForRanges(n,e,t){var r,i,s,o;const d=this._univerInstanceService.getUnit(n,j.UNIVER_SHEET);if(!d)return[];const a=d.getSheetBySheetId(e);if(!a)return[];const c=a.getCellMatrix(),l=c.getDataRange();let u=1/0,g=-1/0;const h=new Set;for(const w of t){u=Math.min(u,w.startRow),g=Math.max(g,w.endRow);for(let _=w.startColumn;_<=w.endColumn;_++)h.add(_)}const p=new Set;for(let w=l.startColumn;w<=l.endColumn;w++)if(!h.has(w))for(let _=u;_<=g;_++){const R=c.getValue(_,w);if(R&&((r=R.v)!=null&&r.toString()||(o=(s=(i=R.p)==null?void 0:i.body)==null?void 0:s.dataStream)!=null&&o.trim())){p.add(w);break}}const m=[],f=Array.from(p).sort((w,_)=>w-_);for(const w of f)m.push({index:w,label:En(w)});return m}getSelectionRangeNotation(){const n=this._selectionService.getCurrentSelections();return!n||n.length===0?"":n.map(e=>eo(e.range)).join(", ")}getSelectionRowRange(){const n=this._selectionService.getCurrentSelections();if(!n||n.length===0)return null;let e=1/0,t=-1/0;for(const r of n)e=Math.min(e,r.range.startRow),t=Math.max(t,r.range.endRow);return{startRow:e,endRow:t}}getSelectionColumnIndices(){const n=this._selectionService.getCurrentSelections();if(!n||n.length===0)return new Set;const e=new Set;for(const t of n)for(let r=t.range.startColumn;r<=t.range.endColumn;r++)e.add(r);return e}generateFileName(n,e){var t,r,i,s;const o=this._univerInstanceService.getCurrentUnitForType(j.UNIVER_SHEET),d=pn(n.source,n.imageSourceType),a=[];for(const c of e.fileNameParts)if(c==="cellAddress")a.push(n.cellAddress);else if(c==="columnValue"&&e.columnIndex!==void 0){const l=o?.getActiveSheet();if(l){const u=l.getCellMatrix().getValue(n.row,e.columnIndex);if(u){const g=((t=u.v)==null?void 0:t.toString())||((s=(i=(r=u.p)==null?void 0:r.body)==null?void 0:i.dataStream)==null?void 0:s.trim())||"";if(g){const h=g.replace(/[<>:"/\\|?*]/g,"_").trim();h&&a.push(h)}}}}return a.length===0?`${n.cellAddress}.${d}`:`${a.join("_")}.${d}`}generateFileNameWithContext(n,e,t,r){var i,s,o,d;const a=this._univerInstanceService.getUnit(t,j.UNIVER_SHEET),c=pn(n.source,n.imageSourceType),l=[];for(const u of e.fileNameParts)if(u==="cellAddress")l.push(n.cellAddress);else if(u==="columnValue"&&e.columnIndex!==void 0){const g=a?.getSheetBySheetId(r);if(g){const h=g.getCellMatrix().getValue(n.row,e.columnIndex);if(h){const p=((i=h.v)==null?void 0:i.toString())||((d=(o=(s=h.p)==null?void 0:s.body)==null?void 0:o.dataStream)==null?void 0:d.trim())||"";if(p){const m=p.replace(/[<>:"/\\|?*]/g,"_").trim();m&&l.push(m)}}}}return l.length===0?`${n.cellAddress}.${c}`:`${l.join("_")}.${c}`}async saveImages(n,e){var t;const r=await window.showDirectoryPicker({mode:"readwrite"}),i=new Map;for(const s of n){let o=this.generateFileName(s,e);const d=o.replace(/\.\w+$/,""),a=((t=o.match(/\.\w+$/))==null?void 0:t[0])||".png",c=i.get(d)||0;c>0&&(o=`${d}_${c}${a}`),i.set(d,c+1);try{const l=await this._getImageBlob(s),u=await(await r.getFileHandle(o,{create:!0})).createWritable();await u.write(l),await u.close()}catch(l){throw console.error(`Failed to save image ${o}:`,l),l}}}async saveImagesWithContext(n,e,t,r){var i;const s=await window.showDirectoryPicker({mode:"readwrite"}),o=new Map;for(const d of n){let a=this.generateFileNameWithContext(d,e,t,r);const c=a.replace(/\.\w+$/,""),l=((i=a.match(/\.\w+$/))==null?void 0:i[0])||".png",u=o.get(c)||0;u>0&&(a=`${c}_${u}${l}`),o.set(c,u+1);try{const g=await this._getImageBlob(d),h=await(await s.getFileHandle(a,{create:!0})).createWritable();await h.write(g),await h.close()}catch(g){throw console.error(`Failed to save image ${a}:`,g),g}}}async downloadSingleImage(n){const e=pn(n.source,n.imageSourceType),t=`${n.cellAddress}.${e}`;try{const r=await this._getImageBlob(n),i=URL.createObjectURL(r),s=document.createElement("a");s.href=i,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}catch(r){throw console.error(`Failed to download image ${t}:`,r),r}}async _getImageBlob(n){if(n.imageSourceType===re.UUID){const e=await this._imageIoService.getImage(n.source);return pr(e,re.URL)}return n.imageSourceType===re.URL?this._urlImageService.downloadImage(n.source):pr(n.source,n.imageSourceType)}};Tn=qs([Pt(0,me),Pt(1,O(vt)),Pt(2,Qt),Pt(3,Pn)],Tn);const et="sheet.dialog.batch-save-images",wt={id:"sheet.command.save-cell-images",type:ie.COMMAND,handler:async n=>{const e=n.get(Nn),t=n.get(St),r=t.getCellImagesInSelection();if(r.length===1)try{return await t.downloadSingleImage(r[0]),!0}catch(d){return console.error("Failed to download image:",d),!1}const i=n.get(We),s=t.getSelectionRangeNotation(),o=`${i.t("sheetImage.save.title")} (${s})`;return e.open({id:et,draggable:!0,width:360,title:{title:o},children:{label:et},destroyOnClose:!0,preservePositionOnDestroy:!0,onClose:()=>e.close(et)}),!0}},ai="COMPONENT_SHEET_DRAWING_PANEL",di={id:"sidebar.operation.sheet-image",type:ie.COMMAND,handler:async(n,e)=>{const t=n.get(Ms),r=n.get(We),i=n.get(me),s=n.get(H);return he(i)?(e.value==="open"?t.open({header:{title:r.t("sheetImage.panel.title")},children:{label:ai},onClose:()=>{s.syncExecuteCommand(tt.id,[])},width:360}):t.close(),!0):!1}},ci={id:"sheet.operation.edit-sheet-image",type:ie.OPERATION,handler:(n,e)=>{const t=n.get(H);return e==null?!1:(t.syncExecuteCommand(tt.id,[e]),t.executeCommand(di.id,{value:"open"}),!0)}},to="sheets-drawing-ui.config",wr={};var no=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Ie=(n,e)=>(t,r)=>e(t,r,n);let Lt=class extends Mi{constructor(n,e,t,r,i,s,o,d,a,c){super(),fe(this,"_initImagePopupMenu",new Set),this._injector=n,this._localeService=e,this._drawingManagerService=t,this._canvasPopManagerService=r,this._renderManagerService=i,this._univerInstanceService=s,this._messageService=o,this._contextService=d,this._ioService=a,this._commandService=c,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(j.UNIVER_SHEET).subscribe(n=>this._create(n)),this._univerInstanceService.getTypeOfUnitDisposed$(j.UNIVER_SHEET).subscribe(n=>this._dispose(n)),this._univerInstanceService.getAllUnitsForType(j.UNIVER_SHEET).forEach(n=>this._create(n)),this._setupLoadingStatus()}_setupLoadingStatus(){const n="image-upload-loading";let e;this.disposeWithMe(this._ioService.change$.subscribe(t=>{t>0&&!e?e=this._messageService.show({id:n,type:Ee.Loading,content:`${this._localeService.t("uploadLoading.loading")}: ${t}`,duration:0}):t===0&&(e?.dispose(),e=void 0)}))}_dispose(n){super.dispose();const e=n.getUnitId();this._renderManagerService.removeRender(e),this._initImagePopupMenu.delete(e)}_create(n){if(!n)return;const e=n.getUnitId();this._renderManagerService.has(e)&&!this._initImagePopupMenu.has(e)&&(this._popupMenuListener(e),this._initImagePopupMenu.add(e))}_hasCropObject(n){const e=n.getAllObjectsByOrder();for(const t of e)if(t instanceof Si)return!0;return!1}_popupMenuListener(n){var e;const t=(e=this._renderManagerService.getRenderById(n))==null?void 0:e.scene;if(!t)return;const r=t.getTransformerByCreate();if(!r)return;let i;this.disposeWithMe(r.createControl$.subscribe(()=>{if(this._contextService.setContextValue(qe,!0),this._hasCropObject(t))return;const s=r.getSelectedObjectMap();if(s.size>1){i?.dispose();return}const o=s.values().next().value;if(!o)return;const d=o.oKey,a=this._drawingManagerService.getDrawingOKey(d);if(!a)return;const{unitId:c,subUnitId:l,drawingId:u,drawingType:g}=a,h=a.data;if(h&&h.disablePopup)return;i?.dispose();const p=this._canvasPopManagerService.getFeatureMenu(c,l,u,g);i=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(o,{componentKey:bi,direction:"horizontal",offset:[2,0],extraProps:{menuItems:p||this._getImageMenuItems(c,l,u,g)}}))})),this.disposeWithMe(r.clearControl$.subscribe(()=>{i?.dispose(),this._contextService.setContextValue(qe,!1),this._commandService.syncExecuteCommand(tt.id,[])})),this.disposeWithMe(this._contextService.contextChanged$.subscribe(s=>{s[qe]===!1&&i?.dispose()})),this.disposeWithMe(r.changing$.subscribe(()=>{i?.dispose()}))}_getImageMenuItems(n,e,t,r){return[{label:"image-popup.edit",index:0,commandId:ci.id,commandParams:{unitId:n,subUnitId:e,drawingId:t},disable:r===P.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:ge.id,commandParams:{unitId:n,drawings:[{unitId:n,subUnitId:e,drawingId:t}]},disable:!1},{label:"image-popup.crop",index:2,commandId:yi.id,commandParams:{unitId:n,subUnitId:e,drawingId:t},disable:r===P.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:Ri.id,commandParams:[{unitId:n,subUnitId:e,drawingId:t}],disable:r===P.DRAWING_DOM}]}};Lt=no([Ie(0,O(Re)),Ie(1,O(We)),Ie(2,X),Ie(3,O(hs)),Ie(4,Z),Ie(5,me),Ie(6,Qr),Ie(7,Tr),Ie(8,Qt),Ie(9,H)],Lt);var ro=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Nt=(n,e)=>(t,r)=>e(t,r,n);let Un=class extends oe{constructor(n,e,t,r,i){super(),fe(this,"_isSetCursor",!1),this._context=n,this._hoverManagerService=e,this._selectionsService=t,this._drawingRenderService=r,this._sheetSkeletonManagerService=i,this._initHover(),this._initImageClick()}_initHover(){this.disposeWithMe(this._hoverManagerService.currentRichTextNoDistinct$.pipe(Os(33)).subscribe(n=>{var e,t;let r=[];n!==null&&(r=this._selectionsService.getWorkbookSelections(this._context.unitId).getCurrentSelections()),r.length>0&&n?.unitId===this._context.unitId&&n!=null&&n.drawing&&r.length===1&&((e=r[0].primary)==null?void 0:e.actualRow)===n.row&&((t=r[0].primary)==null?void 0:t.actualColumn)===n.col?(this._isSetCursor=!0,this._context.scene.setCursor(Ss.ZOOM_IN)):this._isSetCursor&&(this._isSetCursor=!1,this._context.scene.resetCursor())}))}_initImageClick(){this.disposeWithMe(this._hoverManagerService.currentClickedCell$.subscribe(n=>{var e;if(n!=null&&n.drawing&&this._isSetCursor){const t=n.drawing.drawing.drawingOrigin,r=(e=this._sheetSkeletonManagerService.getCurrentSkeleton())==null?void 0:e.imageCacheMap.getImage(t.imageSourceType,t.source);if(!r)return;this._drawingRenderService.previewImage("preview-cell-image",r.src,r.width,r.height),this._context.scene.resetCursor(),this._isSetCursor=!1}}))}};Un=ro([Nt(1,O(gs)),Nt(2,O(vt)),Nt(3,O(br)),Nt(4,O(z))],Un);var io=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},jt=(n,e)=>(t,r)=>e(t,r,n);let Mn=class extends oe{constructor(n,e,t,r,i){super(),this._context=n,this._sheetDrawingService=e,this._drawingManagerService=t,this._sheetSelectionRenderService=r,this._sheetSkeletonManagerService=i,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){this._sheetDrawingService.initializeNotification(this._context.unitId);const n=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(const e in n){const t=n[e];for(const r in t.data){const i=t.data[r];i.sheetTransform&&(i.transform=te(i.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService))}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}};Mn=io([jt(1,Y),jt(2,X),jt(3,O(we)),jt(4,O(z))],Mn);var so=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},He=(n,e)=>(t,r)=>e(t,r,n);function li(n,e,t){var r,i,s,o;if(((i=(r=t?.p)==null?void 0:r.body)==null?void 0:i.dataStream.length)===3&&((o=(s=t.p)==null?void 0:s.drawingsOrder)==null?void 0:o.length)===1){const d=t.p.drawings[t.p.drawingsOrder[0]],a=Cn(n,{unitId:e.unitId,subUnitId:e.subUnitId,row:e.row,col:e.col},d.docTransform.size.width,d.docTransform.size.height,d.docTransform.angle);if(a)return d.transform.width=a.width,d.transform.height=a.height,d.docTransform.size.width=a.width,d.docTransform.size.height=a.height,d.transform.left=0,d.transform.top=0,d.docTransform.positionH.posOffset=0,d.docTransform.positionV.posOffset=0,t.p.documentStyle.pageSize.width=1/0,t.p.documentStyle.pageSize.height=1/0,!0}return!1}let Yt=class extends oe{constructor(n,e,t,r,i,s){super(),this._commandService=n,this._sheetInterceptorService=e,this._injector=t,this._drawingManagerService=r,this._docDrawingController=i,this._editorBridgeService=s,this._handleInitEditor(),this._initCellContentInterceptor()}_handleInitEditor(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(n=>{n.visible?n.visible&&(this._drawingManagerService.removeDrawingDataForUnit(ft),this._docDrawingController.loadDrawingDataForUnit(ft),this._drawingManagerService.initializeNotification(ft)):this._drawingManagerService.removeDrawingDataForUnit(ft)})),this.disposeWithMe(this._commandService.onCommandExecuted(n=>{n.id===Ts.id&&n.params.unitId===Je&&(this._drawingManagerService.removeDrawingDataForUnit(Je),this._docDrawingController.loadDrawingDataForUnit(Je),this._drawingManagerService.initializeNotification(Je))}))}_initCellContentInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(Qi.CELL_CONTENT,{effect:Oi.Style,priority:qi.CELL_IMAGE,handler:(n,e,t)=>{var r;return n!=null&&n.p&&(r=n.p.drawingsOrder)!=null&&r.length&&(n===e.rawData&&(n={...e.rawData}),n.interceptorStyle||(n.interceptorStyle={}),n.interceptorStyle.tr={a:0},li(this._injector,{unitId:e.unitId,subUnitId:e.subUnitId,row:e.row,col:e.col},n)),t(n)}}))}};Yt=so([He(0,H),He(1,O(ot)),He(2,O(Re)),He(3,X),He(4,O(vi)),He(5,O(ms))],Yt);var oo=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Ir=(n,e)=>(t,r)=>e(t,r,n);let Xt=class extends oe{constructor(n,e){super(),this._autoFillService=n,this._injector=e,this._initAutoFillHooks()}_initAutoFillHooks(){this.disposeWithMe(this._autoFillService.addHook({id:"sheet-cell-image-autofill",onBeforeSubmit:(n,e,t,r)=>{new xi(r).forValue((i,s,o)=>{li(this._injector,{unitId:n.unitId,subUnitId:n.subUnitId,row:i,col:s},o)})}}))}};Xt=oo([Ir(0,O(fs)),Ir(1,O(Re))],Xt);var ao=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},lt=(n,e)=>(t,r)=>e(t,r,n);const co=[ft,ki,Je];let Ht=class extends oe{constructor(n,e,t,r,i){super(),this._commandService=n,this._univerInstanceService=e,this._dialogService=t,this._renderManagerService=r,this._localeService=i,this._initDocImageCopyPasteHooks()}_setCellImage(n){var e;const t=vn("",{}),r=(e=qt(j.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:e.with(es),i=_n.drawing.add({documentDataModel:t,drawings:[n],selection:{collapsed:!0,startOffset:0,endOffset:0}});i&&(t.apply(i),r&&r.submitCellData(t))}_initDocImageCopyPasteHooks(){this.disposeWithMe(this._commandService.beforeCommandExecuted(n=>{var e,t;if(n.id===Us.id){const r=n.params,{doc:i}=r,s=this._univerInstanceService.getCurrentUnitOfType(j.UNIVER_DOC);if(s==null||!Object.keys((e=i.drawings)!=null?e:{}).length)return;const o=s.getUnitId();if(co.includes(o)){if(o!==Je){const d=()=>{this._dialogService.close("sheet-cell-image-copy-paste"),this._commandService.syncExecuteCommand(sr.id,{visible:!1})};((t=s.getBody())==null?void 0:t.dataStream)===`\r
`?(this._commandService.syncExecuteCommand(sr.id,{visible:!1}),this._setCellImage(Object.values(i.drawings)[0])):this._dialogService.open({id:"sheet-cell-image-copy-paste",title:{label:this._localeService.t("cell-image.pasteTitle")},children:{label:this._localeService.t("cell-image.pasteContent")},width:320,destroyOnClose:!0,onClose:d,showOk:!0,showCancel:!0,onOk:()=>{d(),this._setCellImage(Object.values(i.drawings)[0])},onCancel:d})}throw new Error("Sheet cell image copy paste is not supported in this unit")}}}))}};Ht=ao([lt(0,H),lt(1,me),lt(2,Nn),lt(3,Z),lt(4,O(We))],Ht);var lo=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},ut=(n,e)=>(t,r)=>e(t,r,n);const ui="image/png";function uo(n){const e=n.split(","),t=atob(e[1]),r=t.length,i=new Uint8Array(r);for(let s=0;s<r;s++)i[s]=t.charCodeAt(s);return new Blob([i],{type:ui})}function ho(n){const e=new ClipboardItem({[ui]:uo(n)});navigator.clipboard.write([e]).catch(t=>{console.error("Could not copy image using clipboard API: ",t)})}function go(){function n(){const r=document.createElement("input");return r.style.position="absolute",r.style.height="1px",r.style.width="1px",r.style.opacity="0",r}const e=document.activeElement,t=n();return document.body.appendChild(t),t.focus(),()=>{t.blur(),document.body.removeChild(t),e instanceof HTMLElement&&e.focus()}}const vr=[Ze.SPECIAL_PASTE_COL_WIDTH,Ze.SPECIAL_PASTE_VALUE,Ze.SPECIAL_PASTE_FORMAT,Ze.SPECIAL_PASTE_FORMULA];let Vt=class extends oe{constructor(n,e,t,r,i){super(),fe(this,"_copyInfo"),this._sheetClipboardService=n,this._renderManagerService=e,this._drawingService=t,this._clipboardInterfaceService=r,this._commandService=i,this._initCopyPaste()}get _focusedDrawings(){return this._drawingService.getFocusDrawings()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:(n,e,t,r)=>{this._copyInfo=null;const i=this._focusedDrawings;if(i.length>0){const[s]=i;if(s.drawingType!==P.DRAWING_IMAGE)return;if(r===Pe.CUT){const d={unitId:n,drawings:[s]};this._commandService.executeCommand(ge.id,d)}setTimeout(()=>{const d=go();s.drawingType===P.DRAWING_IMAGE&&s.imageSourceType===re.BASE64?ho(s.source):this._clipboardInterfaceService.writeText(""),d()},200);const o={unitId:s.unitId,subUnitId:s.subUnitId,drawings:[s]};this._copyInfo=o}else{const s=this._createDrawingsCopyInfoByRange(n,e,t);this._copyInfo=s}},onPasteCells:(n,e,t,r)=>{if(!this._copyInfo)return{redos:[],undos:[]};const{copyType:i=Pe.COPY,pasteType:s}=r,{range:o}=n||{},{range:d,unitId:a,subUnitId:c}=e;return this._copyInfo.copyRange?this._generateRangeDrawingsPasteMutations({pasteType:s,unitId:a,subUnitId:c,pasteRange:d},{copyRange:o,copyType:i}):this._generateSingleDrawingPasteMutations({pasteTo:e,pasteType:s},Pe.COPY)},onPastePlainText:(n,e)=>({undos:[],redos:[]}),onPasteUnrecognized:n=>this._copyInfo?this._generateSingleDrawingPasteMutations({pasteTo:n,pasteType:Ze.DEFAULT_PASTE},Pe.COPY):{undos:[],redos:[]},onPasteFiles:(n,e)=>{if(this._copyInfo)return this._generateSingleDrawingPasteMutations({pasteTo:n,pasteType:Ze.DEFAULT_PASTE},Pe.COPY);{const t=e.filter(r=>r.type.includes("image"));if(t.length)return{undos:[],redos:[{id:nn.id,params:{files:t}}]}}return{undos:[],redos:[]}}})}_createDrawingsCopyInfoByRange(n,e,t){var r;const i=(r=this._renderManagerService.getRenderById(n))==null?void 0:r.with(z);if(!i)return;const s=i.attachRangeWithCoord(t);if(!s)return;const{startX:o,endX:d,startY:a,endY:c}=s,l=this._drawingService.getDrawingData(n,e),u=this._focusedDrawings.slice();if(Object.keys(l).forEach(g=>{const h=l[g];if(h.drawingType!==P.DRAWING_IMAGE)return;const{transform:p}=h;if(h.anchorType!==k.Both||!p)return;const{left:m=0,top:f=0,width:w=0,height:_=0}=p,{drawingStartX:R,drawingEndX:b,drawingStartY:S,drawingEndY:v}={drawingStartX:m,drawingEndX:m+w,drawingStartY:f,drawingEndY:f+_};o<=R&&b<=d&&a<=S&&v<=c&&u.push(h)}),u.length)return{copyRange:t,drawings:u,unitId:n,subUnitId:e}}_generateSingleDrawingPasteMutations(n,e){const{pasteType:t,pasteTo:r}=n;if(vr.includes(t))return{redos:[],undos:[]};const{unitId:i,subUnitId:s,range:o}=r,d=this._renderManagerService.getRenderById(i),a=d?.with(z),c=d?.with(we),l=this._copyInfo;if(!a||!c)return{redos:[],undos:[]};const{drawings:u}=l,g=ir(o);return this._generateMutations(u,{unitId:i,subUnitId:s,isCut:e===Pe.CUT,getTransform:(h,p)=>{var m,f;const w=a.attachRangeWithCoord({startRow:g.startRow,endRow:g.endRow,startColumn:g.startColumn,endColumn:g.endColumn}),_={...h,left:w?.startX,top:w?.startY};return{transform:_,sheetTransform:(m=B(_,c))!=null?m:p,axisAlignSheetTransform:(f=W(_,c))!=null?f:p}}})}_generateMutations(n,e){const{unitId:t,subUnitId:r,getTransform:i,isCut:s}=e,o=[],d=[],{_drawingService:a}=this;return n.forEach(c=>{const{transform:l,sheetTransform:u}=c;if(!l)return;const g=i(l,u),h={...c,unitId:t,subUnitId:r,drawingId:s?c.drawingId:Te(),transform:g.transform,sheetTransform:g.sheetTransform,axisAlignSheetTransform:g.axisAlignSheetTransform};if(s){const{undo:p,redo:m,objects:f}=a.getBatchUpdateOp([h]);o.push({id:A.id,params:{unitId:t,subUnitId:r,type:M.UPDATE,op:m,objects:f}}),d.push({id:A.id,params:{unitId:t,subUnitId:r,type:M.UPDATE,op:p,objects:f}})}else{const{undo:p,redo:m,objects:f}=a.getBatchAddOp([h]);o.push({id:A.id,params:{op:m,unitId:t,subUnitId:r,objects:f,type:M.INSERT}}),d.push({id:A.id,params:{op:p,unitId:t,subUnitId:r,objects:f,type:M.REMOVE}})}}),{redos:o,undos:d}}_generateRangeDrawingsPasteMutations(n,e){var t;const{unitId:r,subUnitId:i,pasteType:s,pasteRange:o}=n,{copyRange:d,copyType:a}=e;if(vr.includes(s))return{redos:[],undos:[]};const c=(t=this._renderManagerService.getRenderById(r))==null?void 0:t.with(z);if(!c||!this._copyInfo)return{redos:[],undos:[]};const{drawings:l}=this._copyInfo;if(!d)return this._generateSingleDrawingPasteMutations({pasteTo:{unitId:r,subUnitId:i,range:ir(o)},pasteType:s},a);const{ranges:[u,g],mapFunc:h}=Zi([d,o]),{row:p,col:m}=h(u.startRow,u.startColumn),{row:f,col:w}=h(g.startRow,g.startColumn),_=c.attachRangeWithCoord({startRow:p,endRow:p,startColumn:m,endColumn:m}),R=c.attachRangeWithCoord({startRow:f,endRow:f,startColumn:w,endColumn:w});if(!_||!R||!this._copyInfo)return{redos:[],undos:[]};const b=R.startX-_.startX,S=R.startY-_.startY,v=f-p,D=w-m;return this._generateMutations(l,{unitId:r,subUnitId:i,getTransform:(y,C)=>{var U,T,I;const E={...y,left:((U=y?.left)!=null?U:0)+b,top:((T=y?.top)!=null?T:0)+S},x=this._renderManagerService.getRenderById(r),N=x?.with(we);return N?{transform:E,sheetTransform:{...C,to:{...C.to,row:C.to.row+v,column:C.to.column+D},from:{...C.from,row:C.from.row+v,column:C.from.column+D}},axisAlignSheetTransform:(I=W(E,N))!=null?I:C}:{transform:E,sheetTransform:{...C,to:{...C.to,row:C.to.row+v,column:C.to.column+D},from:{...C.from,row:C.from.row+v,column:C.from.column+D}},axisAlignSheetTransform:{...C,to:{...C.to,row:C.to.row+v,column:C.to.column+D},from:{...C.from,row:C.from.row+v,column:C.from.column+D}}}},isCut:a===Pe.CUT})}};Vt=lo([ut(0,ps),ut(1,Z),ut(2,X),ut(3,Ns),ut(4,H)],Vt);var mo=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},ht=(n,e)=>(t,r)=>e(t,r,n);let zt=class extends oe{constructor(n,e,t,r,i){super(),this._drawingManagerService=n,this._renderManagerService=e,this._permissionService=t,this._univerInstanceService=r,this._userManagerService=i,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){const n=this._univerInstanceService.getCurrentTypeOfUnit$(j.UNIVER_SHEET),e=this._userManagerService.currentUser$,t=mt([n,e]);this.disposeWithMe(t.pipe(be(([r,i])=>r?r.activeSheet$.pipe(er(s=>{if(!s){this._drawingManagerService.setDrawingVisible(!1);return}const o=r.getUnitId(),d=s.getSheetId();this._permissionService.composePermission([new or(o).id,new ar(o,d).id]).every(a=>a.value)?this._drawingManagerService.setDrawingVisible(!0):this._handleDrawingVisibilityFalse(r,s)})):(this._drawingManagerService.setDrawingVisible(!1),De))).subscribe())}_handleDrawingVisibilityFalse(n,e){this._drawingManagerService.setDrawingVisible(!1);const t=n.getUnitId(),r=e.getSheetId(),i=this._drawingManagerService.getDrawingData(t,r),s=Object.values(i),o=this._renderManagerService.getRenderById(t),d=o?.scene;d&&d.getAllObjectsByOrder().forEach(a=>{a.classType===Ye.IMAGE&&s.some(c=>a.oKey.includes(c.drawingId))&&d.removeObject(a)})}_initDrawingEditable(){const n=this._univerInstanceService.getCurrentTypeOfUnit$(j.UNIVER_SHEET),e=this._userManagerService.currentUser$,t=mt([n,e]);this.disposeWithMe(t.pipe(be(([r,i])=>r?r.activeSheet$.pipe(er(s=>{if(!s){this._drawingManagerService.setDrawingEditable(!1);return}const o=r.getUnitId(),d=s.getSheetId();this._permissionService.composePermission([new Rn(o).id,new Dn(o,d).id]).every(a=>a.value)?this._drawingManagerService.setDrawingEditable(!0):this._handleDrawingEditableFalse(r,s)})):(this._drawingManagerService.setDrawingEditable(!1),De))).subscribe())}_handleDrawingEditableFalse(n,e){this._drawingManagerService.setDrawingEditable(!1);const t=n.getUnitId(),r=e.getSheetId(),i=this._drawingManagerService.getDrawingData(t,r),s=Object.values(i),o=this._renderManagerService.getRenderById(t),d=o?.scene;d&&d.getAllObjectsByOrder().forEach(a=>{a.classType===Ye.IMAGE&&s.some(c=>a.oKey.includes(c.drawingId))&&d.detachTransformerFrom(a)})}_initViewPermissionChange(){const n=this._univerInstanceService.getCurrentTypeOfUnit$(j.UNIVER_SHEET),e=this._userManagerService.currentUser$;this.disposeWithMe(mt([n,e]).pipe(be(([t,r])=>t?t.activeSheet$.pipe(be(i=>{if(!i)return De;const s=t.getUnitId(),o=i.getSheetId(),d=this._renderManagerService.getRenderById(s),a=d?.scene;if(!a)return De;const c=a.getTransformerByCreate();return this._permissionService.composePermission$([new or(s).id,new ar(s,o).id]).pipe(ye(l=>l.every(u=>u.value)),tr()).pipe(ye(l=>({permission:l,scene:a,transformer:c,unitId:s,subUnitId:o})))})):De)).subscribe({next:({permission:t,scene:r,transformer:i,unitId:s,subUnitId:o})=>{this._drawingManagerService.setDrawingVisible(t);const d=r.getAllObjectsByOrder(),a=this._drawingManagerService.getDrawingData(s,o),c=Object.values(a);t?this._drawingManagerService.addNotification(c):(d.forEach(l=>{l.classType===Ye.IMAGE&&c.some(u=>l.oKey.includes(u.drawingId))&&r.removeObject(l)}),i.clearSelectedObjects())},complete:()=>{this._drawingManagerService.setDrawingVisible(!0);const t=this._univerInstanceService.getCurrentUnitForType(j.UNIVER_SHEET),r=t?.getActiveSheet(),i=t?.getUnitId(),s=r?.getSheetId();if(!i||!s)return;const o=this._drawingManagerService.getDrawingData(i,s),d=Object.values(o);this._drawingManagerService.addNotification(d)}}))}_initEditPermissionChange(){const n=this._univerInstanceService.getCurrentTypeOfUnit$(j.UNIVER_SHEET),e=this._userManagerService.currentUser$;this.disposeWithMe(mt([n,e]).pipe(be(([t,r])=>t?t.activeSheet$.pipe(be(i=>{if(!i)return De;const s=t.getUnitId(),o=i.getSheetId(),d=this._renderManagerService.getRenderById(s),a=d?.scene;if(!a)return De;const c=a.getTransformerByCreate();return this._permissionService.composePermission$([new Rn(s).id,new Dn(s,o).id]).pipe(ye(l=>l.every(u=>u.value)),tr()).pipe(ye(l=>({permission:l,scene:a,transformer:c,unitId:s,subUnitId:o})))})):De)).subscribe({next:({permission:t,scene:r,transformer:i,unitId:s,subUnitId:o})=>{this._drawingManagerService.setDrawingEditable(t);const d=r.getAllObjectsByOrder(),a=this._drawingManagerService.getDrawingData(s,o),c=Object.values(a);t?(d.forEach(l=>{l.classType===Ye.IMAGE&&c.some(u=>l.oKey.includes(u.drawingId))&&r.attachTransformerTo(l)}),this._drawingManagerService.addNotification(c)):(d.forEach(l=>{l.classType===Ye.IMAGE&&c.some(u=>l.oKey.includes(u.drawingId))&&r.detachTransformerFrom(l)}),i.clearSelectedObjects())},complete:()=>{const t=this._univerInstanceService.getCurrentUnitForType(j.UNIVER_SHEET);if(!t)return;const r=t.getUnitId(),i=t.getActiveSheet();if(!i)return;const s=i.getSheetId(),o=this._renderManagerService.getRenderById(r),d=o?.scene;if(!d)return;const a=this._drawingManagerService.getDrawingData(r,s),c=Object.values(a);this._drawingManagerService.setDrawingEditable(!0),d.getAllObjectsByOrder().forEach(l=>{l.classType===Ye.IMAGE&&c.some(u=>l.oKey.includes(u.drawingId))&&d.detachTransformerFrom(l)})}}))}};zt=mo([ht(0,X),ht(1,Z),ht(2,Gi),ht(3,me),ht(4,O(Li))],zt);var fo=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Ne=(n,e)=>(t,r)=>e(t,r,n);const po="univer-sheet-float-dom-";function hi(n,e,t,r,i,s=!1){const{scaleX:o,scaleY:d}=e.getAncestorScale(),a=e.getViewport(Zr.VIEW_MAIN),c=r.getFreeze(),{startColumn:l,startRow:u,xSplit:g,ySplit:h}=c,p={left:!0,top:!0};if(!a)return{...n,absolute:p};const{left:m,right:f,top:w,bottom:_}=n;let{top:R,left:b,viewportScrollX:S,viewportScrollY:v}=a;const{boundsOfViewArea:D,scrollDirectionResponse:y}=i||{},{rowHeaderWidth:C,columnHeaderHeight:U}=t,T={top:s?0:U,left:s?0:C};D&&(Ke.isDefine(T.top)&&(T.top=D.top),Ke.isDefine(T.left)&&(T.left=D.left)),y==="HORIZONTAL"&&(v=0),y==="VERTICAL"&&(S=0);let I=0,E=0;const x=t.rowStartY(u-h)+U,N=t.colStartX(l-g)+C,se=t.rowStartY(u)+U,Q=t.colStartX(l)+C;if(g===0)p.left=!1,I=(m-S)*o,E=(f-S)*o;else{const ne=m-(N-C),G=f-(N-C);f<Q?(I=ne*o,E=G*o):m<=Q&&f>=Q?(I=ne*o,E=Math.max(b,(f-S)*o)):m>Q&&(p.left=!1,I=Math.max((m-S)*o,b),E=Math.max((f-S)*o,b))}let K=0,q=0;if(h===0)p.top=!1,K=(w-v)*d,q=(_-v)*d;else{const ne=w-(x-U),G=_-(x-U);_<se?(K=ne*d,q=G*d):w<=se&&_>=se?(K=ne*d,q=Math.max(R,(_-v)*d)):w>se&&(p.top=!1,K=Math.max((w-v)*d,R),q=Math.max((_-v)*d,R))}return I=Math.max(I,T.left),K=Math.max(K,T.top),E=Math.max(E,T.left),q=Math.max(q,T.top),{left:I,right:E,top:K,bottom:q,absolute:p}}const Se=(n,e,t,r,i)=>{const{left:s,top:o,width:d,height:a,angle:c}=n,l={left:s,right:s+d,top:o,bottom:o+a},u=hi(l,e,t,r,i),{scaleX:g,scaleY:h}=e.getAncestorScale();return{startX:u.left,endX:u.right,startY:u.top,endY:u.bottom,rotate:c,width:d*g,height:a*h,absolute:u.absolute}};let ce=class extends oe{constructor(n,e,t,r,i,s,o){super(),fe(this,"_domLayerInfoMap",new Map),fe(this,"_transformChange$",new an),fe(this,"transformChange$",this._transformChange$.asObservable()),fe(this,"_add$",new an),fe(this,"add$",this._add$.asObservable()),fe(this,"_remove$",new an),fe(this,"remove$",this._remove$.asObservable()),this._renderManagerService=n,this._univerInstanceService=e,this._commandService=t,this._drawingManagerService=r,this._canvasFloatDomService=i,this._sheetDrawingService=s,this._lifecycleService=o,this._drawingAddListener(),this._featureUpdateListener(),this._deleteListener(),this._bindScrollEvent()}_bindScrollEvent(){this._lifecycleService.lifecycle$.pipe(Ei(n=>n===Bi.Rendered),Ti(1)).subscribe(()=>{this._scrollUpdateListener()})}getFloatDomInfo(n){return this._domLayerInfoMap.get(n)}getFloatDomsBySubUnitId(n,e){return Array.from(this._domLayerInfoMap.values()).filter(t=>t.subUnitId===e&&t.unitId===n)}_getSceneAndTransformerByDrawingSearch(n){if(n==null)return;const e=this._renderManagerService.getRenderById(n),t=e?.scene;if(e==null||t==null)return null;const r=t.getTransformerByCreate(),i=e.engine.getCanvasElement();return{scene:t,transformer:r,renderUnit:e,canvas:i}}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(n=>{n.forEach(e=>{var t;const{unitId:r,subUnitId:i,drawingId:s}=e,o=he(this._univerInstanceService,{unitId:r,subUnitId:i}),d=this._drawingManagerService.getDrawingByParam(e),a=this._univerInstanceService.getUnit(r,j.UNIVER_SHEET);if(!a)return;const c=a.getActiveSheet().getSheetId();if(!d||!o)return;const l=(t=this._renderManagerService.getRenderById(r))==null?void 0:t.with(z).getSkeletonParam(i);if(!l)return;const{transform:u,drawingType:g,data:h}=d;if(g!==P.DRAWING_DOM&&g!==P.DRAWING_CHART)return;const p=this._getSceneAndTransformerByDrawingSearch(r);if(p==null)return;const{scene:m,canvas:f}=p;if(u==null)return!0;if(c!==i)return;const{left:w,top:_,width:R,height:b,angle:S,flipX:v,flipY:D,skewX:y,skewY:C}=u,U=xe({unitId:r,subUnitId:i,drawingId:s}),T=m.getObject(U);if(T!=null){T.transformByState({left:w,top:_,width:R,height:b,angle:S,flipX:v,flipY:D,skewX:y,skewY:C});return}const I={left:w,top:_,width:R,height:b,zIndex:this._drawingManagerService.getDrawingOrder(r,i).length-1},E=g===P.DRAWING_CHART;if(I.rotateEnabled=!1,E){const G=h?h.backgroundColor:"white";I.fill=G,h&&h.border&&(I.stroke=h.border),I.paintFirst="stroke",I.strokeWidth=1,I.borderEnabled=!1,I.radius=8}const x=new Le(U,I);E&&x.setObjectType(dr.CHART),m.addObject(x,ln),d.allowTransform!==!1&&m.attachTransformerTo(x);const N=new xt,se=Se(x,p.renderUnit.scene,l.skeleton,o.worksheet),Q=new ze(se),K=`${po}${Te(6)}`,q={dispose:N,rect:x,position$:Q,unitId:r,subUnitId:i,id:s,domId:K};this._canvasFloatDomService.addFloatDom({position$:Q,id:s,domId:K,componentKey:d.componentKey,onPointerDown:G=>{f.dispatchEvent(new PointerEvent(G.type,G))},onPointerMove:G=>{f.dispatchEvent(new PointerEvent(G.type,G))},onPointerUp:G=>{f.dispatchEvent(new PointerEvent(G.type,G))},onWheel:G=>{f.dispatchEvent(new WheelEvent(G.type,G))},data:h,unitId:r});const ne=x.onTransformChange$.subscribeEvent(()=>{const G=Se(x,p.renderUnit.scene,l.skeleton,o.worksheet);Q.next(G)});N.add(()=>{this._canvasFloatDomService.removeFloatDom(s)}),ne&&N.add(ne),this._domLayerInfoMap.set(s,q)})})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(n=>{n.forEach(e=>{var t;const{unitId:r,subUnitId:i,drawingId:s}=e,o=xe({unitId:r,subUnitId:i,drawingId:s}),d=this._getSceneAndTransformerByDrawingSearch(r);if(d==null)return;const{transformer:a,scene:c}=d,l=c.getObject(o);l!=null&&l.oKey&&(a.clearControlByIds([l?.oKey]),(t=c.getTransformer())==null||t.clearSelectedObjects())})}))}_scrollUpdateListener(){const n=(e,t)=>{var r;const i=this._getSceneAndTransformerByDrawingSearch(e),s=Array.from(this._domLayerInfoMap.keys()).map(a=>({id:a,...this._domLayerInfoMap.get(a)})).filter(a=>a.subUnitId===t&&a.unitId===e).map(a=>a.id),o=he(this._univerInstanceService,{unitId:e,subUnitId:t}),d=(r=this._renderManagerService.getRenderById(e))==null?void 0:r.with(z).getSkeletonParam(t);!i||!o||!d||s.forEach(a=>{const c=this._domLayerInfoMap.get(a);if(c){const l=Se(c.rect,i.renderUnit.scene,d.skeleton,o.worksheet,c);c.position$.next(l)}})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(j.UNIVER_SHEET).pipe(be(e=>e?e.activeSheet$:Sn(null)),ye(e=>{if(!e)return null;const t=e.getUnitId(),r=this._renderManagerService.getRenderById(t);return r?{render:r,unitId:t,subUnitId:e.getSheetId()}:null}),be(e=>e?Fi(e.render.scene.getViewport(Zr.VIEW_MAIN).onScrollAfter$).pipe(ye(()=>({unitId:e.unitId,subUnitId:e.subUnitId}))):Sn(null))).subscribe(e=>{if(!e)return;const{unitId:t,subUnitId:r}=e;n(t,r)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===nr.id){const t=e.params,{unitId:r}=t;Array.from(this._domLayerInfoMap.values()).filter(i=>i.unitId===r).map(i=>i.subUnitId).forEach(i=>{n(r,i)})}else if(e.id===Vi.id){const{unitId:t,subUnitId:r}=e.params;n(t,r)}else if(e.id===zi.id){const{unitId:t,subUnitId:r}=e.params;n(t,r)}}))}updateFloatDomProps(n,e,t,r){const i=this._domLayerInfoMap.get(t),s=this._getSceneAndTransformerByDrawingSearch(n);if(i&&s){const{scene:o}=s,d=xe({unitId:n,subUnitId:e,drawingId:t}),a=o.getObject(d);a&&a instanceof Le&&a.setProps(r)}}_getPosition(n,e){var t;const{startX:r,endX:i,startY:s,endY:o}=n,d=(t=this._renderManagerService.getRenderById(e))==null?void 0:t.with(we);if(d==null)return;const a=d.getCellWithCoordByOffset(r,s);if(a==null)return;const c={column:a.actualColumn,columnOffset:r-a.startX,row:a.actualRow,rowOffset:s-a.startY},l=d.getCellWithCoordByOffset(i,o);if(l==null)return;const u={column:l.actualColumn,columnOffset:i-l.startX,row:l.actualRow,rowOffset:o-l.startY};return{from:c,to:u}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(n=>{n.forEach(e=>{const t=this._drawingManagerService.getDrawingByParam(e);if(!t||t.drawingType!==P.DRAWING_DOM&&t.drawingType!==P.DRAWING_CHART)return;const r={...t.transform};this._transformChange$.next({id:e.drawingId,value:r}),this._canvasFloatDomService.updateFloatDom(e.drawingId,{...t});const i=this._getSceneAndTransformerByDrawingSearch(e.unitId);if(i&&t.drawingType!==P.DRAWING_CHART){const{scene:s}=i,o=this._domLayerInfoMap.get(e.drawingId);o!=null&&o.rect&&(t.allowTransform===!1?s.detachTransformerFrom(o.rect):s.attachTransformerTo(o.rect))}})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(n=>{n.forEach(e=>{this._removeDom(e.drawingId)})}))}addFloatDomToPosition(n,e){const t=he(this._univerInstanceService,{unitId:n.unitId,subUnitId:n.subUnitId});if(!t)throw new Error("cannot find current target!");const{unitId:r,subUnitId:i}=t,{initPosition:s,componentKey:o,data:d,allowTransform:a=!0}=n,c=e??Te(),l=this._getPosition(s,r);if(l==null)return;const u={unitId:r,subUnitId:i,drawingId:c,drawingType:n.type||P.DRAWING_DOM,componentKey:o,sheetTransform:l,transform:{left:s.startX,top:s.startY,width:s.endX-s.startX,height:s.endY-s.startY},axisAlignSheetTransform:l,data:d,allowTransform:a};return this._commandService.executeCommand(ve.id,{unitId:r,drawings:[u]}),this._add$.next({unitId:r,subUnitId:i,id:c}),{id:c,dispose:()=>{this._removeDom(c,!0)}}}_removeDom(n,e=!1){const t=this._domLayerInfoMap.get(n);if(!t)return;const{unitId:r,subUnitId:i}=t;this._domLayerInfoMap.delete(n),t.dispose.dispose();const s=this._getSceneAndTransformerByDrawingSearch(r);if(s&&s.scene.removeObject(t.rect),e){const o=this._drawingManagerService.getDrawingByParam({unitId:r,subUnitId:i,drawingId:n});if(!o)return;const d=this._sheetDrawingService.getBatchRemoveOp([o]),{redo:a,objects:c}=d;this._commandService.syncExecuteCommand(A.id,{unitId:r,subUnitId:i,op:a,objects:c,type:M.REMOVE})}}addFloatDomToRange(n,e,t,r){var i,s,o;const d=he(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!d)throw new Error("cannot find current target!");const{unitId:a,subUnitId:c}=d,l=this._getSceneAndTransformerByDrawingSearch(a);if(!l)return;const u=this._renderManagerService.getRenderById(a);if(!u)return;const g=(i=this._renderManagerService.getRenderById(a))==null?void 0:i.with(z).getWorksheetSkeleton(c);if(!g)return;const{componentKey:h,data:p,allowTransform:m=!0}=e,f=r??Te(),{position:w,position$:_}=this._createRangePositionObserver(n,u,g.skeleton);if(this._getPosition(w,a)==null)return;const R=l.scene,{scaleX:b}=R.getAncestorScale(),S=Wt(w,t,b),v={unitId:a,subUnitId:c,drawingId:f,drawingType:e.type||P.DRAWING_DOM,componentKey:h,transform:{left:S.startX,top:S.startY,width:S.width,height:S.height},data:p,allowTransform:m};{const{unitId:D,subUnitId:y,drawingId:C}=v,U=he(this._univerInstanceService,{unitId:D,subUnitId:y}),T=v,I=this._univerInstanceService.getUnit(D,j.UNIVER_SHEET);if(!I)return;const E=I.getActiveSheet().getSheetId();if(!T||!U)return;const x=(s=this._renderManagerService.getRenderById(D))==null?void 0:s.with(z);if(!x)return;const N=x.getWorksheetSkeleton(y);if(!N)return;const{transform:se,drawingType:Q,data:K}=T;if(Q!==P.DRAWING_DOM&&Q!==P.DRAWING_CHART)return;const q=this._getSceneAndTransformerByDrawingSearch(D);if(q==null)return;const{scene:ne,canvas:G}=q;if(se==null||E!==y)return;const{left:yt,top:Rt,width:Dt,height:Ct,angle:rn,flipX:Et,flipY:Tt,skewX:$e,skewY:sn}=se,_e=xe({unitId:D,subUnitId:y,drawingId:C}),Be=ne.getObject(_e);if(Be!=null){Be.transformByState({left:yt,top:Rt,width:Dt,height:Ct,angle:rn,flipX:Et,flipY:Tt,skewX:$e,skewY:sn});return}const ue={left:yt,top:Rt,width:Dt,height:Ct,zIndex:this._drawingManagerService.getDrawingOrder(D,y).length-1},Ut=Q===P.DRAWING_CHART;if(Ut){const $=K?K.backgroundColor:"white";ue.fill=$,ue.rotateEnabled=!1,K&&K.border&&(ue.stroke=K.border),ue.paintFirst="stroke",ue.strokeWidth=1,ue.borderEnabled=!1,ue.radius=8}const ae=new Le(_e,ue);Ut&&ae.setObjectType(dr.CHART),ne.addObject(ae,ln),T.allowTransform!==!1&&ne.attachTransformerTo(ae);const at=new xt,Oe=ne.getMainViewport(),{rowHeaderWidth:dt,columnHeaderHeight:Mt}=N.skeleton,At={top:Mt,left:dt,bottom:Oe.bottom,right:Oe.right},L={dispose:at,rect:ae,boundsOfViewArea:At,domAnchor:t,unitId:D,subUnitId:y},on=Se(ae,q.renderUnit.scene,N.skeleton,U.worksheet,L),Fe=new ze(on);L.position$=Fe;let ct={position$:Fe,id:C,componentKey:T.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:$=>{G.dispatchEvent(new WheelEvent($.type,$))},data:K,unitId:D};e.eventPassThrough&&(ct={...ct,onPointerDown:$=>{G.dispatchEvent(new PointerEvent($.type,$))},onPointerMove:$=>{G.dispatchEvent(new PointerEvent($.type,$))},onPointerUp:$=>{G.dispatchEvent(new PointerEvent($.type,$))}}),this._canvasFloatDomService.addFloatDom(ct),this.disposeWithMe(_.subscribe($=>{var $n,Bn,Fn,Gn;const Ln=Wt({startX:$.startX,startY:$.startY,endX:$.endX,endY:$.endY,width:($n=t.width)!=null?$n:$.width,height:(Bn=t.height)!=null?Bn:$.height,absolute:{left:w.absolute.left,top:w.absolute.top}},t),pi=xe({unitId:D,subUnitId:y,drawingId:C}),wi=new Le(pi,{left:Ln.startX,top:Ln.startY,width:(Fn=t.width)!=null?Fn:$.width,height:(Gn=t.height)!=null?Gn:$.height,zIndex:this._drawingManagerService.getDrawingOrder(D,y).length-1}),Ii=Se(wi,q.renderUnit.scene,N.skeleton,U.worksheet,L);Fe.next(Ii)}));const Ot=(o=this._renderManagerService.getRenderById(D))==null?void 0:o.with(z);Ot?.currentSkeleton$.subscribe($=>{$&&N.sheetId!==$.sheetId&&this._removeDom(f,!0)});const Wn=ae.onTransformChange$.subscribeEvent(()=>{const $=Se(ae,q.renderUnit.scene,N.skeleton,U.worksheet,L);Fe.next($)});at.add(()=>{this._canvasFloatDomService.removeFloatDom(C)}),Wn&&at.add(Wn),this._domLayerInfoMap.set(C,L)}return{id:f,dispose:()=>{this._removeDom(f,!0)}}}addFloatDomToColumnHeader(n,e,t,r){var i,s,o;const d=he(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!d)throw new Error("cannot find current target!");const{unitId:a,subUnitId:c}=d;if(!this._getSceneAndTransformerByDrawingSearch(a))return;const l=this._renderManagerService.getRenderById(a);if(!l)return;const u=(i=this._renderManagerService.getRenderById(a))==null?void 0:i.with(z).getWorksheetSkeleton(c);if(!u)return;const{componentKey:g,data:h,allowTransform:p=!0}=e,m=r??Te(),{position:f,position$:w}=this._createRangePositionObserver({startRow:0,endRow:0,startColumn:n,endColumn:n},l,u.skeleton),_=f;if(_.startY=0,this._getPosition(f,a)==null)return;const R={unitId:a,subUnitId:c,drawingId:m,drawingType:e.type||P.DRAWING_DOM,componentKey:g,transform:{left:_.startX,top:_.startY,width:_.width,height:_.height},data:h,allowTransform:p};{const{unitId:b,subUnitId:S,drawingId:v}=R,D=he(this._univerInstanceService,{unitId:b,subUnitId:S}),y=R,C=this._univerInstanceService.getUnit(b,j.UNIVER_SHEET);if(!C)return;const U=C.getActiveSheet().getSheetId();if(!y||!D)return;const T=(s=this._renderManagerService.getRenderById(b))==null?void 0:s.with(z);if(!T)return;const I=T.getWorksheetSkeleton(S);if(!I)return;const{transform:E,data:x}=y,N=this._getSceneAndTransformerByDrawingSearch(b);if(N==null)return;const{scene:se,canvas:Q}=N;if(E==null||U!==S)return;const{left:K,top:q,width:ne,height:G,angle:yt,flipX:Rt,flipY:Dt,skewX:Ct,skewY:rn}=E,Et=xe({unitId:b,subUnitId:S,drawingId:v}),Tt=se.getObject(Et);if(Tt!=null){Tt.transformByState({left:K,top:q,width:ne,height:G,angle:yt,flipX:Rt,flipY:Dt,skewX:Ct,skewY:rn});return}const $e=Wt({startX:_.startX,startY:0,endX:f.endX,endY:f.endY,width:t.width,height:t.height,absolute:{left:f.absolute.left,top:f.absolute.top}},t),sn={left:$e.startX,top:$e.startY,width:$e.width,height:$e.height,zIndex:this._drawingManagerService.getDrawingOrder(b,S).length-1},_e=new Le(Et,sn);se.addObject(_e,ln),y.allowTransform!==!1&&se.attachTransformerTo(_e);const Be=new xt,ue=se.getMainViewport(),Ut={top:0,left:ue.left,bottom:ue.bottom,right:ue.right},ae={dispose:Be,rect:_e,unitId:b,subUnitId:S,boundsOfViewArea:Ut,domAnchor:t,scrollDirectionResponse:"HORIZONTAL"},at=Se(_e,N.renderUnit.scene,I.skeleton,D.worksheet,ae),Oe=new ze(at);ae.position$=Oe;let dt={position$:Oe,id:v,componentKey:y.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:L=>{Q.dispatchEvent(new WheelEvent(L.type,L))},data:x,unitId:b};e.eventPassThrough&&(dt={...dt,onPointerDown:L=>{Q.dispatchEvent(new PointerEvent(L.type,L))},onPointerMove:L=>{Q.dispatchEvent(new PointerEvent(L.type,L))},onPointerUp:L=>{Q.dispatchEvent(new PointerEvent(L.type,L))}}),this._canvasFloatDomService.addFloatDom(dt);const Mt=_e.onTransformChange$.subscribeEvent(()=>{const L=Se(_e,N.renderUnit.scene,I.skeleton,D.worksheet,ae);Oe.next(L)});this.disposeWithMe(w.subscribe(L=>{const on=Wt({startX:L.startX,startY:0,endX:L.endX,endY:L.endY,width:t.width,height:t.height,absolute:{left:f.absolute.left,top:f.absolute.top}},t),Fe=xe({unitId:b,subUnitId:S,drawingId:v}),ct=new Le(Fe,{left:on.startX,top:0,width:t.width,height:t.height,zIndex:this._drawingManagerService.getDrawingOrder(b,S).length-1}),Ot=Se(ct,N.renderUnit.scene,I.skeleton,D.worksheet,ae);Oe.next(Ot)}));const At=(o=this._renderManagerService.getRenderById(b))==null?void 0:o.with(z);At?.currentSkeleton$.subscribe(L=>{L&&u.sheetId!==L.sheetId&&this._removeDom(m,!0)}),Be.add(()=>{this._canvasFloatDomService.removeFloatDom(v)}),Mt&&Be.add(Mt),this._domLayerInfoMap.set(v,ae)}return{id:m,dispose:()=>{this._removeDom(m,!0)}}}_createRangePositionObserver(n,e,t){let{startRow:r,startColumn:i}=n;const s=gt(r,i,t),o=new ze(s),d=gt(n.endRow,n.endColumn,t),a=new ze(d),c=()=>{const m=gt(r,i,t),f=gt(n.endRow,n.endColumn,t);o.next(m),a.next(f)},l=new xt;l.add(e.engine.clientRect$.subscribe(()=>c())),l.add(this._commandService.onCommandExecuted(m=>{if(m.id===Ur.id&&m.params.rowsAutoHeightInfo.findIndex(f=>f.row===r)>-1){c();return}(Ki.indexOf(m.id)>-1||m.id===Ji.id||m.id===nr.id)&&c()}));const u=(m,f)=>{r=m,i=f,c()},g=()=>({rotate:0,width:d.right-s.left,height:d.bottom-s.top,absolute:{left:!0,top:!0},startX:s.left,startY:s.top,endX:d.right,endY:d.bottom}),h=o.pipe(ye(m=>{const f=gt(n.endRow,n.endColumn,t);return{rotate:0,width:f.right-m.left,height:f.bottom-m.top,absolute:{left:!0,top:!0},startX:m.left,startY:m.top,endX:f.right,endY:f.bottom}})),p=g();return{position$:h,position:p,updateRowCol:u,topLeftPos$:o,rightBottomPos$:a,disposable:l}}};ce=fo([Ne(0,O(Z)),Ne(1,me),Ne(2,O(H)),Ne(3,X),Ne(4,O(js)),Ne(5,Y),Ne(6,O(Yi))],ce);function gt(n,e,t){const r=t.getCellWithCoordByIndex(n,e),i=r.isMergedMainCell?r.mergeInfo:r;return{left:i.startX,right:i.endX,top:i.startY,bottom:i.endY}}function Wt(n,e,t){var r,i;t=t??1;const s=n.endX-n.startX,o=n.endY-n.startY,d=(r=e?.width)!=null?r:s,a=(i=e?.height)!=null?i:o;let c=0,l=0;if(e){if(e.horizonOffsetAlign==="right"){const u=$t(e.marginX,s*t);c=n.endX-u-d}else c=n.startX+$t(e.marginX,s);if(e.verticalOffsetAlign==="bottom"){const u=$t(e.marginY,o*t);l=n.endY-u-a}else l=n.startY+$t(e.marginY,o)}return{rotate:0,startX:c,startY:l,endX:n.endX,endY:n.endY,width:d,height:a,absolute:{left:n.absolute.left,top:n.absolute.top}}}function $t(n,e){if(n===void 0)return 0;if(typeof n=="number")return n;const t=Number.parseFloat(n);return e*t/100}const wo=n=>{const{floatDomInfos:e,scene:t,skeleton:r,worksheet:i}=n,s=J.useMemo(()=>e.map(o=>{const{width:d,height:a,angle:c,left:l,top:u}=o.transform,g=hi({left:l??0,right:(l??0)+(d??0),top:u??0,bottom:(u??0)+(a??0)},t,r,i,void 0,!0),{scaleX:h,scaleY:p}=t.getAncestorScale(),m={startX:g.left,endX:g.right,startY:g.top,endY:g.bottom,rotate:c,width:d*h,height:a*p,absolute:g.absolute},f={position$:new ze(m),position:m,id:o.drawingId,componentKey:o.componentKey,onPointerMove:()=>{},onPointerDown:()=>{},onPointerUp:()=>{},onWheel:()=>{},unitId:o.unitId,data:o.data};return[o.drawingId,f]}),[e,t,r,i]);return F.jsx("div",{style:{position:"absolute",top:0,left:0},children:s.map(([o,d])=>F.jsx(ks,{layer:d,id:o,position:d.position},o))})};var Io=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},je=(n,e)=>(t,r)=>e(t,r,n);let Kt=class extends oe{constructor(n,e,t,r,i,s,o){super(),this._sheetPrintInterceptorService=n,this._drawingRenderService=e,this._drawingManagerService=t,this._renderManagerService=r,this._canvasFloatDomManagerService=i,this._componetManager=s,this._injector=o,this._initPrinting(),this._initPrintingDom()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(n,e,t)=>{const{unitId:r,scene:i,subUnitId:s}=e,o=this._drawingManagerService.getDrawingDataForUnit(r),d=o?.[s];return d&&d.order.forEach(a=>{const c=d.data[a];c.drawingType!==P.DRAWING_CHART&&c.drawingType!==P.DRAWING_DOM&&this._drawingRenderService.renderDrawing(c,i)}),t()}})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:(n,e,t)=>{const{unitId:r,subUnitId:i}=e,s=this._renderManagerService.getRenderById(r);if(!s)return t(n);const o=s.with(z).getSkeletonParam(i);if(!o)return t(n);const d=this._drawingManagerService.getDrawingDataForUnit(r),a=d?.[e.subUnitId];if(!a)return t(n);const{scaleX:c,scaleY:l}=s.scene,u=n?{...n}:{startColumn:0,endColumn:0,endRow:0,startRow:0},g=a.order.map(h=>a.data[h]);return g.length?(g.forEach(h=>{if(!h.groupId&&h.transform&&Ke.isDefine(h.transform.left)&&Ke.isDefine(h.transform.top)&&Ke.isDefine(h.transform.width)&&Ke.isDefine(h.transform.height)){const p=o.skeleton.getCellIndexByOffset(h.transform.left,h.transform.top,c,l,{x:0,y:0}),m=o.skeleton.getCellIndexByOffset(h.transform.left+h.transform.width,h.transform.top+h.transform.height,c,l,{x:0,y:0});p.column<u.startColumn&&(u.startColumn=p.column),p.row<u.startRow&&(u.startRow=p.row),u.endRow<m.row&&(u.endRow=m.row),u.endColumn<m.column&&(u.endColumn=m.column)}}),t(u)):t(n)}}))}_initPrintingDom(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_DOM_COLLECT,{handler:(n,e,t)=>{const{unitId:r,subUnitId:i}=e,s=this._drawingManagerService.getDrawingDataForUnit(r),o=s?.[i];if(o){const d=o.order.map(c=>{const l=o.data[c];if(l.drawingType===P.DRAWING_CHART)return{...l,componentKey:this._componetManager.get(Ai)};if(l.drawingType===P.DRAWING_DOM){const u=this._sheetPrintInterceptorService.getPrintComponent(l.componentKey);return{...l,componentKey:this._componetManager.get(u||l.componentKey)}}return null}).filter(Boolean),a=As(wo,this._injector);return Rs(F.jsx(a,{floatDomInfos:d,scene:e.scene,skeleton:e.skeleton,worksheet:e.worksheet}),e.root),n?.add(()=>{Ds(e.root)}),t(n)}}}))}};Kt=Io([je(0,O(ws)),je(1,O(br)),je(2,X),je(3,Z),je(4,O(ce)),je(5,O(pt)),je(6,O(Re))],Kt);var vo=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Ce=(n,e)=>(t,r)=>e(t,r,n);const _o=[Or.id,xr.id,kr.id,Pr.id,Nr.id,jr.id,Wr.id,$r.id,bn.id,yn.id,Br.id,Fr.id,Gr.id,Lr.id,Yr.id,Xr.id,Hr.id,Vr.id,zr.id],So=[ns.id,rs.id,is.id,ss.id,os.id,Ur.id,as.id,ds.id];let An=class extends oe{constructor(n,e,t,r,i,s,o,d,a){super(),this._context=n,this._renderManagerService=e,this._commandService=t,this._selectionRenderService=r,this._skeletonManagerService=i,this._sheetInterceptorService=s,this._sheetDrawingService=o,this._drawingManagerService=d,this._univerInstanceService=a,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptAfterCommand({getMutations:n=>{if(!_o.includes(n.id))return{redos:[],undos:[]};if(n.params==null)return{redos:[],undos:[]};const e=n.id;if(e===Or.id)return this._moveRowInterceptor(n.params,"insert");if([Hr.id,Vr.id,zr.id].includes(e))return this._moveRangeInterceptor(n.params);if(e===xr.id)return this._moveColInterceptor(n.params,"insert");if(e===kr.id)return this._moveRowInterceptor(n.params,"remove");if(e===Pr.id)return this._moveColInterceptor(n.params,"remove");if(e===Nr.id){const{range:t}=n.params;return this._getRangeMoveUndo(t,0)}else if(e===jr.id){const{range:t}=n.params;return this._getRangeMoveUndo(t,1)}else if(e===Wr.id){const{range:t}=n.params;return this._getRangeMoveUndo(t,2)}else if(e===$r.id){const{range:t}=n.params;return this._getRangeMoveUndo(t,3)}else if(e===Gr.id||e===Lr.id){const t=n.params,{unitId:r,subUnitId:i,ranges:s}=t;return this._getDrawingUndoForRowVisible(r,i,s)}else if(e===Yr.id||e===Xr.id){const t=n.params,{unitId:r,subUnitId:i,ranges:s}=t;return this._getDrawingUndoForColVisible(r,i,s)}else if(e===bn.id||e===yn.id||e===Br.id||e===Fr.id){const t=n.params,{unitId:r,subUnitId:i,ranges:s}=t,o=e===bn.id||e===yn.id;return this._getDrawingUndoForRowAndColSize(r,i,s,o)}return{redos:[],undos:[]}}}))}_getRangeMoveUndo(n,e){const t=he(this._univerInstanceService);if(t==null)return{redos:[],undos:[]};const r=t.unitId,i=t.subUnitId,s=[],o=[],d=this._sheetDrawingService.getDrawingData(r,i),a=[],c=[];if(Object.keys(d).forEach(l=>{const u=d[l],{updateDrawings:g,deleteDrawings:h}=this._getUpdateOrDeleteDrawings(n,e,u);a.push(...g),c.push(...h)}),a.length===0&&c.length===0)return{redos:[],undos:[]};if(a.length>0){const l=this._sheetDrawingService.getBatchUpdateOp(a),{undo:u,redo:g,objects:h}=l;s.push({id:A.id,params:{unitId:r,subUnitId:i,op:g,objects:h,type:M.UPDATE}}),o.push({id:A.id,params:{unitId:r,subUnitId:i,op:u,objects:h,type:M.UPDATE}})}if(c.length>0){const l=this._sheetDrawingService.getBatchRemoveOp(c),u=l.undo,g=l.redo,h=l.objects;s.push({id:A.id,params:{unitId:r,subUnitId:i,op:g,objects:h,type:M.REMOVE}}),o.push({id:A.id,params:{unitId:r,subUnitId:i,op:u,objects:h,type:M.INSERT}})}return s.push({id:V.id,params:[r]}),o.push({id:V.id,params:[r]}),{redos:s,undos:o}}_getUpdateOrDeleteDrawings(n,e,t){var r,i,s,o;const d=[],a=[],{sheetTransform:c,anchorType:l=k.Position,transform:u,unitId:g,subUnitId:h,drawingId:p}=t,{from:m,to:f}=c,{row:w,column:_}=m,{row:R,column:b}=f;if(c==null||u==null)return{updateDrawings:d,deleteDrawings:a};const{startRow:S,endRow:v,startColumn:D,endColumn:y}=n;let C=null,U=null,T;if(e===0&&w>=S&&R<=v)if(_>=D&&b<=y)a.push({unitId:g,subUnitId:h,drawingId:p});else{const I=this._shrinkCol(c,u,D,y,l);C=I?.newSheetTransform,U=I?.newTransform,T=(r=I?.axisAlignSheetTransform)!=null?r:void 0}else if(e===1&&_>=D&&b<=y)if(w>=S&&R<=v)a.push({unitId:g,subUnitId:h,drawingId:p});else{const I=this._shrinkRow(c,u,S,v,l);C=I?.newSheetTransform,U=I?.newTransform,T=(i=I?.axisAlignSheetTransform)!=null?i:void 0}else if(e===2){const I=this._expandRow(c,u,S,v,l);C=I?.newSheetTransform,U=I?.newTransform,T=(s=I?.axisAlignSheetTransform)!=null?s:void 0}else if(e===3){const I=this._expandCol(c,u,D,y,l);C=I?.newSheetTransform,U=I?.newTransform,T=(o=I?.axisAlignSheetTransform)!=null?o:void 0}if(C!=null&&U!=null){const I=te(C,this._selectionRenderService,this._skeletonManagerService);d.push({...t,sheetTransform:C,transform:I,axisAlignSheetTransform:T})}return{updateDrawings:d,deleteDrawings:a}}_remainDrawingSize(n,e,t){const r=B({...n},this._selectionRenderService);if(r!=null){const i=W({...n},this._selectionRenderService);e.push({...t,sheetTransform:r,axisAlignSheetTransform:i})}}_getDrawingUndoForColVisible(n,e,t){const r=this._drawingManagerService.getDrawingData(n,e),i=[],s=[];if(Object.keys(r).forEach(l=>{const u=r[l],{sheetTransform:g,transform:h,anchorType:p=k.Position}=u;if(p===k.None)this._remainDrawingSize(h,i,u);else{const{from:m,to:f}=g,{row:w,column:_}=m,{row:R,column:b}=f;for(let S=0;S<t.length;S++){const v=t[S],{startRow:D,endRow:y,startColumn:C,endColumn:U}=v;if(b<C)continue;if(p===k.Position){let E=null,x=null;if(_>=C&&_<=U){const N=this._skeletonManagerService.attachRangeWithCoord({startColumn:_,endColumn:U,startRow:m.row,endRow:f.row});if(N==null)return;x={...h,left:N.startX}}if(x!=null){E=B(x,this._selectionRenderService);const N=W(x,this._selectionRenderService);if(E!=null&&x!=null){i.push({...u,sheetTransform:E,transform:x,axisAlignSheetTransform:N});break}}this._remainDrawingSize(h,i,u);continue}if(_>=C&&b<=U)continue;let T=null,I=null;if(_>=C&&_<=U){const E=this._skeletonManagerService.attachRangeWithCoord({startColumn:_,endColumn:U,startRow:m.row,endRow:f.row});if(E==null)return;I={...h,left:E?.startX||0,width:(h?.width||0)-E.endX+E.startX}}else if(b>=C&&b<=U){const E=this._skeletonManagerService.attachRangeWithCoord({startColumn:C,endColumn:b,startRow:m.row,endRow:f.row});if(E==null)return;I={...h,left:E.startX-(h?.width||0)}}else{const E=this._skeletonManagerService.attachRangeWithCoord({startColumn:C,endColumn:U,startRow:m.row,endRow:f.row});if(E==null)return;if(I={...h,width:(h?.width||0)-E.endX+E.startX},T=B(I,this._selectionRenderService),T!=null&&I!=null){const x=W(I,this._selectionRenderService);s.push({...u,sheetTransform:T,transform:I,axisAlignSheetTransform:x});break}}if(I!=null&&(T=B(I,this._selectionRenderService)),I!=null&&T!=null){const E=W(I,this._selectionRenderService);i.push({...u,sheetTransform:T,transform:I,axisAlignSheetTransform:E});break}else this._remainDrawingSize(h,i,u)}}}),i.length===0&&s.length===0)return{redos:[],undos:[]};const{redos:o,undos:d}=this._createUndoAndRedoMutation(n,e,i),a=[],c=[];if(s.length>0){const{redos:l,undos:u}=this._createUndoAndRedoMutation(n,e,s);a.push(...l),c.push(...u)}return{redos:o,undos:d,preRedos:a,preUndos:c}}_createUndoAndRedoMutation(n,e,t){const r=this._sheetDrawingService.getBatchUpdateOp(t),{undo:i,redo:s,objects:o}=r,d=[{id:A.id,params:{unitId:n,subUnitId:e,op:s,objects:o,type:M.UPDATE}},{id:V.id,params:[n]}],a=[{id:A.id,params:{unitId:n,subUnitId:e,op:i,objects:o,type:M.UPDATE}},{id:V.id,params:[n]}];return{redos:d,undos:a}}_getDrawingUndoForRowVisible(n,e,t){const r=this._drawingManagerService.getDrawingData(n,e),i=[],s=[];if(Object.keys(r).forEach(l=>{const u=r[l],{sheetTransform:g,transform:h,anchorType:p=k.Position}=u;if(p===k.None)this._remainDrawingSize(h,i,u);else{const{from:m,to:f}=g,{row:w,column:_}=m,{row:R,column:b}=f;for(let S=0;S<t.length;S++){const v=t[S],{startRow:D,endRow:y,startColumn:C,endColumn:U}=v;if(R<D)continue;if(p===k.Position){let E=null,x=null;if(w>=D&&w<=y){const N=this._skeletonManagerService.attachRangeWithCoord({startColumn:m.column,endColumn:f.column,startRow:w,endRow:y});if(N==null)return;x={...h,top:N.startY}}if(x!=null){E=B(x,this._selectionRenderService);const N=W(x,this._selectionRenderService);if(E!=null&&x!=null){i.push({...u,sheetTransform:E,transform:x,axisAlignSheetTransform:N});break}}this._remainDrawingSize(h,i,u);continue}if(w>=D&&R<=y)continue;let T=null,I=null;if(w>=D&&w<=y){const E=this._skeletonManagerService.attachRangeWithCoord({startColumn:m.column,endColumn:f.column,startRow:w,endRow:y});if(E==null)return;I={...h,top:E?.startY||0,height:(h?.height||0)-E.endY+E.startY}}else if(R>=D&&R<=y){const E=this._skeletonManagerService.attachRangeWithCoord({startColumn:m.column,endColumn:f.column,startRow:D,endRow:R});if(E==null)return;I={...h,top:E.startY-(h?.height||0)}}else{const E=this._skeletonManagerService.attachRangeWithCoord({startColumn:m.column,endColumn:f.column,startRow:D,endRow:y});if(E==null)return;if(I={...h,height:(h?.height||0)-E.endY+E.startY},T=B(I,this._selectionRenderService),T!=null&&I!=null){const x=W(I,this._selectionRenderService);s.push({...u,sheetTransform:T,transform:I,axisAlignSheetTransform:x});break}}if(I!=null&&(T=B(I,this._selectionRenderService)),I!=null&&T!=null){const E=W(I,this._selectionRenderService);i.push({...u,sheetTransform:T,transform:I,axisAlignSheetTransform:E});break}else this._remainDrawingSize(h,i,u)}}}),i.length===0&&s.length===0)return{redos:[],undos:[]};const{redos:o,undos:d}=this._createUndoAndRedoMutation(n,e,i),a=[],c=[];if(s.length>0){const{redos:l,undos:u}=this._createUndoAndRedoMutation(n,e,s);a.push(...l),c.push(...u)}return{redos:o,undos:d,preRedos:a,preUndos:c}}_getDrawingUndoForRowAndColSize(n,e,t,r){const i=this._drawingManagerService.getDrawingData(n,e),s=[];return Object.keys(i).forEach(o=>{const d=i[o],{sheetTransform:a,transform:c,anchorType:l=k.Position}=d;if(l===k.None)this._remainDrawingSize(c,s,d);else{const{from:u,to:g}=a,{row:h,column:p}=u,{row:m,column:f}=g;for(let w=0;w<t.length;w++){const _=t[w],{startRow:R,endRow:b,startColumn:S,endColumn:v}=_;if(m<R||f<S)continue;if(l===k.Position&&(h<=R&&m>=b||p<=S&&f>=v)){this._remainDrawingSize(c,s,d);continue}const D=te({...a},this._selectionRenderService,this._skeletonManagerService);if(D!=null){s.push({...d,transform:D});break}}}}),s.length===0?{redos:[],undos:[]}:this._createUndoAndRedoMutation(n,e,s)}_getUnitIdAndSubUnitId(n,e){let t,r;if(e==="insert")t=n.unitId,r=n.subUnitId;else{const i=he(this._univerInstanceService);if(i==null)return;t=i.unitId,r=i.subUnitId}return{unitId:t,subUnitId:r}}_moveRangeInterceptor(n){var e,t;const{toRange:r,fromRange:i}=n,s=he(this._univerInstanceService);if(!s)return{redos:[],undos:[]};const{unitId:o,subUnitId:d}=s,a=(t=(e=this._renderManagerService.getRenderById(o))==null?void 0:e.with(z))==null?void 0:t.getCurrentSkeleton();if(!a)return{redos:[],undos:[]};const c=Mr(a,i);if(!c)return{redos:[],undos:[]};const{startX:l,endX:u,startY:g,endY:h}=c,p=this._sheetDrawingService.getDrawingData(o,d),m=[];Object.keys(p).forEach(S=>{const v=p[S];if(v.anchorType!==k.Both)return;const{transform:D}=v;if(!D)return;const{left:y=0,top:C=0,width:U=0,height:T=0}=D,{drawingStartX:I,drawingEndX:E,drawingStartY:x,drawingEndY:N}={drawingStartX:y,drawingEndX:y+U,drawingStartY:C,drawingEndY:C+T};l<=I&&E<=u&&g<=x&&N<=h&&m.push(v)});const f=[],w=[],_=r.startRow-i.startRow,R=r.startColumn-i.startColumn,b=m.map(S=>{const v=S.sheetTransform,D={to:{...v.to,row:v.to.row+_,column:v.to.column+R},from:{...v.from,row:v.from.row+_,column:v.from.column+R}},y=te(D,this._selectionRenderService,this._skeletonManagerService);return{unitId:o,subUnitId:d,drawingId:S.drawingId,transform:y,sheetTransform:D}});if(b.length){const S=this._sheetDrawingService.getBatchUpdateOp(b),{undo:v,redo:D,objects:y}=S;f.push({id:A.id,params:{unitId:o,subUnitId:d,op:D,objects:y,type:M.UPDATE}}),w.push({id:A.id,params:{unitId:o,subUnitId:d,op:v,objects:y,type:M.UPDATE}})}return{redos:f,undos:w}}_moveRowInterceptor(n,e){const t=this._getUnitIdAndSubUnitId(n,e);if(t==null)return{redos:[],undos:[]};const{unitId:r,subUnitId:i}=t,{range:s}=n,o=s.startRow,d=s.endRow,a=[],c=[],l=this._sheetDrawingService.getDrawingData(r,i),u=[],g=[];if(Object.keys(l).forEach(h=>{var p,m;const f=l[h],{sheetTransform:w,transform:_,anchorType:R=k.Position}=f;if(w==null||_==null)return;let b,S,v;if(e==="insert"){const y=this._expandRow(w,_,o,d,R);b=y?.newSheetTransform,S=y?.newTransform,v=(p=y?.axisAlignSheetTransform)!=null?p:void 0}else{const{from:y,to:C}=w,{row:U}=y,{row:T}=C;if(R===k.Both&&U>=o&&T<=d)g.push({unitId:r,subUnitId:i,drawingId:h});else{const I=this._shrinkRow(w,_,o,d,R);b=I?.newSheetTransform,S=I?.newTransform,v=(m=I?.axisAlignSheetTransform)!=null?m:void 0}}if(!b||!S)return;const D={unitId:r,subUnitId:i,drawingId:h,transform:S,sheetTransform:b,axisAlignSheetTransform:v};u.push(D)}),u.length===0&&g.length===0)return{redos:[],undos:[]};if(u.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(u),{undo:p,redo:m,objects:f}=h;a.push({id:A.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:M.UPDATE}}),c.push({id:A.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:M.UPDATE}})}if(g.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(g),p=h.undo,m=h.redo,f=h.objects;a.push({id:A.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:M.REMOVE}}),c.push({id:A.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:M.INSERT}})}return a.push({id:V.id,params:[r]}),c.push({id:V.id,params:[r]}),{redos:a,undos:c}}_moveColInterceptor(n,e){const t=this._getUnitIdAndSubUnitId(n,e);if(t==null)return{redos:[],undos:[]};const{unitId:r,subUnitId:i}=t,{range:s}=n,o=s.startColumn,d=s.endColumn,a=[],c=[],l=this._sheetDrawingService.getDrawingData(r,i),u=[],g=[];if(Object.keys(l).forEach(h=>{var p,m;const f=l[h],{sheetTransform:w,transform:_,anchorType:R=k.Position}=f;if(w==null||_==null)return;let b,S,v;if(e==="insert"){const y=this._expandCol(w,_,o,d,R);b=y?.newSheetTransform,S=y?.newTransform,v=(p=y?.axisAlignSheetTransform)!=null?p:void 0}else{const{from:y,to:C}=w,{column:U}=y,{column:T}=C;if(R===k.Both&&U>=o&&T<=d)g.push({unitId:r,subUnitId:i,drawingId:h});else{const I=this._shrinkCol(w,_,o,d,R);b=I?.newSheetTransform,S=I?.newTransform,v=(m=I?.axisAlignSheetTransform)!=null?m:void 0}}if(!b||!S)return;const D={unitId:r,subUnitId:i,drawingId:h,transform:S,sheetTransform:b,axisAlignSheetTransform:v};u.push(D)}),u.length===0&&g.length===0)return{redos:[],undos:[]};if(u.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(u),{undo:p,redo:m,objects:f}=h;a.push({id:A.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:M.UPDATE}}),c.push({id:A.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:M.UPDATE}})}if(g.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(g),p=h.undo,m=h.redo,f=h.objects;a.push({id:A.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:M.REMOVE}}),c.push({id:A.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:M.INSERT}})}return a.push({id:V.id,params:[r]}),c.push({id:V.id,params:[r]}),{redos:a,undos:c}}_expandCol(n,e,t,r,i=k.Position){const s=r-t+1,{from:o,to:d}=n,{column:a}=o,{column:c}=d;if(i===k.None)return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};let l=null,u=null,g=null;if(a>=t){const h=this._skeletonManagerService.attachRangeWithCoord({startColumn:t,endColumn:r,startRow:o.row,endRow:d.row});if(h==null)return;u={...e,left:(e.left||0)+h.endX-h.startX},l=B(u,this._selectionRenderService),g=W(u,this._selectionRenderService)}else if(c>=r)if(i===k.Both)l={from:{...o},to:{...d,column:c+s}},u=te(l,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};return l!=null&&u!=null?{newSheetTransform:l,newTransform:u,axisAlignSheetTransform:g}:null}_shrinkCol(n,e,t,r,i=k.Position){const s=r-t+1,{from:o,to:d}=n,{column:a}=o,{column:c}=d;if(i===k.None)return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};let l=null,u=null,g=null;if(a>r)l={from:{...o,column:a-s},to:{...d,column:c-s}},u=te(l,this._selectionRenderService,this._skeletonManagerService);else{if(a>=t&&c<=r)return null;if(a<t&&c>r)if(i===k.Both)l={from:{...o},to:{...d,column:c-s}},u=te(l,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};else if(a>=t&&a<=r){if(a===t)u={...e,left:(e.left||0)-n.from.columnOffset};else{const h=this._skeletonManagerService.attachRangeWithCoord({startColumn:t,endColumn:a-1,startRow:o.row,endRow:d.row});if(h==null)return;u={...e,left:(e.left||0)-h.endX+h.startX-n.from.columnOffset}}l=B(u,this._selectionRenderService),g=W(u,this._selectionRenderService)}else if(c>=t&&c<=r&&i===k.Both){const h=this._skeletonManagerService.attachRangeWithCoord({startColumn:t-1,endColumn:t-1,startRow:o.row,endRow:d.row});if(h==null)return;l={from:{...o},to:{...d,column:t-1,columnOffset:h.endX-h.startX}},u=te(l,this._selectionRenderService,this._skeletonManagerService)}}return l!=null&&u!=null?{newSheetTransform:l,newTransform:u,axisAlignSheetTransform:g}:null}_expandRow(n,e,t,r,i=k.Position){const s=r-t+1,{from:o,to:d}=n,{row:a}=o,{row:c}=d;if(i===k.None)return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};let l=null,u=null,g=null;if(a>=t){const h=this._skeletonManagerService.attachRangeWithCoord({startRow:t,endRow:r,startColumn:o.column,endColumn:d.column});if(h==null)return;u={...e,top:(e.top||0)+h.endY-h.startY},l=B(u,this._selectionRenderService),g=W(u,this._selectionRenderService)}else if(c>=r)if(i===k.Both)l={from:{...o},to:{...d,row:c+s}},u=te(l,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};return l!=null&&u!=null?{newSheetTransform:l,newTransform:u,axisAlignSheetTransform:g}:null}_shrinkRow(n,e,t,r,i=k.Position){const s=r-t+1,{from:o,to:d}=n,{row:a}=o,{row:c}=d;if(i===k.None)return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};let l=null,u=null,g=null;if(a>r)l={from:{...o,row:a-s},to:{...d,row:c-s}},u=te(l,this._selectionRenderService,this._skeletonManagerService);else{if(a>=t&&c<=r)return null;if(a<t&&c>r)if(i===k.Both)l={from:{...o},to:{...d,row:c-s}},u=te(l,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:B({...e},this._selectionRenderService),newTransform:e,axisAlignSheetTransform:W({...e},this._selectionRenderService)};else if(a>=t&&a<=r){if(a===t)u={...e,top:(e.top||0)-n.from.rowOffset};else{const h=this._skeletonManagerService.attachRangeWithCoord({startRow:t,endRow:a-1,startColumn:o.column,endColumn:d.column});if(h==null)return;u={...e,top:(e.top||0)-h.endY+h.startY-n.from.rowOffset}}l=B(u,this._selectionRenderService),g=W(u,this._selectionRenderService)}else if(c>=t&&c<=r&&i===k.Both){const h=this._skeletonManagerService.attachRangeWithCoord({startColumn:o.column,endColumn:o.column,startRow:t-1,endRow:t-1});if(h==null)return;l={from:{...o},to:{...d,row:t-1,rowOffset:h.endY-h.startY}},u=te(l,this._selectionRenderService,this._skeletonManagerService)}}return l!=null&&u!=null?{newSheetTransform:l,newTransform:u,axisAlignSheetTransform:g}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id===ts.id){const{unitId:e,subUnitId:t}=n.params;this._updateDrawings(e,t)}})),this.disposeWithMe(this._context.activated$.subscribe(n=>{const{unit:e,unitId:t}=this._context;if(n){const r=e.getActiveSheet().getSheetId();this._updateDrawings(t,r)}else this._clearDrawings(t)}))}_clearDrawings(n){setTimeout(()=>{const e=this._drawingManagerService.drawingManagerData,t=[];Object.keys(e).forEach(r=>{const i=e[r];i!=null&&Object.keys(i).forEach(s=>{const o=i[s].data;o!=null&&Object.keys(o).forEach(d=>{r===n&&t.push(o[d])})})}),this._sheetDrawingService.removeNotification(t),this._drawingManagerService.removeNotification(t)})}_updateDrawings(n,e){setTimeout(()=>{const t=this._drawingManagerService.drawingManagerData,r=[],i=[];Object.keys(t).forEach(s=>{const o=t[s];o!=null&&Object.keys(o).forEach(d=>{const a=o[d].data;a!=null&&Object.keys(a).forEach(c=>{if(s===n&&d===e){const l=a[c];l.transform=te(l.sheetTransform,this._selectionRenderService,this._skeletonManagerService),r.push(a[c])}else i.push(a[c])})})}),this._sheetDrawingService.removeNotification(i),this._sheetDrawingService.addNotification(r),this._drawingManagerService.removeNotification(i),this._drawingManagerService.addNotification(r)},0)}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(n=>{So.includes(n.id)&&requestIdleCallback(()=>{const e=n.params,t=he(this._univerInstanceService,e);if(!t)return;const{unitId:r,subUnitId:i,worksheet:s}=t;let o=[];"ranges"in e?o=e.ranges:"rowsAutoHeightInfo"in e&&(o=e.rowsAutoHeightInfo.map(d=>({startRow:d.row,endRow:d.row,startColumn:0,endColumn:s.getColumnCount()-1}))),this._refreshDrawingTransform(r,i,o)})}))}_refreshDrawingTransform(n,e,t){const r=this._drawingManagerService.getDrawingData(n,e),i=[];Object.keys(r).forEach(s=>{const o=r[s],{sheetTransform:d,transform:a,anchorType:c=k.Position}=o;if(c===k.None)return!0;const{from:l,to:u}=d,{row:g,column:h}=l,{row:p,column:m}=u;for(let f=0;f<t.length;f++){const w=t[f],{startRow:_,endRow:R,startColumn:b,endColumn:S}=w;if(Pi.intersects({startRow:_,endRow:R,startColumn:b,endColumn:S},{startRow:g,endRow:p,startColumn:h,endColumn:m})||g>R||h>S){const v=c===k.Position,D=te(d,this._selectionRenderService,this._skeletonManagerService);i.push({...o,transform:{...D,width:v?a?.width:D?.width,height:v?a?.height:D?.height}});break}}}),i.length!==0&&(this._sheetDrawingService.refreshTransform(i),this._drawingManagerService.refreshTransform(i),this._commandService.syncExecuteCommand(V.id,[n]))}};An=vo([Ce(1,Z),Ce(2,H),Ce(3,we),Ce(4,O(z)),Ce(5,O(ot)),Ce(6,Y),Ce(7,X),Ce(8,me)],An);function bo(){const n=Ae(We),e=Ae(Nn),t=Ae(St),[r,i]=J.useState([le.CELL_ADDRESS]),[s,o]=J.useState(!1),[d,a]=J.useState(null),c=J.useMemo(()=>t.getCellImagesInSelection(),[t]),l=J.useMemo(()=>t.getDataColumns(),[t]),u=J.useMemo(()=>t.getSelectionRowRange(),[t]),g=l.length>0,h=J.useMemo(()=>l.map(v=>({label:v.label,value:String(v.index)})),[l]),[p,m]=J.useState(()=>h.length>0?h[0].value:"0"),f=J.useMemo(()=>{if(!r.includes(le.COLUMN_VALUE)||!u)return[];const v=Number(p);return[{startRow:u.startRow,endRow:u.endRow,startColumn:v,endColumn:v}]},[r,p,u]);cs(f);const w=J.useCallback(v=>{v.length!==0&&i(v)},[]),_=J.useCallback(v=>{m(String(v))},[]),R=J.useCallback(()=>{e.close(et)},[e]),b=J.useCallback(async()=>{if(c.length!==0){o(!0),a(null);try{await t.saveImages(c,{fileNameParts:r,columnIndex:r.includes(le.COLUMN_VALUE)?Number(p):void 0}),e.close(et)}catch(v){console.error("Failed to save images:",v),a(n.t("sheetImage.save.error"))}finally{o(!1)}}},[t,c,r,p,e,n]),S=r.includes(le.COLUMN_VALUE);return F.jsxs("div",{className:"univer-flex univer-flex-col",children:[F.jsx(hn,{label:n.t("sheetImage.save.imageCount"),children:F.jsx("div",{className:"univer-text-sm univer-text-gray-600",children:c.length})}),F.jsx(hn,{label:n.t("sheetImage.save.fileNameConfig"),children:F.jsxs(Cs,{value:r,onChange:w,direction:"vertical",children:[F.jsx(cr,{value:le.CELL_ADDRESS,disabled:!g,children:n.t("sheetImage.save.useRowCol")}),g&&F.jsx(cr,{value:le.COLUMN_VALUE,children:n.t("sheetImage.save.useColumnValue")})]})}),S&&F.jsx(hn,{label:n.t("sheetImage.save.selectColumn"),children:F.jsx(Es,{value:p,options:h,onChange:_})}),d&&F.jsx("div",{className:"univer-text-xs univer-text-red-500",children:d}),F.jsxs("div",{className:"univer-flex univer-justify-end univer-gap-2 univer-border-t univer-border-gray-200 univer-pt-3",children:[F.jsx(lr,{onClick:R,disabled:s,children:n.t("sheetImage.save.cancel")}),F.jsx(lr,{variant:"primary",onClick:b,disabled:s||c.length===0,children:s?n.t("sheetImage.save.saving"):n.t("sheetImage.save.confirm")})]})]})}const yo=n=>{var e;const t=Ae(H),r=Ae(We),i=Ae(X),s=Ae(Z),{drawings:o}=n,d=o[0];if(d==null)return;const{unitId:a}=d,c=s.getRenderById(a),l=c?.scene;if(l==null)return;const u=l.getTransformerByCreate(),[g,h]=J.useState(!0),p=(e=d.anchorType)!=null?e:k.Position,[m,f]=J.useState(p);function w(R,b){const S=[];return R.forEach(v=>{const{oKey:D}=v,y=b.getDrawingOKey(D);if(y==null)return S.push(null),!0;const{unitId:C,subUnitId:U,drawingId:T,drawingType:I,anchorType:E,sheetTransform:x,axisAlignSheetTransform:N}=y;S.push({unitId:C,subUnitId:U,drawingId:T,anchorType:E,sheetTransform:x,drawingType:I,axisAlignSheetTransform:N})}),S}J.useEffect(()=>{const R=u.clearControl$.subscribe(S=>{S===!0&&h(!1)}),b=u.changeStart$.subscribe(S=>{var v;const{objects:D}=S,y=w(D,i);if(y.length===0)h(!1);else if(y.length>=1){h(!0);const C=((v=y[0])==null?void 0:v.anchorType)||k.Position;f(C)}});return()=>{b.unsubscribe(),R.unsubscribe()}},[]);function _(R){f(R);const b=i.getFocusDrawings();if(b.length===0)return;const S=b.map(v=>({unitId:v.unitId,subUnitId:v.subUnitId,drawingId:v.drawingId,anchorType:R}));t.executeCommand(ee.id,{unitId:b[0].unitId,drawings:S})}return F.jsxs("div",{className:ys("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!g}),children:[F.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:F.jsx("div",{children:r.t("drawing-anchor.title")})}),F.jsx("div",{children:F.jsxs(bs,{value:m,onChange:_,direction:"vertical",children:[F.jsx(un,{value:k.Both,children:r.t("drawing-anchor.both")}),F.jsx(un,{value:k.Position,children:r.t("drawing-anchor.position")}),F.jsx(un,{value:k.None,children:r.t("drawing-anchor.none")})]})})]})},Ro=()=>{const n=Ae(X),e=n.getFocusDrawings(),[t,r]=J.useState(e);return J.useEffect(()=>{const i=n.focus$.subscribe(s=>{r(s)});return()=>{i.unsubscribe()}},[]),!!(t!=null&&t.length)&&F.jsxs("div",{className:"univer-text-sm",children:[F.jsx(Di,{drawings:t}),F.jsx(yo,{drawings:t})]})},gi="sheet.menu.image";function Do(n){return{id:gi,type:tn.SUBITEMS,icon:"AddImageIcon",tooltip:"sheetImage.title",hidden$:en(n,j.UNIVER_SHEET),disabled$:ls(n,{workbookTypes:[Rn],worksheetTypes:[Dn],rangeTypes:[us]})}}function Co(n){return{id:nn.id,title:"sheetImage.upload.float",type:tn.BUTTON,hidden$:en(n,j.UNIVER_SHEET)}}function Eo(n){return{id:jn.id,title:"sheetImage.upload.cell",type:tn.BUTTON,hidden$:en(n,j.UNIVER_SHEET)}}function To(n){var e,t,r,i;return!!((t=(e=n?.p)==null?void 0:e.drawingsOrder)!=null&&t.length&&((i=(r=n?.p)==null?void 0:r.drawingsOrder)==null?void 0:i.length)>0)}function Uo(n,e){const t=n.getActiveSheet();if(!t)return!1;const r=t.getCellMatrix(),{startRow:i,endRow:s,startColumn:o,endColumn:d}=e;for(let a=i;a<=s;a++)for(let c=o;c<=d;c++){const l=r.getValue(a,c);if(To(l))return!0}return!1}function Mo(){return"showDirectoryPicker"in window}function wn(n){const e=n.get(me),t=n.get(vt),r=mt([en(n,j.UNIVER_SHEET),e.getCurrentTypeOfUnit$(j.UNIVER_SHEET).pipe(be(i=>i?t.selectionMoveEnd$.pipe(ye(()=>{if(!Mo())return!0;const s=t.getCurrentSelections();if(!s||s.length===0)return!0;for(const o of s)if(Uo(i,o.range))return!1;return!0})):Sn(!0)))]).pipe(ye(([i,s])=>i||s));return{id:wt.id,type:tn.BUTTON,icon:"DownloadImageIcon",title:"sheetImage.save.menuLabel",hidden$:r}}const Ao={[xs.MEDIA]:{[gi]:{order:0,menuItemFactory:Do,[nn.id]:{order:0,menuItemFactory:Co},[jn.id]:{order:1,menuItemFactory:Eo}}},[gn.MAIN_AREA]:{[mn.OTHERS]:{[wt.id]:{order:10,menuItemFactory:wn}}},[gn.COL_HEADER]:{[mn.OTHERS]:{[wt.id]:{order:10,menuItemFactory:wn}}},[gn.ROW_HEADER]:{[mn.OTHERS]:{[wt.id]:{order:10,menuItemFactory:wn}}}};function bt(n){return n.getContextValue(Ni)&&!n.getContextValue(ji)&&!n.getContextValue(Wi)&&n.getContextValue(qe)&&!n.getContextValue($i)}const Oo={id:_t.id,description:"shortcut.drawing-move-down",group:"4_drawing-view",binding:nt.ARROW_DOWN,priority:100,preconditions:bt,staticParameters:{direction:Ue.DOWN}},xo={id:_t.id,description:"shortcut.drawing-move-up",group:"4_drawing-view",binding:nt.ARROW_UP,priority:100,preconditions:bt,staticParameters:{direction:Ue.UP}},ko={id:_t.id,description:"shortcut.drawing-move-left",group:"4_drawing-view",binding:nt.ARROW_LEFT,priority:100,preconditions:bt,staticParameters:{direction:Ue.LEFT}},Po={id:_t.id,description:"shortcut.drawing-move-right",group:"4_drawing-view",binding:nt.ARROW_RIGHT,priority:100,preconditions:bt,staticParameters:{direction:Ue.RIGHT}},No={id:ii.id,description:"shortcut.drawing-delete",group:"4_drawing-view",priority:100,preconditions:bt,binding:nt.DELETE,mac:nt.BACKSPACE};var jo=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},Ve=(n,e)=>(t,r)=>e(t,r,n);let Jt=class extends oe{constructor(n,e,t,r,i,s){super(),this._componentManager=n,this._menuManagerService=e,this._commandService=t,this._shortcutService=r,this._drawingManagerService=i,this._sheetsSelectionsService=s,this._init()}_initCustomComponents(){const n=this._componentManager;this.disposeWithMe(n.register(ai,Ro)),this.disposeWithMe(n.register(et,bo))}_initMenus(){this._menuManagerService.mergeMenu(Ao)}_initCommands(){[nn,jn,ve,ge,ee,di,V,ci,si,oi,_t,ii,Qe,wt].forEach(n=>this.disposeWithMe(this._commandService.registerCommand(n)))}_initShortcuts(){[Oo,xo,ko,Po,No].forEach(n=>{this.disposeWithMe(this._shortcutService.registerShortcut(n))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};Jt=jo([Ve(0,O(pt)),Ve(1,Ws),Ve(2,H),Ve(3,$s),Ve(4,X),Ve(5,O(vt))],Jt);var Wo=Object.defineProperty,$o=(n,e,t)=>e in n?Wo(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Bo=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},In=(n,e)=>(t,r)=>e(t,r,n),mi=(n,e,t)=>$o(n,typeof e!="symbol"?e+"":e,t);const Fo="SHEET_IMAGE_UI_PLUGIN";let It=class extends Rr{constructor(n=wr,e,t,r){super(),this._config=n,this._injector=e,this._renderManagerService=t,this._configService=r;const{menu:i,...s}=Dr({},wr,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(to,s)}onStarting(){Ui(this._injector,[[ce],[Jt],[Lt],[Kt],[zt],[Vt],[Yt],[Xt],[Ht],[St,{useClass:Tn}]]),dn(this._injector,[[ce]])}onReady(){dn(this._injector,[[Vt],[Ht]])}onRendered(){this._registerRenderModules(),dn(this._injector,[[zt],[Kt],[Jt],[Yt],[Xt]])}onSteady(){this._injector.get(Lt)}_registerRenderModules(){[[it],[An],[Mn],[Un]].forEach(n=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(j.UNIVER_SHEET,n))})}};mi(It,"type",j.UNIVER_SHEET);mi(It,"pluginName",Fo);It=Bo([Cr(xn,_r,Sr,rt),In(1,O(Re)),In(2,Z),In(3,Er)],It);var Go=Object.defineProperty,Lo=(n,e,t)=>e in n?Go(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Yo=(n,e,t)=>Lo(n,e+"",t),fi=(n,e,t,r)=>{for(var i=e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(i=o(i)||i);return i},On=(n,e)=>(t,r)=>e(t,r,n);function Xo(n,e){const{from:t,to:r,flipY:i=!1,flipX:s=!1,angle:o=0,skewX:d=0,skewY:a=0}=n.sheetTransform,{column:c,columnOffset:l,row:u,rowOffset:g}=t,h=Ar(n.unitId,n.subUnitId,{from:t,to:r},e),{width:p,height:m}=h;return{...n,column:c,columnOffset:l,row:u,rowOffset:g,width:p,height:m,flipY:i,flipX:s,angle:o,skewX:d,skewY:a}}function Ho(n,e,t){const{column:r,columnOffset:i,row:s,rowOffset:o,flipY:d=!1,flipX:a=!1,angle:c=0,skewX:l=0,skewY:u=0,width:g,height:h}=n,p=Is(n.unitId,n.subUnitId,{column:r,columnOffset:i,row:s,rowOffset:o},g,h,e,t),{sheetTransform:m,transform:f}=p;return{...n,sheetTransform:{...m,flipY:d,flipX:a,angle:c,skewX:l,skewY:u},transform:{...f,flipY:d,flipX:a,angle:c,skewX:l,skewY:u},axisAlignSheetTransform:W(f,e)}}let Zt=class{constructor(e,t,r){Yo(this,"_image"),this._injector=r,this._image={drawingId:Te(6),drawingType:P.DRAWING_IMAGE,imageSourceType:re.BASE64,source:"",unitId:e,subUnitId:t,column:0,columnOffset:0,row:0,rowOffset:0,width:0,height:0,axisAlignSheetTransform:{from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}}}setImage(e){const t=this._injector.get(Z).getRenderById(e.unitId);if(!t)throw new Error(`Render Unit with unitId ${e.unitId} not found`);const r=t.with(z);return e.sheetTransform==null&&(e.sheetTransform={from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}),e.axisAlignSheetTransform==null&&(e.axisAlignSheetTransform={from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}),this._image=Xo(e,r),this}setSource(e,t){const r=t??re.URL;return this._image.source=e,this._image.imageSourceType=r,this}getSource(){return this._image.source}getSourceType(){return this._image.imageSourceType}setColumn(e){return this._image.column=e,this}setRow(e){return this._image.row=e,this}setColumnOffset(e){return this._image.columnOffset=e,this}setRowOffset(e){return this._image.rowOffset=e,this}setWidth(e){return this._image.width=e,this}setHeight(e){return this._image.height=e,this}setAnchorType(e){return this._image.anchorType=e,this}setCropTop(e){return this._initializeSrcRect(),this._image.srcRect.top=e,this}setCropLeft(e){return this._initializeSrcRect(),this._image.srcRect.left=e,this}setCropBottom(e){return this._initializeSrcRect(),this._image.srcRect.bottom=e,this}setCropRight(e){return this._initializeSrcRect(),this._image.srcRect.right=e,this}_initializeSrcRect(){this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0})}setRotate(e){return this._image.angle=e,this}setUnitId(e){return this._image.unitId=e,this}setSubUnitId(e){return this._image.subUnitId=e,this}async buildAsync(){const e=this._injector.get(Z).getRenderById(this._image.unitId);if(!e)throw new Error(`Render Unit with unitId ${this._image.unitId} not found`);const t=e.with(we),r=e.with(z);if(this._image.width===0||this._image.height===0){const i=await Bt(this._image.source),s=i.width,o=i.height;this._image.width===0&&(this._image.width=s),this._image.height===0&&(this._image.height=o)}return Ho(this._image,t,r)}};Zt=fi([On(2,O(Re))],Zt);let pe=class extends Bs{constructor(n,e,t){super(),this._image=n,this._commandService=e,this._injector=t}getId(){return this._image.drawingId}getType(){return this._image.drawingType}remove(){return this._commandService.syncExecuteCommand(ge.id,{unitId:this._image.unitId,drawings:[this._image]})}toBuilder(){const n=this._injector.createInstance(Zt);return n.setImage(this._image),n}setSource(n,e){const t=e??re.URL;return this._image.source=n,this._image.imageSourceType=t,this._commandService.syncExecuteCommand(ee.id,{unitId:this._image.unitId,drawings:[this._image]})}async setPositionAsync(n,e,t,r){const i=this.toBuilder();i.setColumn(e),i.setRow(n),t!=null&&i.setRowOffset(t),r!=null&&i.setColumnOffset(r);const s=await i.buildAsync();return this._commandService.syncExecuteCommand(ee.id,{unitId:this._image.unitId,drawings:[s]})}async setSizeAsync(n,e){const t=this.toBuilder();t.setWidth(n),t.setHeight(e);const r=await t.buildAsync();return this._commandService.syncExecuteCommand(ee.id,{unitId:this._image.unitId,drawings:[r]})}setCrop(n,e,t,r){return this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0}),n!=null&&(this._image.srcRect.top=n),e!=null&&(this._image.srcRect.left=e),t!=null&&(this._image.srcRect.bottom=t),r!=null&&(this._image.srcRect.right=r),this._commandService.syncExecuteCommand(ee.id,{unitId:this._image.unitId,drawings:[this._image]})}setRotate(n){if(this._image.sheetTransform.angle=n,this._image.transform&&(this._image.transform.angle=n),this._image.transform){const e=this._injector.get(Z).getRenderById(this._image.unitId);if(!e)throw new Error(`Render Unit with unitId ${this._image.unitId} not found`);const t=e.with(we);this._image.axisAlignSheetTransform&&(this._image.axisAlignSheetTransform=W(this._image.transform,t))}return this._commandService.syncExecuteCommand(ee.id,{unitId:this._image.unitId,drawings:[this._image]})}setForward(){return this._commandService.syncExecuteCommand(Qe.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:Me.forward})}setBackward(){return this._commandService.syncExecuteCommand(Qe.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:Me.backward})}setBack(){return this._commandService.syncExecuteCommand(Qe.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:Me.back})}setFront(){return this._commandService.syncExecuteCommand(Qe.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:Me.front})}};pe=fi([On(1,H),On(2,O(Re))],pe);class Vo extends Kr{getFloatDomById(e){const t=this._injector.get(ce).getFloatDomInfo(e);if(!t)return null;const{unitId:r,subUnitId:i}=t,{rect:s}=t,o=s.getState(),{left:d=0,top:a=0,width:c=0,height:l=0,flipX:u=!1,flipY:g=!1,angle:h=0,skewX:p=0,skewY:m=0}=o,f=this._injector.get(Y).getDrawingByParam({drawingId:t.id,unitId:r,subUnitId:i});return f?{position:{left:d,top:a,width:c,height:l,flipX:u,flipY:g,angle:h,skewX:p,skewY:m},componentKey:f.componentKey,allowTransform:f.allowTransform,data:f.data,id:t.id}:null}getAllFloatDoms(){const e=this._injector.get(ce),t=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return Array.from(e.getFloatDomsBySubUnitId(t,r).values()).map(i=>{const{rect:s}=i,o=this._injector.get(Y).getDrawingByParam({drawingId:i.id,unitId:t,subUnitId:r}),{left:d,top:a,width:c,height:l,flipX:u,flipY:g,angle:h,skewX:p,skewY:m}=s.getState();return{position:{left:d,top:a,width:c,height:l,flipX:u,flipY:g,angle:h,skewX:p,skewY:m},componentKey:o.componentKey,allowTransform:o.allowTransform,data:o.data,id:i.id}})}updateFloatDom(e,t){var r,i,s;const o=this._injector.get(ce).getFloatDomInfo(e);if(!o)return this;const{unitId:d,subUnitId:a}=o,c=this._injector.get(Y).getDrawingByParam({unitId:d,subUnitId:a,drawingId:e}),l=this._injector.get(Z);if(!l.getRenderById(d))return this;if(!this.getSkeleton())return this;const u=(r=l.getRenderById(this.getWorkbook().getUnitId()))==null?void 0:r.with(we);if(!u)return this;const g={...c,componentKey:t.componentKey||c.componentKey,allowTransform:t.allowTransform!==void 0?t.allowTransform:c.allowTransform,data:t.data||c.data,sheetTransform:t.position&&(i=B(t.position,u))!=null?i:c.sheetTransform,transform:{...c.transform,...t.position},axisAlignSheetTransform:t.position&&(s=W(t.position,u))!=null?s:c.sheetTransform};if(!this._commandService.syncExecuteCommand(ee.id,{unitId:d,subUnitId:a,drawings:[g]}))throw new Error("updateFloatDom failed");return this}batchUpdateFloatDoms(e){var t,r;const i=this._injector.get(ce),s=this._injector.get(Y),o=this._injector.get(Z),d=[];for(const a of e){const c=i.getFloatDomInfo(a.id);if(!c)continue;const{unitId:l,subUnitId:u}=c,g=s.getDrawingByParam({unitId:l,subUnitId:u,drawingId:a.id});if(!g)continue;const h=o.getRenderById(l);if(!h||!this.getSkeleton())continue;const p=h.with(we);if(!p)return this;const m={...g,componentKey:a.config.componentKey||g.componentKey,allowTransform:a.config.allowTransform!==void 0?a.config.allowTransform:g.allowTransform,data:a.config.data||g.data,sheetTransform:a.config.position&&(t=B(a.config.position,p))!=null?t:g.sheetTransform,transform:{...g.transform,...a.config.position},axisAlignSheetTransform:a.config.position&&(r=W(a.config.position,p))!=null?r:g.sheetTransform};d.push(m)}if(d.length>0){const a=this._workbook.getUnitId(),c=this._worksheet.getSheetId();if(!this._commandService.syncExecuteCommand(ee.id,{unitId:a,subUnitId:c,drawings:d}))throw new Error("batchUpdateFloatDoms failed")}return this}removeFloatDom(e){const t=this._injector.get(ce).getFloatDomInfo(e);if(!t)return this;const{unitId:r,subUnitId:i}=t,s=this._injector.get(Y).getDrawingByParam({unitId:r,subUnitId:i,drawingId:e});if(!s)return this;if(!this._commandService.syncExecuteCommand(ge.id,{unitId:r,drawings:[s]}))throw new Error("removeFloatDom failed");return this}addFloatDomToPosition(e,t){const r=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),{key:s,disposableCollection:o}=fn(e,this._injector.get(pt)),d=this._injector.get(ce).addFloatDomToPosition({...e,componentKey:s,unitId:r,subUnitId:i},t);return d?(o.add(d.dispose),{id:d.id,dispose:()=>{o.dispose(),d.dispose()}}):(o.dispose(),null)}addFloatDomToRange(e,t,r,i){const s=this._workbook.getUnitId(),o=this._worksheet.getSheetId(),{key:d,disposableCollection:a}=fn(t,this._injector.get(pt)),c=this._injector.get(ce).addFloatDomToRange(e.getRange(),{...t,componentKey:d,unitId:s,subUnitId:o},r,i);return c?(a.add(c.dispose),{id:c.id,dispose:()=>{a.dispose(),c.dispose()}}):(a.dispose(),null)}addFloatDomToColumnHeader(e,t,r,i){const s=this._workbook.getUnitId(),o=this._worksheet.getSheetId(),{key:d,disposableCollection:a}=fn(t,this._injector.get(pt)),c=this._injector.get(ce).addFloatDomToColumnHeader(e,{...t,componentKey:d,unitId:s,subUnitId:o},r,i);return c?(a.add(c.dispose),{id:c.id,dispose:()=>{a.dispose(),c.dispose()}}):(a.dispose(),null)}async insertImage(e,t,r,i,s){const o=this.newOverGridImage();if(typeof e=="string")o.setSource(e);else{const a=await e.getBlob().getDataAsString();o.setSource(a,re.BASE64)}t!==void 0?o.setColumn(t):o.setColumn(0),r!==void 0?o.setRow(r):o.setRow(0),i!==void 0?o.setColumnOffset(i):o.setColumnOffset(0),s!==void 0?o.setRowOffset(s):o.setRowOffset(0);const d=await o.buildAsync();return this._commandService.syncExecuteCommand(ve.id,{unitId:this._fWorkbook.getId(),drawings:[d]})}insertImages(e){const t=e.map(r=>(r.unitId=this._fWorkbook.getId(),r.subUnitId=this.getSheetId(),r));return this._commandService.syncExecuteCommand(ve.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}deleteImages(e){const t=e.map(r=>({unitId:this._fWorkbook.getId(),drawingId:r.getId(),subUnitId:this.getSheetId(),drawingType:r.getType()}));return this._commandService.syncExecuteCommand(ge.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}getImages(){const e=this._injector.get(Y).getDrawingData(this._fWorkbook.getId(),this.getSheetId()),t=[];for(const r in e){const i=e[r];i.drawingType===P.DRAWING_IMAGE&&t.push(this._injector.createInstance(pe,i))}return t}getImageById(e){const t=this._injector.get(Y).getDrawingByParam({unitId:this._fWorkbook.getId(),subUnitId:this.getSheetId(),drawingId:e});return t&&t.drawingType===P.DRAWING_IMAGE?this._injector.createInstance(pe,t):null}getActiveImages(){const e=this._injector.get(Y).getFocusDrawings(),t=[];for(const r in e){const i=e[r];t.push(this._injector.createInstance(pe,i))}return t}updateImages(e){return this._commandService.syncExecuteCommand(ee.id,{unitId:this._fWorkbook.getId(),drawings:e}),this}onImageInserted(e){const t=this._injector.get(Y);return cn(t.add$.subscribe(r=>{const i=r.map(s=>this._injector.createInstance(pe,t.getDrawingByParam(s)));e(i)}))}onImageDeleted(e){const t=this._injector.get(Y);return cn(t.remove$.subscribe(r=>{const i=r.map(s=>this._injector.createInstance(pe,t.getDrawingByParam(s)));e(i)}))}onImageChanged(e){const t=this._injector.get(Y);return cn(t.update$.subscribe(r=>{const i=r.map(s=>this._injector.createInstance(pe,t.getDrawingByParam(s)));e(i)}))}newOverGridImage(){const e=this._fWorkbook.getId(),t=this.getSheetId();return this._injector.createInstance(Zt,e,t)}async saveCellImagesAsync(e,t){var r;const i=this._injector.get(St),s=this._fWorkbook.getId(),o=this.getSheetId(),d=t?t.map(g=>g.getRange()):[this._worksheet.getCellMatrix().getDataRange()],a=i.getCellImagesFromRanges(s,o,d);if(a.length===0)return!1;if(a.length===1)try{return await i.downloadSingleImage(a[0]),!0}catch(g){return console.error("Failed to download image:",g),!1}const c=[],l=(r=e?.useCellAddress)!=null?r:!0,u=e?.useColumnIndex;l&&c.push(le.CELL_ADDRESS),u!==void 0&&c.push(le.COLUMN_VALUE),c.length===0&&c.push(le.CELL_ADDRESS);try{return await i.saveImagesWithContext(a,{fileNameParts:c,columnIndex:u},s,o),!0}catch(g){return console.error("Failed to save images:",g),!1}}}Kr.extend(Vo);class zo extends qr{get DrawingType(){return P}get ImageSourceType(){return re}get SheetDrawingAnchorType(){return k}}qr.extend(zo);class Ko extends ei{get BeforeFloatDomAdd(){return"BeforeFloatDomAdd"}get FloatDomAdded(){return"FloatDomAdded"}get BeforeFloatDomUpdate(){return"BeforeFloatDomUpdate"}get FloatDomUpdated(){return"FloatDomUpdated"}get BeforeFloatDomDelete(){return"BeforeFloatDomDelete"}get FloatDomDeleted(){return"FloatDomDeleted"}get BeforeOverGridImageChange(){return"BeforeOverGridImageChange"}get OverGridImageChanged(){return"OverGridImageChanged"}get BeforeOverGridImageInsert(){return"BeforeOverGridImageInsert"}get OverGridImageInserted(){return"OverGridImageInserted"}get BeforeOverGridImageRemove(){return"BeforeOverGridImageRemove"}get OverGridImageRemoved(){return"OverGridImageRemoved"}get BeforeOverGridImageSelect(){return"BeforeOverGridImageSelect"}get OverGridImageSelected(){return"OverGridImageSelected"}}ei.extend(Ko);class Jo extends ti{_initialize(e){const t=e.get(H);this.disposeWithMe(this.registerEventHandler(this.Event.BeforeFloatDomAdd,()=>t.beforeCommandExecuted(r=>{if(r.id!==ve.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i,d=o.filter(c=>c.drawingType===P.DRAWING_DOM);if(d.length===0)return;const a={workbook:s,drawings:d};if(this.fireEvent(this.Event.BeforeFloatDomAdd,a),a.cancel)throw new ke}))),this.disposeWithMe(this.registerEventHandler(this.Event.FloatDomAdded,()=>t.onCommandExecuted(r=>{if(r.id!==ve.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i,d=o.filter(a=>a.drawingType===P.DRAWING_DOM);d.length!==0&&this.fireEvent(this.Event.FloatDomAdded,{workbook:s,drawings:d})}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeOverGridImageInsert,()=>t.beforeCommandExecuted(r=>{if(r.id!==ve.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i,d={workbook:s,insertImageParams:o};if(this.fireEvent(this.Event.BeforeOverGridImageInsert,d),d.cancel)throw new ke}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeOverGridImageRemove,()=>t.beforeCommandExecuted(r=>{if(r.id!==ge.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const o=e.get(X),{drawings:d}=i,a=d.map(l=>o.getDrawingByParam(l)),c={workbook:s,images:this._createFOverGridImage(a)};if(this.fireEvent(this.Event.BeforeOverGridImageRemove,c),c.cancel)throw new ke}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeOverGridImageChange,()=>t.beforeCommandExecuted(r=>{if(r.id!==ee.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i,d=e.get(X),a=[];o.forEach(l=>{const u=d.getDrawingByParam(l);u!=null&&a.push({changeParam:l,image:this._injector.createInstance(pe,u)})});const c={workbook:s,images:a};if(this.fireEvent(this.Event.BeforeOverGridImageChange,c),c.cancel)throw d.updateNotification(o),new ke}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeFloatDomUpdate,()=>t.beforeCommandExecuted(r=>{if(r.id!==ee.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i,d=e.get(X),a=[];if(o.forEach(l=>{const u=d.getDrawingByParam(l);u?.drawingType===P.DRAWING_DOM&&a.push(u)}),a.length===0)return;const c={workbook:s,drawings:a};if(this.fireEvent(this.Event.BeforeFloatDomUpdate,c),c.cancel)throw d.updateNotification(o),new ke}))),this.disposeWithMe(this.registerEventHandler(this.Event.FloatDomUpdated,()=>t.onCommandExecuted(r=>{if(r.id!==ee.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i,d=e.get(X),a=[];o.forEach(c=>{const l=d.getDrawingByParam(c);l?.drawingType===P.DRAWING_DOM&&a.push(l)}),a.length!==0&&this.fireEvent(this.Event.FloatDomUpdated,{workbook:s,drawings:a})}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeFloatDomDelete,()=>t.beforeCommandExecuted(r=>{if(r.id!==ge.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const o=e.get(X),{drawings:d}=i,a=d.map(l=>o.getDrawingByParam(l)).filter(l=>l?.drawingType===P.DRAWING_DOM);if(a.length===0)return;const c={workbook:s,drawings:a};if(this.fireEvent(this.Event.BeforeFloatDomDelete,c),c.cancel)throw new ke}))),this.disposeWithMe(this.registerEventHandler(this.Event.FloatDomDeleted,()=>t.onCommandExecuted(r=>{if(r.id!==ge.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i;this.fireEvent(this.Event.FloatDomDeleted,{workbook:s,drawings:o.filter(d=>d.drawingType===P.DRAWING_DOM).map(d=>d.drawingId)})}))),this.disposeWithMe(this.registerEventHandler(this.Event.BeforeOverGridImageSelect,()=>t.beforeCommandExecuted(r=>{if(r.id!==tt.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null)return;const o=e.get(X),d=o.getFocusDrawings(),a=i.map(l=>o.getDrawingByParam(l)),c={workbook:s,selectedImages:this._createFOverGridImage(a),oldSelectedImages:this._createFOverGridImage(d)};if(this.fireEvent(this.Event.BeforeOverGridImageSelect,c),c.cancel)throw new ke}))),this.disposeWithMe(this.registerEventHandler(this.Event.OverGridImageInserted,()=>t.onCommandExecuted(r=>{if(r.id!==ve.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i;this.fireEvent(this.Event.OverGridImageInserted,{workbook:s,images:this._createFOverGridImage(o)})}))),this.disposeWithMe(this.registerEventHandler(this.Event.OverGridImageRemoved,()=>t.onCommandExecuted(r=>{if(r.id!==ge.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i;this.fireEvent(this.Event.OverGridImageRemoved,{workbook:s,removeImageParams:o})}))),this.disposeWithMe(this.registerEventHandler(this.Event.OverGridImageChanged,()=>t.onCommandExecuted(r=>{if(r.id!==ee.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null||i==null)return;const{drawings:o}=i,d=e.get(X),a=o.map(c=>this._injector.createInstance(pe,d.getDrawingByParam(c)));this.fireEvent(this.Event.OverGridImageChanged,{workbook:s,images:a})}))),this.disposeWithMe(this.registerEventHandler(this.Event.OverGridImageSelected,()=>t.onCommandExecuted(r=>{if(r.id!==tt.id)return;const i=r.params,s=this.getActiveWorkbook();if(s==null)return;const o=e.get(X),d=i.map(a=>o.getDrawingByParam(a));this.fireEvent(this.Event.OverGridImageSelected,{workbook:s,selectedImages:this._createFOverGridImage(d)})})))}_createFOverGridImage(e){return e.map(t=>this._injector.createInstance(pe,t))}registerURLImageDownloader(e){return this._injector.get(Pn).registerURLImageDownloader(e)}}ti.extend(Jo);class Zo extends Jr{async insertCellImageAsync(e){var t;const r=this._injector.get(Z),i=(t=qt(j.UNIVER_SHEET,this._injector.get(me),r))==null?void 0:t.with(it);if(!i)return!1;const s={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this.getRow(),col:this.getColumn()};return typeof e=="string"?i.insertCellImageByUrl(e,s):i.insertCellImageByFile(e,s)}async saveCellImagesAsync(e){var t;const r=this._injector.get(St),i=this._workbook.getUnitId(),s=this._worksheet.getSheetId(),o=this.getRange(),d=r.getCellImagesFromRanges(i,s,[o]);if(d.length===0)return!1;if(d.length===1)try{return await r.downloadSingleImage(d[0]),!0}catch(u){return console.error("Failed to download image:",u),!1}const a=[],c=(t=e?.useCellAddress)!=null?t:!0,l=e?.useColumnIndex;c&&a.push(le.CELL_ADDRESS),l!==void 0&&a.push(le.COLUMN_VALUE),a.length===0&&a.push(le.CELL_ADDRESS);try{return await r.saveImagesWithContext(d,{fileNameParts:a,columnIndex:l},i,s),!0}catch(u){return console.error("Failed to save images:",u),!1}}}Jr.extend(Zo);function pa(n={}){const{collaboration:e=!1}=n;return{plugins:[[xn,{override:e?[[Qt,null]]:[]}],_r,Sr,rt,It].filter(t=>!!t)}}export{Ea as AutoImageCropOperation,Tn as BatchSaveImagesService,bi as COMPONENT_IMAGE_POPUP_MENU,V as ClearSheetDrawingTransformerOperation,Ta as CloseImageCropOperation,va as DOCS_DRAWING_PLUGIN,Yn as DRAWING_IMAGE_ALLOW_IMAGE_LIST,Hn as DRAWING_IMAGE_ALLOW_SIZE,Xn as DRAWING_IMAGE_COUNT_LIMIT,zn as DRAWING_IMAGE_HEIGHT_LIMIT,Vn as DRAWING_IMAGE_WIDTH_LIMIT,ii as DeleteDrawingsCommand,vi as DocDrawingController,_a as DocDrawingService,M as DrawingApplyType,Di as DrawingCommonPanel,ya as DrawingManagerService,br as DrawingRenderService,ci as EditSheetDrawingOperation,le as FileNamePart,si as GroupSheetDrawingCommand,St as IBatchSaveImagesService,Sa as IDocDrawingService,X as IDrawingManagerService,Qt as IImageIoService,Y as ISheetDrawingService,Si as ImageCropperObject,Ra as ImageIoService,Ua as ImagePopupMenu,Ri as ImageResetSizeOperation,re as ImageSourceType,Ge as ImageUploadStatusType,nn as InsertFloatImageCommand,ve as InsertSheetDrawingCommand,_t as MoveDrawingsCommand,yi as OpenImageCropOperation,ge as RemoveSheetDrawingCommand,gi as SHEETS_IMAGE_MENU_ID,ni as SHEET_DRAWING_PLUGIN,po as SHEET_FLOAT_DOM_PREFIX,wt as SaveCellImagesCommand,Ma as SetDrawingAlignOperation,A as SetDrawingApplyMutation,Qe as SetDrawingArrangeCommand,tt as SetDrawingSelectedOperation,ee as SetSheetDrawingCommand,ce as SheetCanvasFloatDomManagerService,yo as SheetDrawingAnchor,k as SheetDrawingAnchorType,it as SheetDrawingUpdateController,di as SidebarSheetDrawingOperation,Da as URLImageService,oi as UngroupSheetDrawingCommand,_i as UnitDrawingService,_r as UniverDocsDrawingPlugin,xn as UniverDrawingPlugin,Sr as UniverDrawingUIPlugin,rt as UniverSheetsDrawingPlugin,pa as UniverSheetsDrawingPreset,It as UniverSheetsDrawingUIPlugin,Se as calcSheetFloatDomPosition,te as drawingPositionToTransform,Aa as getCurrentUnitInfo,xe as getDrawingShapeKeyByDrawingSearch,Bt as getImageSize,Oa as getUpdateParams,xa as insertGroupObject,W as transformToAxisAlignPosition,B as transformToDrawingPosition};
