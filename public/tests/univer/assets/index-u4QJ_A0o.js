import{L as At,dT as St,gm as _e,bk as at,bl as Qe,ea as Rt,aB as Bt,f$ as Wt,fT as Gt,fU as Ft,c5 as Kt,fk as Lt,fm as zt,ba as Ht,bh as Xt,bm as Vt,bo as qt,b7 as Yt,b6 as Zt}from"./index-BI8deSNo.js";var Jt=Object.defineProperty,Qt=(a,e,t)=>e in a?Jt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,L=(a,e,t)=>Qt(a,typeof e!="symbol"?e+"":e,t);const wn=500,vn=500,yn=10,en=5*1024*1024,tn=["image/png","image/jpeg","image/jpg","image/gif","image/bmp"],Tt=St("univer.drawing-manager.service"),nn={id:"drawing.operation.set-drawing-selected",type:At.OPERATION,handler:(a,e)=>{const t=a.get(Tt);return e==null?!1:(t.focusDrawing(e),!0)}},rn="drawing.config",gt={};var qe={},et={},tt={},mt;function sn(){if(mt)return tt;mt=1,Object.defineProperty(tt,"__esModule",{value:!0});function a(n,r){if(Array.isArray(r))return!1;for(let l in n)if(!t(n[l],r[l]))return!1;for(let l in r)if(n[l]===void 0)return!1;return!0}function e(n,r){if(!Array.isArray(r)||n.length!==r.length)return!1;for(let l=0;l<n.length;l++)if(!t(n[l],r[l]))return!1;return!0}function t(n,r){return n===r?!0:n===null||r===null||typeof n!="object"||typeof r!="object"?!1:Array.isArray(n)?e(n,r):a(n,r)}return tt.default=t,tt}var nt={},bt;function on(){if(bt)return nt;bt=1,Object.defineProperty(nt,"__esModule",{value:!0});function a(e){if(e===null)return null;if(Array.isArray(e))return e.map(a);if(typeof e=="object"){const t={};for(let n in e)t[n]=a(e[n]);return t}else return e}return nt.default=a,nt}var wt={},vt;function Mt(){return vt||(vt=1,(function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.eachChildOf=a.advancer=a.readCursor=a.writeCursor=a.WriteCursor=a.ReadCursor=a.isValidPathItem=void 0;function e(g,s){if(!g)throw new Error(s)}const t=g=>g!=null&&typeof g=="object"&&!Array.isArray(g),n=(g,s)=>typeof g==typeof s?g>s:typeof g=="string"&&typeof s=="number";function r(g,s){for(let d in g){const f=d;s.write(f,g[f])}}a.isValidPathItem=g=>typeof g=="number"||typeof g=="string"&&g!=="__proto__";class l{constructor(s=null){this.parents=[],this.indexes=[],this.lcIdx=-1,this.idx=-1,this.container=s}ascend(){e(this.parents.length===this.indexes.length/2),this.idx===0?this.parents.length?(this.lcIdx=this.indexes.pop(),this.container=this.parents.pop(),this.idx=this.indexes.pop()):(this.lcIdx=0,this.idx=-1):(e(this.idx>0),this.idx--,t(this.container[this.idx])&&this.idx--)}getPath(){const s=[];let d=this.container,f=this.parents.length-1,k=this.idx;for(;k>=0;)s.unshift(d[k]),k===0?(k=this.indexes[f*2],d=this.parents[f--]):k-=t(d[k-1])?2:1;return s}}class o extends l{get(){return this.container?this.container.slice(this.idx+1):null}getKey(){return e(this.container!=null,"Invalid call to getKey before cursor descended"),this.container[this.idx]}getComponent(){let s;return this.container&&this.container.length>this.idx+1&&t(s=this.container[this.idx+1])?s:null}descendFirst(){let s=this.idx+1;if(!this.container||s>=this.container.length||t(this.container[s])&&s+1>=this.container.length)return!1;t(this.container[s])&&s++;const d=this.container[s];return Array.isArray(d)?(this.indexes.push(this.idx),this.parents.push(this.container),this.indexes.push(s),this.idx=0,this.container=d):this.idx=s,!0}nextSibling(){if(e(this.parents.length===this.indexes.length/2),this.idx>0||this.parents.length===0)return!1;const s=this.indexes[this.indexes.length-1]+1,d=this.parents[this.parents.length-1];return s>=d.length?!1:(e(!isNaN(s)),this.indexes[this.indexes.length-1]=s,this.container=d[s],!0)}_init(s,d,f,k){this.container=s,this.idx=d,this.parents=f.slice(),this.indexes=k.slice()}clone(){const s=new o;return s._init(this.container,this.idx,this.parents,this.indexes),s}*[Symbol.iterator](){if(this.descendFirst()){do yield this.getKey();while(this.nextSibling());this.ascend()}}traverse(s,d){const f=this.getComponent();f&&d(f,s);for(const k of this)s&&s.descend(k),this.traverse(s,d),s&&s.ascend()}eachPick(s,d){this.traverse(s,(f,k)=>{f.p!=null&&d(f.p,k)})}eachDrop(s,d){this.traverse(s,(f,k)=>{f.d!=null&&d(f.d,k)})}}a.ReadCursor=o;class u extends l{constructor(s=null){super(s),this.pendingDescent=[],this._op=s}flushDescent(){e(this.parents.length===this.indexes.length/2),this.container===null&&(this._op=this.container=[]);for(let s=0;s<this.pendingDescent.length;s++){const d=this.pendingDescent[s];let f=this.idx+1;if(f<this.container.length&&t(this.container[f])&&f++,e(f===this.container.length||!t(this.container[f])),f===this.container.length)this.container.push(d),this.idx=f;else if(this.container[f]===d)this.idx=f;else{if(!Array.isArray(this.container[f])){const k=this.container.splice(f,this.container.length-f);this.container.push(k),this.lcIdx>-1&&(this.lcIdx=f)}for(this.indexes.push(this.idx),this.parents.push(this.container),this.lcIdx!==-1&&(e(n(d,this.container[this.lcIdx][0])),f=this.lcIdx+1,this.lcIdx=-1);f<this.container.length&&n(d,this.container[f][0]);)f++;if(this.indexes.push(f),this.idx=0,f<this.container.length&&this.container[f][0]===d)this.container=this.container[f];else{const k=[d];this.container.splice(f,0,k),this.container=k}}}this.pendingDescent.length=0}reset(){this.lcIdx=-1}getComponent(){this.flushDescent();const s=this.idx+1;if(s<this.container.length&&t(this.container[s]))return this.container[s];{const d={};return this.container.splice(s,0,d),d}}write(s,d){const f=this.getComponent();e(f[s]==null||f[s]===d,"Internal consistency error: Overwritten component. File a bug"),f[s]=d}get(){return this._op}descend(s){if(!a.isValidPathItem(s))throw Error("Invalid JSON key");this.pendingDescent.push(s)}descendPath(s){return this.pendingDescent.push(...s),this}ascend(){this.pendingDescent.length?this.pendingDescent.pop():super.ascend()}mergeTree(s,d=r){if(s===null)return;if(e(Array.isArray(s)),s===this._op)throw Error("Cannot merge into my own tree");const f=this.lcIdx,k=this.parents.length;let Z=0;for(let de=0;de<s.length;de++){const J=s[de];typeof J=="string"||typeof J=="number"?(Z++,this.descend(J)):Array.isArray(J)?this.mergeTree(J,d):typeof J=="object"&&d(J,this)}for(;Z--;)this.ascend();this.lcIdx=this.parents.length===k?f:-1}at(s,d){this.descendPath(s),d(this);for(let f=0;f<s.length;f++)this.ascend();return this}writeAtPath(s,d,f){return this.at(s,()=>this.write(d,f)),this.reset(),this}writeMove(s,d,f=0){return this.writeAtPath(s,"p",f).writeAtPath(d,"d",f)}getPath(){const s=super.getPath();return s.push(...this.pendingDescent),s}}a.WriteCursor=u,a.writeCursor=()=>new u,a.readCursor=g=>new o(g);function P(g,s,d){let f,k;k=f=g?g.descendFirst():!1;function Z(de){let J;for(;k;){const De=J=g.getKey();if(de!=null){let Fe=!1;if(s&&typeof De=="number"&&(J=s(De,g.getComponent()),J<0&&(J=~J,Fe=!0)),n(J,de))return null;if(J===de&&!Fe)return g}d&&typeof J=="number"&&d(J,g.getComponent()),k=g.nextSibling()}return null}return Z.end=()=>{f&&g.ascend()},Z}a.advancer=P;function W(g,s,d){let f,k,Z,de;for(f=k=g&&g.descendFirst(),Z=de=s&&s.descendFirst();f||Z;){let J=f?g.getKey():null,De=Z?s.getKey():null;J!==null&&De!==null&&(n(De,J)?De=null:J!==De&&(J=null)),d(J??De,J!=null?g:null,De!=null?s:null),J!=null&&f&&(f=g.nextSibling()),De!=null&&Z&&(Z=s.nextSibling())}k&&g.ascend(),de&&s.ascend()}a.eachChildOf=W})(wt)),wt}var yt={},It;function jt(){return It||(It=1,(function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.ConflictType=void 0,(function(e){e[e.RM_UNEXPECTED_CONTENT=1]="RM_UNEXPECTED_CONTENT",e[e.DROP_COLLISION=2]="DROP_COLLISION",e[e.BLACKHOLE=3]="BLACKHOLE"})(a.ConflictType||(a.ConflictType={}))})(yt)),yt}var ke={},Ye={},_t;function dt(){return _t||(_t=1,Object.defineProperty(Ye,"__esModule",{value:!0}),Ye.uniToStrPos=Ye.strPosToUni=void 0,Ye.strPosToUni=(a,e=a.length)=>{let t=0,n=0;for(;n<e;n++){const r=a.charCodeAt(n);r>=55296&&r<=57343&&(t++,n++)}if(n!==e)throw Error("Invalid offset - splits unicode bytes");return n-t},Ye.uniToStrPos=(a,e)=>{let t=0;for(;e>0;e--){const n=a.charCodeAt(t);t+=n>=55296&&n<=57343?2:1}return t}),Ye}var Dt={},Ot;function ct(){return Ot||(Ot=1,(function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.uniSlice=a.dlen=a.eachOp=void 0;const e=dt(),t=h=>{if(!Array.isArray(h))throw Error("Op must be an array of components");let b=null;for(let _=0;_<h.length;_++){const j=h[_];switch(typeof j){case"object":if(typeof j.d!="number"&&typeof j.d!="string")throw Error("Delete must be number or string");if(a.dlen(j.d)<=0)throw Error("Deletes must not be empty");break;case"string":if(!(j.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(j>0))throw Error("Skip components must be >0");if(typeof b=="number")throw Error("Adjacent skip components should be combined");break}b=j}if(typeof b=="number")throw Error("Op has a trailing skip")};function n(h,b){let _=0,j=0;for(let z=0;z<h.length;z++){const H=h[z];switch(b(H,_,j),typeof H){case"object":_+=a.dlen(H.d);break;case"string":j+=e.strPosToUni(H);break;case"number":_+=H,j+=H;break}}}a.eachOp=n;function r(h,b){const _=[],j=u(_);return n(h,(z,H,me)=>{j(b(z,H,me))}),s(_)}const l=h=>h,o=h=>r(h,l);a.dlen=h=>typeof h=="number"?h:e.strPosToUni(h);const u=h=>b=>{if(!(!b||b.d===0||b.d===""))if(h.length===0)h.push(b);else if(typeof b==typeof h[h.length-1])if(typeof b=="object"){const _=h[h.length-1];_.d=typeof _.d=="string"&&typeof b.d=="string"?_.d+b.d:a.dlen(_.d)+a.dlen(b.d)}else h[h.length-1]+=b;else h.push(b)},P=h=>typeof h=="number"?h:typeof h=="string"?e.strPosToUni(h):typeof h.d=="number"?h.d:e.strPosToUni(h.d);a.uniSlice=(h,b,_)=>{const j=e.uniToStrPos(h,b),z=_==null?1/0:e.uniToStrPos(h,_);return h.slice(j,z)};const W=(h,b,_)=>typeof h=="number"?_==null?h-b:Math.min(h,_)-b:a.uniSlice(h,b,_),g=h=>{let b=0,_=0;return{take:(j,z)=>{if(b===h.length)return j===-1?null:j;const H=h[b];let me;if(typeof H=="number")return j===-1||H-_<=j?(me=H-_,++b,_=0,me):(_+=j,j);if(typeof H=="string"){if(j===-1||z==="i"||e.strPosToUni(H.slice(_))<=j)return me=H.slice(_),++b,_=0,me;{const Oe=_+e.uniToStrPos(H.slice(_),j);return me=H.slice(_,Oe),_=Oe,me}}else{if(j===-1||z==="d"||a.dlen(H.d)-_<=j)return me={d:W(H.d,_)},++b,_=0,me;{let Oe=W(H.d,_,_+j);return _+=j,{d:Oe}}}},peek:()=>h[b]}},s=h=>(h.length>0&&typeof h[h.length-1]=="number"&&h.pop(),h);function d(h,b,_){if(_!=="left"&&_!=="right")throw Error("side ("+_+") must be 'left' or 'right'");t(h),t(b);const j=[],z=u(j),{take:H,peek:me}=g(h);for(let ve=0;ve<b.length;ve++){const be=b[ve];let he,Ee;switch(typeof be){case"number":for(he=be;he>0;)Ee=H(he,"i"),z(Ee),typeof Ee!="string"&&(he-=P(Ee));break;case"string":_==="left"&&typeof me()=="string"&&z(H(-1)),z(e.strPosToUni(be));break;case"object":for(he=a.dlen(be.d);he>0;)switch(Ee=H(he,"i"),typeof Ee){case"number":he-=Ee;break;case"string":z(Ee);break;case"object":he-=a.dlen(Ee.d)}break}}let Oe;for(;Oe=H(-1);)z(Oe);return s(j)}function f(h,b){t(h),t(b);const _=[],j=u(_),{take:z}=g(h);for(let me=0;me<b.length;me++){const Oe=b[me];let ve,be;switch(typeof Oe){case"number":for(ve=Oe;ve>0;)be=z(ve,"d"),j(be),typeof be!="object"&&(ve-=P(be));break;case"string":j(Oe);break;case"object":ve=a.dlen(Oe.d);let he=0;for(;he<ve;)switch(be=z(ve-he,"d"),typeof be){case"number":j({d:W(Oe.d,he,he+be)}),he+=be;break;case"string":he+=e.strPosToUni(be);break;case"object":j(be)}break}}let H;for(;H=z(-1);)j(H);return s(_)}const k=(h,b)=>{let _=0;for(let j=0;j<b.length&&h>_;j++){const z=b[j];switch(typeof z){case"number":{_+=z;break}case"string":const H=e.strPosToUni(z);_+=H,h+=H;break;case"object":h-=Math.min(a.dlen(z.d),h-_);break}}return h},Z=(h,b)=>typeof h=="number"?k(h,b):h.map(_=>k(_,b));function de(h,b,_){return r(h,(j,z)=>typeof j=="object"&&typeof j.d=="number"?{d:_.slice(b,z,z+j.d)}:j)}function J(h){return r(h,b=>{switch(typeof b){case"object":if(typeof b.d=="number")throw Error("Cannot invert text op: Deleted characters missing from operation. makeInvertible must be called first.");return b.d;case"string":return{d:b};case"number":return b}})}function De(h){return r(h,b=>typeof b=="object"&&typeof b.d=="string"?{d:e.strPosToUni(b.d)}:b)}function Fe(h){let b=!0;return n(h,_=>{typeof _=="object"&&typeof _.d=="number"&&(b=!1)}),b}function ge(h){return{name:"text-unicode",uri:"http://sharejs.org/types/text-unicode",trim:s,normalize:o,checkOp:t,create(b=""){if(typeof b!="string")throw Error("Initial data must be a string");return h.create(b)},apply(b,_){t(_);const j=h.builder(b);for(let z=0;z<_.length;z++){const H=_[z];switch(typeof H){case"number":j.skip(H);break;case"string":j.append(H);break;case"object":j.del(a.dlen(H.d));break}}return j.build()},transform:d,compose:f,transformPosition:k,transformSelection:Z,isInvertible:Fe,makeInvertible(b,_){return de(b,_,h)},stripInvertible:De,invert:J,invertWithDoc(b,_){return J(de(b,_,h))},isNoop:b=>b.length===0}}a.default=ge})(Dt)),Dt}var rt={},Ct;function an(){if(Ct)return rt;Ct=1,Object.defineProperty(rt,"__esModule",{value:!0});const a=ct(),e=dt();function t(n,r){return{get:n,getLength(){return n().length},insert(l,o,u){const P=e.strPosToUni(n(),l);return r([P,o],u)},remove(l,o,u){const P=e.strPosToUni(n(),l);return r([P,{d:o}],u)},_onOp(l){a.eachOp(l,(o,u,P)=>{switch(typeof o){case"string":this.onInsert&&this.onInsert(P,o);break;case"object":const W=a.dlen(o.d);this.onRemove&&this.onRemove(P,W)}})},onInsert:null,onRemove:null}}return rt.default=t,t.provides={text:!0},rt}var Et;function ln(){return Et||(Et=1,(function(a){var e=ke&&ke.__createBinding||(Object.create?(function(d,f,k,Z){Z===void 0&&(Z=k),Object.defineProperty(d,Z,{enumerable:!0,get:function(){return f[k]}})}):(function(d,f,k,Z){Z===void 0&&(Z=k),d[Z]=f[k]})),t=ke&&ke.__setModuleDefault||(Object.create?(function(d,f){Object.defineProperty(d,"default",{enumerable:!0,value:f})}):function(d,f){d.default=f}),n=ke&&ke.__importStar||function(d){if(d&&d.__esModule)return d;var f={};if(d!=null)for(var k in d)Object.hasOwnProperty.call(d,k)&&e(f,d,k);return t(f,d),f},r=ke&&ke.__importDefault||function(d){return d&&d.__esModule?d:{default:d}};Object.defineProperty(a,"__esModule",{value:!0}),a.type=a.remove=a.insert=void 0;const l=dt(),o=n(ct()),u=r(an()),P={create(d){return d},toString(d){return d},builder(d){if(typeof d!="string")throw Error("Invalid document snapshot: "+d);const f=[];return{skip(k){let Z=l.uniToStrPos(d,k);if(Z>d.length)throw Error("The op is too long for this document");f.push(d.slice(0,Z)),d=d.slice(Z)},append(k){f.push(k)},del(k){d=d.slice(l.uniToStrPos(d,k))},build(){return f.join("")+d}}},slice:o.uniSlice},W=o.default(P),g=Object.assign(Object.assign({},W),{api:u.default});a.type=g,a.insert=(d,f)=>f.length===0?[]:d===0?[f]:[d,f],a.remove=(d,f)=>o.dlen(f)===0?[]:d===0?[{d:f}]:[d,{d:f}];var s=ct();Object.defineProperty(a,"makeType",{enumerable:!0,get:function(){return s.default}})})(ke)),ke}var Ut;function un(){return Ut||(Ut=1,(function(a){var e=et&&et.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(a,"__esModule",{value:!0}),a.editOp=a.replaceOp=a.insertOp=a.moveOp=a.removeOp=a.type=void 0;const t=e(sn()),n=e(on()),r=Mt(),l=jt();function o(i,c){if(!i)throw new Error(c)}a.type={name:"json1",uri:"http://sharejs.org/types/JSONv1",readCursor:r.readCursor,writeCursor:r.writeCursor,create:i=>i,isNoop:i=>i==null,setDebug(i){},registerSubtype:J,checkValidOp:z,normalize:H,apply:me,transformPosition:Oe,compose:ve,tryTransform:st,transform:$t,makeInvertible:Ee,invert:be,invertWithDoc:Nt,RM_UNEXPECTED_CONTENT:l.ConflictType.RM_UNEXPECTED_CONTENT,DROP_COLLISION:l.ConflictType.DROP_COLLISION,BLACKHOLE:l.ConflictType.BLACKHOLE,transformNoConflict:(i,c,v)=>pt(()=>!0,i,c,v),typeAllowingConflictsPred:i=>Object.assign(Object.assign({},a.type),{transform:(c,v,C)=>pt(i,c,v,C)})};const u=i=>i?i.getComponent():null;function P(i){return i&&typeof i=="object"&&!Array.isArray(i)}const W=i=>Array.isArray(i)?i.slice():i!==null&&typeof i=="object"?Object.assign({},i):i,g=i=>i&&(i.p!=null||i.r!==void 0),s=i=>i&&(i.d!=null||i.i!==void 0);function d(i,c){return o(i!=null),typeof c=="number"?(o(Array.isArray(i),"Invalid key - child is not an array"),(i=i.slice()).splice(c,1)):(o(P(i),"Invalid key - child is not an object"),delete(i=Object.assign({},i))[c]),i}function f(i,c,v){return typeof c=="number"?(o(i!=null,"Container is missing for key"),o(Array.isArray(i),"Cannot use numerical key for object container"),o(i.length>=c,"Cannot insert into out of bounds index"),i.splice(c,0,v)):(o(P(i),"Cannot insert into missing item"),o(i[c]===void 0,"Trying to overwrite value at key. Your op needs to remove it first"),i[c]=v),v}a.removeOp=(i,c=!0)=>r.writeCursor().writeAtPath(i,"r",c).get(),a.moveOp=(i,c)=>r.writeCursor().writeMove(i,c).get(),a.insertOp=(i,c)=>r.writeCursor().writeAtPath(i,"i",c).get(),a.replaceOp=(i,c,v)=>r.writeCursor().at(i,C=>{C.write("r",c),C.write("i",v)}).get(),a.editOp=(i,c,v,C=!1)=>r.writeCursor().at(i,y=>b(y,c,v,C)).get();const k=(i,c)=>i!=null&&(typeof c=="number"?Array.isArray(i):typeof i=="object"),Z=(i,c)=>k(i,c)?i[c]:void 0,de={};function J(i){let c=i.type?i.type:i;c.name&&(de[c.name]=c),c.uri&&(de[c.uri]=c)}const De=i=>{const c=de[i];if(c)return c;throw Error("Missing type: "+i)};J(ln());const Fe=(i,c)=>i+c;J({name:"number",apply:Fe,compose:Fe,invert:i=>-i,transform:i=>i});const ge=i=>i==null?null:i.et?De(i.et):i.es?de["text-unicode"]:i.ena!=null?de.number:null,h=i=>i.es?i.es:i.ena!=null?i.ena:i.e,b=(i,c,v,C=!1)=>{const[y,O]=typeof c=="string"?[De(c),c]:[c,c.name];!C&&y.isNoop&&y.isNoop(v)||(O==="number"?i.write("ena",v):O==="text-unicode"?i.write("es",v):(i.write("et",O),i.write("e",v)))};function _(i){o(typeof i=="number"),o(i>=0),o(i===(0|i))}function j(i){typeof i=="number"?_(i):o(typeof i=="string")}function z(i){if(i===null)return;const c=new Set,v=new Set,C=O=>{let R=!0,A=!1;for(let p in O){const w=O[p];if(R=!1,o(p==="p"||p==="r"||p==="d"||p==="i"||p==="e"||p==="es"||p==="ena"||p==="et","Invalid component item '"+p+"'"),p==="p")_(w),o(!c.has(w)),c.add(w),o(O.r===void 0);else if(p==="d")_(w),o(!v.has(w)),v.add(w),o(O.i===void 0);else if(p==="e"||p==="es"||p==="ena"){o(!A),A=!0;const I=ge(O);o(I,"Missing type in edit"),I.checkValidOp&&I.checkValidOp(h(O))}}o(!R)},y=(O,R,A)=>{if(!Array.isArray(O))throw Error("Op must be null or a list");if(O.length===0)throw Error("Empty descent");R||j(O[0]);let p=1,w=0,I=0;for(let D=0;D<O.length;D++){const S=O[D];if(o(S!=null),Array.isArray(S)){const B=y(S,!1);if(w){const m=typeof I,M=typeof B;m===M?o(I<B,"descent keys are not in order"):o(m==="number"&&M==="string")}I=B,w++,p=3}else typeof S=="object"?(o(p===1,`Prev not scalar - instead ${p}`),C(S),p=2):(o(p!==3),j(S),o(r.isValidPathItem(S),"Invalid path key"),p=1)}return o(w!==1,"Operation makes multiple descents. Remove some []"),o(p===2||p===3),O[0]};y(i,!0),o(c.size===v.size,"Mismatched picks and drops in op");for(let O=0;O<c.size;O++)o(c.has(O)),o(v.has(O))}function H(i){let c=0,v=[];const C=r.writeCursor();return C.mergeTree(i,(y,O)=>{const R=ge(y);if(R){const p=h(y);b(O,R,R.normalize?R.normalize(p):p)}for(const p of["r","p","i","d"])if(y[p]!==void 0){const w=p==="p"||p==="d"?(A=y[p],v[A]==null&&(v[A]=c++),v[A]):y[p];O.write(p,w)}var A}),C.get()}function me(i,c){if(z(c),c===null)return i;const v=[];return(function C(y,O){let R=y,A=0,p={root:y},w=0,I=p,D="root";function S(){for(;w<A;w++){let B=O[w];typeof B!="object"&&(o(k(I,D)),I=I[D]=W(I[D]),D=B)}}for(;A<O.length;A++){const B=O[A];if(Array.isArray(B)){const m=C(R,B);m!==R&&m!==void 0&&(S(),R=I[D]=m)}else if(typeof B=="object"){B.d!=null?(S(),R=f(I,D,v[B.d])):B.i!==void 0&&(S(),R=f(I,D,B.i));const m=ge(B);if(m)S(),R=I[D]=m.apply(R,h(B));else if(B.e!==void 0)throw Error("Subtype "+B.et+" undefined")}else R=Z(R,B)}return p.root})(i=(function C(y,O){const R=[];let A=0;for(;A<O.length;A++){const D=O[A];if(Array.isArray(D))break;typeof D!="object"&&(R.push(y),y=Z(y,D))}for(let D=O.length-1;D>=A;D--)y=C(y,O[D]);for(--A;A>=0;A--){const D=O[A];if(typeof D!="object"){const S=R.pop();y=y===Z(S,D)?S:y===void 0?d(S,D):(w=D,I=y,(p=W(p=S))[w]=I,p)}else g(D)&&(o(y!==void 0,"Cannot pick up or remove undefined"),D.p!=null&&(v[D.p]=y),y=void 0)}var p,w,I;return y})(i,c),c)}function Oe(i,c){i=i.slice(),z(c);const v=r.readCursor(c);let C,y,O=!1;const R=[];for(let p=0;;p++){const w=i[p],I=v.getComponent();if(I&&(I.r!==void 0?O=!0:I.p!=null&&(O=!1,C=I.p,y=p)),p>=i.length)break;let D=0;const S=r.advancer(v,void 0,(m,M)=>{g(M)&&D++});R.unshift(S);const B=S(w);if(typeof w=="number"&&(i[p]-=D),!B)break}if(R.forEach(p=>p.end()),O)return null;const A=()=>{let p=0;if(C!=null){const w=v.getPath();p=w.length,i=w.concat(i.slice(y))}for(;p<i.length;p++){const w=i[p],I=u(v),D=ge(I);if(D){const m=h(I);D.transformPosition&&(i[p]=D.transformPosition(i[p],m));break}let S=0;const B=r.advancer(v,(m,M)=>s(M)?~(m-S):m-S,(m,M)=>{s(M)&&S++})(w);if(typeof w=="number"&&(i[p]+=S),!B)break}};return C!=null?v.eachDrop(null,p=>{p===C&&A()}):A(),i}function ve(i,c){if(z(i),z(c),i==null)return c;if(c==null)return i;let v=0;const C=r.readCursor(i),y=r.readCursor(c),O=r.writeCursor(),R=[],A=[],p=[],w=[],I=[],D=[],S=new Set;C.traverse(null,m=>{m.p!=null&&(p[m.p]=C.clone())}),y.traverse(null,m=>{m.d!=null&&(w[m.d]=y.clone())});const B=r.writeCursor();return(function m(M,ne,te,K,ie,Ae,ye,pe){o(ne||te);const se=u(ne),Ue=u(te),xe=!!Ue&&Ue.r!==void 0,Ke=!!se&&se.i!==void 0,Pe=se?se.d:null,Ce=Ue?Ue.p:null,Se=(Ae||xe)&&Ce==null;if(Ce!=null)K=w[Ce],ye=A[Ce]=new r.WriteCursor;else if(Ue&&Ue.r!==void 0)K=null;else{const U=u(K);U&&U.d!=null&&(K=null)}const Q=u(K);if(Pe!=null)if(M=p[Pe],pe=R[Pe]=new r.WriteCursor,Se)Ae&&!xe&&pe.write("r",!0);else{const U=I[Pe]=v++;ye.write("d",U)}else if(se&&se.i!==void 0)M=null;else{const U=u(M);U&&U.p!=null&&(M=null)}let x;Ke?(o(ie===void 0),x=se.i):x=ie;const G=(Ce==null?!Ke||Ae||xe:x===void 0)?null:ye.getComponent();if(Ce!=null){if(!(ie!==void 0||Ke)){const U=Pe!=null?I[Pe]:v++;D[Ce]=U,pe.write("p",U)}}else xe&&(Ke||ie!==void 0||(Ue.r,pe.write("r",Ue.r)));const T=Se?null:ge(se),E=ge(Q);if((T||E)&&(T&&T.name,E&&E.name),T&&E){o(T===E);const U=h(se),F=h(Q),ce=T.compose(U,F);b(ye,T,ce),S.add(Q)}else T?b(ye,T,h(se)):E&&(b(ye,E,h(Q)),S.add(Q));const N=typeof x=="object"&&x!=null;let Y=!1,q=0,ee=0,ue=0,le=0,oe=0;const we=r.advancer(K,(U,F)=>s(F)?le-U-1:U-le,(U,F)=>{s(F)&&le++}),V=r.advancer(M,(U,F)=>g(F)?q-U-1:U-q,(U,F)=>{g(F)&&q++});if(r.eachChildOf(ne,te,(U,F,ce)=>{let Ie,Re,Le=U,Te=U,Ze=U;if(typeof U=="number"){let fe=U+ue;Re=we(fe),Te=fe+le;let ae=U+ee;Ie=V(ae),s(u(Re))&&(Ie=null),Le=ae+q,Ze=U+oe,o(Le>=0,"p1PickKey is negative"),o(Te>=0,"p2DropKey is negative");const Me=s(u(F)),Be=g(u(ce));(Me||Be&&!Se)&&oe--,Me&&ee--,Be&&ue--}else Ie=V(U),Re=we(U);pe.descend(Le),ye.descend(Te);const Xe=N&&!s(u(F))?x[Ze]:void 0,Ne=m(Ie,F,ce,Re,Xe,Se,ye,pe);var $e,$,re;N&&!Se?Xe!==Ne&&(Y||(x=Array.isArray(x)?x.slice():Object.assign({},x),Y=!0),$e=x,re=Ne,typeof($=Ze)=="number"?(o(Array.isArray($e)),o($<$e.length)):(o(!Array.isArray($e)),o($e[$]!==void 0)),re===void 0?typeof $=="number"?$e.splice($,1):delete $e[$]:$e[$]=re):o(Ne===void 0),ye.ascend(),pe.ascend()}),V.end(),we.end(),G!=null)G.i=x;else if(!Ae&&!xe&&Ce==null)return x})(C,C.clone(),y,y.clone(),void 0,!1,O,B),O.reset(),O.mergeTree(B.get()),O.reset(),O.get(),R.map(m=>m.get()),A.map(m=>m.get()),C.traverse(O,(m,M)=>{const ne=m.p;if(ne!=null){const te=I[ne];te!=null&&M.write("p",te);const K=R[ne];K&&K.get(),K&&M.mergeTree(K.get())}else m.r!==void 0&&M.write("r",m.r)}),O.reset(),O.get(),y.traverse(O,(m,M)=>{const ne=m.d;if(ne!=null){const K=D[ne];K!=null&&M.write("d",K);const ie=A[ne];ie&&M.mergeTree(ie.get())}else m.i!==void 0&&M.write("i",m.i);const te=ge(m);te&&!S.has(m)&&b(M,te,h(m))}),O.get()}function be(i){if(i==null)return null;const c=new r.ReadCursor(i),v=new r.WriteCursor;let C;const y=[],O=[];return(function R(A,p,w){const I=A.getComponent();let D,S=!1;if(I){I.p!=null&&(p.write("d",I.p),y[I.p]=A.clone()),I.r!==void 0&&p.write("i",I.r),I.d!=null&&(p.write("p",I.d),w=void 0),I.i!==void 0&&(w=D=I.i);const m=ge(I);m&&(w===void 0?(C||(C=new Set),C.add(I)):(h(I),w=m.apply(w,h(I)),S=!0))}let B=0;for(const m of A){p.descend(m);const M=typeof m=="number"?m-B:m,ne=Z(w,M);s(A.getComponent())&&B++;const te=R(A,p,ne);if(w!==void 0&&te!==void 0){if(S||(S=!0,w=W(w)),!k(w,M))throw Error("Cannot modify child - invalid operation");w[M]=te}p.ascend()}if(D===void 0)return S?w:void 0;p.write("r",w)})(c,v,void 0),C&&(v.reset(),(function R(A,p,w){const I=p.getComponent();if(I){const m=I.d;if(m!=null&&(A=y[m],w=O[m]=r.writeCursor()),C.has(I)){const M=ge(I);if(!M.invert)throw Error(`Cannot invert subtype ${M.name}`);b(w,M,M.invert(h(I)))}}let D=0,S=0;const B=r.advancer(A,(m,M)=>g(M)?D-m-1:m-D,(m,M)=>{g(M)&&D++});for(const m of p)if(typeof m=="number"){const M=m-S,ne=B(M),te=M+D;w.descend(te),R(ne,p,w),s(p.getComponent())&&S++,w.ascend()}else w.descend(m),R(B(m),p,w),w.ascend();B.end()})(c.clone(),c,v),O.length&&(v.reset(),c.traverse(v,(R,A)=>{const p=R.p;if(p!=null){const w=O[p];w&&w.get(),w&&A.mergeTree(w.get())}}))),v.get()}const he=(i,c)=>i.some(v=>typeof v=="object"&&(Array.isArray(v)?he(v,c):c(v)));function Ee(i,c){if(i==null||!he(i,p=>{var w;return p.r!==void 0||((w=ge(p))===null||w===void 0?void 0:w.makeInvertible)!=null}))return i;const v=new r.ReadCursor(i),C=new r.WriteCursor;let y=!1;const O=[],R=[],A=(p,w,I)=>{const D=p.getComponent();let S=!1;if(D){D.d!=null&&w.write("d",D.d),D.i!==void 0&&w.write("i",D.i);const m=D.p;if(m!=null&&(O[m]=p.clone(),o(I!==void 0,"Operation picks up at an invalid key"),R[m]=I,w.write("p",D.p)),D.r!==void 0&&I===void 0)throw Error("Invalid doc / op in makeInvertible: removed item missing from doc");const M=ge(D);M&&(M.makeInvertible?y=!0:b(w,M,h(D),!0))}let B=0;for(const m of p){w.descend(m);const M=typeof m=="number"?m-B:m,ne=Z(I,M),te=A(p,w,ne);ne!==te&&(S||(S=!0,I=W(I)),te===void 0?(I=d(I,M),typeof m=="number"&&B++):I[M]=te),w.ascend()}return D&&(D.r!==void 0?(w.write("r",n.default(I)),I=void 0):D.p!=null&&(I=void 0)),I};return A(v,C,c),C.get(),y&&(C.reset(),(function p(w,I,D,S,B){const m=I.getComponent();if(m){m.i!==void 0?(S=m.i,B=!0):m.d!=null&&(S=R[m.d],w=O[m.d],B=!1,m.d);let K=ge(m);if(K&&K.makeInvertible){const ie=h(m);b(D,K,K.makeInvertible(ie,S),!0)}}let M=0,ne=0;const te=r.advancer(w,(K,ie)=>g(ie)?M-K-1:K-M,(K,ie)=>{g(ie)&&M++});for(const K of I)if(typeof K=="number"){const ie=K-ne,Ae=te(ie),ye=ie+M,pe=Z(S,B?ie:ye);D.descend(K),p(Ae,I,D,pe,B),s(I.getComponent())&&ne++,D.ascend()}else{const ie=Z(S,K);D.descend(K),p(te(K),I,D,ie,B),D.ascend()}te.end()})(v.clone(),v,C,c,!1)),C.get()}function Nt(i,c){return be(Ee(i,c))}const it=i=>{if(i==null)return null;const c=i.slice();for(let v=0;v<i.length;v++){const C=c[v];Array.isArray(C)&&(c[v]=it(C))}return c};function st(i,c,v){o(v==="left"||v==="right","Direction must be left or right");const C=v==="left"?0:1;if(c==null)return{ok:!0,result:i};z(i),z(c);let y=null;const O=[],R=[],A=[],p=[],w=[],I=[],D=[],S=[],B=[],m=[],M=[],ne=[],te=[],K=[],ie=[];let Ae=0;const ye=r.readCursor(i),pe=r.readCursor(c),se=r.writeCursor();if((function Q(x,G=null,T){const E=u(G);E&&(E.r!==void 0?T=G.clone():E.p!=null&&(T=null,I[E.p]=x.clone()));const N=x.getComponent();let Y;N&&(Y=N.p)!=null&&(w[Y]=G?G.clone():null,A[Y]=x.clone(),T&&(m[Y]=!0,B[Y]=T),E&&E.p!=null&&(K[Y]=E.p));const q=r.advancer(G);for(const ee of x)Q(x,q(ee),T);q.end()})(pe,ye,null),(function Q(x,G,T,E,N){const Y=T.getComponent();let q,ee=!1;Y&&((q=Y.d)!=null?(p[q]=T.clone(),E!=null&&(ie[E]==null&&(ie[E]=[]),ie[E].push(q)),m[q],x=w[q]||null,G=A[q]||null,m[q]?(N&&(M[q]=!0),N=B[q]||null):!N||C!==1&&K[q]!=null||y==null&&(y={type:l.ConflictType.RM_UNEXPECTED_CONTENT,op1:a.removeOp(N.getPath()),op2:a.moveOp(G.getPath(),T.getPath())}),ee=!0):Y.i!==void 0&&(x=G=null,ee=!0,N&&y==null&&(y={type:l.ConflictType.RM_UNEXPECTED_CONTENT,op1:a.removeOp(N.getPath()),op2:a.insertOp(T.getPath(),Y.i)})));const ue=u(x);ue&&(ue.r!==void 0?N=x.clone():ue.p!=null&&(ue.p,E=ue.p,N=null));const le=ge(Y);le&&N&&y==null&&(y={type:l.ConflictType.RM_UNEXPECTED_CONTENT,op1:a.removeOp(N.getPath()),op2:a.editOp(T.getPath(),le,h(Y),!0)});let oe=0,we=0;const V=r.advancer(G,(F,ce)=>g(ce)?oe-F-1:F-oe,(F,ce)=>{g(ce)&&oe++}),U=r.advancer(x);for(const F of T)if(typeof F=="number"){const ce=F-we,Ie=V(ce);we+=+Q(U(ce+oe),Ie,T,E,N)}else{const ce=V(F);Q(U(F),ce,T,E,N)}return V.end(),U.end(),ee})(ye,pe,pe.clone(),null,null),p.map(Q=>Q&&Q.get()),y)return{ok:!1,conflict:y};M.map(Q=>!!Q);const Ue=[];let xe=null;(function Q(x,G,T,E,N){let Y=!1;const q=u(G);if(g(q)){const V=q.p;V!=null?(T=p[V],E=ne[V]=r.writeCursor(),Y=!0,N=null):(T=null,N=G.clone())}else s(u(T))&&(T=null);const ee=x.getComponent();if(ee){const V=ee.p;V!=null?(N&&(S[V]=N),Ue[V]=N||C===1&&Y?null:E.getComponent(),O[V]=x.clone(),T&&(D[V]=T.clone())):ee.r!==void 0&&(N||E.write("r",!0),(N||Y)&&(xe==null&&(xe=new Set),xe.add(ee)))}let ue=0,le=0;const oe=r.advancer(G,void 0,(V,U)=>{g(U)&&ue++}),we=r.advancer(T,(V,U)=>s(U)?~(V-le):V-le,(V,U)=>{s(U)&&le++});if(x)for(const V of x)if(typeof V=="string"){const U=oe(V),F=we(V);E.descend(V),Q(x,U,F,E,N),E.ascend()}else{const U=oe(V),F=V-ue,ce=g(u(U))?null:we(F),Ie=F+le;o(Ie>=0),E.descend(Ie),Q(x,U,ce,E,N),E.ascend()}oe.end(),we.end()})(ye,pe,pe.clone(),se,null),se.reset();let Ke=[];if((function Q(x,G,T,E,N,Y){o(G);const q=G.getComponent();let ee=u(E),ue=!1;const le=($,re,fe)=>$?a.moveOp($.getPath(),re.getPath()):a.insertOp(re.getPath(),fe.i);if(s(q)){const $=q.d;$!=null&&(R[$]=G.clone());const re=$!=null?Ue[$]:null;let fe=!1;if(q.i!==void 0||$!=null&&re){let ae;ee&&(ee.i!==void 0||(ae=ee.d)!=null&&!m[ae])&&(fe=ae!=null?$!=null&&$===K[ae]:t.default(ee.i,q.i),fe||ae!=null&&C!==1&&K[ae]!=null||y==null&&(y={type:l.ConflictType.DROP_COLLISION,op1:le($!=null?O[$]:null,G,q),op2:le(ae!=null?A[ae]:null,E,ee)})),fe||(Y?y==null&&(y={type:l.ConflictType.RM_UNEXPECTED_CONTENT,op1:le($!=null?O[$]:null,G,q),op2:a.removeOp(Y.getPath())}):($!=null?(Ke[Ae]=$,N.write("d",re.p=Ae++)):N.write("i",n.default(q.i)),ue=!0))}else if($!=null&&!re){const ae=S[$];ae&&(Y=ae.clone())}$!=null?(x=O[$],T=I[$],E=D[$]):q.i!==void 0&&(x=T=null,fe||(E=null))}else g(u(x))&&(x=T=E=null);const oe=u(x),we=u(T);if(g(we)){const $=we.p;we.r!==void 0&&(!oe||oe.r===void 0)||m[$]?(E=null,Y=T.clone()):$!=null&&(E=p[$],C!==1&&K[$]!=null||((N=te[$])||(N=te[$]=r.writeCursor()),N.reset(),Y=null))}else!s(q)&&s(ee)&&(E=null);ee=E!=null?E.getComponent():null;const V=ge(q);if(V){const $=h(q);if(Y)y==null&&(y={type:l.ConflictType.RM_UNEXPECTED_CONTENT,op1:a.editOp(G.getPath(),V,$,!0),op2:a.removeOp(Y.getPath())});else{const re=ge(ee);let fe;if(re){if(V!==re)throw Error("Transforming incompatible types");const ae=h(ee);fe=V.transform($,ae,v)}else fe=n.default($);b(N,V,fe)}}let U=0,F=0,ce=0,Ie=0,Re=0,Le=0,Te=x!=null&&x.descendFirst(),Ze=Te;const Xe=r.advancer(T,void 0,($,re)=>{g(re)&&ce++});let Ne=E!=null&&E.descendFirst(),$e=Ne;for(const $ of G)if(typeof $=="number"){let re;const fe=s(G.getComponent()),ae=$-F;{let We;for(;Te&&typeof(We=x.getKey())=="number";){We+=U;const je=x.getComponent(),Ve=g(je);if(We>ae||We===ae&&(!Ve||C===0&&fe))break;if(Ve){U--;const ze=je.p;K.includes(ze),je.d,u(te[je.d]),g(u(te[je.d])),(je.r===void 0||xe&&xe.has(je))&&(ze==null||!Ue[ze]||C!==1&&K.includes(ze))||Re--}Te=x.nextSibling()}re=Te&&We===ae?x:null}const Me=ae-U;let Be=Xe(Me);const ot=Me-ce;let Je=null;{let We,je;for(;Ne&&typeof(We=E.getKey())=="number";){je=We-Ie;const Ve=E.getComponent(),ze=s(Ve);if(je>ot)break;if(je===ot){if(!ze){Je=E;break}{if(C===0&&fe){Je=E;break}const Ge=Be&&g(Be.getComponent());if(C===0&&Ge)break}}if(ze){const Ge=Ve.d;m[Ge],K[Ge],Ve.i===void 0&&(m[Ge]||K[Ge]!=null&&C!==1)?(m[Ge]||K[Ge]!=null&&C===0)&&(Ie++,Le--):Ie++}Ne=E.nextSibling()}}const ft=ot+Ie+Re+Le;o(ft>=0,"trying to descend to a negative index"),N.descend(ft),fe&&(re=Be=Je=null,F++),Q(re,G,Be,Je,N,Y)&&Le++,N.ascend()}else{let re;for(;Te&&(re=x.getKey(),typeof re!="string"||!(re>$||re===$));)Te=x.nextSibling();const fe=Te&&re===$?x:null,ae=Xe($);let Me;for(;Ne&&(Me=E.getKey(),typeof Me!="string"||!(Me>$||Me===$));)Ne=E.nextSibling();const Be=Ne&&Me===$?E:null;N.descend($),Q(fe,G,ae,Be,N,Y),N.ascend()}return Xe.end(),Ze&&x.ascend(),$e&&E.ascend(),ue})(ye,ye.clone(),pe,pe.clone(),se,null),y)return{ok:!1,conflict:y};se.reset();const Pe=(Q,x,G)=>Q.traverse(x,(T,E)=>{T.d!=null&&G(T.d,Q,E)});(m.length||ne.length)&&(Pe(pe,se,(Q,x,G)=>{m[Q]&&!M[Q]&&G.write("r",!0),ne[Q]&&G.mergeTree(ne[Q].get())}),se.reset());const Ce=[],Se=[];if((te.length||m.length)&&!y){const Q=r.readCursor(it(se.get()));if(Pe(Q,null,(x,G)=>{Ce[x]=G.clone()}),te.forEach(x=>{x&&Pe(r.readCursor(x.get()),null,(G,T)=>{Ce[G]=T.clone()})}),(function x(G,T,E,N,Y,q){const ee=u(T);if(ee&&g(ee))if(ee.p!=null){const U=ee.p;Ce[U].getPath(),E=Ce[U],N=Se[U]=r.writeCursor()}else ee.r!==void 0&&(E=null);else s(u(E))&&(E=null);const ue=G.getComponent();if(ue){let U;if((U=ue.d)!=null){const F=te[U];F&&(F.get(),N.mergeTree(F.get()),E=r.readCursor(F.get()))}}let le=0,oe=0;const we=r.advancer(T,void 0,(U,F)=>{g(F)&&le--}),V=r.advancer(E,(U,F)=>s(F)?-(U-oe)-1:U-oe,(U,F)=>{s(F)&&oe++});for(const U of G)if(typeof U=="number"){const F=we(U),ce=U+le,Ie=V(ce),Re=ce+oe;N.descend(Re),x(G,F,Ie,N),N.ascend()}else N.descend(U),x(G,we(U),V(U),N),N.ascend();we.end(),V.end()})(pe,Q,Q.clone(),se),se.reset(),y)return{ok:!1,conflict:y};if(se.get(),Se.length){const x=Se.map(T=>T?T.get():null),G=r.readCursor(it(se.get()));if(Pe(G,se,(T,E,N)=>{const Y=x[T];Y&&(N.mergeTree(Y),x[T]=null)}),x.find(T=>T)){const T=r.writeCursor(),E=r.writeCursor();let N=0,Y=0;x.forEach(q=>{q!=null&&Pe(r.readCursor(q),null,ee=>{const ue=Ke[ee];T.writeMove(O[ue].getPath(),R[ue].getPath(),N++);const le=ie[ue];le&&le.forEach(oe=>{m[oe]||C!==1&&K[oe]!=null||E.writeMove(A[oe].getPath(),p[oe].getPath(),Y++)})})}),y={type:l.ConflictType.BLACKHOLE,op1:T.get(),op2:E.get()}}}}return y?{ok:!1,conflict:y}:{ok:!0,result:se.get()}}const ht=i=>{const c=new Error("Transform detected write conflict");throw c.conflict=i,c.type=c.name="writeConflict",c};function $t(i,c,v){const C=st(i,c,v);if(C.ok)return C.result;ht(C.conflict)}const He=i=>{const c=r.writeCursor();return r.readCursor(i).traverse(c,(v,C)=>{(s(v)||ge(v))&&C.write("r",!0)}),c.get()},kt=(i,c)=>{const{type:v,op1:C,op2:y}=i;switch(v){case l.ConflictType.DROP_COLLISION:return c==="left"?[null,He(y)]:[He(C),null];case l.ConflictType.RM_UNEXPECTED_CONTENT:let O=!1;return r.readCursor(C).traverse(null,R=>{R.r!==void 0&&(O=!0)}),O?[null,He(y)]:[He(C),null];case l.ConflictType.BLACKHOLE:return[He(C),He(y)];default:throw Error("Unrecognised conflict: "+v)}};function pt(i,c,v,C){let y=null;for(;;){const O=st(c,v,C);if(O.ok)return ve(y,O.result);{const{conflict:R}=O;i(R)||ht(R);const[A,p]=kt(R,C);c=ve(H(c),A),v=ve(H(v),p),y=ve(y,p)}}}})(et)),et}var Pt;function cn(){return Pt||(Pt=1,(function(a){var e=qe&&qe.__createBinding||(Object.create?(function(l,o,u,P){P===void 0&&(P=u),Object.defineProperty(l,P,{enumerable:!0,get:function(){return o[u]}})}):(function(l,o,u,P){P===void 0&&(P=u),l[P]=o[u]})),t=qe&&qe.__exportStar||function(l,o){for(var u in l)u!=="default"&&!o.hasOwnProperty(u)&&e(o,l,u)};Object.defineProperty(a,"__esModule",{value:!0}),t(un(),a);var n=Mt();Object.defineProperty(a,"ReadCursor",{enumerable:!0,get:function(){return n.ReadCursor}}),Object.defineProperty(a,"WriteCursor",{enumerable:!0,get:function(){return n.WriteCursor}});var r=jt();Object.defineProperty(a,"ConflictType",{enumerable:!0,get:function(){return r.ConflictType}})})(qe)),qe}var X=cn();class dn{constructor(){L(this,"drawingManagerData",{}),L(this,"_oldDrawingManagerData",{}),L(this,"_focusDrawings",[]),L(this,"_remove$",new _e),L(this,"remove$",this._remove$.asObservable()),L(this,"_add$",new _e),L(this,"add$",this._add$.asObservable()),L(this,"_update$",new _e),L(this,"update$",this._update$.asObservable()),L(this,"_order$",new _e),L(this,"order$",this._order$.asObservable()),L(this,"_group$",new _e),L(this,"group$",this._group$.asObservable()),L(this,"_ungroup$",new _e),L(this,"ungroup$",this._ungroup$.asObservable()),L(this,"_refreshTransform$",new _e),L(this,"refreshTransform$",this._refreshTransform$.asObservable()),L(this,"_visible$",new _e),L(this,"visible$",this._visible$.asObservable()),L(this,"_focus$",new _e),L(this,"focus$",this._focus$.asObservable()),L(this,"_featurePluginUpdate$",new _e),L(this,"featurePluginUpdate$",this._featurePluginUpdate$.asObservable()),L(this,"_featurePluginAdd$",new _e),L(this,"featurePluginAdd$",this._featurePluginAdd$.asObservable()),L(this,"_featurePluginRemove$",new _e),L(this,"featurePluginRemove$",this._featurePluginRemove$.asObservable()),L(this,"_featurePluginOrderUpdate$",new _e),L(this,"featurePluginOrderUpdate$",this._featurePluginOrderUpdate$.asObservable()),L(this,"_featurePluginGroupUpdate$",new _e),L(this,"featurePluginGroupUpdate$",this._featurePluginGroupUpdate$.asObservable()),L(this,"_featurePluginUngroupUpdate$",new _e),L(this,"featurePluginUngroupUpdate$",this._featurePluginUngroupUpdate$.asObservable()),L(this,"_visible",!0),L(this,"_editable",!0)}dispose(){this._remove$.complete(),this._add$.complete(),this._update$.complete(),this._order$.complete(),this._focus$.complete(),this._featurePluginUpdate$.complete(),this._featurePluginAdd$.complete(),this._featurePluginRemove$.complete(),this._featurePluginOrderUpdate$.complete(),this.drawingManagerData={},this._oldDrawingManagerData={}}visibleNotification(e){this._visible$.next(e)}refreshTransform(e){e.forEach(t=>{const n=this._getCurrentBySearch(t);n!=null&&(n.transform=t.transform,n.transforms=t.transforms,n.isMultiTransform=t.isMultiTransform)}),this.refreshTransformNotification(e)}getDrawingDataForUnit(e){return this.drawingManagerData[e]||{}}removeDrawingDataForUnit(e){const t=this.drawingManagerData[e];if(t==null)return;delete this.drawingManagerData[e];const n=[];Object.keys(t).forEach(r=>{const l=t[r];l?.data!=null&&Object.keys(l.data).forEach(o=>{n.push({unitId:e,subUnitId:r,drawingId:o})})}),n.length>0&&this.removeNotification(n)}registerDrawingData(e,t){this.drawingManagerData[e]=t}initializeNotification(e){const t=[],n=this.drawingManagerData[e];n!=null&&(Object.keys(n).forEach(r=>{this._establishDrawingMap(e,r);const l=n[r];Object.keys(l.data).forEach(o=>{const u=l.data[o];u.unitId=e,u.subUnitId=r,t.push(u)})}),t.length>0&&this.addNotification(t))}getDrawingData(e,t){return this._getDrawingData(e,t)}setDrawingData(e,t,n){this.drawingManagerData[e][t].data=n}getBatchAddOp(e){const t=[],n=[],r=[];e.forEach(W=>{const{op:g,invertOp:s}=this._addByParam(W);t.push({unitId:W.unitId,subUnitId:W.subUnitId,drawingId:W.drawingId}),n.push(g),r.push(s)});const l=n.reduce(X.type.compose,null),o=r.reduce(X.type.compose,null),{unitId:u,subUnitId:P}=e[0];return{undo:o,redo:l,unitId:u,subUnitId:P,objects:t}}getBatchRemoveOp(e){const t=[],n=[];e.forEach(P=>{const{op:W,invertOp:g}=this._removeByParam(P);t.unshift(W),n.push(g)});const r=t.reduce(X.type.compose,null),l=n.reduce(X.type.compose,null),{unitId:o,subUnitId:u}=e[0];return{undo:l,redo:r,unitId:o,subUnitId:u,objects:e}}getBatchUpdateOp(e){const t=[],n=[],r=[];e.forEach(W=>{const{op:g,invertOp:s}=this._updateByParam(W);t.push({unitId:W.unitId,subUnitId:W.subUnitId,drawingId:W.drawingId}),n.push(g),r.push(s)});const l=n.reduce(X.type.compose,null),o=r.reduce(X.type.compose,null),{unitId:u,subUnitId:P}=e[0];return{undo:o,redo:l,unitId:u,subUnitId:P,objects:t}}removeNotification(e){this._remove$.next(e)}addNotification(e){this._add$.next(e)}updateNotification(e){this._update$.next(e)}orderNotification(e){this._order$.next(e)}groupUpdateNotification(e){this._group$.next(e)}ungroupUpdateNotification(e){this._ungroup$.next(e)}refreshTransformNotification(e){this._refreshTransform$.next(e)}getGroupDrawingOp(e){const t=[],{unitId:n,subUnitId:r}=e[0].parent;e.forEach(o=>{t.push(this._getGroupDrawingOp(o))});const l=t.reduce(X.type.compose,null);return{undo:X.type.invertWithDoc(l,this.drawingManagerData),redo:l,unitId:n,subUnitId:r,objects:e}}getUngroupDrawingOp(e){const t=[],{unitId:n,subUnitId:r}=e[0].parent;e.forEach(o=>{t.push(this._getUngroupDrawingOp(o))});const l=t.reduce(X.type.compose,null);return{undo:X.type.invertWithDoc(l,this.drawingManagerData),redo:l,unitId:n,subUnitId:r,objects:e}}getDrawingsByGroup(e){const{unitId:t,subUnitId:n,drawingId:r}=e;if(this.getDrawingByParam({unitId:t,subUnitId:n,drawingId:r})==null)return[];const l=this._getDrawingData(t,n),o=[];return Object.keys(l).forEach(u=>{const P=l[u];P.groupId===r&&o.push(P)}),o}_getGroupDrawingOp(e){const{parent:t,children:n}=e,{unitId:r,subUnitId:l,drawingId:o}=t,u=[];u.push(X.insertOp([r,l,"data",o],t));let P=Number.NEGATIVE_INFINITY;return n.forEach(W=>{const{unitId:g,subUnitId:s,drawingId:d}=W,f=this._hasDrawingOrder({unitId:g,subUnitId:s,drawingId:d});P=Math.max(P,f),u.push(...this._getUpdateParamCompareOp(W,this.getDrawingByParam({unitId:g,subUnitId:s,drawingId:d})))}),P===Number.NEGATIVE_INFINITY&&(P=this._getDrawingOrder(r,l).length),u.push(X.insertOp([r,l,"order",P],o)),u.reduce(X.type.compose,null)}_getUngroupDrawingOp(e){const{parent:t,children:n}=e,{unitId:r,subUnitId:l,drawingId:o}=t,u=[];return n.forEach(P=>{const{unitId:W,subUnitId:g,drawingId:s}=P;u.push(...this._getUpdateParamCompareOp(P,this.getDrawingByParam({unitId:W,subUnitId:g,drawingId:s})))}),u.push(X.removeOp([r,l,"data",o],!0)),u.push(X.removeOp([r,l,"order",this._getDrawingOrder(r,l).indexOf(o)],!0)),u.reduce(X.type.compose,null)}applyJson1(e,t,n){this._establishDrawingMap(e,t),this._oldDrawingManagerData={...this.drawingManagerData},this.drawingManagerData=X.type.apply(this.drawingManagerData,n)}featurePluginUpdateNotification(e){this._featurePluginUpdate$.next(e)}featurePluginOrderUpdateNotification(e){this._featurePluginOrderUpdate$.next(e)}featurePluginAddNotification(e){this._featurePluginAdd$.next(e)}featurePluginRemoveNotification(e){this._featurePluginRemove$.next(e)}featurePluginGroupUpdateNotification(e){this._featurePluginGroupUpdate$.next(e)}featurePluginUngroupUpdateNotification(e){this._featurePluginUngroupUpdate$.next(e)}getDrawingByParam(e){return this._getCurrentBySearch(e)}getOldDrawingByParam(e){return this._getOldBySearch(e)}getDrawingOKey(e){const[t,n,r]=e.split("#-#");return this._getCurrentBySearch({unitId:t,subUnitId:n,drawingId:r})}focusDrawing(e){if(e==null||e.length===0){this._focusDrawings=[],this._focus$.next([]);return}const t=[];e.forEach(n=>{var r;const{unitId:l,subUnitId:o,drawingId:u}=n,P=(r=this._getDrawingData(l,o))==null?void 0:r[u];P!=null&&t.push(P)}),t.length>0&&(this._focusDrawings=t,this._focus$.next(t))}getFocusDrawings(){const e=[];return this._focusDrawings.forEach(t=>{var n;const{unitId:r,subUnitId:l,drawingId:o}=t,u=(n=this._getDrawingData(r,l))==null?void 0:n[o];u!=null&&e.push(u)}),e}getDrawingOrder(e,t){return this._getDrawingOrder(e,t)}setDrawingOrder(e,t,n){this.drawingManagerData[e][t].order=n}orderUpdateNotification(e){this._order$.next(e)}getForwardDrawingsOp(e){const{unitId:t,subUnitId:n,drawingIds:r}=e,l=[],o=this.getDrawingOrder(t,n),u=[...r];r.forEach(W=>{const g=this._hasDrawingOrder({unitId:t,subUnitId:n,drawingId:W});if(g===-1||g===o.length-1)return;const s=X.moveOp([t,n,"order",g],[t,n,"order",g+1]);l.push(s),u.includes(o[g+1])||u.push(o[g+1])});const P=l.reduce(X.type.compose,null);return{undo:X.type.invertWithDoc(P,this.drawingManagerData),redo:P,unitId:t,subUnitId:n,objects:{...e,drawingIds:u}}}getBackwardDrawingOp(e){const{unitId:t,subUnitId:n,drawingIds:r}=e,l=[],o=this.getDrawingOrder(t,n),u=[...r];r.forEach(W=>{const g=this._hasDrawingOrder({unitId:t,subUnitId:n,drawingId:W});if(g===-1||g===0)return;const s=X.moveOp([t,n,"order",g],[t,n,"order",g-1]);l.push(s),u.includes(o[g-1])||u.push(o[g-1])});const P=l.reduce(X.type.compose,null);return{undo:X.type.invertWithDoc(P,this.drawingManagerData),redo:P,unitId:t,subUnitId:n,objects:{...e,drawingIds:u}}}getFrontDrawingsOp(e){const{unitId:t,subUnitId:n,drawingIds:r}=e,l=this._getOrderFromSearchParams(t,n,r),o=[...r],u=this.getDrawingOrder(t,n),P=[];l.forEach(g=>{const{drawingId:s}=g,d=this._getDrawingCount(t,n)-1,f=X.moveOp([t,n,"order",this._getDrawingOrder(t,n).indexOf(s)],[t,n,"order",d]);P.push(f),o.includes(u[d])||o.push(u[d])});const W=P.reduce(X.type.compose,null);return{undo:X.type.invertWithDoc(W,this.drawingManagerData),redo:W,unitId:t,subUnitId:n,objects:{...e,drawingIds:o}}}getBackDrawingsOp(e){const{unitId:t,subUnitId:n,drawingIds:r}=e,l=this._getOrderFromSearchParams(t,n,r,!0),o=[...r],u=this.getDrawingOrder(t,n),P=[];l.forEach(g=>{const{drawingId:s}=g,d=X.moveOp([t,n,"order",this._getDrawingOrder(t,n).indexOf(s)],[t,n,"order",0]);P.push(d),o.includes(u[0])||o.push(u[0])});const W=P.reduce(X.type.compose,null);return{undo:X.type.invertWithDoc(W,this.drawingManagerData),redo:W,unitId:t,subUnitId:n,objects:{...e,drawingIds:o}}}_getDrawingCount(e,t){return this.getDrawingOrder(e,t).length||0}_getOrderFromSearchParams(e,t,n,r=!1){return n.map(l=>{const o=this._hasDrawingOrder({unitId:e,subUnitId:t,drawingId:l});return{drawingId:l,zIndex:o}}).sort(r===!1?Gt:Ft)}_hasDrawingOrder(e){if(e==null)return-1;const{unitId:t,subUnitId:n,drawingId:r}=e;return this._establishDrawingMap(t,n),this._getDrawingOrder(t,n).indexOf(r)}_getCurrentBySearch(e){var t,n,r;if(e==null)return;const{unitId:l,subUnitId:o,drawingId:u}=e;return(r=(n=(t=this.drawingManagerData[l])==null?void 0:t[o])==null?void 0:n.data)==null?void 0:r[u]}_getOldBySearch(e){var t,n,r;if(e==null)return;const{unitId:l,subUnitId:o,drawingId:u}=e;return(r=(n=(t=this._oldDrawingManagerData[l])==null?void 0:t[o])==null?void 0:n.data)==null?void 0:r[u]}_establishDrawingMap(e,t,n){var r;return this.drawingManagerData[e]||(this.drawingManagerData[e]={}),this.drawingManagerData[e][t]||(this.drawingManagerData[e][t]={data:{},order:[]}),n==null?null:(r=this.drawingManagerData[e][t].data)==null?void 0:r[n]}_addByParam(e){const{unitId:t,subUnitId:n,drawingId:r}=e;this._establishDrawingMap(t,n,r);const l=X.insertOp([t,n,"data",r],e),o=X.insertOp([t,n,"order",this._getDrawingOrder(t,n).length],r),u=[l,o].reduce(X.type.compose,null),P=X.type.invertWithDoc(u,this.drawingManagerData);return{op:u,invertOp:P}}_removeByParam(e){if(e==null)return{op:[],invertOp:[]};const{unitId:t,subUnitId:n,drawingId:r}=e;if(this._establishDrawingMap(t,n,r)==null)return{op:[],invertOp:[]};const l=X.removeOp([t,n,"data",r],!0),o=X.removeOp([t,n,"order",this._getDrawingOrder(t,n).indexOf(r)],!0),u=[l,o].reduce(X.type.compose,null),P=X.type.invertWithDoc(u,this.drawingManagerData);return{op:u,invertOp:P}}_updateByParam(e){const{unitId:t,subUnitId:n,drawingId:r}=e,l=this._establishDrawingMap(t,n,r);if(l==null)return{op:[],invertOp:[]};const o=this._getUpdateParamCompareOp(e,l).reduce(X.type.compose,null),u=X.type.invertWithDoc(o,this.drawingManagerData);return{op:o,invertOp:u}}_getUpdateParamCompareOp(e,t){const{unitId:n,subUnitId:r,drawingId:l}=e,o=[];return Object.keys(e).forEach(u=>{const P=e[u],W=t[u];W!==P&&o.push(X.replaceOp([n,r,"data",l,u],W,P))}),o}_getDrawingData(e,t){var n,r;return((r=(n=this.drawingManagerData[e])==null?void 0:n[t])==null?void 0:r.data)||{}}_getDrawingOrder(e,t){var n,r;return((r=(n=this.drawingManagerData[e])==null?void 0:n[t])==null?void 0:r.order)||[]}getDrawingVisible(){return this._visible}getDrawingEditable(){return this._editable}setDrawingVisible(e){this._visible=e}setDrawingEditable(e){this._editable=e}}class hn extends dn{}class pn{constructor(){L(this,"_waitCount",0),L(this,"_change$",new _e),L(this,"change$",this._change$),L(this,"_imageSourceCache",new Map)}setWaitCount(e){this._waitCount=e,this._change$.next(e)}getImageSourceCache(e,t){if(t===at.BASE64){const n=new Image;return n.src=e,n}return this._imageSourceCache.get(e)}addImageSourceCache(e,t,n){t===at.BASE64||n==null||this._imageSourceCache.set(e,n)}async getImage(e){return Promise.resolve(e)}async saveImage(e){return new Promise((t,n)=>{if(!tn.includes(e.type)){n(new Error(Qe.ERROR_IMAGE_TYPE)),this._decreaseWaiting();return}if(e.size>en){n(new Error(Qe.ERROR_EXCEED_SIZE)),this._decreaseWaiting();return}const r=new FileReader;r.readAsDataURL(e),r.onload=l=>{var o;const u=(o=l.target)==null?void 0:o.result;if(u==null){n(new Error(Qe.ERROR_IMAGE)),this._decreaseWaiting();return}const P=Rt(6);t({imageId:P,imageSourceType:at.BASE64,source:u,base64Cache:u,status:Qe.SUCCUSS}),this._decreaseWaiting()}})}_decreaseWaiting(){this._waitCount-=1,this._change$.next(this._waitCount)}}class fn extends Bt{constructor(){super(...arguments),L(this,"_urlImageDownloader",null)}registerURLImageDownloader(e){return this._urlImageDownloader=e,Wt(()=>{this._urlImageDownloader=null})}async getImage(e){if(this._urlImageDownloader)try{return await this._urlImageDownloader(e)}catch(t){console.error(`Custom downloader failed for ${e}, falling back to default behavior:`,t)}return e}async downloadImage(e){if(this._urlImageDownloader)try{const t=await this._urlImageDownloader(e);return await(await fetch(t)).blob()}catch(t){console.error(`Custom downloader failed for ${e}, falling back to default fetch:`,t)}return await(await fetch(e)).blob()}}var gn=(a,e,t,n)=>{for(var r=e,l=a.length-1,o;l>=0;l--)(o=a[l])&&(r=o(r)||r);return r},lt=(a,e)=>(t,n)=>e(t,n,a);const mn="UNIVER_DRAWING_PLUGIN";var ut;let xt=(ut=class extends Kt{constructor(a=gt,e,t,n){super(),this._config=a,this._injector=e,this._configService=t,this._commandService=n;const{...r}=Lt({},gt,this._config);this._configService.setConfig(rn,r)}onStarting(){this._initCommands(),this._initDependencies()}_initDependencies(){var a;zt([[Ht,{useClass:pn}],[Xt,{useClass:fn}],[Tt,{useClass:hn}]],(a=this._config)==null?void 0:a.override).forEach(e=>this._injector.add(e))}_initCommands(){[nn].forEach(a=>this.disposeWithMe(this._commandService.registerCommand(a)))}},L(ut,"pluginName",mn),ut);xt=gn([lt(1,Vt(qt)),lt(2,Yt),lt(3,Zt)],xt);function In({unitId:a,subUnitId:e,drawingId:t},n){return typeof n=="number"?`${a}#-#${e}#-#${t}#-#${n}`:`${a}#-#${e}#-#${t}`}const _n=async a=>new Promise((e,t)=>{const n=new Image;n.src=a,n.onload=()=>{e({width:n.width,height:n.height,image:n})},n.onerror=r=>{t(r)}});export{tn as DRAWING_IMAGE_ALLOW_IMAGE_LIST,en as DRAWING_IMAGE_ALLOW_SIZE,yn as DRAWING_IMAGE_COUNT_LIMIT,vn as DRAWING_IMAGE_HEIGHT_LIMIT,wn as DRAWING_IMAGE_WIDTH_LIMIT,hn as DrawingManagerService,Tt as IDrawingManagerService,Ht as IImageIoService,pn as ImageIoService,at as ImageSourceType,Qe as ImageUploadStatusType,nn as SetDrawingSelectedOperation,fn as URLImageService,dn as UnitDrawingService,xt as UniverDrawingPlugin,In as getDrawingShapeKeyByDrawingSearch,_n as getImageSize};
