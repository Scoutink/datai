import{L as P,i as nt,b6 as A,bi as z,fM as We,aB as G,d5 as ge,e5 as fr,g6 as k,cm as Et,fn as ft,aJ as pi,bB as re,da as V,gb as pr,e7 as gr,gf as _r,aC as vr,c5 as ot,fk as Mt,g0 as Rt,dW as Cr,j as Ve,fr as Vt,k as ze,f4 as gi,gl as he,bf as _i,bm as b,bS as Sr,b7 as lt,bo as ie,b9 as at,ca as Ir,fA as vi,gp as Ci,cz as Fr,g7 as Si,dT as Er,gm as Ii,gc as Fi,gd as ve,dd as Qe,bp as Ei,fy as pt,e as zt,aw as Rr,bc as Ri,d4 as br}from"./index-BI8deSNo.js";import{hm as Fe,bf as wr,ch as Tr,bI as Nr,K as yr,hS as bi,gO as Ge,ee as wi,am as Ti,cp as Ni,R as Or,co as yi,bu as Oi,X as Mr,bM as Mi,bK as xi,aM as Gt,cm as Ai,cf as Ui,be as $i,bt as Li,Y as xr,c9 as Ar,gq as ki,i as Yt,d4 as Pi,ga as we,gp as Te,c3 as Ne,i6 as Hi,cU as Bi,gw as ji,h5 as Di,hg as Wi,m as Qi,fo as Vi,f3 as zi,p as Gi,b9 as Yi,fl as Ur,eR as Zi,f as xt,i7 as $r,ia as qi}from"./facade-BslPbXnu.js";import{z as bt,c_ as Lr,a_ as Xi,aG as Zt,aa as kr}from"./index-DnxWP_AP.js";import{cb as Ji,a9 as Ki,ak as es,co as ts,cn as rs,cd as Pr}from"./index-BBqjqAkl.js";import{bE as ut,aa as is,bF as Hr,an as ss,ar as qt,aF as ns,ao as At,ba as Ut,bt as ee,bw as Q,bq as os,_ as ls,ae as Br,w as as,ai as us,ad as cs}from"./index-BeEHzc6r.js";import{i as jr,aj as O,ak as f,X as ds,Z as gt,Y as Dr,u as hs,I as ms,a4 as Ye,T as $t,p as Xt,E as fs,v as ps,J as gs,o as Jt}from"./index-BmfxE5KL.js";import{a as _s}from"./shareReplay-DR2HpNHE.js";import{t as vs}from"./takeUntil-BWepI5Pd.js";import{O as Cs,j as Lt,U as Wr}from"./facade-bHpds0ZF.js";import"./index-C5GuqOxb.js";import"./index-GTTB9Gpg.js";import"./index-u4QJ_A0o.js";import"./bufferTime-Dc1Jgi3q.js";import"./isObservable-DLg0_x3m.js";var Ss=Object.defineProperty,Is=(e,t,r)=>t in e?Ss(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,T=(e,t,r)=>Is(e,typeof t!="symbol"?t+"":t,r);const Qr="sheet.mutation.set-filter-range",Vr="sheet.mutation.set-filter-criteria",zr="sheet.mutation.remove-filter",Gr="sheet.mutation.re-calc-filter",kt=new Set([Qr,Vr,zr,Gr]);var x=(e=>(e[e.VALUES=0]="VALUES",e[e.COLORS=1]="COLORS",e[e.CONDITIONS=2]="CONDITIONS",e))(x||{}),m=(e=>(e.EQUAL="equal",e.GREATER_THAN="greaterThan",e.GREATER_THAN_OR_EQUAL="greaterThanOrEqual",e.LESS_THAN="lessThan",e.LESS_THAN_OR_EQUAL="lessThanOrEqual",e.NOT_EQUALS="notEqual",e))(m||{});const Fs={operator:m.GREATER_THAN,fn:(e,t)=>Ee(e)?e>t:!1},Es={operator:m.GREATER_THAN_OR_EQUAL,fn:(e,t)=>Ee(e)?e>=t:!1},Rs={operator:m.LESS_THAN,fn:(e,t)=>Ee(e)?e<t:!1},bs={operator:m.LESS_THAN_OR_EQUAL,fn:(e,t)=>Ee(e)?e<=t:!1},ws={operator:m.EQUAL,fn:(e,t)=>Ee(e)?e===t:!1},Yr={operator:m.NOT_EQUALS,fn:(e,t)=>{if(typeof t=="string"){if(t===" ")return e!=null;const r=qr(e);return r&&Os(t)?!Cr(t).test(r):r!==t}return Ee(e)?e!==t:!0}},Zr=new Map([]),Ts=[Fs,Es,Rs,bs,ws,Yr];Ts.forEach(e=>{Zr.set(e.operator,e)});function Ns(e){return!!e}const ys={fn:(e,t)=>{const r=qr(e);return r===null?t==="":Cr(t).test(r)}};function Kt(e){return e?Zr.get(e):ys}function Ee(e){return typeof e=="number"}function er(e){return!!(typeof e=="number"||typeof e=="string"&&gi(e))}function qr(e){return typeof e=="boolean"||e==null?null:typeof e=="string"?e:e.toString()}function Os(e){return typeof e=="number"?!1:e.indexOf("*")!==-1||e.indexOf("?")!==-1}const _t=()=>new Set;let tr=class Xr extends G{constructor(t,r,i){super(),T(this,"_filteredOutRows$",new k(_t())),T(this,"filteredOutRows$",this._filteredOutRows$.asObservable()),T(this,"_hasCriteria$",new k(!1)),T(this,"hasCriteria$",this._hasCriteria$.asObservable()),T(this,"_filterColumnByIndex",new Map),T(this,"_alreadyFilteredOutRows",_t()),T(this,"_range"),this.unitId=t,this.subUnitId=r,this._worksheet=i}get filteredOutRows(){return this._filteredOutRows$.getValue()}set filteredOutRows(t){this._alreadyFilteredOutRows=t,this._filteredOutRows$.next(t)}dispose(){super.dispose(),this._filteredOutRows$.complete(),this._hasCriteria$.complete(),this._worksheet=null}serialize(){const t={ref:Et.clone(this._range),filterColumns:this._getAllFilterColumns(!0).sort(([r],[i])=>r-i).map(([r,i])=>i.serialize())};return this._alreadyFilteredOutRows&&(t.cachedFilteredOut=Array.from(this._alreadyFilteredOutRows).sort()),t}static deserialize(t,r,i,n){const o=new Xr(t,r,i);return o._dump(n),o}_dump(t){var r;this.setRange(t.ref),(r=t.filterColumns)==null||r.filter(i=>!(!i.filters&&!i.colorFilters&&!i.customFilters)).forEach(i=>this._setCriteriaWithoutReCalc(i.colId,i)),t.cachedFilteredOut?(this._alreadyFilteredOutRows=new Set(t.cachedFilteredOut),this._emit()):t.filterColumns&&t.filterColumns.length>0&&(this._reCalcAllColumns(),this._emit()),this._emitHasCriteria()}isRowFiltered(t){return this._alreadyFilteredOutRows.has(t)}getRange(){if(!this._range)throw new Error("[FilterModel] could not get range before a range is set!");return this._range}getFilteredOutRowsExceptCol(t){return this._getAllFilterColumns(!0).filter(([r])=>r!==t).reduce((r,[,i])=>{const n=i.calc({getAlreadyFilteredOutRows:()=>r});return n?ft(r,n):r},new Set)}setRange(t){this._range=t,this._getAllFilterColumns(!0).forEach(([r,i])=>{i.setRangeAndColumn({startRow:t.startRow,endRow:t.endRow,startColumn:r,endColumn:r},r)})}setCriteria(t,r,i=!1){if(!this._range)throw new Error("[FilterModel] could not set criteria before a range is set!");if(!r){this._removeCriteria(t),this._rebuildAlreadyFilteredOutRowsWithCache(),i&&this._reCalcAllColumns(),this._emit(),this._emitHasCriteria();return}this._setCriteriaWithoutReCalc(t,r),i&&(this._rebuildAlreadyFilteredOutRowsWithCache(),this._getAllFilterColumns().forEach(n=>n.__clearCache()),this._reCalcWithNoCacheColumns(),this._emit(),this._emitHasCriteria())}getAllFilterColumns(){return this._getAllFilterColumns(!0)}getFilterColumn(t){var r;return(r=this._filterColumnByIndex.get(t))!=null?r:null}reCalc(){this._reCalcAllColumns(),this._emit()}_getAllFilterColumns(t=!1){const r=Array.from(this._filterColumnByIndex.entries());return t?r:r.map(([i,n])=>n)}_reCalcAllColumns(){this._alreadyFilteredOutRows=_t(),this._getAllFilterColumns().forEach(t=>t.__clearCache()),this._reCalcWithNoCacheColumns()}_setCriteriaWithoutReCalc(t,r){const i=this._range;if(!i)throw new Error("[FilterModel] could not set criteria before a range is set!");const{startColumn:n,endColumn:o}=i;if(t>o||t<n)throw new Error(`[FilterModel] could not set criteria on column ${t} which is out of range!`);let s;this._filterColumnByIndex.has(t)?s=this._filterColumnByIndex.get(t):(s=new Ms(this.unitId,this.subUnitId,this._worksheet,r,{getAlreadyFilteredOutRows:()=>this._alreadyFilteredOutRows}),s.setRangeAndColumn(i,t),this._filterColumnByIndex.set(t,s)),s.setCriteria(r)}_removeCriteria(t){const r=this._filterColumnByIndex.get(t);r&&(r.dispose(),this._filterColumnByIndex.delete(t))}_emit(){this._filteredOutRows$.next(this._alreadyFilteredOutRows)}_emitHasCriteria(){this._hasCriteria$.next(this._filterColumnByIndex.size>0)}_rebuildAlreadyFilteredOutRowsWithCache(){const t=this._getAllFilterColumns().filter(r=>r.hasCache()).reduce((r,i)=>ft(r,i.filteredOutRows),new Set);this._alreadyFilteredOutRows=t}_reCalcWithNoCacheColumns(){const t=this._getAllFilterColumns().filter(r=>!r.hasCache());for(const r of t){const i=r.reCalc();i&&(this._alreadyFilteredOutRows=ft(this._alreadyFilteredOutRows,i))}}},Ms=class extends G{constructor(t,r,i,n,o){super(),T(this,"_filteredOutRows",null),T(this,"_filterFn",null),T(this,"_range",null),T(this,"_column",0),T(this,"_filterBy",x.VALUES),this.unitId=t,this.subUnitId=r,this._worksheet=i,this._criteria=n,this._filterColumnContext=o}get filteredOutRows(){return this._filteredOutRows}get filterBy(){return this._filterBy}dispose(){super.dispose(),this._filteredOutRows=null}__clearCache(){this._filteredOutRows=null}serialize(){if(!this._criteria)throw new Error("[FilterColumn]: could not serialize without a filter column!");return ge.deepClone({...this._criteria,colId:this._column})}hasCache(){return this._filteredOutRows!==null}setRangeAndColumn(t,r){this._range=t,this._column=r}setCriteria(t){this._criteria=t,this._generateFilterFn(),this._filteredOutRows=null}getColumnData(){return ge.deepClone(this._criteria)}reCalc(){return this._filteredOutRows=this.calc(this._filterColumnContext),this._filteredOutRows}calc(t){if(!this._filterFn)throw new Error("[FilterColumn] cannot calculate without a filter fn!");if(!this._range)throw new Error("[FilterColumn] cannot calculate without a range!");if(typeof this._column!="number")throw new TypeError("[FilterColumn] cannot calculate without a column offset!");const r=this._column,i={startColumn:r,endColumn:r,startRow:this._range.startRow+1,endRow:this._range.endRow},n=new Set,o=t.getAlreadyFilteredOutRows();for(const s of this._worksheet.iterateByColumn(i,!1,!1)){const{row:l,rowSpan:a,col:u}=s;if(!(o.has(l)&&(!a||a===1))&&!(this._filterBy===x.VALUES?this._filterFn(fr(this._worksheet.getCell(l,u))):this._filterBy===x.COLORS?this._filterFn(this._worksheet.getComposedCellStyle(l,u)):this._filterFn(Bs(this._worksheet,l,u)))&&(n.add(l),a))for(let c=1;c<a;c++)n.add(l+c)}return n}_generateFilterFn(){this._criteria&&(this._filterFn=xs(this._criteria),this._filterBy=this._criteria.filters?x.VALUES:this._criteria.colorFilters?x.COLORS:x.CONDITIONS)}};function xs(e){if(e.filters)return As(e.filters);if(e.colorFilters)return Us(e.colorFilters);if(e.customFilters)return $s(e.customFilters);throw new Error("[FilterModel]: other types of filters are not supported yet.")}function As(e){const t=!!e.blank,r=new Set(e.filters);return i=>i===void 0||i===""?t:r.has(typeof i=="string"?i:`${i}`)}function Us(e){if(e.cellFillColors){const t=new Set(e.cellFillColors);return r=>{var i;if(!r||!((i=r.bg)!=null&&i.rgb))return!!t.has(null);const n=new ze(r.bg.rgb).toRgbString();return t.has(n)}}if(e.cellTextColors){const t=new Set(e.cellTextColors);return r=>{var i;if(!r||!((i=r.cl)!=null&&i.rgb))return!!t.has(bt);const n=new ze(r.cl.rgb).toRgbString();return t.has(n)}}throw new Error("[FilterModel]: color filters are not supported yet.")}function $s(e){const t=e.customFilters.map(r=>Hs(r));return Ps(t)?e.and?Ls(t):ks(t):t[0]}function Ls(e){const[t,r]=e;return i=>t(i)&&r(i)}function ks(e){const[t,r]=e;return i=>t(i)||r(i)}function Ps(e){return e.length===2}function Hs(e){const t=e.val;if(e.operator===m.NOT_EQUALS&&!er(t))return i=>Yr.fn(i,t);if(Ns(e.operator)){if(!er(t))return()=>!1;const i=Kt(e.operator),n=Number(t);return o=>i.fn(o,n)}const r=Kt(e.operator);return i=>r.fn(i,t)}function Bs(e,t,r){const i=e.getCell(t,r);if(!i)return null;const n=e.getCellRaw(t,r);return i&&!n?rr(i):n?i.t===Ve.NUMBER&&typeof i.v=="string"?n.v:i.t===Ve.NUMBER?Number(n.v):rr(n):null}function rr(e){var t,r;const i=(r=(t=e.p)==null?void 0:t.body)==null?void 0:r.dataStream;if(i)return i.trimEnd();const n=e.v;return typeof n=="string"?e.t===Ve.BOOLEAN?n.toUpperCase():n:typeof n=="number"?e.t===Ve.BOOLEAN?n?"TRUE":"FALSE":n:typeof n=="boolean"?n?"TRUE":"FALSE":""}var js=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},vt=(e,t)=>(r,i)=>t(r,i,e);const Jr="SHEET_FILTER_PLUGIN";let M=class extends G{constructor(t,r,i){super(),T(this,"_filterModels",new Map),T(this,"_loadedUnitId$",new k(null)),T(this,"loadedUnitId$",this._loadedUnitId$.asObservable()),T(this,"_errorMsg$",new k(null)),T(this,"errorMsg$",this._errorMsg$.asObservable()),T(this,"_activeFilterModel$",new k(null)),T(this,"activeFilterModel$",this._activeFilterModel$.asObservable()),this._resourcesManagerService=t,this._univerInstanceService=r,this._commandService=i,this._initModel(),this._initActiveFilterModel()}get activeFilterModel(){return this._activeFilterModel$.getValue()}ensureFilterModel(t,r){const i=this.getFilterModel(t,r);if(i)return i;const n=this._univerInstanceService.getUniverSheetInstance(t);if(!n)throw new Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing workbook ${t}!`);const o=n.getSheetBySheetId(r);if(!o)throw new Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing worksheet ${r}!`);const s=new tr(t,r,o);return this._cacheFilterModel(t,r,s),s}getFilterModel(t,r){var i,n;return(n=(i=this._filterModels.get(t))==null?void 0:i.get(r))!=null?n:null}removeFilterModel(t,r){const i=this.getFilterModel(t,r);return i?(i.dispose(),this._filterModels.get(t).delete(r),!0):!1}setFilterErrorMsg(t){this._errorMsg$.next(t)}_updateActiveFilterModel(){let t;try{if(t=this._univerInstanceService.getCurrentUnitForType(V.UNIVER_SHEET),!t){this._activeFilterModel$.next(null);return}}catch(s){console.error("[SheetsFilterService]: could not get active workbook!",s);return}const r=t.getActiveSheet(!0);if(!r){this._activeFilterModel$.next(null);return}const i=r.getUnitId(),n=r.getSheetId(),o=this.getFilterModel(i,n);this._activeFilterModel$.next(o)}_initActiveFilterModel(){this.disposeWithMe(pr(gr(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(_r(([t])=>t.type===P.MUTATION&&kt.has(t.id))),this._univerInstanceService.getCurrentTypeOfUnit$(V.UNIVER_SHEET).pipe(ut(t=>{var r;return(r=t?.activeSheet$)!=null?r:he(null)}))).subscribe(()=>this._updateActiveFilterModel()))}_serializeAutoFiltersForUnit(t){const r=this._filterModels.get(t);if(!r)return"{}";const i={};return r.forEach((n,o)=>{i[o]=n.serialize()}),JSON.stringify(i)}_deserializeAutoFiltersForUnit(t,r){const i=this._univerInstanceService.getUniverSheetInstance(t);Object.keys(r).forEach(n=>{const o=r[n],s=tr.deserialize(t,n,i.getSheetBySheetId(n),o);this._cacheFilterModel(t,n,s)})}dispose(){super.dispose(),this._loadedUnitId$.complete(),this._errorMsg$.complete(),this._activeFilterModel$.complete(),this._filterModels.forEach(t=>{t.forEach(r=>r.dispose()),t.clear()}),this._filterModels.clear()}_initModel(){this._resourcesManagerService.registerPluginResource({pluginName:Jr,businesses:[V.UNIVER_SHEET],toJson:t=>this._serializeAutoFiltersForUnit(t),parseJson:t=>JSON.parse(t),onLoad:(t,r)=>{this._deserializeAutoFiltersForUnit(t,r),this._loadedUnitId$.next(t),this._updateActiveFilterModel()},onUnLoad:t=>{const r=this._filterModels.get(t);r&&(r.forEach(i=>i.dispose()),this._filterModels.delete(t))}})}_cacheFilterModel(t,r,i){this._filterModels.has(t)||this._filterModels.set(t,new Map),this._filterModels.get(t).set(r,i)}};M=js([vt(0,_i),vt(1,z),vt(2,A)],M);const N={id:Qr,type:P.MUTATION,handler:(e,t)=>{const{subUnitId:r,unitId:i,range:n}=t;return e.get(M).ensureFilterModel(i,r).setRange(n),!0}},y={id:Vr,type:P.MUTATION,handler:(e,t)=>{const{subUnitId:r,unitId:i,criteria:n,col:o,reCalc:s=!0}=t,l=e.get(M).getFilterModel(i,r);return l?(l.setCriteria(o,n,s),!0):!1}},K={id:zr,type:P.MUTATION,handler:(e,t)=>{const{unitId:r,subUnitId:i}=t;return e.get(M).removeFilterModel(r,i)}},_e={id:Gr,type:P.MUTATION,handler:(e,t)=>{const{unitId:r,subUnitId:i}=t,n=e.get(M).getFilterModel(r,i);return n?(n.reCalc(),!0):!1}},Pt={id:"sheet.command.set-filter-range",type:P.COMMAND,handler:(e,t)=>{const r=e.get(M),i=e.get(A),n=e.get(nt),o=e.get(z),{unitId:s,subUnitId:l,range:a}=t;if(!Fe(o,t)||r.getFilterModel(s,l))return!1;if(a.endRow===a.startRow){const d=e.get(pi),h=e.get(re);return d.emit(h.t("sheets-filter.command.not-valid-filter-range")),!1}const u={id:N.id,params:{unitId:s,subUnitId:l,range:a}},c=i.syncExecuteCommand(u.id,u.params);return c&&n.pushUndoRedo({unitID:s,undoMutations:[{id:K.id,params:{unitId:s,subUnitId:l}}],redoMutations:[u]}),c}},Ht={id:"sheet.command.remove-sheet-filter",type:P.COMMAND,handler:(e,t)=>{const r=e.get(z),i=e.get(M),n=e.get(A),o=e.get(nt),s=Fe(r,t);if(!s)return!1;const{unitId:l,subUnitId:a}=s,u=i.getFilterModel(l,a);if(!u)return!1;const c=u?.serialize(),d=Ds(l,a,c),h=n.syncExecuteCommand(K.id,{unitId:l,subUnitId:a});return h&&o.pushUndoRedo({unitID:l,undoMutations:d,redoMutations:[{id:K.id,params:{unitId:l,subUnitId:a}}]}),h}},Pe={id:"sheet.command.smart-toggle-filter",type:P.COMMAND,handler:async e=>{const t=e.get(z),r=e.get(M),i=e.get(A),n=t.getCurrentUnitForType(V.UNIVER_SHEET),o=n?.getActiveSheet();if(!o||!n)return!1;const s=n.getUnitId(),l=o.getSheetId();if(r.getFilterModel(s,l))return i.executeCommand(Ht.id,{unitId:s,subUnitId:l});const a=e.get(yr).getCurrentLastSelection();if(!a)return!1;const u=a.range,c=bi(a)?Ge(u,{left:!0,right:!0,up:!0,down:!0},o):u.startRow===u.endRow?Ge(u,{down:!0},o):u;return i.executeCommand(Pt.id,{unitId:s,subUnitId:l,range:c})}},W={id:"sheet.command.set-filter-criteria",type:P.COMMAND,handler:(e,t)=>{const r=e.get(M),i=e.get(A),n=e.get(nt),{unitId:o,subUnitId:s,col:l,criteria:a}=t,u=r.getFilterModel(o,s);if(!u)return!1;const c=u.getRange();if(!c||l<c.startColumn||l>c.endColumn)return!1;const d=u.getFilterColumn(l),h=Qs(o,s,l,d),p={id:y.id,params:{unitId:o,subUnitId:s,col:l,criteria:a}},v=i.syncExecuteCommand(p.id,p.params);return v&&n.pushUndoRedo({unitID:o,undoMutations:[h],redoMutations:[p]}),v}},Ce={id:"sheet.command.clear-filter-criteria",type:P.COMMAND,handler:(e,t)=>{const r=e.get(M),i=e.get(nt),n=e.get(A),o=e.get(z),s=Fe(o,t);if(!s)return!1;const{unitId:l,subUnitId:a}=s,u=r.getFilterModel(s.unitId,s.subUnitId);if(!u)return!1;const c=u.serialize(),d=Kr(l,a,c),h=Ws(l,a,c);return We(h,n).result?(i.pushUndoRedo({unitID:l,undoMutations:d,redoMutations:h}),!0):!1}},Bt={id:"sheet.command.re-calc-filter",type:P.COMMAND,handler:(e,t)=>{const r=e.get(M),i=e.get(A),n=e.get(z),o=Fe(n,t);if(!o)return!1;const{unitId:s,subUnitId:l}=o;return r.getFilterModel(o.unitId,o.subUnitId)?i.executeCommand(_e.id,{unitId:s,subUnitId:l}):!1}};function Ds(e,t,r){const i=[],n={id:N.id,params:{unitId:e,subUnitId:t,range:r.ref}};return i.push(n),Kr(e,t,r).forEach(o=>i.push(o)),i}function Kr(e,t,r){var i;const n=[];return(i=r.filterColumns)==null||i.forEach(o=>{const s={id:y.id,params:{unitId:e,subUnitId:t,col:o.colId,criteria:o}};n.push(s)}),n}function Ws(e,t,r){var i;const n=[];return(i=r.filterColumns)==null||i.forEach(o=>{const s={id:y.id,params:{unitId:e,subUnitId:t,col:o.colId,criteria:null}};n.push(s)}),n}function Qs(e,t,r,i){if(!i)return{id:y.id,params:{unitId:e,subUnitId:t,col:r,criteria:null}};const n=i.serialize();return{id:y.id,params:{unitId:e,subUnitId:t,col:r,criteria:n}}}const ei="sheets-filter.config",ir={};function Vs(e,t){for(let r=0;r<e.length;r++){let i=r;if(e[r])for(let n=r+1;n<e.length;n++)e[i]&&e[n]&&t(e[i],e[n])&&(e[i]=null,i=n)}return e.filter(r=>r!==null)}function fe(e){return Vs(e,(t,r)=>t.id===y.id&&r.id===y.id&&t.params.unitId===r.params.unitId&&t.params.subUnitId===r.params.subUnitId&&t.params.col===r.params.col)}var zs=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},ce=(e,t)=>(r,i)=>t(r,i,e);let xe=class extends G{constructor(e,t,r,i,n,o,s){super(),T(this,"_disposableCollection",new vr),this._commandService=e,this._sheetInterceptorService=t,this._sheetsFilterService=r,this._univerInstanceService=i,this._refRangeService=n,this._dataSyncPrimaryController=o,this._zebraCrossingCacheController=s,this._initCommands(),this._initRowFilteredInterceptor(),this._initInterceptors(),this._commandExecutedListener(),this._initErrorHandling(),this._initZebraCrossingCacheListener()}_initZebraCrossingCacheListener(){this.disposeWithMe(this._sheetsFilterService.activeFilterModel$.subscribe(e=>{e&&this.disposeWithMe(e.filteredOutRows$.subscribe(()=>{this._zebraCrossingCacheController.updateZebraCrossingCache(e.unitId,e.subUnitId)}))}))}_initCommands(){[y,N,_e,K].forEach(e=>{var t;this.disposeWithMe(this._commandService.registerCommand(e)),(t=this._dataSyncPrimaryController)==null||t.registerSyncingMutations(e)})}_initInterceptors(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:e=>this._getUpdateFilter(e)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===wi.id){const t=e.params,r=t.subUnitId,i=t.unitId;if(!r||!i)return;this._registerRefRange(i,r)}if(e.id===N.id){const t=e.params,r=t.subUnitId,i=t.unitId;if(!r||!i)return;this._registerRefRange(t.unitId,t.subUnitId)}})),this.disposeWithMe(this._sheetsFilterService.loadedUnitId$.subscribe(e=>{if(e){const t=this._univerInstanceService.getUniverSheetInstance(e),r=t?.getActiveSheet();r&&this._registerRefRange(e,r.getSheetId())}}))}_registerRefRange(e,t){var r;this._disposableCollection.dispose();const i=this._univerInstanceService.getUniverSheetInstance(e),n=i?.getSheetBySheetId(t);if(!i||!n)return;const o=(r=this._sheetsFilterService.getFilterModel(e,t))==null?void 0:r.getRange(),s=l=>{switch(l.id){case Li.id:{const a=l.params,u=a.unitId||e,c=a.subUnitId||t;return this._handleInsertRowCommand(a,u,c)}case $i.id:{const a=l.params,u=a.unitId||e,c=a.subUnitId||t;return this.handleInsertColCommand(a.range,u,c)}case Ui.id:{const a=l.params;return this.handleRemoveColCommand(a.range,e,t)}case Ai.id:{const a=l.params;return this._handleRemoveRowCommand(a,e,t)}case Gt.MoveColsCommandId:{const a=l.params;return this.handleMoveColsCommand({fromRange:a.fromRange,toRange:a.toRange},e,t)}case Gt.MoveRowsCommandId:{const a=l.params;return this._handleMoveRowsCommand(a,e,t)}case xi.id:{const a=l.params;return this._handleMoveRangeCommand(a,e,t)}}return{redos:[],undos:[]}};o&&this._disposableCollection.add(this._refRangeService.registerRefRange(o,s,e,t))}_getUpdateFilter(e){const{id:t}=e;switch(t){case Ni.id:{const r=e.params;return this._handleRemoveSheetCommand(r,r.unitId,r.subUnitId)}case Ti.id:{const r=e.params,{targetSubUnitId:i,unitId:n,subUnitId:o}=r;return!n||!o||!i?this._handleNull():this._handleCopySheetCommand(n,o,i)}}return{redos:[],undos:[]}}handleInsertColCommand(e,t,r){var i;const n=this._sheetsFilterService.getFilterModel(t,r),o=(i=n?.getRange())!=null?i:null;if(!n||!o)return this._handleNull();const{startColumn:s,endColumn:l}=o,{startColumn:a,endColumn:u}=e,c=u-a+1;if(u>l)return this._handleNull();const d=[],h=[],p=a,v={unitId:t,subUnitId:r,range:{...o,startColumn:a<=s?s+c:s,endColumn:l+c}},C={unitId:t,subUnitId:r,range:o};d.push({id:N.id,params:v}),h.push({id:N.id,params:C});const S=n.getAllFilterColumns().filter(g=>g[0]>=p);if(S.length!==0){const{newRange:g,oldRange:_}=this._moveCriteria(t,r,S,c);d.push(..._.redos,...g.redos),h.push(...g.undos,..._.undos)}return{redos:fe(d),undos:fe(h)}}_handleInsertRowCommand(e,t,r){var i;const n=this._sheetsFilterService.getFilterModel(t,r),o=(i=n?.getRange())!=null?i:null;if(!n||!o)return this._handleNull();const{startRow:s,endRow:l}=o,{startRow:a,endRow:u}=e.range,c=u-a+1;if(u>l)return this._handleNull();const d=[],h=[],p={unitId:t,subUnitId:r,range:{...o,startRow:a<=s?s+c:s,endRow:l+c}},v={unitId:t,subUnitId:r,range:o};return d.push({id:N.id,params:p}),h.push({id:N.id,params:v}),{redos:fe(d),undos:fe(h)}}handleRemoveColCommand(e,t,r){var i;const n=this._sheetsFilterService.getFilterModel(t,r),o=(i=n?.getRange())!=null?i:null;if(!n||!o)return this._handleNull();const{startColumn:s,endColumn:l}=o,{startColumn:a,endColumn:u}=e;if(a>l)return this._handleNull();const c=[],d=[],h=u<s?0:Math.min(u,l)-Math.max(a,s)+1,p=u-a+1,v=n.getAllFilterColumns();v.forEach(g=>{const[_,E]=g;_<=u&&_>=a&&(c.push({id:y.id,params:{unitId:t,subUnitId:r,col:_,criteria:null}}),d.push({id:y.id,params:{unitId:t,subUnitId:r,col:_,criteria:{...E.serialize(),colId:_}}}))});const C=v.filter(g=>{const[_,E]=g;return _>u});let S={undos:[],redos:[]};if(C.length>0){const{oldRange:g,newRange:_}=this._moveCriteria(t,r,C,-p);S=_,c.push(...g.redos),d.unshift(...g.undos)}if(h===l-s+1){const g={unitId:t,subUnitId:r};c.push({id:K.id,params:g}),d.unshift({id:N.id,params:{range:o,unitId:t,subUnitId:r}})}else{const g=s<=a?s:h===0?s-p:a,_=s<=a?l-h:l-p,E={unitId:t,subUnitId:r,range:{...o,startColumn:g,endColumn:_}};c.push({id:N.id,params:E}),d.unshift({id:N.id,params:{range:o,unitId:t,subUnitId:r}}),c.push(...S.redos),d.unshift(...S.undos)}return{undos:d,redos:c}}_handleRemoveRowCommand(e,t,r){var i;const n=this._sheetsFilterService.getFilterModel(t,r);if(!n)return this._handleNull();const o=n.getRange(),{startRow:s,endRow:l}=o,{startRow:a,endRow:u}=e.range;if(a>l)return this._handleNull();if(u<s)return{undos:[{id:N.id,params:{range:o,unitId:t,subUnitId:r}}],redos:[{id:N.id,params:{range:{...o,startRow:s-(u-a+1),endRow:l-(u-a+1)},unitId:t,subUnitId:r}}]};const c=[],d=[],h=n.getAllFilterColumns(),p=s<=u&&s>=a;d.push({id:N.id,params:{range:o,unitId:t,subUnitId:r}});const v=Math.min(u,l)-Math.max(a,s)+1;if(v===l-s+1||p){const C={unitId:t,subUnitId:r};c.push({id:K.id,params:C}),h.forEach(S=>{const[g,_]=S,E={unitId:t,subUnitId:r,col:g,criteria:{..._.serialize(),colId:g}};d.push({id:y.id,params:E})})}else{const C=(i=this._univerInstanceService.getUniverSheetInstance(t))==null?void 0:i.getSheetBySheetId(r);if(!C)return this._handleNull();const S=[];for(let w=a;w<=u;w++)C.getRowFiltered(w)&&S.push(w);const g=Math.min(s,a),_=g+(l-s)-v+S.length,E={unitId:t,subUnitId:r,range:{...o,startRow:g,endRow:_}};c.push({id:N.id,params:E})}return{undos:fe(d),redos:fe(c)}}handleMoveColsCommand({fromRange:e,toRange:t},r,i){var n;const o=this._sheetsFilterService.getFilterModel(r,i),s=(n=o?.getRange())!=null?n:null;if(!o||!s)return this._handleNull();const{startColumn:l,endColumn:a}=s;if(e.endColumn<l&&t.startColumn<=l||e.startColumn>a&&t.endColumn>a)return this._handleNull();const u=[],c=[],d={};for(let g=l;g<=a;g++)d[g]={colIndex:g,filter:o.getFilterColumn(g)};Vt(e.startColumn,e.endColumn-e.startColumn+1,t.startColumn,d);let h=s.startColumn,p=s.endColumn;l>=e.startColumn&&l<=e.endColumn&&t.startColumn>e.startColumn&&e.endColumn<a&&(h=e.endColumn+1),a>=e.startColumn&&a<=e.endColumn&&t.startColumn<e.startColumn&&e.startColumn>l&&(p=e.startColumn-1);const v=Object.keys(d).map(g=>Number(g)),C=v.find(g=>d[g].colIndex===p),S=v.find(g=>d[g].colIndex===h);if(v.forEach(g=>{var _,E;const{colIndex:w,filter:Y}=d[g],L=g;if(Y){if(L>=S&&L<=C){const Z={unitId:r,subUnitId:i,col:L,criteria:{...Y.serialize(),colId:L}},H={unitId:r,subUnitId:i,col:L,criteria:o.getFilterColumn(L)?{...(_=o.getFilterColumn(L))==null?void 0:_.serialize(),colId:L}:null};u.push({id:y.id,params:Z}),c.push({id:y.id,params:H})}if(!((E=d[w])!=null&&E.filter)){const Z={unitId:r,subUnitId:i,col:w,criteria:null};u.push({id:y.id,params:Z}),c.push({id:y.id,params:{unitId:r,subUnitId:i,col:w,criteria:{...Y.serialize(),colId:w}}})}}}),l!==S||a!==C){const g={unitId:r,subUnitId:i,range:{...s,startColumn:S,endColumn:C}};u.unshift({id:N.id,params:g}),c.unshift({id:N.id,params:{range:s,unitId:r,subUnitId:i}})}return{undos:c,redos:u}}_handleMoveRowsCommand(e,t,r){var i;const n=this._sheetsFilterService.getFilterModel(t,r),o=(i=n?.getRange())!=null?i:null;if(!n||!o)return this._handleNull();const{startRow:s,endRow:l}=o,{fromRange:a,toRange:u}=e;if(a.endRow<s&&u.startRow<=s||a.startRow>l&&u.endRow>l)return this._handleNull();const c=[],d=[],h={};for(let _=s;_<=l;_++)h[_]={oldIndex:_};const p=s;let v=l;l>=a.startRow&&l<=a.endRow&&u.startRow<a.startRow&&a.startRow>s&&(v=a.startRow-1),Vt(a.startRow,a.endRow-a.startRow+1,u.startRow,h);const C=Object.keys(h).map(_=>Number(_)),S=C.find(_=>h[_].oldIndex===v),g=C.find(_=>h[_].oldIndex===p);if(s!==g||l!==S){const _={unitId:t,subUnitId:r,range:{...o,startRow:g,endRow:S}};c.push({id:N.id,params:_},{id:_e.id,params:{unitId:t,subUnitId:r}}),d.push({id:N.id,params:{range:o,unitId:t,subUnitId:r}},{id:_e.id,params:{unitId:t,subUnitId:r}})}return{redos:c,undos:d}}_handleMoveRangeCommand(e,t,r){const{fromRange:i,toRange:n}=e,o=this._sheetsFilterService.getFilterModel(t,r);if(!o)return this._handleNull();const s=o.getRange();if(!s)return this._handleNull();const l=[],a=[];if(Et.contains(i,s)){const u=s.startRow-i.startRow,c=s.startColumn-i.startColumn,d={startRow:n.startRow+u,startColumn:n.startColumn+c,endRow:n.startRow+u+(s.endRow-s.startRow),endColumn:n.startColumn+c+(s.endColumn-s.startColumn)},h={id:K.id,params:{unitId:t,subUnitId:r}},p={id:N.id,params:{unitId:t,subUnitId:r,range:d}},v={id:N.id,params:{unitId:t,subUnitId:r,range:s}};l.push(h,p),a.push(h,v);const C=o.getAllFilterColumns(),S=n.startColumn-i.startColumn;C.forEach(g=>{const[_,E]=g;E&&(l.push({id:y.id,params:{unitId:t,subUnitId:r,col:_+S,criteria:{...E.serialize(),colId:_+S}}}),a.push({id:y.id,params:{unitId:t,subUnitId:r,col:_,criteria:{...E.serialize(),colId:_}}}))})}else if(Et.intersects(n,s)){const u={...s,endRow:Math.max(s.endRow,n.endRow)};l.push({id:N.id,params:{unitId:t,subUnitId:r,range:u}}),a.push({id:N.id,params:{unitId:t,subUnitId:r,range:s}})}return{redos:l,undos:a}}_handleRemoveSheetCommand(e,t,r){const i=this._sheetsFilterService.getFilterModel(t,r);if(!i)return this._handleNull();const n=i.getRange();if(!n)return this._handleNull();const o=[],s=[];return i.getAllFilterColumns().forEach(([l,a])=>{s.push({id:y.id,params:{unitId:t,subUnitId:r,col:l,criteria:{...a.serialize(),colId:l}}})}),o.push({id:K.id,params:{unitId:t,subUnitId:r,range:n}}),s.unshift({id:N.id,params:{range:n,unitId:t,subUnitId:r}}),{undos:s,redos:o}}_handleCopySheetCommand(e,t,r){const i=this._sheetsFilterService.getFilterModel(e,t);if(!i)return this._handleNull();const n=i.getRange();if(!n)return this._handleNull();const o=[],s=[],l=[],a=[];return i.getAllFilterColumns().forEach(([u,c])=>{o.push({id:y.id,params:{unitId:e,subUnitId:r,col:u,criteria:{...c.serialize(),colId:u}}}),l.push({id:y.id,params:{unitId:e,subUnitId:r,col:u,criteria:null}})}),l.push({id:K.id,params:{unitId:e,subUnitId:r,range:n}}),o.unshift({id:N.id,params:{range:n,unitId:e,subUnitId:r}}),{undos:s,redos:o,preUndos:l,preRedos:a}}_handleNull(){return{redos:[],undos:[]}}_initRowFilteredInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(Or.ROW_FILTERED,{handler:(e,t)=>{var r,i;return e?!0:(i=(r=this._sheetsFilterService.getFilterModel(t.unitId,t.subUnitId))==null?void 0:r.isRowFiltered(t.row))!=null?i:!1}}))}_moveCriteria(e,t,r,i){const n={unitId:e,subUnitId:t,criteria:null,col:-1},o=[],s=[],l=[],a=[];return r.forEach(u=>{const[c,d]=u;s.push({id:y.id,params:{...n,col:c}}),o.push({id:y.id,params:{...n,col:c,criteria:{...d.serialize(),colId:c}}})}),r.forEach(u=>{const[c,d]=u;a.push({id:y.id,params:{...n,col:c+i,criteria:{...d.serialize(),colId:c+i}}}),l.push({id:y.id,params:{...n,col:c+i,criteria:null}})}),{newRange:{redos:a,undos:l},oldRange:{redos:s,undos:o}}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((e,t)=>{var r,i;const{unitId:n,subUnitId:o}=e.params||{},s=this._sheetsFilterService.getFilterModel(n,o);if(!s)return;const l=Array.from(s.filteredOutRows).sort((c,d)=>c-d),a=[];let u=!1;if(e.id===yi.id){const{startRow:c,endRow:d}=e.params.range,h=l.filter(p=>p>=c&&p<=d);l.forEach(p=>{if(p<c)a.push(p);else if(u=!0,p<=d){const v=Math.max(c,a.length?a[a.length-1]+1:c);a.push(v)}else a.push(p-(d-c+1-h.length))})}if(e.id===Oi.id){const{startRow:c,endRow:d}=e.params.range;l.forEach(h=>{h>=c?(u=!0,a.push(h+(d-c+1))):a.push(h)})}if(u&&(s.filteredOutRows=new Set(a)),e.id===Mr.id&&!(t!=null&&t.onlyLocal)){const c=this._getExtendRegion(n,o);if(c){const d=e.params.cellValue;if(d)for(let h=c.startColumn;h<=c.endColumn;h++){const p=(r=d?.[c.startRow])==null?void 0:r[h];if(p&&this._cellHasValue(p)){const v=(i=this._univerInstanceService.getUnit(n))==null?void 0:i.getSheetBySheetId(o);if(v){const C=Ge(c,{down:!0},v),S=this._sheetsFilterService.getFilterModel(n,o),g=S.getRange();S.setRange({...g,endRow:C.endRow}),this._registerRefRange(n,o)}}}}}}))}_getExtendRegion(e,t){var r;const i=this._sheetsFilterService.getFilterModel(e,t);if(!i)return null;const n=(r=this._univerInstanceService.getUnit(e))==null?void 0:r.getSheetBySheetId(t);if(!n)return null;const o=i.getRange();if(!o)return null;const s=n.getRowCount()-1,l=n.getRowManager();for(let a=o.endRow+1;a<=s;a++)if(l.getRowRawVisible(a))return{startRow:a,endRow:a,startColumn:o.startColumn,endColumn:o.endColumn};return null}_initErrorHandling(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{const t=e.params,r=Fe(this._univerInstanceService,t);if(!r)return;const{subUnitId:i,unitId:n}=r,o=this._sheetsFilterService.getFilterModel(n,i);if(!o)return;const s=o.getRange();if(e.id===Mi.id&&t.fromRange.startRow<=s.startRow&&t.fromRange.endRow<s.endRow&&t.fromRange.endRow>=s.startRow)throw this._sheetsFilterService.setFilterErrorMsg("sheets-filter.msg.filter-header-forbidden"),new Error("[SheetsFilterController]: Cannot move header row of filter")}))}_cellHasValue(e){const t=Object.values(e);return!(t.length===0||t.every(r=>r==null))}};xe=zs([ce(0,A),ce(1,b(xr)),ce(2,b(M)),ce(3,z),ce(4,b(Ar)),ce(5,Sr(Ji)),ce(6,b(ki))],xe);var Gs=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},Ct=(e,t)=>(r,i)=>t(r,i,e);const Ys=[y.id,_e.id],Zs=[wr.id,Tr.id,Nr.id];let Ae=class extends G{constructor(e,t,r){var i;super(),T(this,"_d",new vr),T(this,"_visible$",new k(!1)),T(this,"visible$",this._visible$.asObservable()),T(this,"_enabled$",new k(!0)),T(this,"enabled$",this._enabled$.asObservable()),this._sheetsFilterController=e,this._commandService=t,this._configService=r;const n=this._configService.getConfig(ei);n!=null&&n.enableSyncSwitch&&(this._visible$.next(!0),typeof n.enableSyncSwitch=="object"&&this.setEnabled((i=n.enableSyncSwitch.defaultValue)!=null?i:!0))}get visible(){return this._visible$.getValue()}get enabled(){return this._enabled$.getValue()}setEnabled(e){this._enabled$.next(e),e?this._d.dispose():this._initOnlyLocalListener()}_initOnlyLocalListener(){this._d.add(this._commandService.beforeCommandExecuted((e,t)=>{Ys.includes(e.id)&&(t||(t={}),t.onlyLocal=!0)})),this._d.add(this._commandService.onCommandExecuted((e,t)=>{if(Zs.includes(e.id)&&t!=null&&t.fromCollab){if(e.id===wr.id){const{range:r,unitId:i,subUnitId:n}=e.params,{redos:o}=this._sheetsFilterController.handleInsertColCommand(r,i,n);We(o,this._commandService,t)}else if(e.id===Tr.id){const{range:r,unitId:i,subUnitId:n}=e.params,{redos:o}=this._sheetsFilterController.handleRemoveColCommand(r,i,n);We(o,this._commandService,t)}else if(e.id===Nr.id){const{sourceRange:r,targetRange:i,unitId:n,subUnitId:o}=e.params,{redos:s}=this._sheetsFilterController.handleMoveColsCommand({fromRange:r,toRange:i},n,o);We(s,this._commandService,t)}}}))}};Ae=Gs([Ct(0,b(xe)),Ct(1,A),Ct(2,lt)],Ae);var qs=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},Be=(e,t)=>(r,i)=>t(r,i,e);let Ze=class extends G{constructor(e,t,r,i){super(),this._activeDirtyManagerService=e,this._sheetRowFilteredService=t,this._sheetsFilterService=r,this._univerInstanceService=i,this._initFormulaDirtyRange(),this._registerSheetRowFiltered()}_initFormulaDirtyRange(){kt.forEach(e=>{this._activeDirtyManagerService.register(e,{commandId:e,getDirtyData:t=>{const r=t.params,{unitId:i,subUnitId:n}=r;return{dirtyRanges:this._getHideRowMutation(i,n),clearDependencyTreeCache:{[i]:{[n]:"1"}}}}})})}_getHideRowMutation(e,t){var r,i;const n=(r=this._sheetsFilterService.getFilterModel(e,t))==null?void 0:r.getRange(),o=(i=this._univerInstanceService.getUnit(e))==null?void 0:i.getSheetBySheetId(t);if(n==null||o==null)return[];const{startRow:s,endRow:l}=n;return[{unitId:e,sheetId:t,range:{startRow:s,startColumn:0,endRow:l,endColumn:o.getColumnCount()-1}}]}_registerSheetRowFiltered(){this._sheetRowFilteredService.register((e,t,r)=>{var i,n;return(n=(i=this._sheetsFilterService.getFilterModel(e,t))==null?void 0:i.isRowFiltered(r))!=null?n:!1})}};Ze=qs([Be(0,b(Ki)),Be(1,b(es)),Be(2,b(M)),Be(3,z)],Ze);var Xs=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},sr=(e,t)=>(r,i)=>t(r,i,e),je;let Ue=(je=class extends ot{constructor(e=ir,t,r){super(),this._config=e,this._injector=t,this._configService=r;const{...i}=Mt({},ir,this._config);this._configService.setConfig(ei,i)}onStarting(){[[Ze],[M],[xe],[Ae]].forEach(e=>this._injector.add(e))}onReady(){Rt(this._injector,[[Ze],[xe],[Ae]])}},T(je,"type",V.UNIVER_SHEET),T(je,"pluginName",Jr),je);Ue=Xs([sr(1,b(ie)),sr(2,lt)],Ue);var Js=Object.defineProperty,Ks=(e,t,r)=>t in e?Js(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,F=(e,t,r)=>Ks(e,typeof t!="symbol"?t+"":t,r),$=(e=>(e[e.FIRST=0]="FIRST",e[e.SECOND=1]="SECOND",e))($||{}),R=(e=>(e.NONE="none",e.STARTS_WITH="startsWith",e.DOES_NOT_START_WITH="doesNotStartWith",e.ENDS_WITH="endsWith",e.DOES_NOT_END_WITH="doesNotEndWith",e.CONTAINS="contains",e.DOES_NOT_CONTAIN="doesNotContain",e.EQUALS="equals",e.NOT_EQUALS="notEquals",e.EMPTY="empty",e.NOT_EMPTY="notEmpty",e.BETWEEN="between",e.NOT_BETWEEN="notBetween",e.CUSTOM="custom",e))(R||{}),I;(e=>{e.NONE={label:"sheets-filter.conditions.none",operator:R.NONE,order:$.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.NONE]: should not have initial form params!")},testMappingParams:s=>s.operator1===R.NONE,mapToFilterColumn:()=>null,testMappingFilterColumn:s=>!s.customFilters&&!s.filters?{}:!1},e.EMPTY={label:"sheets-filter.conditions.empty",operator:R.EMPTY,order:$.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.EMPTY]: should not have initial form params!")},testMappingParams:({operator1:s})=>s===R.EMPTY,mapToFilterColumn:()=>({customFilters:{customFilters:[{val:""}]}}),testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.val===""&&a.operator===void 0?{operator1:R.EMPTY}:!1}},e.NOT_EMPTY={label:"sheets-filter.conditions.not-empty",operator:R.NOT_EMPTY,order:$.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.NOT_EMPTY]: should not have initial form params!")},testMappingParams:({operator1:s})=>s===R.NOT_EMPTY,mapToFilterColumn:()=>({customFilters:{customFilters:[{val:"",operator:m.NOT_EQUALS}]}}),testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.val===" "&&a.operator===m.NOT_EQUALS?{operator1:R.NOT_EMPTY}:!1}},e.TEXT_CONTAINS={label:"sheets-filter.conditions.text-contains",operator:R.CONTAINS,order:$.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:R.CONTAINS,val1:""}),testMappingParams:s=>{const[l]=q(s);return l===R.CONTAINS},mapToFilterColumn:s=>{const{val1:l}=s;return l===""?null:{customFilters:{customFilters:[{val:`*${l}*`}]}}},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0],u=a.val.toString();return!a.operator&&u.startsWith("*")&&u.endsWith("*")?{operator1:R.CONTAINS,val1:u.slice(1,-1)}:!1}},e.DOES_NOT_CONTAIN={label:"sheets-filter.conditions.does-not-contain",operator:R.DOES_NOT_CONTAIN,order:$.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:R.DOES_NOT_CONTAIN,val1:""}),mapToFilterColumn:s=>({customFilters:{customFilters:[{val:`*${s.val1}*`,operator:m.NOT_EQUALS}]}}),testMappingParams:s=>{const[l]=q(s);return l===R.DOES_NOT_CONTAIN},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0],u=a.val.toString();return a.operator===m.NOT_EQUALS&&u.startsWith("*")&&u.endsWith("*")?{operator1:R.DOES_NOT_CONTAIN,val1:u.slice(1,-1)}:!1}},e.STARTS_WITH={label:"sheets-filter.conditions.starts-with",operator:R.STARTS_WITH,order:$.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:R.STARTS_WITH,val1:""}),mapToFilterColumn:s=>({customFilters:{customFilters:[{val:`${s.val1}*`}]}}),testMappingParams:s=>{const[l]=q(s);return l===R.STARTS_WITH},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0],u=a.val.toString();return!a.operator&&u.endsWith("*")&&!u.startsWith("*")?{operator1:R.STARTS_WITH,val1:u.slice(0,-1)}:!1}},e.ENDS_WITH={label:"sheets-filter.conditions.ends-with",operator:R.ENDS_WITH,order:$.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:R.ENDS_WITH,val1:""}),mapToFilterColumn:s=>({customFilters:{customFilters:[{val:`*${s.val1}`}]}}),testMappingParams:s=>{const[l]=q(s);return l===R.ENDS_WITH},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0],u=a.val.toString();return!a.operator&&u.startsWith("*")&&!u.endsWith("*")?{operator1:R.ENDS_WITH,val1:u.slice(1)}:!1}},e.EQUALS={label:"sheets-filter.conditions.equals",operator:R.EQUALS,order:$.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:R.EQUALS,val1:""}),testMappingParams:s=>{const[l]=q(s);return l===R.EQUALS},mapToFilterColumn:s=>{const{val1:l}=s;return l===""?null:{customFilters:{customFilters:[{val:l}]}}},testMappingFilterColumn:s=>{var l,a,u;return((a=(l=s.filters)==null?void 0:l.filters)==null?void 0:a.length)===1?{operator1:R.EQUALS,val1:""}:((u=s.customFilters)==null?void 0:u.customFilters.length)===1&&!s.customFilters.customFilters[0].operator?{operator1:R.EQUALS,val1:s.customFilters.customFilters[0].val.toString()}:!1}},e.GREATER_THAN={label:"sheets-filter.conditions.greater-than",operator:m.GREATER_THAN,numOfParameters:1,order:$.FIRST,getDefaultFormParams:()=>({operator1:m.GREATER_THAN,val1:""}),mapToFilterColumn:s=>({customFilters:{customFilters:[{val:s.val1,operator:m.GREATER_THAN}]}}),testMappingParams:s=>{const[l]=q(s);return l===m.GREATER_THAN},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.operator!==m.GREATER_THAN?!1:{operator1:m.GREATER_THAN,val1:a.val.toString()}}},e.GREATER_THAN_OR_EQUAL={label:"sheets-filter.conditions.greater-than-or-equal",operator:m.GREATER_THAN_OR_EQUAL,numOfParameters:1,order:$.FIRST,getDefaultFormParams:()=>({operator1:m.GREATER_THAN_OR_EQUAL,val1:""}),testMappingParams:s=>{const[l]=q(s);return l===m.GREATER_THAN_OR_EQUAL},mapToFilterColumn:s=>({customFilters:{customFilters:[{val:s.val1,operator:m.GREATER_THAN_OR_EQUAL}]}}),testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.operator!==m.GREATER_THAN_OR_EQUAL?!1:{operator1:m.GREATER_THAN_OR_EQUAL,val1:a.val.toString()}}},e.LESS_THAN={label:"sheets-filter.conditions.less-than",operator:m.LESS_THAN,numOfParameters:1,order:$.FIRST,getDefaultFormParams:()=>({operator1:m.LESS_THAN,val1:""}),testMappingParams:s=>{const[l]=q(s);return l===m.LESS_THAN},mapToFilterColumn:s=>({customFilters:{customFilters:[{val:s.val1,operator:m.LESS_THAN}]}}),testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.operator!==m.LESS_THAN?!1:{operator1:m.LESS_THAN,val1:a.val.toString()}}},e.LESS_THAN_OR_EQUAL={label:"sheets-filter.conditions.less-than-or-equal",operator:m.LESS_THAN_OR_EQUAL,numOfParameters:1,order:$.FIRST,getDefaultFormParams:()=>({operator1:m.LESS_THAN_OR_EQUAL,val1:""}),testMappingParams:s=>{const[l]=q(s);return l===m.LESS_THAN_OR_EQUAL},mapToFilterColumn:s=>({customFilters:{customFilters:[{val:s.val1,operator:m.LESS_THAN_OR_EQUAL}]}}),testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.operator!==m.LESS_THAN_OR_EQUAL?!1:{operator1:m.LESS_THAN_OR_EQUAL,val1:a.val.toString()}}},e.EQUAL={label:"sheets-filter.conditions.equal",operator:m.EQUAL,numOfParameters:1,order:$.FIRST,getDefaultFormParams:()=>({operator1:m.EQUAL,val1:""}),testMappingParams:s=>{const[l]=q(s);return l===m.EQUAL},mapToFilterColumn:s=>({customFilters:{customFilters:[{val:s.val1,operator:m.EQUAL}]}}),testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.operator!==m.EQUAL?!1:{operator1:m.EQUAL,val1:a.val.toString()}}},e.NOT_EQUAL={label:"sheets-filter.conditions.not-equal",operator:m.NOT_EQUALS,numOfParameters:1,order:$.FIRST,getDefaultFormParams:()=>({operator1:m.NOT_EQUALS,val1:""}),testMappingParams:s=>{const[l]=q(s);return l===m.NOT_EQUALS},mapToFilterColumn:s=>({customFilters:{customFilters:[{val:s.val1,operator:m.NOT_EQUALS}]}}),testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=s.customFilters.customFilters[0];return a.operator!==m.NOT_EQUALS?!1:{operator1:m.NOT_EQUALS,val1:a.val.toString()}}},e.BETWEEN={label:"sheets-filter.conditions.between",operator:R.BETWEEN,order:$.SECOND,numOfParameters:2,getDefaultFormParams:()=>({and:!0,operator1:m.GREATER_THAN_OR_EQUAL,val1:"",operator2:m.LESS_THAN_OR_EQUAL,val2:""}),testMappingParams:s=>{const{and:l,operator1:a,operator2:u}=s;if(!l)return!1;const c=[a,u];return c.includes(m.GREATER_THAN_OR_EQUAL)&&c.includes(m.LESS_THAN_OR_EQUAL)},mapToFilterColumn:s=>{const{val1:l,val2:a,operator1:u}=s,c=u===m.GREATER_THAN_OR_EQUAL;return{customFilters:{and:zt.TRUE,customFilters:[{val:c?l:a,operator:m.GREATER_THAN_OR_EQUAL},{val:c?a:l,operator:m.LESS_THAN_OR_EQUAL}]}}},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==2)return!1;const[a,u]=s.customFilters.customFilters;return a.operator===m.GREATER_THAN_OR_EQUAL&&u.operator===m.LESS_THAN_OR_EQUAL&&s.customFilters.and?{and:!0,operator1:m.GREATER_THAN_OR_EQUAL,val1:a.val.toString(),operator2:m.LESS_THAN_OR_EQUAL,val2:u.val.toString()}:u.operator===m.GREATER_THAN_OR_EQUAL&&a.operator===m.LESS_THAN_OR_EQUAL&&s.customFilters.and?{and:!0,operator1:m.GREATER_THAN_OR_EQUAL,val1:u.val.toString(),operator2:m.LESS_THAN_OR_EQUAL,val2:a.val.toLocaleString()}:!1}},e.NOT_BETWEEN={label:"sheets-filter.conditions.not-between",operator:R.NOT_BETWEEN,order:$.SECOND,numOfParameters:2,getDefaultFormParams:()=>({operator1:m.LESS_THAN,val1:"",operator2:m.GREATER_THAN,val2:""}),testMappingParams:s=>{const{and:l,operator1:a,operator2:u}=s;if(l)return!1;const c=[a,u];return c.includes(m.GREATER_THAN)&&c.includes(m.LESS_THAN)},mapToFilterColumn:s=>{const{val1:l,val2:a,operator1:u}=s,c=u===m.GREATER_THAN;return{customFilters:{customFilters:[{val:c?l:a,operator:m.GREATER_THAN},{val:c?a:l,operator:m.LESS_THAN}]}}},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==2)return!1;const[a,u]=s.customFilters.customFilters;return a.operator===m.LESS_THAN&&u.operator===m.GREATER_THAN&&!s.customFilters.and?{operator1:m.LESS_THAN,val1:a.val.toString(),operator2:m.GREATER_THAN,val2:u.val.toString()}:u.operator===m.LESS_THAN&&a.operator===m.GREATER_THAN&&!s.customFilters.and?{operator1:m.GREATER_THAN,val1:u.val.toString(),operator2:m.LESS_THAN,val2:a.val.toLocaleString()}:!1}},e.CUSTOM={label:"sheets-filter.conditions.custom",operator:R.CUSTOM,order:$.SECOND,numOfParameters:2,getDefaultFormParams:()=>({operator1:R.NONE,val1:"",operator2:R.NONE,val2:""}),testMappingParams:()=>!0,mapToFilterColumn:s=>{const{and:l,val1:a,val2:u,operator1:c,operator2:d}=s;function h(_,E){for(const w of e.ALL_CONDITIONS)if(w.operator===_)return w.mapToFilterColumn({val1:E,operator1:_})}const p=!c||c===e.NONE.operator,v=!d||d===e.NONE.operator;if(p&&v)return e.NONE.mapToFilterColumn({});if(p)return h(d,u);if(v)return h(c,a);const C=h(c,a),S=h(d,u),g={customFilters:[C.customFilters.customFilters[0],S.customFilters.customFilters[0]]};return l&&(g.and=zt.TRUE),{customFilters:g}},testMappingFilterColumn:s=>{var l;if(((l=s.customFilters)==null?void 0:l.customFilters.length)!==2)return!1;const a=s.customFilters.customFilters.map(c=>o({customFilters:{customFilters:[c]}})),u={operator1:a[0][0].operator,val1:a[0][1].val1,operator2:a[1][0].operator,val2:a[1][1].val1};return s.customFilters.and&&(u.and=!0),u}},e.ALL_CONDITIONS=[e.NONE,e.EMPTY,e.NOT_EMPTY,e.TEXT_CONTAINS,e.DOES_NOT_CONTAIN,e.STARTS_WITH,e.ENDS_WITH,e.EQUALS,e.GREATER_THAN,e.GREATER_THAN_OR_EQUAL,e.LESS_THAN,e.LESS_THAN_OR_EQUAL,e.EQUAL,e.NOT_EQUAL,e.BETWEEN,e.NOT_BETWEEN,e.CUSTOM];function t(s){const l=e.ALL_CONDITIONS.find(a=>a.operator===s);if(!l)throw new Error(`[SheetsFilter]: no condition item found for operator: ${s}`);return l}e.getItemByOperator=t;function r(s,l){for(const a of e.ALL_CONDITIONS.filter(u=>u.numOfParameters===l))if(a.numOfParameters!==0&&a.testMappingParams(s))return a;for(const a of e.ALL_CONDITIONS)if(a.testMappingParams(s))return a;throw new Error("[SheetsFilter]: no condition item can be mapped from the filter map params!")}e.testMappingParams=r;function i(s){const l=e.ALL_CONDITIONS.find(a=>a.operator===s);return l?.numOfParameters===0?{operator1:l.operator}:l.getDefaultFormParams()}e.getInitialFormParams=i;function n(s,l){return s.mapToFilterColumn(l)}e.mapToFilterColumn=n;function o(s){if(!s)return[e.NONE,{}];for(const l of e.ALL_CONDITIONS){const a=l.testMappingFilterColumn(s);if(a)return[l,a]}return[e.NONE,{}]}e.testMappingFilterColumn=o})(I||(I={}));function q(e){const{operator1:t,operator2:r,val1:i,val2:n}=e;if(t&&r)throw new Error("Both operator1 and operator2 are set!");if(!t&&!r)throw new Error("Neither operator1 and operator2 and both not set!");return t?[t,i]:[r,n]}function wt(e){const t=[],r=[];let i=0,n=0;function o(s){s.leaf&&(s.checked?(t.push(s),i+=s.count):(r.push(s),n+=s.count)),s.children&&s.children.forEach(o)}return e.forEach(o),{checkedItems:t,uncheckedItems:r,checked:i,unchecked:n}}var en=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},St=(e,t)=>(r,i)=>t(r,i,e);const jt="sheets-filter.generate-filter-values.service",qe=Er(jt);let Tt=class extends G{constructor(e,t,r){super(),this._localeService=e,this._univerInstanceService=t,this._logService=r}async getFilterValues(e){var t;const{unitId:r,subUnitId:i,filteredOutRowsByOtherColumns:n,filterColumn:o,filters:s,blankChecked:l,iterateRange:a,alreadyChecked:u}=e,c=this._univerInstanceService.getUnit(r),d=(t=this._univerInstanceService.getUnit(r))==null?void 0:t.getSheetBySheetId(i);return!c||!d?[]:(this._logService.debug("[SheetsGenerateFilterValuesService]","getFilterValues for",{unitId:r,subUnitId:i}),ti(s,this._localeService,a,d,new Set(n),o,new Set(u.map(String)),l,c.getStyles()))}};Tt=en([St(0,b(re)),St(1,z),St(2,Ri)],Tt);function ti(e,t,r,i,n,o,s,l,a){var u,c,d,h,p,v,C,S,g,_;const E=new Map,w=new Map,Y="yyyy-mm-dd",L="empty",Z=!e&&(o?.filterBy===x.COLORS||o?.filterBy===x.CONDITIONS)&&((u=o.filteredOutRows)==null?void 0:u.size);let H=0;for(const j of i.iterateByColumn(r,!1,!1)){const{row:dt,rowSpan:Dt=1}=j;let me=0;for(;me<Dt;){const fi=dt+me;if(n.has(fi)){me++;continue}const ae=j!=null&&j.value?fr(j.value):"";if(!ae){H+=1,me+=Dt;continue}const He=(c=j.value)!=null&&c.v&&!j.value.p?(p=(h=a.get((d=j.value)==null?void 0:d.s))==null?void 0:h.n)==null?void 0:p.pattern:"",Wt=He&&pt.getFormatInfo(He).isDate;let Qt=!1;if(Wt){const{year:X,month:se,day:U}=pt.getFormatDateInfo(He);Qt=X||se||U}if(He&&Wt&&Qt){const X=(v=i.getCellRaw(j.row,j.col))==null?void 0:v.v;if(!X){me++;continue}const se=pt.format(Y,Number(X)),[U,J,be]=se.split("-").map(Number);let ue=E.get(`${U}`);ue||(ue={title:`${U}`,key:`${U}`,children:[],count:0,leaf:!1,checked:!1},E.set(`${U}`,ue),w.set(`${U}`,[`${U}`]));let ne=(C=ue.children)==null?void 0:C.find(mt=>mt.key===`${U}-${J}`);ne||(ne={title:t.t(`sheets-filter.date.${J}`),key:`${U}-${J}`,children:[],count:0,leaf:!1,checked:!1},(S=ue.children)==null||S.push(ne),w.set(`${U}-${J}`,[`${U}`,`${U}-${J}`]));const ht=(g=ne?.children)==null?void 0:g.find(mt=>mt.key===`${U}-${J}-${be}`);ht?(ht.originValues.add(ae),ht.count++,ne.count++,ue.count++):((_=ne.children)==null||_.push({title:`${be}`,key:`${U}-${J}-${be}`,count:1,originValues:new Set([ae]),leaf:!0,checked:Z?!1:s.size?s.has(ae):!l}),ne.count++,ue.count++,w.set(`${U}-${J}-${be}`,[`${U}`,`${U}-${J}`,`${U}-${J}-${be}`]))}else{const X=ae;let se=E.get(X);se?se.count++:(se={title:ae,leaf:!0,checked:Z?!1:s.size?s.has(ae):!l,key:X,count:1},E.set(X,se),w.set(X,[X]))}me++}}const B=Z?!1:e?l:!0;if(H>0){const j={title:t.t("sheets-filter.panel.empty"),count:H,leaf:!0,checked:B,key:L};E.set("empty",j),w.set("empty",[L])}return{filterTreeItems:tn(Array.from(E.values())),filterTreeMapCache:w}}function tn(e){return Array.from(e).sort((t,r)=>t.children&&!r.children?-1:!t.children&&r.children?1:rn(t.title,r.title)).map(t=>(t.children&&t.children.sort((r,i)=>{const n=Number.parseInt(r.key.split("-")[1],10),o=Number.parseInt(i.key.split("-")[1],10);return n-o}).forEach(r=>{r.children&&r.children.sort((i,n)=>{const o=Number.parseInt(i.key.split("-")[2],10),s=Number.parseInt(n.key.split("-")[2],10);return o-s})}),t))}const nr=e=>!Number.isNaN(Number(e))&&!Number.isNaN(Number.parseFloat(e));function rn(e,t){const r=nr(e),i=nr(t);return r&&i?Number.parseFloat(e)-Number.parseFloat(t):r&&!i?-1:!r&&i?1:e.localeCompare(t)}function Nt(e,t){for(const r of e){if(r.key===t)return r;if(r.children){const i=Nt(r.children,t);if(i)return i}}return null}function ri(e){return e.leaf?e.checked:e.children?e.children.every(t=>ri(t)):!0}function ye(e,t){e.leaf&&(t!==void 0?e.checked=t:e.checked=!e.checked),e.children&&e.children.forEach(r=>ye(r,t))}function ii(e,t){const r=[];return e.forEach(i=>{const n=i.originValues?t.some(s=>Array.from(i.originValues).some(l=>l.toLowerCase().includes(s.toLowerCase()))):!1,o=!n&&t.some(s=>i.title.toLowerCase().includes(s.toLowerCase()));if(n||o)r.push({...i});else if(i.children){const s=ii(i.children,t);if(s.length>0){const l=s.reduce((a,u)=>a+u.count,0);r.push({...i,count:l,children:s})}}}),r}var ct=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},$e=(e,t)=>(r,i)=>t(r,i,e);Er("sheets-filter-ui.sheets-filter-panel.service");let le=class extends G{constructor(e,t){super(),F(this,"_filterBy$",new k(x.VALUES)),F(this,"filterBy$",this._filterBy$.asObservable()),F(this,"_filterByModel$",new Ci(1)),F(this,"filterByModel$",this._filterByModel$.asObservable()),F(this,"_filterByModel",null),F(this,"_hasCriteria$",new k(!1)),F(this,"hasCriteria$",this._hasCriteria$.asObservable()),F(this,"_filterModel",null),F(this,"_col$",new k(-1)),F(this,"col$",this._col$.asObservable()),F(this,"_filterHeaderListener",null),this._injector=e,this._refRangeService=t}get filterBy(){return this._filterBy$.getValue()}get filterByModel(){return this._filterByModel}set filterByModel(e){this._filterByModel=e,this._filterByModel$.next(e)}get filterModel(){return this._filterModel}get col(){return this._col$.getValue()}dispose(){this._filterBy$.complete(),this._filterByModel$.complete(),this._hasCriteria$.complete()}setupCol(e,t){this.terminate(),this._filterModel=e,this._col$.next(t);const r=e.getFilterColumn(t);if(r){const i=r.getColumnData();if(i.customFilters){this._hasCriteria$.next(!0),this._setupByConditions(e,t);return}if(i.colorFilters){this._hasCriteria$.next(!0),this._setupByColors(e,t);return}if(i.filters){this._hasCriteria$.next(!0),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t)}changeFilterBy(e){if(!this._filterModel||this.col===-1)return!1;switch(e){case x.VALUES:this._setupByValues(this._filterModel,this.col);break;case x.COLORS:this._setupByColors(this._filterModel,this.col);break;case x.CONDITIONS:this._setupByConditions(this._filterModel,this.col);break}return!0}terminate(){return this._filterModel=null,this._col$.next(-1),this._disposeFilterHeaderChangeListener(),!0}_disposeFilterHeaderChangeListener(){var e;(e=this._filterHeaderListener)==null||e.dispose(),this._filterHeaderListener=null}_listenToFilterHeaderChange(e,t){this._disposeFilterHeaderChangeListener();const r=e.unitId,i=e.subUnitId,n=e.getRange(),o={startColumn:t,startRow:n.startRow,endRow:n.startRow,endColumn:t};this._filterHeaderListener=this._refRangeService.watchRange(r,i,o,(s,l)=>{if(!l)this.terminate();else{const a=l.startColumn-s.startColumn;a!==0&&this._filterByModel.deltaCol(a)}})}async _setupByValues(e,t){this._disposePreviousModel();const r=e.getRange();if(r.startRow===r.endRow)return!1;const i=await Je.fromFilterColumn(this._injector,e,t);return this.filterByModel=i,this._filterBy$.next(x.VALUES),this._listenToFilterHeaderChange(e,t),!0}async _setupByColors(e,t){this._disposePreviousModel();const r=e.getRange();if(r.startRow===r.endRow)return!1;const i=await Ke.fromFilterColumn(this._injector,e,t);return this.filterByModel=i,this._filterBy$.next(x.COLORS),this._listenToFilterHeaderChange(e,t),!0}_setupByConditions(e,t){this._disposePreviousModel();const r=e.getRange();if(r.startRow===r.endRow)return!1;const i=Xe.fromFilterColumn(this._injector,e,t,e.getFilterColumn(t));return this.filterByModel=i,this._filterBy$.next(x.CONDITIONS),this._listenToFilterHeaderChange(e,t),!0}_disposePreviousModel(){var e;(e=this._filterByModel)==null||e.dispose(),this.filterByModel=null}};le=ct([$e(0,b(ie)),$e(1,b(Ar))],le);let Xe=class extends G{constructor(e,t,r,i,n){super(),F(this,"canApply$",he(!0)),F(this,"_conditionItem$"),F(this,"conditionItem$"),F(this,"_filterConditionFormParams$"),F(this,"filterConditionFormParams$"),this._filterModel=e,this.col=t,this._commandService=n,this._conditionItem$=new k(r),this.conditionItem$=this._conditionItem$.asObservable(),this._filterConditionFormParams$=new k(i),this.filterConditionFormParams$=this._filterConditionFormParams$.asObservable()}static fromFilterColumn(e,t,r,i){const[n,o]=I.testMappingFilterColumn(i?.getColumnData());return e.createInstance(Xe,t,r,n,o)}get conditionItem(){return this._conditionItem$.getValue()}get filterConditionFormParams(){return this._filterConditionFormParams$.getValue()}dispose(){super.dispose(),this._conditionItem$.complete(),this._filterConditionFormParams$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;const e=I.mapToFilterColumn(this.conditionItem,this.filterConditionFormParams);return this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:e})}onPrimaryConditionChange(e){const t=I.ALL_CONDITIONS.find(r=>r.operator===e);if(!t)throw new Error(`[ByConditionsModel]: condition item not found for operator: ${e}!`);this._conditionItem$.next(t),this._filterConditionFormParams$.next(I.getInitialFormParams(e))}onConditionFormChange(e){const t={...this.filterConditionFormParams,...e};if(t.and!==!0&&delete t.and,typeof e.and<"u"||typeof e.operator1<"u"||typeof e.operator2<"u"){const r=I.testMappingParams(t,this.conditionItem.numOfParameters);this._conditionItem$.next(r)}this._filterConditionFormParams$.next(t)}};Xe=ct([$e(4,A)],Xe);let Je=class extends G{constructor(e,t,r,i,n){super(),F(this,"_rawFilterItems$"),F(this,"rawFilterItems$"),F(this,"filterItems$"),F(this,"_filterItems",[]),F(this,"_treeMapCache"),F(this,"canApply$"),F(this,"_manuallyUpdateFilterItems$"),F(this,"_searchString$"),F(this,"searchString$"),this._filterModel=e,this.col=t,this._commandService=n,this._treeMapCache=i,this._searchString$=new k(""),this.searchString$=this._searchString$.asObservable(),this._rawFilterItems$=new k(r),this.rawFilterItems$=this._rawFilterItems$.asObservable(),this._manuallyUpdateFilterItems$=new Ii,this.filterItems$=pr(Fi([this._searchString$.pipe(Hr(500,void 0,{leading:!0,trailing:!0}),Lr(void 0)),this._rawFilterItems$]).pipe(ve(([o,s])=>{if(!o)return s;const l=o.toLowerCase().split(/\s+/).filter(a=>!!a);return ii(s,l)})),this._manuallyUpdateFilterItems$).pipe(_s(1)),this.canApply$=this.filterItems$.pipe(ve(o=>wt(o).checked>0)),this.disposeWithMe(this.filterItems$.subscribe(o=>this._filterItems=o))}static async fromFilterColumn(e,t,r){const i=e.get(z),n=e.get(re),o=e.get(qe,Ir.OPTIONAL),{unitId:s,subUnitId:l}=t,a=i.getUniverSheetInstance(s);if(!a)throw new Error(`[ByValuesModel]: Workbook not found for filter model with unitId: ${s}!`);const u=a?.getSheetBySheetId(l);if(!u)throw new Error(`[ByValuesModel]: Worksheet not found for filter model with unitId: ${s} and subUnitId: ${l}!`);const c=t.getRange(),d=r,h=t.getFilterColumn(r),p=h?.getColumnData().filters,v=new Set(p?.filters),C=!!(p&&p.blank),S=t.getFilteredOutRowsExceptCol(r),g={...c,startRow:c.startRow+1,startColumn:d,endColumn:d};let _,E;if(o){const w=await o.getFilterValues({unitId:s,subUnitId:l,filteredOutRowsByOtherColumns:Array.from(S),filterColumn:h,filters:!!p,blankChecked:C,iterateRange:g,alreadyChecked:Array.from(v)});_=w.filterTreeItems,E=w.filterTreeMapCache}else{const w=ti(!!p,n,g,u,S,h,v,C,a.getStyles());_=w.filterTreeItems,E=w.filterTreeMapCache}return e.createInstance(Je,t,r,_,E)}get rawFilterItems(){return this._rawFilterItems$.getValue()}get filterItems(){return this._filterItems}get treeMapCache(){return this._treeMapCache}dispose(){this._rawFilterItems$.complete(),this._searchString$.complete()}deltaCol(e){this.col+=e}setSearchString(e){this._searchString$.next(e)}onCheckAllToggled(e){const t=ge.deepClone(this._filterItems);t.forEach(r=>ye(r,e)),this._manuallyUpdateFilterItems(t)}onFilterCheckToggled(e){const t=ge.deepClone(this._filterItems),r=Nt(t,e.key);if(!r)return;const i=ri(r);ye(r,!i),this._manuallyUpdateFilterItems(t)}onFilterOnly(e){const t=ge.deepClone(this._filterItems);t.forEach(r=>ye(r,!1)),e.forEach(r=>{const i=Nt(t,r);i&&ye(i,!0)}),this._manuallyUpdateFilterItems(t)}_manuallyUpdateFilterItems(e){this._manuallyUpdateFilterItems$.next(e)}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;const e=wt(this._filterItems),{checked:t,checkedItems:r}=e,i=this.rawFilterItems;let n=0;for(const a of i)n+=a.count;const o=t===0,s=e.checked===n,l={colId:this.col};if(o)throw new Error("[ByValuesModel]: no checked items!");if(s)return this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});{l.filters={};const a=r.filter(u=>u.key!=="empty");a.length>0&&(l.filters={filters:a.flatMap(u=>u.originValues?Array.from(u.originValues):[u.title])}),a.length!==r.length&&(l.filters.blank=!0)}return this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:l})}};Je=ct([$e(4,A)],Je);let Ke=class extends G{constructor(e,t,r,i,n){super(),F(this,"canApply$",he(!0)),F(this,"_cellFillColors$"),F(this,"cellFillColors$"),F(this,"_cellTextColors$"),F(this,"cellTextColors$"),this._filterModel=e,this.col=t,this._commandService=n,this._cellFillColors$=new k(Array.from(r.values())),this.cellFillColors$=this._cellFillColors$.asObservable(),this._cellTextColors$=new k(Array.from(i.values())),this.cellTextColors$=this._cellTextColors$.asObservable()}static async fromFilterColumn(e,t,r){var i,n,o;const s=e.get(z),{unitId:l,subUnitId:a}=t,u=s.getUniverSheetInstance(l);if(!u)throw new Error(`[ByColorsModel]: Workbook not found for filter model with unitId: ${l}!`);const c=u?.getSheetBySheetId(a);if(!c)throw new Error(`[ByColorsModel]: Worksheet not found for filter model with unitId: ${l} and subUnitId: ${a}!`);const d=t.getRange(),h=r,p=(i=t.getFilterColumn(r))==null?void 0:i.getColumnData().colorFilters,v=t.getFilteredOutRowsExceptCol(r),C={...d,startRow:d.startRow+1,startColumn:h,endColumn:h},S=new Map,g=new Set((n=p?.cellFillColors)!=null?n:[]),_=new Map,E=new Set((o=p?.cellTextColors)!=null?o:[]);for(const w of c.iterateByColumn(C,!1,!0)){const{row:Y,col:L,value:Z}=w;if(v.has(Y))continue;const H=c.getComposedCellStyleByCellData(Y,L,Z);if(H.bg&&H.bg.rgb){const B=new ze(H.bg.rgb).toRgbString();S.has(B)||S.set(B,{color:B,checked:g.has(B)})}else S.set("default-fill-color",{color:null,checked:g.has(null)});if(H.cl&&H.cl.rgb){const B=new ze(H.cl.rgb).toRgbString();_.has(B)||_.set(B,{color:B,checked:E.has(B)})}else _.set("default-font-color",{color:bt,checked:E.has(bt)})}return e.createInstance(Ke,t,r,S,_)}get cellFillColors(){return this._cellFillColors$.getValue()}get cellTextColors(){return this._cellTextColors$.getValue()}dispose(){super.dispose(),this._cellFillColors$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}onFilterCheckToggled(e,t=!0){const r=t?this.cellFillColors:this.cellTextColors,i=[];let n=!1;for(let o=0;o<r.length;o++){const s=r[o];if(s.color===e.color){n=!0,i.push({color:s.color,checked:!s.checked});continue}i.push({color:s.color,checked:s.checked})}n&&(this._resetColorsCheckedStatus(!t),t?this._cellFillColors$.next([...i]):this._cellTextColors$.next([...i]))}_resetColorsCheckedStatus(e=!0){const t=e?this.cellFillColors:this.cellTextColors,r=[];for(let i=0;i<t.length;i++)r.push({color:t[i].color,checked:!1});e?this._cellFillColors$.next([...r]):this._cellTextColors$.next([...r])}async apply(){if(this._disposed)return!1;const e=this.cellFillColors.filter(i=>i.checked).map(i=>i.color),t=this.cellTextColors.filter(i=>i.checked).map(i=>i.color);if(e.length===0&&t.length===0)return this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});const r={colId:this.col};return e.length>0?r.colorFilters={cellFillColors:e}:t.length>0&&(r.colorFilters={cellTextColors:t}),this._commandService.executeCommand(W.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:r})}};Ke=ct([$e(4,A)],Ke);const Se="FILTER_PANEL_OPENED",et={id:"sheet.operation.open-filter-panel",type:P.OPERATION,handler:(e,t)=>{const r=e.get(at),i=e.get(M),n=e.get(le),o=e.get(A),s=e.has(Yt)?e.get(Yt):null;s!=null&&s.isVisible().visible&&o.syncExecuteCommand(Pi.id,{visible:!1});const{unitId:l,subUnitId:a,col:u}=t,c=i.getFilterModel(l,a);return c?(n.setupCol(c,u),r.getContextValue(Se)||r.setContextValue(Se,!0),!0):!1}},Oe={id:"sheet.operation.close-filter-panel",type:P.OPERATION,handler:e=>{const t=e.get(at),r=e.get(le),i=e.get(is,Ir.OPTIONAL);return t.getContextValue(Se)?(t.setContextValue(Se,!1),i?.focus(),r.terminate()):!1}},si={id:"sheet.operation.apply-filter",type:P.OPERATION,handler:(e,t)=>{const{filterBy:r}=t;return e.get(le).changeFilterBy(r)}},ni="sheets-filter-ui.config",tt={};var sn=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},pe=(e,t)=>(r,i)=>t(r,i,e);let Ie=class extends G{constructor(e,t,r,i,n,o){super(),this._sheetsFilterService=e,this._localeService=t,this._commandService=r,this._sheetPermissionCheckPermission=i,this._injector=n,this._sheetsSelectionService=o,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{var t,r,i;if(e.id===Pe.id){const n=this._injector.get(z),o=Fe(n);if(!o)return;const{unitId:s,subUnitId:l,worksheet:a}=o,u=(t=this._sheetsFilterService.getFilterModel(s,l))==null?void 0:t.getRange();let c;if(u)c=this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[Ne],worksheetTypes:[we,Te]},[u],s,l);else{const d=(r=this._sheetsSelectionService.getCurrentLastSelection())==null?void 0:r.range;if(d){let h={...d};h=d.startColumn===d.endColumn&&d.startRow===d.endRow?Ge(h,{left:!0,right:!0,up:!0,down:!0},a):h,c=this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[Ne],worksheetTypes:[Te,we]},[h],s,l)}else c=this._sheetPermissionCheckPermission.permissionCheckWithoutRange({rangeTypes:[Ne],worksheetTypes:[Te,we]})}c||this._sheetPermissionCheckPermission.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.filterErr"))}if(e.id===et.id){const n=e.params,{unitId:o,subUnitId:s}=n,l=(i=this._sheetsFilterService.getFilterModel(o,s))==null?void 0:i.getRange(),a=ge.deepClone(l);a&&(a.startColumn=n.col,a.endColumn=n.col,this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[Ne],worksheetTypes:[we,Te]},[a],o,s)||this._sheetPermissionCheckPermission.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.filterErr")))}}))}};Ie=sn([pe(0,b(M)),pe(1,b(re)),pe(2,A),pe(3,b(zi)),pe(4,b(ie)),pe(5,b(yr))],Ie);const oe=16,nn=new Path2D("M3.30363 3C2.79117 3 2.51457 3.60097 2.84788 3.99024L6.8 8.60593V12.5662C6.8 12.7184 6.8864 12.8575 7.02289 12.9249L8.76717 13.7863C8.96655 13.8847 9.2 13.7396 9.2 13.5173V8.60593L13.1521 3.99024C13.4854 3.60097 13.2088 3 12.6964 3H3.30363Z");class or{static drawNoCriteria(t,r,i,n){t.save(),Zt.drawWith(t,{radius:2,width:oe,height:oe,fill:n}),t.lineCap="square",t.strokeStyle=i,t.scale(r/oe,r/oe),t.beginPath(),t.lineWidth=1,t.lineCap="round",t.moveTo(3,4),t.lineTo(13,4),t.moveTo(4.5,8),t.lineTo(11.5,8),t.moveTo(6,12),t.lineTo(10,12),t.stroke(),t.restore()}static drawHasCriteria(t,r,i,n){t.save(),Zt.drawWith(t,{radius:2,width:oe,height:oe,fill:n}),t.scale(r/oe,r/oe),t.fillStyle=i,t.fill(nn),t.restore()}}var on=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},It=(e,t)=>(r,i)=>t(r,i,e);const te=16,Me=1;let yt=class extends Xi{constructor(e,t,r,i,n){super(e,t),F(this,"_cellWidth",0),F(this,"_cellHeight",0),F(this,"_filterParams"),F(this,"_hovered",!1),this._contextService=r,this._commandService=i,this._themeService=n,this.setShapeProps(t),this.onPointerDown$.subscribeEvent(o=>this.onPointerDown(o)),this.onPointerEnter$.subscribeEvent(()=>this.onPointerEnter()),this.onPointerLeave$.subscribeEvent(()=>this.onPointerLeave())}setShapeProps(e){typeof e.cellHeight<"u"&&(this._cellHeight=e.cellHeight),typeof e.cellWidth<"u"&&(this._cellWidth=e.cellWidth),typeof e.filterParams<"u"&&(this._filterParams=e.filterParams),this.transformByState({width:e.width,height:e.height})}_draw(e){const t=this._cellHeight,r=this._cellWidth,i=te-r,n=te-t;e.save();const o=new Path2D;o.rect(i,n,r,t),e.clip(o);const{hasCriteria:s}=this._filterParams,l=this._themeService.getColorFromTheme("primary.600"),a=this._hovered?this._themeService.getColorFromTheme("gray.50"):"rgba(255, 255, 255, 1.0)";s?or.drawHasCriteria(e,te,l,a):or.drawNoCriteria(e,te,l,a),e.restore()}onPointerDown(e){if(e.button===2)return;const{col:t,unitId:r,subUnitId:i}=this._filterParams;this._contextService.getContextValue(Se)||!this._commandService.hasCommand(et.id)||setTimeout(()=>{this._commandService.executeCommand(et.id,{unitId:r,subUnitId:i,col:t})},200)}onPointerEnter(){this._hovered=!0,this.makeDirty(!0)}onPointerLeave(){this._hovered=!1,this.makeDirty(!0)}};yt=on([It(2,at),It(3,A),It(4,b(br))],yt);var ln=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},de=(e,t)=>(r,i)=>t(r,i,e);const an=1e3,un=5e3;function cn(e,t,r,i){switch(i){case Qe.TOP:return e+Me;case Qe.MIDDLE:return e+Math.max(0,(r-te)/2);case Qe.BOTTOM:default:return t-te-Me}}let Ot=class extends Fr{constructor(e,t,r,i,n,o,s,l){super(),F(this,"_filterRangeShape",null),F(this,"_buttonRenderDisposable",null),F(this,"_filterButtonShapes",[]),this._context=e,this._injector=t,this._sheetSkeletonManagerService=r,this._sheetsFilterService=i,this._themeService=n,this._sheetInterceptorService=o,this._commandService=s,this._selectionRenderService=l,this._initRenderer()}dispose(){super.dispose(),this._disposeRendering()}_initRenderer(){this._sheetSkeletonManagerService.currentSkeleton$.pipe(ut(e=>{var t,r;if(!e)return he(null);const{unit:i,unitId:n}=this._context,o=((t=i.getActiveSheet())==null?void 0:t.getSheetId())||"",s=(r=this._sheetsFilterService.getFilterModel(n,o))!=null?r:void 0,l=()=>({unitId:n,worksheetId:o,filterModel:s,range:s?.getRange(),skeleton:e.skeleton});return gr(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(_r(([a])=>{var u;return a.type===P.MUTATION&&((u=a.params)==null?void 0:u.unitId)===i.getUnitId()&&(kt.has(a.id)||a.id===Mr.id)}),Hr(20,void 0,{leading:!1,trailing:!0}),ve(l),Lr(l()))}),vs(this.dispose$)).subscribe(e=>{this._disposeRendering(),!(!e||!e.range)&&(this._renderRange(e.range,e.skeleton),this._renderButtons(e))})}_renderRange(e,t){const{scene:r}=this._context,{rowHeaderWidth:i,columnHeaderHeight:n}=t,o=this._filterRangeShape=new Bi(r,an,this._themeService,{rowHeaderWidth:i,columnHeaderHeight:n,enableAutoFill:!1,highlightHeader:!1}),s=ji({range:e,primary:null,style:{fill:"rgba(0, 0, 0, 0.0)"}},t);o.updateRangeBySelectionWithCoord(s),o.setEvent(!1),r.makeDirty(!0)}_renderButtons(e){const{range:t,filterModel:r,unitId:i,skeleton:n,worksheetId:o}=e,{unit:s,scene:l}=this._context,a=s.getSheetBySheetId(o);if(!a)return;this._interceptCellContent(i,o,e.range);const{startColumn:u,endColumn:c,startRow:d}=t;for(let h=u;h<=c;h++){const p=`sheets-filter-button-${h}`,v=Di(d,h,l,n),C=a.getComposedCellStyle(d,h),S=C?.vt||Qe.BOTTOM,{startX:g,startY:_,endX:E,endY:w}=v,Y=E-g,L=w-_;if(L<=Me||Y<=Me)continue;const Z=!!r.getFilterColumn(h),H=E-te-Me,B=cn(_,w,L,S),j={left:H,top:B,height:te,width:te,zIndex:un,cellHeight:L,cellWidth:Y,filterParams:{unitId:i,subUnitId:o,col:h,hasCriteria:Z}},dt=this._injector.createInstance(yt,p,j);this._filterButtonShapes.push(dt)}l.addObjects(this._filterButtonShapes),l.makeDirty()}_interceptCellContent(e,t,r){const{startRow:i,startColumn:n,endColumn:o}=r;this._buttonRenderDisposable=this._sheetInterceptorService.intercept(Or.CELL_CONTENT,{effect:Ei.Style,handler:(s,l,a)=>{const{row:u,col:c,unitId:d,subUnitId:h}=l;return d!==e||h!==t||u!==i||c<n||c>o||((!s||s===l.rawData)&&(s={...l.rawData}),s.fontRenderExtension={...s?.fontRenderExtension,rightOffset:te}),a(s)},priority:10})}_disposeRendering(){var e,t;(e=this._filterRangeShape)==null||e.dispose(),this._filterButtonShapes.forEach(r=>r.dispose()),(t=this._buttonRenderDisposable)==null||t.dispose(),this._filterRangeShape=null,this._buttonRenderDisposable=null,this._filterButtonShapes=[]}};Ot=ln([de(1,b(ie)),de(2,b(Gi)),de(3,b(M)),de(4,b(br)),de(5,b(xr)),de(6,A),de(7,Yi)],Ot);var dn=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},lr=(e,t)=>(r,i)=>t(r,i,e);let Le=class extends Fr{constructor(e,t){super(),this._renderManagerService=e,this._sheetsRenderService=t,[N,y,K,_e].forEach(r=>this.disposeWithMe(this._sheetsRenderService.registerSkeletonChangingMutations(r.id))),this.disposeWithMe(this._renderManagerService.registerRenderModule(V.UNIVER_SHEET,[Ot]))}};Le=dn([lr(0,kr),lr(1,b(Ur))],Le);var hn=Object.defineProperty,mn=(e,t,r)=>t in e?hn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,fn=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},ar=(e,t)=>(r,i)=>t(r,i,e),oi=(e,t,r)=>mn(e,typeof t!="symbol"?t+"":t,r);const pn="SHEET_FILTER_UI_PLUGIN";let rt=class extends ot{constructor(e=tt,t,r){super(),this._config=e,this._injector=t,this._configService=r;const{menu:i,...n}=Mt({},tt,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(ni,n)}onStarting(){[[Ie],[Le]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(Ie)}onRendered(){this._injector.get(Le)}};oi(rt,"type",V.UNIVER_SHEET);oi(rt,"pluginName",pn);rt=fn([Rr(Ue),ar(1,b(ie)),ar(2,lt)],rt);function Re({ref:e,...t}){const{icon:r,id:i,className:n,extend:o,...s}=t,l=`univerjs-icon univerjs-icon-${i} ${n||""}`.trim(),a=O.useRef(`_${vn()}`);return li(r,`${i}`,{defIds:r.defIds,idSuffix:a.current},{ref:e,className:l,...s},o)}function li(e,t,r,i,n){return O.createElement(e.tag,{key:t,...gn(e,r,n),...i},(_n(e,r).children||[]).map((o,s)=>li(o,`${t}-${e.tag}-${s}`,r,void 0,n)))}function gn(e,t,r){const i={...e.attrs};r!=null&&r.colorChannel1&&i.fill==="colorChannel1"&&(i.fill=r.colorChannel1),e.tag==="mask"&&i.id&&(i.id=i.id+t.idSuffix),Object.entries(i).forEach(([o,s])=>{o==="mask"&&typeof s=="string"&&(i[o]=s.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))});const{defIds:n}=t;return!n||n.length===0||(e.tag==="use"&&i["xlink:href"]&&(i["xlink:href"]=i["xlink:href"]+t.idSuffix),Object.entries(i).forEach(([o,s])=>{typeof s=="string"&&(i[o]=s.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))})),i}function _n(e,t){var r;const{defIds:i}=t;return!i||i.length===0?e:e.tag==="defs"&&(r=e.children)!=null&&r.length?{...e,children:e.children.map(n=>typeof n.attrs.id=="string"&&i&&i.includes(n.attrs.id)?{...n,attrs:{...n.attrs,id:n.attrs.id+t.idSuffix}}:n)}:e}function vn(){return Math.random().toString(36).substring(2,8)}Re.displayName="UniverIcon";const Cn={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 20",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M10 1.05957C10.356 1.05957 10.6816 1.26162 10.8408 1.58008L18.8408 17.5801L18.8799 17.668C19.0486 18.1134 18.8551 18.6232 18.4199 18.8408C17.9557 19.0727 17.3913 18.8841 17.1592 18.4199L10 4.10156L2.84082 18.4199C2.60871 18.8841 2.04434 19.0727 1.58008 18.8408C1.11587 18.6087 0.92731 18.0443 1.15918 17.5801L9.15918 1.58008C9.31841 1.26162 9.64395 1.05957 10 1.05957Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M15.3337 11.7261L15.4294 11.731C15.9035 11.779 16.2732 12.1798 16.2732 12.6665C16.2732 13.1532 15.9035 13.554 15.4294 13.602L15.3337 13.6069H4.66675C4.1476 13.6069 3.72632 13.1856 3.72632 12.6665C3.72632 12.1474 4.1476 11.7261 4.66675 11.7261H15.3337Z"}}]},ai=O.forwardRef(function(e,t){return O.createElement(Re,Object.assign({},e,{id:"a-icon",ref:t,icon:Cn}))});ai.displayName="AIcon";const Sn={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 20",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M17.0596 10C17.0596 6.10087 13.8992 2.94043 10 2.94043C6.10087 2.94043 2.94043 6.10087 2.94043 10C2.94043 13.8992 6.10087 17.0596 10 17.0596C13.8992 17.0596 17.0596 13.8992 17.0596 10ZM18.9404 10C18.9404 14.9374 14.9374 18.9404 10 18.9404C5.06257 18.9404 1.05957 14.9374 1.05957 10C1.05957 5.06257 5.06257 1.05957 10 1.05957C14.9374 1.05957 18.9404 5.06257 18.9404 10Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.29492 4.13476C4.63911 3.79057 5.1845 3.76906 5.55371 4.07031L5.625 4.13476L16.0244 14.5352L16.0889 14.6064C16.3902 14.9757 16.3686 15.52 16.0244 15.8643C15.6573 16.2313 15.0624 16.2313 14.6953 15.8643L4.29492 5.46484L4.23047 5.39355C3.92922 5.02434 3.95073 4.47895 4.29492 4.13476Z"}}]},ui=O.forwardRef(function(e,t){return O.createElement(Re,Object.assign({},e,{id:"ban-icon",ref:t,icon:Sn}))});ui.displayName="BanIcon";const In={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.32182 2.60967C2.98161 2.60967 2.79671 3.0074 3.01601 3.2675L6.85819 7.8246C6.94943 7.93282 6.99947 8.06981 6.99947 8.21136V12.7338C6.99947 12.898 7.0998 13.0455 7.2525 13.1058L8.73833 13.6928C9.00085 13.7965 9.28531 13.6031 9.28531 13.3208V8.21136C9.28531 8.06981 9.33535 7.93282 9.42659 7.8246L13.2688 3.2675C13.4881 3.0074 13.3032 2.60967 12.963 2.60967H3.32182ZM2.09858 4.04101C1.22139 3.0006 1.96097 1.40967 3.32182 1.40967H12.963C14.3238 1.40967 15.0634 3.0006 14.1862 4.04101L10.4853 8.43054V13.3208C10.4853 14.4498 9.34747 15.2237 8.29742 14.8089L6.81158 14.2219C6.20078 13.9806 5.79947 13.3905 5.79947 12.7338V8.43054L2.09858 4.04101Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ci=O.forwardRef(function(e,t){return O.createElement(Re,Object.assign({},e,{id:"filter-icon",ref:t,icon:In}))});ci.displayName="FilterIcon";const Fn={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.00016 1.33203C6.68162 1.33203 5.39269 1.72302 4.29636 2.45557C3.20004 3.18811 2.34555 4.2293 1.84097 5.44747C1.33638 6.66565 1.20436 8.00609 1.4616 9.2993C1.71883 10.5925 2.35377 11.7804 3.28612 12.7127C4.21847 13.6451 5.40636 14.28 6.69956 14.5373C7.99277 14.7945 9.33321 14.6625 10.5514 14.1579C11.7696 13.6533 12.8108 12.7988 13.5433 11.7025C14.2758 10.6062 14.6668 9.31724 14.6668 7.9987C14.6649 6.23118 13.9619 4.53662 12.7121 3.2868C11.4622 2.03697 9.76768 1.33397 8.00016 1.33203ZM7.66683 3.9987C7.86461 3.9987 8.05795 4.05735 8.2224 4.16723C8.38685 4.27711 8.51502 4.43329 8.59071 4.61601C8.6664 4.79874 8.6862 4.99981 8.64762 5.19379C8.60903 5.38777 8.51379 5.56595 8.37394 5.7058C8.23409 5.84566 8.0559 5.9409 7.86192 5.97948C7.66794 6.01807 7.46687 5.99826 7.28415 5.92258C7.10142 5.84689 6.94524 5.71872 6.83536 5.55427C6.72548 5.38982 6.66683 5.19648 6.66683 4.9987C6.66683 4.73348 6.77219 4.47913 6.95972 4.29159C7.14726 4.10405 7.40162 3.9987 7.66683 3.9987ZM9.3335 11.332H6.66683C6.49002 11.332 6.32045 11.2618 6.19543 11.1368C6.0704 11.0117 6.00016 10.8422 6.00016 10.6654C6.00016 10.4886 6.0704 10.319 6.19543 10.194C6.32045 10.0689 6.49002 9.9987 6.66683 9.9987H7.3335V7.9987H6.66683C6.49002 7.9987 6.32045 7.92846 6.19543 7.80343C6.0704 7.67841 6.00016 7.50884 6.00016 7.33203C6.00016 7.15522 6.0704 6.98565 6.19543 6.86063C6.32045 6.7356 6.49002 6.66536 6.66683 6.66536H8.00016C8.17698 6.66536 8.34655 6.7356 8.47157 6.86063C8.59659 6.98565 8.66683 7.15522 8.66683 7.33203V9.9987H9.3335C9.51031 9.9987 9.67988 10.0689 9.8049 10.194C9.92993 10.319 10.0002 10.4886 10.0002 10.6654C10.0002 10.8422 9.92993 11.0117 9.8049 11.1368C9.67988 11.2618 9.51031 11.332 9.3335 11.332Z"}}]},di=O.forwardRef(function(e,t){return O.createElement(Re,Object.assign({},e,{id:"info-icon",ref:t,icon:Fn}))});di.displayName="InfoIcon";const En={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8 15C11.866 15 15 11.866 15 8C15 4.13401 11.866 1 8 1C4.13401 1 1 4.13401 1 8C1 11.866 4.13401 15 8 15ZM11.7245 6.42417C11.9588 6.18985 11.9588 5.80995 11.7245 5.57564C11.4901 5.34132 11.1102 5.34132 10.8759 5.57564L7.3002 9.15137L5.72446 7.57564C5.49014 7.34132 5.11025 7.34132 4.87593 7.57564C4.64162 7.80995 4.64162 8.18985 4.87593 8.42417L6.87593 10.4242C7.11025 10.6585 7.49014 10.6585 7.72446 10.4242L11.7245 6.42417Z",fillRule:"evenodd",clipRule:"evenodd"}}]},hi=O.forwardRef(function(e,t){return O.createElement(Re,Object.assign({},e,{id:"success-icon",ref:t,icon:En}))});hi.displayName="SuccessIcon";function Rn(e){const{model:t}=e,r=ee(re),i=Q(t.cellFillColors$,[],!0),n=Q(t.cellTextColors$,[],!0),o=O.useCallback(l=>{t.onFilterCheckToggled(l)},[t]),s=O.useCallback(l=>{t.onFilterCheckToggled(l,!1)},[t]);return f.jsx("div",{"data-u-comp":"sheets-filter-panel-colors-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:f.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:Ye("univer-mt-2 univer-box-border univer-flex univer-h-[300px] univer-flex-grow univer-flex-col univer-gap-4 univer-overflow-auto univer-rounded-md univer-px-2 univer-py-2.5",$t),children:[i.length>1&&f.jsxs("div",{children:[f.jsx("div",{className:"univer-mb-2 univer-text-sm univer-text-gray-900 dark:!univer-text-white",children:r.t("sheets-filter.panel.filter-by-cell-fill-color")}),f.jsx("div",{className:"univer-grid univer-grid-cols-8 univer-items-center univer-justify-start univer-gap-2",children:i.map((l,a)=>f.jsxs("div",{className:"univer-relative univer-size-6",onClick:()=>o(l),children:[l.color?f.jsx("button",{type:"button",className:Ye("univer-box-border univer-size-6 univer-cursor-pointer univer-rounded-full univer-border univer-border-solid univer-border-transparent univer-bg-gray-300 univer-transition-shadow hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white"),style:{backgroundColor:l.color}}):f.jsx(ui,{className:"univer-size-6 univer-cursor-pointer univer-rounded-full hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white"}),l.checked&&f.jsx(ur,{})]},`sheets-filter-cell-fill-color-${a}`))})]}),n.length>1&&f.jsxs("div",{children:[f.jsx("div",{className:"univer-mb-2 univer-text-sm univer-text-gray-900 dark:!univer-text-white",children:r.t("sheets-filter.panel.filter-by-cell-text-color")}),f.jsx("div",{className:"univer-grid univer-grid-cols-8 univer-items-center univer-justify-start univer-gap-2",children:n.map((l,a)=>f.jsxs("div",{className:"univer-relative univer-size-6",onClick:()=>s(l),children:[f.jsx("div",{className:"univer-box-border univer-flex univer-size-full univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-full univer-border univer-border-solid univer-border-[rgba(13,13,13,0.06)] univer-p-0.5 hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white dark:!univer-border-[rgba(255,255,255,0.06)]",children:f.jsx(ai,{style:{color:l.color}})}),l.checked&&f.jsx(ur,{})]},`sheets-filter-cell-text-color-${a}`))})]}),i.length<=1&&n.length<=1&&f.jsx("div",{className:"univer-flex univer-size-full univer-items-center univer-justify-center univer-text-sm univer-text-gray-900 dark:!univer-text-gray-200",children:r.t("sheets-filter.panel.filter-by-color-none")})]})})}function ur(){return f.jsx("div",{className:"univer-absolute -univer-bottom-0.5 -univer-right-0.5 univer-flex univer-size-3 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-full univer-bg-white",children:f.jsx(hi,{className:"univer-size-full univer-font-bold univer-text-[#418F1F]"})})}function bn(e){var t,r;const{model:i}=e,n=ee(re),o=Q(i.conditionItem$,void 0),s=Q(i.filterConditionFormParams$,void 0),l=s!=null&&s.and?"AND":"OR",a=O.useCallback(C=>{i.onConditionFormChange({and:C==="AND"})},[i]),u=wn(n),c=O.useCallback(C=>{i.onPrimaryConditionChange(C)},[i]),d=Tn(n),h=O.useCallback(C=>{i.onConditionFormChange(C)},[i]),p=n.t("sheets-filter.panel.input-values-placeholder");function v(C,S,g){const _=I.getItemByOperator(C).numOfParameters===1;return f.jsxs(f.Fragment,{children:[g==="operator2"&&f.jsxs(gs,{value:l,onChange:a,children:[f.jsx(Jt,{value:"AND",children:n.t("sheets-filter.panel.and")}),f.jsx(Jt,{value:"OR",children:n.t("sheets-filter.panel.or")})]}),f.jsx(Xt,{value:C,options:d,onChange:E=>h({[g]:E})}),_&&f.jsx("div",{children:f.jsx(Dr,{className:"univer-mt-2",value:S,placeholder:p,onChange:E=>h({[g==="operator1"?"val1":"val2"]:E})})})]})}return f.jsx("div",{"data-u-comp":"sheets-filter-panel-conditions-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:o&&s&&f.jsxs(f.Fragment,{children:[f.jsx(Xt,{value:o.operator,options:u,onChange:c}),I.getItemByOperator(o.operator).numOfParameters!==0?f.jsxs("div",{"data-u-comp":"sheets-filter-panel-conditions-container-inner",className:Ye("univer-mt-2 univer-flex-grow univer-overflow-hidden univer-rounded-md univer-p-2",$t),children:[o.numOfParameters>=1&&v(s.operator1,(t=s.val1)!=null?t:"","operator1"),o.numOfParameters>=2&&v(s.operator2,(r=s.val2)!=null?r:"","operator2"),f.jsxs("div",{"data-u-comp":"sheets-filter-panel-conditions-desc",className:"univer-mt-2 univer-text-xs univer-text-gray-500",children:[n.t("sheets-filter.panel.?"),f.jsx("br",{}),n.t("sheets-filter.panel.*")]})]}):null]})})}function wn(e){const t=e.getCurrentLocale();return O.useMemo(()=>[{options:[{label:e.t(I.NONE.label),value:I.NONE.operator}]},{options:[{label:e.t(I.EMPTY.label),value:I.EMPTY.operator},{label:e.t(I.NOT_EMPTY.label),value:I.NOT_EMPTY.operator}]},{options:[{label:e.t(I.TEXT_CONTAINS.label),value:I.TEXT_CONTAINS.operator},{label:e.t(I.DOES_NOT_CONTAIN.label),value:I.DOES_NOT_CONTAIN.operator},{label:e.t(I.STARTS_WITH.label),value:I.STARTS_WITH.operator},{label:e.t(I.ENDS_WITH.label),value:I.ENDS_WITH.operator},{label:e.t(I.EQUALS.label),value:I.EQUALS.operator}]},{options:[{label:e.t(I.GREATER_THAN.label),value:I.GREATER_THAN.operator},{label:e.t(I.GREATER_THAN_OR_EQUAL.label),value:I.GREATER_THAN_OR_EQUAL.operator},{label:e.t(I.LESS_THAN.label),value:I.LESS_THAN.operator},{label:e.t(I.LESS_THAN_OR_EQUAL.label),value:I.LESS_THAN_OR_EQUAL.operator},{label:e.t(I.EQUAL.label),value:I.EQUAL.operator},{label:e.t(I.NOT_EQUAL.label),value:I.NOT_EQUAL.operator},{label:e.t(I.BETWEEN.label),value:I.BETWEEN.operator},{label:e.t(I.NOT_BETWEEN.label),value:I.NOT_BETWEEN.operator}]},{options:[{label:e.t(I.CUSTOM.label),value:I.CUSTOM.operator}]}],[t,e])}function Tn(e){const t=e.getCurrentLocale();return O.useMemo(()=>I.ALL_CONDITIONS.filter(r=>r.numOfParameters!==2).map(r=>({label:e.t(r.label),value:r.operator})),[t,e])}function Nn(e){const{model:t}=e,r=ee(re),i=Q(t.searchString$,"",!0),n=Q(t.filterItems$,void 0,!0),o=r.t("sheets-filter.panel.filter-only"),s=wt(n),l=s.checked>0&&s.unchecked===0,a=s.checked>0&&s.unchecked>0,u=t.treeMapCache,c=O.useCallback(()=>{t.onCheckAllToggled(!l)},[t,l]),d=O.useCallback(p=>{t.setSearchString(p)},[t]);function h(p){let v=[];return p.forEach(C=>{C.checked&&v.push(C.key),C.children&&(v=v.concat(h(C.children)))}),v}return f.jsxs("div",{"data-u-comp":"sheets-filter-panel-values-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:[f.jsx(Dr,{autoFocus:!0,value:i,placeholder:r.t("sheets-filter.panel.search-placeholder"),onChange:d}),f.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:Ye("univer-mt-2 univer-box-border univer-flex univer-flex-grow univer-flex-col univer-overflow-hidden univer-rounded-md univer-px-2 univer-py-2.5",$t),children:[f.jsx("div",{"data-u-comp":"sheets-filter-panel-values-item",className:"univer-box-border univer-h-8 univer-w-full univer-py-0.5",children:f.jsxs("div",{"data-u-comp":"sheets-filter-panel-values-item-inner",className:"univer-box-border univer-flex univer-h-7 univer-items-center univer-rounded-md univer-py-0 univer-pl-5 univer-pr-0.5 univer-text-sm",children:[f.jsx(hs,{indeterminate:a,disabled:n.length===0,checked:l,onChange:c}),f.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-text",className:"univer-mx-1 univer-inline-block univer-flex-shrink univer-truncate univer-text-gray-900 dark:!univer-text-white",children:`${r.t("sheets-filter.panel.select-all")}`}),f.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-count",className:"univer-text-gray-400 dark:!univer-text-gray-500",children:`(${s.checked}/${s.checked+s.unchecked})`})]})}),f.jsx("div",{"data-u-comp":"sheets-filter-panel-values-virtual",className:"univer-flex-grow",children:f.jsx(ms,{data:n,defaultExpandAll:!1,valueGroup:h(n),onChange:p=>{t.onFilterCheckToggled(p)},defaultCache:u,itemHeight:28,treeNodeClassName:`
                          univer-pr-2 univer-border-box univer-rounded-md
                          [&:hover_a]:univer-inline-block
                          hover:univer-bg-gray-50 univer-h-full
                          univer-text-gray-900 dark:hover:!univer-bg-gray-900
                          dark:!univer-text-white
                        `,attachRender:p=>f.jsxs("div",{className:"univer-ml-1 univer-flex univer-h-5 univer-flex-1 univer-cursor-pointer univer-items-center univer-justify-between univer-text-sm univer-text-primary-500",children:[f.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-count",className:"univer-text-gray-400 dark:!univer-text-gray-500",children:`(${p.count})`}),f.jsx("a",{className:"univer-box-border univer-hidden univer-h-4 univer-whitespace-nowrap univer-px-1.5",onClick:()=>{const v=[];p.children?p.children.forEach(C=>{C.children?C.children.forEach(S=>{v.push(S.key)}):v.push(C.key)}):v.push(p.key),t.onFilterOnly(v)},children:o})]})})})]})]})}function yn(){const e=ee(Ae);if(!Q(e.visible$,void 0,!0))return null;const t=ee(re),r=ee(Br),i=Q(e.enabled$,void 0,!0);return f.jsxs("div",{className:"univer-mt-2 univer-flex univer-items-center univer-justify-between univer-text-sm univer-text-gray-900 dark:!univer-text-gray-200",children:[f.jsxs("div",{className:"univer-flex univer-items-center univer-gap-1",children:[f.jsx("span",{children:t.t("sheets-filter.sync.title")}),f.jsx(fs,{title:i?t.t("sheets-filter.sync.statusTips.off"):t.t("sheets-filter.sync.statusTips.on"),asChild:!0,children:f.jsx(di,{className:"univer-block"})})]}),f.jsx(ps,{defaultChecked:i,onChange:n=>{const o=n?t.t("sheets-filter.sync.switchTips.on"):t.t("sheets-filter.sync.switchTips.off");e.setEnabled(n),r.show({content:o,type:jr.Success,duration:2e3})}})]})}function On(){var e;const t=ee(le),r=ee(re),i=ee(A),n=Q(t.filterBy$,void 0,!0),o=Q(t.filterByModel$,void 0,!1),s=Q(()=>o?.canApply$||he(!1),void 0,!1,[o]),l=Mn(r),a=!Q(t.hasCriteria$),u=O.useCallback(S=>{i.executeCommand(si.id,{filterBy:S})},[i]),c=O.useCallback(async()=>{await o?.clear(),i.executeCommand(Oe.id)},[o,i]),d=O.useCallback(()=>{i.executeCommand(Oe.id)},[i]),h=O.useCallback(async()=>{await o?.apply(),i.executeCommand(Oe.id)},[o,i]),p=(e=ee(M).activeFilterModel)==null?void 0:e.getRange(),v=t.col,C=os(Vi.FILTER_PANEL_EMBED_POINT);return f.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:"univer-box-border univer-flex univer-max-h-[500px] univer-w-[400px] univer-flex-col univer-rounded-lg univer-bg-white univer-p-4 univer-shadow-lg dark:!univer-border-gray-600 dark:!univer-bg-gray-700",children:[f.jsx(ls,{components:C,sharedProps:{range:p,colIndex:v,onClose:d}}),f.jsx("div",{className:"univer-mb-1 univer-flex-shrink-0 univer-flex-grow-0",children:f.jsx(ds,{value:n,items:l,onChange:S=>u(S)})}),o?f.jsx("div",{"data-u-comp":"sheets-filter-panel-content",className:"univer-flex-shrink univer-flex-grow univer-pt-2",children:n===x.VALUES?f.jsx(Nn,{model:o}):n===x.COLORS?f.jsx(Rn,{model:o}):f.jsx(bn,{model:o})}):f.jsx("div",{className:"univer-flex-1"}),f.jsx(yn,{}),f.jsxs("div",{"data-u-comp":"sheets-filter-panel-footer",className:"univer-mt-4 univer-inline-flex univer-flex-shrink-0 univer-flex-grow-0 univer-flex-nowrap univer-justify-between univer-overflow-hidden",children:[f.jsx(gt,{variant:"link",onClick:c,disabled:a,children:r.t("sheets-filter.panel.clear-filter")}),f.jsxs("span",{className:"univer-flex univer-gap-2",children:[f.jsx(gt,{variant:"default",onClick:d,children:r.t("sheets-filter.panel.cancel")}),f.jsx(gt,{disabled:!s,variant:"primary",onClick:h,children:r.t("sheets-filter.panel.confirm")})]})]})]})}function Mn(e){const t=e.getCurrentLocale();return O.useMemo(()=>[{label:e.t("sheets-filter.panel.by-values"),value:x.VALUES},{label:e.t("sheets-filter.panel.by-colors"),value:x.COLORS},{label:e.t("sheets-filter.panel.by-conditions"),value:x.CONDITIONS}],[t,e])}function xn(e){const t=e.get(M);return{id:Pe.id,type:At.BUTTON_SELECTOR,icon:"FilterIcon",tooltip:"sheets-filter.toolbar.smart-toggle-filter-tooltip",hidden$:Ut(e,V.UNIVER_SHEET),activated$:t.activeFilterModel$.pipe(ve(r=>!!r)),disabled$:Wi(e,Qi(e,{worksheetTypes:[we,Te],rangeTypes:[Ne]}))}}function An(e){const t=e.get(M);return{id:Ce.id,type:At.BUTTON,title:"sheets-filter.toolbar.clear-filter-criteria",hidden$:Ut(e,V.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe(ut(r=>{var i;return(i=r?.hasCriteria$.pipe(ve(n=>!n)))!=null?i:he(!0)}))}}function Un(e){const t=e.get(M);return{id:Bt.id,type:At.BUTTON,title:"sheets-filter.toolbar.re-calc-filter-conditions",hidden$:Ut(e,V.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe(ut(r=>{var i;return(i=r?.hasCriteria$.pipe(ve(n=>!n)))!=null?i:he(!0)}))}}const $n={[ns.ORGANIZATION]:{[Pe.id]:{order:2,menuItemFactory:xn,[Ce.id]:{order:0,menuItemFactory:An},[Bt.id]:{order:1,menuItemFactory:Un}}}},Ln={id:Pe.id,binding:ss.L|qt.CTRL_COMMAND|qt.SHIFT,description:"sheets-filter.shortcut.smart-toggle-filter",preconditions:Hi,group:"4_sheet-edit"};var kn=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},D=(e,t)=>(r,i)=>t(r,i,e);const cr="FILTER_PANEL_POPUP";let it=class extends Le{constructor(e,t,r,i,n,o,s,l,a,u,c,d,h){super(h,d),F(this,"_popupDisposable"),this._injector=e,this._componentManager=t,this._sheetsFilterPanelService=r,this._sheetCanvasPopupService=i,this._sheetsFilterService=n,this._localeService=o,this._shortcutService=s,this._commandService=l,this._menuManagerService=a,this._contextService=u,this._messageService=c,this._initCommands(),this._initShortcuts(),this._initMenuItems(),this._initUI()}dispose(){super.dispose(),this._closeFilterPopup()}_initShortcuts(){[Ln].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_initCommands(){[Pe,Ht,Pt,W,Ce,Bt,si,et,Oe].forEach(e=>{this.disposeWithMe(this._commandService.registerCommand(e))})}_initMenuItems(){this._menuManagerService.mergeMenu($n)}_initUI(){[[cr,On],["FilterIcon",ci]].forEach(([e,t])=>{this.disposeWithMe(this._componentManager.register(e,t))}),this.disposeWithMe(this._contextService.subscribeContextValue$(Se).pipe(Si()).subscribe(e=>{e?this._openFilterPopup():this._closeFilterPopup()})),this.disposeWithMe(this._sheetsFilterService.errorMsg$.subscribe(e=>{e&&this._messageService.show({type:jr.Error,content:this._localeService.t(e)})}))}_openFilterPopup(){const e=this._sheetsFilterPanelService.filterModel;if(!e)throw new Error("[SheetsFilterUIController]: no filter model when opening filter popup!");const t=e.getRange(),r=this._sheetsFilterPanelService.col,{startRow:i}=t;this._popupDisposable=this._sheetCanvasPopupService.attachPopupToCell(i,r,{componentKey:cr,direction:"horizontal",onClickOutside:()=>this._commandService.syncExecuteCommand(Oe.id),offset:[5,0]})}_closeFilterPopup(){var e;(e=this._popupDisposable)==null||e.dispose(),this._popupDisposable=null}};it=kn([D(0,b(ie)),D(1,b(as)),D(2,b(le)),D(3,b(Zi)),D(4,b(M)),D(5,b(re)),D(6,us),D(7,A),D(8,cs),D(9,at),D(10,Br),D(11,b(Ur)),D(12,kr)],it);var Pn=Object.defineProperty,Hn=(e,t,r)=>t in e?Pn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Bn=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},Ft=(e,t)=>(r,i)=>t(r,i,e),mi=(e,t,r)=>Hn(e,typeof t!="symbol"?t+"":t,r);const jn="SHEET_FILTER_UI_PLUGIN";let ke=class extends ot{constructor(e=tt,t,r,i){super(),this._config=e,this._injector=t,this._configService=r,this._rpcChannelService=i;const{menu:n,...o}=Mt({},tt,this._config);n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(ni,o)}onStarting(){vi(this._injector,[[le],[Ie],[it]]),this._config.useRemoteFilterValuesGenerator&&this._rpcChannelService&&this._injector.add([qe,{useFactory:()=>ts(this._rpcChannelService.requestChannel(jt))}])}onReady(){Rt(this._injector,[[Ie]])}onRendered(){Rt(this._injector,[[it]])}};mi(ke,"type",V.UNIVER_SHEET);mi(ke,"pluginName",jn);ke=Bn([Rr(Ue),Ft(1,b(ie)),Ft(2,lt),Ft(3,Sr(Pr))],ke);var Dn=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},dr=(e,t)=>(r,i)=>t(r,i,e),De;let hr=(De=class extends ot{constructor(e,t,r){super(),this._config=e,this._injector=t,this._rpcChannelService=r}onStarting(){[[qe,{useClass:Tt}]].forEach(e=>this._injector.add(e))}onReady(){this._rpcChannelService.registerChannel(jt,rs(this._injector.get(qe)))}},F(De,"type",V.UNIVER_SHEET),F(De,"pluginName","SHEET_FILTER_UI_WORKER_PLUGIN"),De);hr=Dn([dr(1,b(ie)),dr(2,Pr)],hr);var Wn=(e,t,r,i)=>{for(var n=t,o=e.length-1,s;o>=0;o--)(s=e[o])&&(n=s(n)||n);return n},mr=(e,t)=>(r,i)=>t(r,i,e);let st=class{constructor(e,t,r,i,n){this._workbook=e,this._worksheet=t,this._filterModel=r,this._injector=i,this._commandSrv=n}getFilteredOutRows(){return Array.from(this._filterModel.filteredOutRows).sort()}getColumnFilterCriteria(e){var t;return(t=this._filterModel.getFilterColumn(e))==null?void 0:t.getColumnData()}removeColumnFilterCriteria(e){return this._commandSrv.syncExecuteCommand(W.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),col:e,criteria:null}),this}setColumnFilterCriteria(e,t){return this._commandSrv.syncExecuteCommand(W.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),col:e,criteria:t}),this}getRange(){const e=this._filterModel.getRange();return this._injector.createInstance(xt,this._workbook,this._worksheet,e)}removeFilterCriteria(){return this._commandSrv.syncExecuteCommand(Ce.id),this}remove(){return this._commandSrv.syncExecuteCommand(Ht.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId()})}};st=Wn([mr(3,b(ie)),mr(4,A)],st);class Qn extends xt{createFilter(){return this._getFilterModel()||!this._commandService.syncExecuteCommand(Pt.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range})?null:this.getFilter()}getFilter(){const t=this._getFilterModel();return t?this._injector.createInstance(st,this._workbook,this._worksheet,t):null}_getFilterModel(){return this._injector.get(M).getFilterModel(this._workbook.getUnitId(),this._worksheet.getSheetId())}}xt.extend(Qn);class Vn extends $r{getFilter(){const t=this._getFilterModel();return t?this._injector.createInstance(st,this._workbook,this._worksheet,t):null}_getFilterModel(){return this._injector.get(M).getFilterModel(this._workbook.getUnitId(),this._worksheet.getSheetId())}}$r.extend(Vn);class zn{get CustomFilterOperator(){return m}}Cs.extend(zn);let Gn=class extends Lt{get SheetBeforeRangeFilter(){return"SheetBeforeRangeFilter"}get SheetRangeFiltered(){return"SheetRangeFiltered"}get SheetRangeFilterCleared(){return"SheetRangeFilterCleared"}get SheetBeforeRangeFilterClear(){return"SheetBeforeRangeFilterClear"}};Lt.extend(Gn);Lt.extend(qi);class Yn extends Wr{_initialize(t){const r=t.get(A);this.disposeWithMe(this.registerEventHandler(this.Event.SheetBeforeRangeFilter,()=>r.beforeCommandExecuted(i=>{i.id===W.id&&this._beforeRangeFilter(i)}))),this.disposeWithMe(this.registerEventHandler(this.Event.SheetBeforeRangeFilterClear,()=>r.beforeCommandExecuted(i=>{i.id===Ce.id&&this._beforeRangeFilterClear()}))),this.disposeWithMe(this.registerEventHandler(this.Event.SheetRangeFiltered,()=>r.onCommandExecuted(i=>{i.id===W.id&&this._onRangeFiltered(i)}))),this.disposeWithMe(this.registerEventHandler(this.Event.SheetRangeFilterCleared,()=>r.onCommandExecuted(i=>{i.id===Ce.id&&this._onRangeFilterCleared()})))}_beforeRangeFilter(t){const r=t.params,i=this.getUniverSheet(r.unitId),n={workbook:i,worksheet:i.getSheetBySheetId(r.subUnitId),col:r.col,criteria:r.criteria};if(this.fireEvent(this.Event.SheetBeforeRangeFilter,n),n.cancel)throw new Error("SetSheetsFilterCriteriaCommand canceled.")}_onRangeFiltered(t){const r=t.params,i=this.getUniverSheet(r.unitId),n={workbook:i,worksheet:i.getSheetBySheetId(r.subUnitId),col:r.col,criteria:r.criteria};this.fireEvent(this.Event.SheetRangeFiltered,n)}_beforeRangeFilterClear(){const t=this.getActiveWorkbook();if(!t)return;const r={workbook:t,worksheet:t.getActiveSheet()};if(this.fireEvent(this.Event.SheetBeforeRangeFilterClear,r),r.cancel)throw new Error("SetSheetsFilterCriteriaCommand canceled.")}_onRangeFilterCleared(){const t=this.getActiveWorkbook();if(!t)return;const r={workbook:t,worksheet:t.getActiveSheet()};this.fireEvent(this.Event.SheetRangeFilterCleared,r)}}Wr.extend(Yn);function mo(e={}){const{enableSyncSwitch:t}=e;return{plugins:[[Ue,{enableSyncSwitch:t}],ke].filter(r=>!!r)}}export{si as ChangeFilterByOperation,Ce as ClearSheetsFilterCriteriaCommand,Oe as CloseFilterPanelOperation,m as CustomFilterOperator,kt as FILTER_MUTATIONS,x as FilterBy,Ms as FilterColumn,tr as FilterModel,et as OpenFilterPanelOperation,Bt as ReCalcSheetsFilterCommand,_e as ReCalcSheetsFilterMutation,Ht as RemoveSheetFilterCommand,K as RemoveSheetsFilterMutation,Jr as SHEET_FILTER_SNAPSHOT_ID,Pt as SetSheetFilterRangeCommand,W as SetSheetsFilterCriteriaCommand,y as SetSheetsFilterCriteriaMutation,N as SetSheetsFilterRangeMutation,M as SheetsFilterService,Ae as SheetsFilterSyncController,Pe as SmartToggleSheetsFilterCommand,rt as UniverSheetsFilterMobileUIPlugin,Ue as UniverSheetsFilterPlugin,mo as UniverSheetsFilterPreset,ke as UniverSheetsFilterUIPlugin,hr as UniverSheetsFilterUIWorkerPlugin,ws as equals,Kt as getCustomFilterFn,Fs as greaterThan,Es as greaterThanOrEqualTo,Rs as lessThan,bs as lessThanOrEqualTo,Yr as notEquals};
