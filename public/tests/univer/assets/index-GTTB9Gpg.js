import{L as V,dU as Q,aB as K,ai as ie,ah as re,aC as D,f$ as oe,fB as ae,dH as ce,cz as k,gm as le,g6 as O,da as w,f0 as de,bi as m,bt as x,c5 as ue,fk as ge,b6 as A,Q as M,bm as T,bB as he,bo as fe,b7 as _e}from"./index-BI8deSNo.js";import{ar as me,F as pe,J as Se,aa as Ie}from"./index-DnxWP_AP.js";import{t as Z}from"./takeUntil-BWepI5Pd.js";import"./shareReplay-DR2HpNHE.js";var Re=Object.defineProperty,xe=(e,t,n)=>t in e?Re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,d=(e,t,n)=>xe(e,typeof t!="symbol"?t+"":t,n);const P={id:"doc.operation.set-selections",type:V.OPERATION,handler:()=>!0};var ve=(e,t,n,s)=>{for(var i=t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(i=o(i)||i);return i},G=(e,t)=>(n,s)=>t(n,s,e);let p=class extends k{constructor(e,t){super(),d(this,"_currentSelection",null),d(this,"_textSelectionInfo",new Map),d(this,"_textSelection$",new le),d(this,"textSelection$",this._textSelection$.asObservable()),d(this,"_refreshSelection$",new O(null)),d(this,"refreshSelection$",this._refreshSelection$.asObservable()),this._commandService=e,this._univerInstanceService=t,this._listenCurrentUnit()}_listenCurrentUnit(){this._univerInstanceService.getCurrentTypeOfUnit$(w.UNIVER_DOC).pipe(Z(this.dispose$)).subscribe(e=>{if(e==null)return;const t=e.getUnitId();this._setCurrentSelectionNotRefresh({unitId:t,subUnitId:t})})}__getCurrentSelection(){return this._currentSelection}getSelectionInfo(e=this._currentSelection){return this._getTextRanges(e)}refreshSelection(e=this._currentSelection){e!=null&&this._refresh(e)}__TEST_ONLY_setCurrentSelection(e){this._currentSelection=e,this._refresh(e)}getTextRanges(e=this._currentSelection){var t;return(t=this._getTextRanges(e))==null?void 0:t.textRanges}getRectRanges(e=this._currentSelection){var t;return(t=this._getTextRanges(e))==null?void 0:t.rectRanges}getDocRanges(e=this._currentSelection){var t,n;const s=(t=this.getTextRanges(e))!=null?t:[],i=(n=this.getRectRanges(e))!=null?n:[];return[...s,...i].filter(r=>r.startOffset!=null&&r.endOffset!=null).sort((r,o)=>r.startOffset>o.startOffset?1:r.startOffset<o.startOffset?-1:0)}getActiveTextRange(){const e=this._getTextRanges(this._currentSelection);if(e==null)return;const{textRanges:t}=e;return t.find(n=>n.isActive)}getActiveRectRange(){const e=this._getTextRanges(this._currentSelection);if(e==null)return;const{rectRanges:t}=e;return t.find(n=>n.isActive)}__TEST_ONLY_add(e,t=!0){this._currentSelection!=null&&this._addByParam({...this._currentSelection,textRanges:e,rectRanges:[],segmentId:"",segmentPage:-1,isEditing:t,style:me})}replaceTextRanges(e,t=!0,n){return this.replaceDocRanges(e,this._currentSelection,t,n)}replaceDocRanges(e,t=this._currentSelection,n=!0,s){if(t==null)return;const{unitId:i,subUnitId:r}=t;this._refreshSelection$.next({unitId:i,subUnitId:r,docRanges:e,isEditing:n,options:s})}__replaceTextRangesWithNoRefresh(e,t){if(this._currentSelection==null)return;const n={...e,...t};this._replaceByParam(n),this._textSelection$.next(n);const{unitId:s,subUnitId:i,segmentId:r,style:o,textRanges:a,rectRanges:c,isEditing:l}=n,_=[...a,...c].filter(u=>u.startOffset!=null&&u.endOffset!=null).sort((u,g)=>u.startOffset>g.startOffset?1:u.startOffset<g.startOffset?-1:0);this._commandService.executeCommand(P.id,{unitId:s,subUnitId:i,segmentId:r,style:o,isEditing:l,ranges:_})}dispose(){this._textSelection$.complete(),this._refreshSelection$.complete()}_setCurrentSelectionNotRefresh(e){this._currentSelection=e}_getTextRanges(e){var t;if(e==null)return;const{unitId:n,subUnitId:s=""}=e;return(t=this._textSelectionInfo.get(n))==null?void 0:t.get(s)}_refresh(e){const t=this._getTextRanges(e);if(t==null)return;const{textRanges:n,rectRanges:s}=t,i=[...n,...s],{unitId:r,subUnitId:o}=e;this._refreshSelection$.next({unitId:r,subUnitId:o,docRanges:i,isEditing:!1})}_replaceByParam(e){const{unitId:t,subUnitId:n,...s}=e;this._textSelectionInfo.has(t)||this._textSelectionInfo.set(t,new Map),this._textSelectionInfo.get(t).set(n,{...s})}_addByParam(e){const{unitId:t,subUnitId:n,...s}=e;this._textSelectionInfo.has(t)||this._textSelectionInfo.set(t,new Map);const i=this._textSelectionInfo.get(t);i.has(n)?i.get(n).textRanges.push(...e.textRanges):i.set(n,{...s})}};p=ve([G(0,A),G(1,m)],p);var Oe=(e,t,n,s)=>{for(var i=t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(i=o(i)||i);return i},H=(e,t)=>(n,s)=>t(n,s,e);let C=class extends k{constructor(e,t,n){super(),d(this,"_skeleton"),d(this,"_docViewModel"),d(this,"_currentSkeleton$",new O(null)),d(this,"currentSkeleton$",this._currentSkeleton$.asObservable()),d(this,"_currentSkeletonBefore$",new O(null)),d(this,"currentSkeletonBefore$",this._currentSkeletonBefore$.asObservable()),d(this,"_currentViewModel$",new O(null)),d(this,"currentViewModel$",this._currentViewModel$.asObservable()),this._context=e,this._localeService=t,this._univerInstanceService=n,this._init(),this._univerInstanceService.getCurrentTypeOfUnit$(w.UNIVER_DOC).pipe(Z(this.dispose$)).subscribe(s=>{s&&s.getUnitId()===this._context.unitId&&this._update(s)})}dispose(){super.dispose(),this._currentSkeletonBefore$.complete(),this._currentSkeleton$.complete()}getSkeleton(){return this._skeleton}getViewModel(){return this._docViewModel}_init(){const e=this._context.unit;this._update(e)}_update(e){const t=this._context.unitId;if(e.getBody()==null)return;this._docViewModel&&de(t)?(this._docViewModel.reset(e),this._context.unit=e):this._docViewModel||(this._docViewModel=this._buildDocViewModel(e)),this._skeleton||(this._skeleton=this._buildSkeleton(this._docViewModel));const n=this._skeleton;n.calculate(),this._currentSkeletonBefore$.next(n),this._currentSkeleton$.next(n),this._currentViewModel$.next(this._docViewModel)}_buildSkeleton(e){return pe.create(e,this._localeService)}_buildDocViewModel(e){return new Se(e)}};C=Oe([H(1,T(he)),H(2,m)],C);class ee extends k{constructor(){super(),d(this,"_docStateChangeParams$",new O(null)),d(this,"docStateChangeParams$",this._docStateChangeParams$.asObservable())}emitStateChangeInfo(t){this._docStateChangeParams$.next(t)}dispose(){super.dispose(),this._docStateChangeParams$.complete()}}const L="doc.mutation.rich-text-editing",b={id:L,type:V.MUTATION,handler:(e,t)=>{var n,s;const{unitId:i,segmentId:r="",actions:o,textRanges:a,prevTextRanges:c,trigger:l,noHistory:_,isCompositionEnd:u,noNeedSetTextRange:g,debounce:f,isEditing:S=!0,isSync:h,syncer:I}=t,R=e.get(m),U=e.get(Ie),te=e.get(ee),v=R.getUniverDocInstance(i),j=(n=U.getRenderById(i))==null?void 0:n.with(C).getViewModel();if(v==null||j==null)throw new Error(`DocumentDataModel or documentViewModel not found for unitId: ${i}`);const F=e.get(p),$=(s=F.getDocRanges())!=null?s:[],ne=!!v.getSnapshot().disabled;if(x.isNoop(o)||o&&o.length===0||ne)return{unitId:i,actions:[],textRanges:$};const W=x.invertWithDoc(o,v.getSnapshot());v.apply(o),j.reset(v),!g&&a&&l!=null&&!h&&queueMicrotask(()=>{F.replaceDocRanges(a,{unitId:i,subUnitId:i},S,t.options)});const se={commandId:L,unitId:i,segmentId:r,trigger:l,noHistory:_,debounce:f,redoState:{actions:o,textRanges:a},undoState:{actions:W,textRanges:c??$},isCompositionEnd:u,isSync:h,syncer:I};return te.emitStateChangeInfo(se),{unitId:i,actions:W,textRanges:$}}},Me={id:"doc.mutation.rename-doc",type:V.MUTATION,handler:(e,t)=>{const n=e.get(m).getUnit(t.unitId,w.UNIVER_DOC);return n?(n.setName(t.name),!0):!1}},be="docs.config",Y={};var Ce=(e,t,n,s)=>{for(var i=t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(i=o(i)||i);return i},E=(e,t)=>(n,s)=>t(n,s,e);let y=class extends K{constructor(e,t,n){super(),this._commandService=e,this._textSelectionManagerService=t,this._univerInstanceService=n,this._initSelectionChange()}_transformCustomRange(e,t){var n;const{startOffset:s,endOffset:i,collapsed:r}=t,o=(n=e.getCustomRanges())==null?void 0:n.filter(a=>!a.wholeEntity||s<=a.startIndex&&i>a.endIndex?!1:r?a.startIndex<s&&a.endIndex>=i:M.range.isIntersects(s,i-1,a.startIndex,a.endIndex));if(o!=null&&o.length){let a=s,c=i;return o.forEach(l=>{a=Math.min(l.startIndex,a),c=Math.max(l.endIndex+1,c)}),{...t,startOffset:a,endOffset:c,collapsed:a===c}}return t}_initSelectionChange(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===P.id){const t=e.params,{unitId:n,ranges:s,isEditing:i}=t,r=this._univerInstanceService.getUnit(n);if(!r)return;const o=s.map(a=>this._transformCustomRange(r,a));o.some((a,c)=>s[c]!==a)&&this._textSelectionManagerService.replaceTextRanges(o,i)}}))}};y=Ce([E(0,A),E(1,T(p)),E(2,m)],y);var ye=(e,t,n,s)=>{for(var i=t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(i=o(i)||i);return i},X=(e,t)=>(n,s)=>t(n,s,e);const we="DOCS_PLUGIN";var N;let J=(N=class extends ue{constructor(e=Y,t,n){super(),this._config=e,this._injector=t,this._configService=n;const{...s}=ge({},Y,this._config);this._configService.setConfig(be,s)}onStarting(){this._initializeDependencies(),this._initializeCommands()}_initializeCommands(){[b,Me,P].forEach(e=>{this._injector.get(A).registerCommand(e)})}_initializeDependencies(){[[p],[ee],[y]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(y)}},d(N,"pluginName",we),N);J=ye([X(1,T(fe)),X(2,_e)],J);const Te=Q("CUSTOM_RANGE"),Ue=Q("CUSTOM_DECORATION"),B={CUSTOM_RANGE:Te,CUSTOM_DECORATION:Ue};var $e=(e,t,n,s)=>{for(var i=t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(i=o(i)||i);return i},De=(e,t)=>(n,s)=>t(n,s,e);let q=class extends K{constructor(e,t){super(),d(this,"_interceptorsByName",new Map),this._context=e,this._docSkeletonManagerService=t;const n=this._docSkeletonManagerService.getViewModel(),s=n.getDataModel().getUnitId();if(s===ie||s===re)return;this.disposeWithMe(this.interceptDocumentViewModel(n)),this.disposeWithMe(this.intercept(B.CUSTOM_RANGE,{priority:-1,handler:(r,o,a)=>a(r)}));let i=new D;n.segmentViewModels$.subscribe(r=>{i.dispose(),i=new D,r.forEach(o=>{i.add(this.interceptDocumentViewModel(o))})}),this.disposeWithMe(i)}intercept(e,t){const n=e;this._interceptorsByName.has(n)||this._interceptorsByName.set(n,[]);const s=this._interceptorsByName.get(n);return s.push(t),this._interceptorsByName.set(n,s.sort((i,r)=>{var o,a;return((o=r.priority)!=null?o:0)-((a=i.priority)!=null?a:0)})),this.disposeWithMe(oe(()=>ae(this._interceptorsByName.get(n),t)))}fetchThroughInterceptors(e){const t=e,n=this._interceptorsByName.get(t);return ce(n||[])}interceptDocumentViewModel(e){const t=new D;return t.add(e.registerCustomRangeInterceptor({getCustomRange:n=>{var s;return this.fetchThroughInterceptors(B.CUSTOM_RANGE)(e.getCustomRangeRaw(n),{index:n,unitId:e.getDataModel().getUnitId(),customRanges:(s=e.getDataModel().getCustomRanges())!=null?s:[]})},getCustomDecoration:n=>{var s;return this.fetchThroughInterceptors(B.CUSTOM_DECORATION)(e.getCustomDecorationRaw(n),{index:n,unitId:e.getDataModel().getUnitId(),customDecorations:(s=e.getDataModel().getCustomDecorations())!=null?s:[]})}})),t}};q=$e([De(1,T(C))],q);function z(e,t=""){if(!t)return["body"];const{headers:n,footers:s}=e.getSnapshot();if(n==null&&s==null)throw new Error("Document data model must have headers or footers when update by segment id");if(n?.[t]!=null)return["headers",t,"body"];if(s?.[t]!=null)return["footers",t,"body"];throw new Error("Segment id not found in headers or footers")}function ke(e,t,n){const{unitId:s,segmentId:i}=t,r=e.get(m).getUnit(s);if(!r)return!1;const o={id:b.id,params:{unitId:t.unitId,actions:[],textRanges:void 0}},a=x.getInstance(),c=M.customRange.add({...t,body:n});if(!c)return!1;const l=z(r,i);return o.params.actions=a.editOp(c.serialize(),l),o}function Ae(e,t){var n;const{rangeId:s,rangeType:i,wholeEntity:r,properties:o,unitId:a,selections:c}=t,l=e.get(p),_=e.get(m),u=c??l.getTextRanges({unitId:a,subUnitId:a}),g=(n=u?.[0])==null?void 0:n.segmentId;if(!(u!=null&&u.length))return!1;const f=_.getUnit(a,w.UNIVER_DOC);if(!f)return!1;const S=f.getSelfOrHeaderFooterModel(g).getBody();if(!S)return!1;const h=M.customRange.add({ranges:u,rangeId:s,rangeType:i,segmentId:g,wholeEntity:r,properties:o,body:S});if(!h)return!1;const I=x.getInstance(),R={id:b.id,params:{unitId:a,actions:[],textRanges:h.selections,segmentId:g},textX:h},U=z(f,g);return R.params.actions=I.editOp(h.serialize(),U),R}function Pe(e,t){const{unitId:n,segmentId:s,insert:i}=t,r=e.get(m).getUnit(n);if(!r)return!1;const o={id:b.id,params:{unitId:t.unitId,actions:[],textRanges:void 0,segmentId:s}},a=x.getInstance(),c=M.customRange.delete({documentDataModel:r,rangeId:t.rangeId,insert:i,segmentId:s});if(!c)return!1;const l=z(r,s);return o.params.actions=a.editOp(c.serialize(),l),o.params.textRanges=c.selections,o}function ze(e,t){var n,s,i,r;const{unitId:o,body:a,doc:c}=t;let l=c;if(l||(l=e.get(m).getUnit(o)),!l)return!1;const _=(n=t.selection)==null?void 0:n.segmentId,u=(s=l.getSelfOrHeaderFooterModel(_))==null?void 0:s.getBody();if(!u)return!1;const g=e.get(p),f=(i=t.selection)!=null?i:g.getActiveTextRange();if(!f||!u)return!1;const S=(r=t.textRanges)!=null?r:[{startOffset:f.startOffset+a.dataStream.length,endOffset:f.startOffset+a.dataStream.length,collapsed:!0,segmentId:_}],h=M.selection.replace({selection:f,body:a,doc:l});if(!h)return!1;const I={id:b.id,params:{unitId:o,actions:[],textRanges:S,debounce:!0,segmentId:_},textX:h},R=x.getInstance();return I.params.actions=R.editOp(h.serialize()),I}export{B as DOC_INTERCEPTOR_POINT,q as DocInterceptorService,p as DocSelectionManagerService,C as DocSkeletonManagerService,ee as DocStateEmitService,b as RichTextEditingMutation,P as SetTextSelectionsOperation,J as UniverDocsPlugin,Ae as addCustomRangeBySelectionFactory,ke as addCustomRangeFactory,Pe as deleteCustomRangeFactory,ze as replaceSelectionFactory};
