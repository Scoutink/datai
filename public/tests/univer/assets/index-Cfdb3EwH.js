import{L as q,b6 as $,aB as Ae,da as me,aC as En,g6 as It,f$ as He,gd as Ot,bR as G,bQ as ee,ea as zt,c7 as j,aG as Re,i as qt,bi as V,c$ as wt,bt as H,d0 as Y,Q as Rn,aA as le,bH as Cn,u as Xe,bB as ct,c5 as An,fk as Nn,bl as ht,dj as $e,e as oe,g9 as Kt,aN as et,cz as Pn,f0 as Un,f_ as xt,d5 as Ce,H as kn,d6 as Ln,co as Bn,ak as jn,aj as _t,e8 as Xt,gf as Mt,bx as Et,aO as Fn,aY as Wn,aF as pt,g8 as Gn,aw as $n,gl as Hn,bm as J,bo as Yt,b7 as Vn,ba as zn,b9 as Jt,bw as qn}from"./index-BI8deSNo.js";import{IDocDrawingService as Ne,UniverDocsDrawingPlugin as Kn}from"./index-CFmm7TGw.js";import{DocSkeletonManagerService as ie,DocSelectionManagerService as St,RichTextEditingMutation as te}from"./index-GTTB9Gpg.js";import{SetDocZoomRatioOperation as Qt,docDrawingPositionToTransform as Zt,getCustomBlockIdsInSelections as Xn,getRichTextEditPath as Ve,DocSelectionRenderService as Oe,NodePositionConvertToCursor as Rt,getOneTextSelectionRange as Ct,getAnchorBounding as Yn,TEXT_RANGE_LAYER_INDEX as Jn,getDocObject as Qn,VIEWPORT_KEY as en,DocPrintInterceptorService as Zn,DocCanvasPopManagerService as ei,IEditorService as ti}from"./index-C5GuqOxb.js";import{aa as Q,c as At,bK as ni,E as ke,ai as tn,aw as Nt,H as Pt,bm as ii,aG as ri,bI as si,bd as ai}from"./index-DnxWP_AP.js";import{i as Ut,ae as oi,ak as m,ai as di,aj as z,J as kt,o as Te,f as Ue,a4 as nn,p as Lt,u as ci}from"./index-BmfxE5KL.js";import{IDrawingManagerService as ue,DRAWING_IMAGE_ALLOW_IMAGE_LIST as li,DRAWING_IMAGE_COUNT_LIMIT as Bt,DRAWING_IMAGE_ALLOW_SIZE as ui,getImageSize as gi,getDrawingShapeKeyByDrawingSearch as hi,DRAWING_IMAGE_WIDTH_LIMIT as jt,DRAWING_IMAGE_HEIGHT_LIMIT as Ft,UniverDrawingPlugin as pi}from"./index-u4QJ_A0o.js";import{bE as fi,aj as mi,an as Le,b8 as vi,bt as fe,aH as Ii,ao as rn,ba as sn,ax as wi,P as _i,ae as Si,ac as Di,n as yi,w as an,ad as bi,ai as Ti}from"./index-BeEHzc6r.js";import{ImageCropperObject as Oi,COMPONENT_IMAGE_POPUP_MENU as xi,OpenImageCropOperation as Mi,ImageResetSizeOperation as Ei,DrawingCommonPanel as Ri,UniverDrawingUIPlugin as Ci,DrawingRenderService as on}from"./index-CLJ8XlZf.js";import{t as Wt}from"./takeUntil-BWepI5Pd.js";import"./bufferTime-Dc1Jgi3q.js";import"./shareReplay-DR2HpNHE.js";import"./isObservable-DLg0_x3m.js";var Ai=Object.defineProperty,Ni=(e,t,n)=>t in e?Ai(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,we=(e,t,n)=>Ni(e,typeof t!="symbol"?t+"":t,n);const Dt={id:"doc.command.remove-doc-image",type:q.COMMAND,handler:(e,t)=>{var n,i,r,s;const a=e.get($),c=e.get(V),d=e.get(Q),o=c.getCurrentUniverDocInstance();if(t==null||o==null)return!1;const u=d.getRenderById(t.unitId).with(Oe),{drawings:g}=t,h=(n=u.getSegment())!=null?n:"",p=new wt,l=H.getInstance(),v=(r=(i=o.getSelfOrHeaderFooterModel(h).getBody())==null?void 0:i.customBlocks)!=null?r:[],I=g.map(E=>v.find(f=>f.blockId===E.drawingId)).filter(E=>!!E).sort((E,f)=>E.startIndex>f.startIndex?1:-1),O=g[0].unitId,w=new Cn;w.reset();const y=I[0].startIndex,b=[{startOffset:y,endOffset:y}],S={id:te.id,params:{unitId:O,actions:[],textRanges:b}},M=[];for(const E of I){const{startIndex:f}=E;f>w.cursor&&p.push({t:Y.RETAIN,len:f-w.cursor}),p.push({t:Y.DELETE,len:1}),w.moveCursorTo(f+1)}const L=Ve(o,h);M.push(l.editOp(p.serialize(),L));for(const E of I){const{blockId:f}=E,R=((s=o.getDrawings())!=null?s:{})[f],F=o.getDrawingsOrder().indexOf(f),C=l.removeOp(["drawings",f],R),B=l.removeOp(["drawingsOrder",F],f);M.push(C),M.push(B)}return S.params.actions=M.reduce((E,f)=>H.compose(E,f),null),!!a.syncExecuteCommand(S.id,S.params)}},dn={id:"doc.command.delete-drawing",type:q.COMMAND,handler:e=>{const t=e.get($),n=e.get(Ne).getFocusDrawings();if(n.length===0)return!1;const{unitId:i}=n[0],r=n.map(s=>{const{unitId:a,subUnitId:c,drawingId:d,drawingType:o}=s;return{unitId:a,subUnitId:c,drawingId:d,drawingType:o}});return t.executeCommand(Dt.id,{unitId:i,drawings:r})}},cn={id:"doc.command.group-doc-image",type:q.COMMAND,handler:(e,t)=>{e.get($),e.get(qt);const n=e.get(Ne);if(!t)return!1;const i=[];t.forEach(({parent:u,children:g})=>{i.push(u.unitId),g.forEach(h=>{i.push(h.unitId)})});const r=n.getGroupDrawingOp(t),{unitId:s,subUnitId:a,undo:c,redo:d,objects:o}=r;return!1}},yt={id:"doc.command.insert-doc-image",type:q.COMMAND,handler:(e,t)=>{var n,i,r,s;if(t==null)return!1;const a=e.get($),c=e.get(St),d=e.get(V),o=c.getActiveTextRange(),u=d.getCurrentUniverDocInstance();if(o==null||u==null)return!1;const g=u.getUnitId(),{drawings:h}=t,{collapsed:p,startOffset:l,segmentId:v}=o,I=u.getSelfOrHeaderFooterModel(v).getBody();if(I==null)return!1;const O=new wt,w=H.getInstance(),y=[],b=(i=(n=u.getSnapshot().drawingsOrder)==null?void 0:n.length)!=null?i:0;let S=0;if(p)l>0&&O.push({t:Y.RETAIN,len:l});else{const f=Rn.selection.delete([o],I,0,null,!1);O.push(...f);const R=Xn(I,[o]),F=(r=u.getDrawings())!=null?r:{},C=(s=u.getDrawingsOrder())!=null?s:[],B=R.sort((_,x)=>C.indexOf(_)>C.indexOf(x)?-1:C.indexOf(_)<C.indexOf(x)?1:0);if(B.length>0)for(const _ of B){const x=F[_],D=C.indexOf(_);if(x==null||D<0)continue;const T=w.removeOp(["drawings",_],x),N=w.removeOp(["drawingsOrder",D],_);y.push(T),y.push(N),S++}}O.push({t:Y.INSERT,body:{dataStream:"\b".repeat(h.length),customBlocks:h.map((f,R)=>({startIndex:R,blockId:f.drawingId}))},len:h.length});const M=Ve(u,v),L=w.editOp(O.serialize(),M);y.push(L);for(const f of h){const{drawingId:R}=f,F=w.insertOp(["drawings",R],f),C=w.insertOp(["drawingsOrder",b-S],R);y.push(F),y.push(C)}const E={id:te.id,params:{unitId:g,actions:[],textRanges:[]}};return E.params.actions=y.reduce((f,R)=>H.compose(f,R),null),!!a.syncExecuteCommand(E.id,E.params)}},ln={id:"doc.command.set-drawing-arrange",type:q.COMMAND,handler:(e,t)=>{const n=e.get($),i=e.get(Ne);if(t==null)return!1;const{unitId:r,subUnitId:s,drawingIds:a,arrangeType:c}=t,d={unitId:r,subUnitId:s,drawingIds:a};let o;if(c===Xe.forward?o=i.getForwardDrawingsOp(d):c===Xe.backward?o=i.getBackwardDrawingOp(d):c===Xe.front?o=i.getFrontDrawingsOp(d):c===Xe.back&&(o=i.getBackDrawingsOp(d)),o==null)return!1;const{redo:u}=o;if(u==null)return!1;const g=[];let h=Ce.deepClone(u);h=h.slice(3),h.unshift("drawingsOrder"),g.push(h);const p={id:te.id,params:{unitId:r,actions:[],textRanges:null}};return p.params.actions=g.reduce((l,v)=>H.compose(l,v),null),!!n.syncExecuteCommand(p.id,p.params)}},un={id:"doc.command.ungroup-doc-image",type:q.COMMAND,handler:(e,t)=>{e.get($),e.get(qt);const n=e.get(Ne);if(!t)return!1;const i=[];t.forEach(({parent:u,children:g})=>{i.push(u.unitId),g.forEach(h=>{i.push(h.unitId)})});const r=n.getUngroupDrawingOp(t),{unitId:s,subUnitId:a,undo:c,redo:d,objects:o}=r;return!1}};class lt{constructor(){we(this,"_refreshDrawings$",new It(null)),we(this,"refreshDrawings$",this._refreshDrawings$.asObservable())}refreshDrawings(t){this._refreshDrawings$.next(t)}}var Pi=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},de=(e,t)=>(n,i)=>t(n,i,e);let tt=class extends Ae{constructor(e,t,n,i,r,s,a,c,d,o,u,g,h){super(),this._context=e,this._commandService=t,this._docSelectionManagerService=n,this._renderManagerSrv=i,this._imageIoService=r,this._docDrawingService=s,this._drawingManagerService=a,this._contextService=c,this._messageService=d,this._localeService=o,this._docSelectionRenderService=u,this._docRefreshDrawingsService=g,this._fileOpenerService=h,this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener(),this._transformDrawingListener(),this._editAreaChangeListener()}dispose(){super.dispose(),delete this._context}async insertDocImage(){const e=await this._fileOpenerService.openFile({multiple:!0,accept:li.map(n=>`.${n.replace("image/","")}`).join(",")}),t=e.length;return t>Bt?(this._messageService.show({type:Ut.Error,content:this._localeService.t("update-status.exceedMaxCount",String(Bt))}),!1):t===0?!1:(await this._insertFloatImages(e),!0)}async _insertFloatImages(e){let t=[];try{t=await Promise.all(e.map(r=>this._imageIoService.saveImage(r)))}catch(r){const s=r.message;let a="";switch(s){case ht.ERROR_EXCEED_SIZE:a=this._localeService.t("update-status.exceedMaxSize",String(ui/(1024*1024)));break;case ht.ERROR_IMAGE_TYPE:a=this._localeService.t("update-status.invalidImageType");break;case ht.ERROR_IMAGE:a=this._localeService.t("update-status.invalidImage");break}this._messageService.show({type:Ut.Error,content:a})}if(t.length===0)return;const{unitId:n}=this._context,i=[];for(const r of t){if(r==null)continue;const{imageId:s,imageSourceType:a,source:c,base64Cache:d}=r,{width:o,height:u,image:g}=await gi(d||"");this._imageIoService.addImageSourceCache(s,a,g);let h=1;if(o>jt||u>Ft){const v=jt/o,I=Ft/u;h=Math.min(v,I)}const p=this._getImagePosition(o*h,u*h);if(p==null)return;const l={unitId:n,subUnitId:n,drawingId:s,drawingType:Re.DRAWING_IMAGE,imageSourceType:a,source:c,transform:Zt(p),docTransform:p,behindDoc:oe.FALSE,title:"",description:"",layoutType:j.INLINE,wrapText:$e.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0};this._isInsertInHeaderFooter()&&(l.isMultiTransform=oe.TRUE,l.transforms=l.transform?[l.transform]:null),i.push(l)}this._commandService.executeCommand(yt.id,{unitId:n,drawings:i})}_isInsertInHeaderFooter(){var e;const{unitId:t}=this._context,n=(e=this._renderManagerSrv.getRenderById(t))==null?void 0:e.with(ie).getViewModel(),i=n?.getEditArea();return i===ke.HEADER||i===ke.FOOTER}_getImagePosition(e,t){const n=this._docSelectionRenderService.getActiveTextRange(),i=n?.getAbsolutePosition()||{left:0};return{size:{width:e,height:t},positionH:{relativeFrom:ee.PAGE,posOffset:i.left},positionV:{relativeFrom:G.PARAGRAPH,posOffset:0},angle:0}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(e=>{const{unitId:t,subUnitId:n,drawingIds:i,arrangeType:r}=e;this._commandService.executeCommand(ln.id,{unitId:t,subUnitId:n,drawingIds:i,arrangeType:r})}))}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(e=>{this._commandService.executeCommand(cn.id,e)})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(e=>{this._commandService.executeCommand(un.id,e)}))}_getCurrentSceneAndTransformer(){const{scene:e,mainComponent:t}=this._context;if(e==null||t==null)return;const n=e.getTransformerByCreate(),{docsLeft:i,docsTop:r}=t.getOffsetConfig();return{scene:e,transformer:n,docsLeft:i,docsTop:r}}_transformDrawingListener(){const e=this._getCurrentSceneAndTransformer();if(e&&e.transformer)this.disposeWithMe(e.transformer.changeEnd$.pipe(Kt(30)).subscribe(t=>{this._docSelectionManagerService.refreshSelection()}));else throw new Error("transformer is not init")}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(e=>{var t;const{transformer:n,docsLeft:i,docsTop:r}=(t=this._getCurrentSceneAndTransformer())!=null?t:{};if(e==null||e.length===0)this._contextService.setContextValue(et,!1),this._docDrawingService.focusDrawing([]),n&&n.resetProps({zeroTop:0,zeroLeft:0});else{this._contextService.setContextValue(et,!0),this._docDrawingService.focusDrawing(e),this._setDrawingSelections(e);const s=this._docSelectionRenderService.getSegment(),a=this._findSegmentIdByDrawingId(e[0].drawingId);s!==a&&this._docSelectionRenderService.setSegment(a),n&&n.resetProps({zeroTop:r,zeroLeft:i})}}))}_findSegmentIdByDrawingId(e){var t,n,i;const{unit:r}=this._context,{body:s,headers:a={},footers:c={}}=r.getSnapshot();if(((t=s?.customBlocks)!=null?t:[]).some(d=>d.blockId===e))return"";for(const d of Object.keys(a))if((n=a[d].body.customBlocks)!=null&&n.some(o=>o.blockId===e))return d;for(const d of Object.keys(c))if((i=c[d].body.customBlocks)!=null&&i.some(o=>o.blockId===e))return d;return""}_updateDrawingsEditStatus(){var e;if(!this._context)return;const{unit:t,scene:n,unitId:i}=this._context,r=(e=this._renderManagerSrv.getRenderById(i))==null?void 0:e.with(ie).getViewModel();if(r==null||t==null)return;const s=t.getSnapshot(),{drawings:a={}}=s,c=r.getEditArea()===ke.BODY;for(const d of Object.keys(a)){const o=a[d],u=hi({unitId:i,drawingId:o.drawingId,subUnitId:i}),g=n.fuzzyMathObjects(u,!0);if(g.length)for(const h of g){n.detachTransformerFrom(h);try{h.setOpacity(.5)}catch{}if(c&&o.isMultiTransform!==oe.TRUE||!c&&o.isMultiTransform===oe.TRUE){o.allowTransform!==!1&&n.attachTransformerTo(h);try{h.setOpacity(1)}catch{}}}}}_editAreaChangeListener(){var e;const{unitId:t}=this._context,n=(e=this._renderManagerSrv.getRenderById(t))==null?void 0:e.with(ie).getViewModel();n!=null&&(this._updateDrawingsEditStatus(),this.disposeWithMe(n.editAreaChange$.subscribe(()=>{this._updateDrawingsEditStatus()})),this.disposeWithMe(this._docRefreshDrawingsService.refreshDrawings$.subscribe(i=>{i!=null&&queueMicrotask(()=>{this._updateDrawingsEditStatus()})})),this.disposeWithMe(this._commandService.onCommandExecuted(async i=>{i.id===te.id&&queueMicrotask(()=>{this._updateDrawingsEditStatus()})})))}_setDrawingSelections(e){var t,n;const{unit:i}=this._context,r=(n=(t=i.getSnapshot().body)==null?void 0:t.customBlocks)!=null?n:[],s=e.map(a=>{const c=a.drawingId,d=r.find(o=>o.blockId===c);return d?d.startIndex:null}).filter(a=>a!==null).map(a=>({startOffset:a,endOffset:a+1}));this._docSelectionManagerService.replaceDocRanges(s)}};tt=Pi([de(1,$),de(2,J(St)),de(3,Q),de(4,zn),de(5,Ne),de(6,ue),de(7,Jt),de(8,Si),de(9,J(ct)),de(10,J(Oe)),de(11,J(lt)),de(12,Di)],tt);const gn={id:"doc.command.insert-float-image",type:q.COMMAND,handler:e=>{var t,n;const i=e.get(V),r=e.get(Q);return(n=(t=ni(me.UNIVER_DOC,i,r))==null?void 0:t.with(tt).insertDocImage())!=null?n:!1}};var ce=(e=>(e.INLINE="inline",e.BEHIND_TEXT="behindText",e.IN_FRONT_OF_TEXT="inFrontOfText",e.WRAP_SQUARE="wrapSquare",e.WRAP_TOP_AND_BOTTOM="wrapTopAndBottom",e))(ce||{});const Ui={inline:j.INLINE,wrapSquare:j.WRAP_SQUARE,wrapTopAndBottom:j.WRAP_TOP_AND_BOTTOM,inFrontOfText:j.WRAP_NONE,behindText:j.WRAP_NONE};function hn(e,t,n,i,r,s,a){var c,d;const o=new wt,u=H.getInstance(),g=[],h=s.getSelfOrHeaderFooterModel(t).getBody(),p=s.getSelfOrHeaderFooterModel(e).getBody();if(h==null||p==null)return;const l=(d=(c=h.customBlocks)==null?void 0:c.find(v=>v.blockId===r))==null?void 0:d.startIndex;if(l!=null){if(i=Math.min(p.dataStream.length-2,i),e===t){if(i<l?(i>0&&o.push({t:Y.RETAIN,len:i}),o.push({t:Y.INSERT,body:{dataStream:"\b",customBlocks:[{startIndex:0,blockId:r}]},len:1}),o.push({t:Y.RETAIN,len:l-i}),o.push({t:Y.DELETE,len:1})):(l>0&&o.push({t:Y.RETAIN,len:l}),o.push({t:Y.DELETE,len:1}),i-l-1>0&&o.push({t:Y.RETAIN,len:i-l-1}),o.push({t:Y.INSERT,body:{dataStream:"\b",customBlocks:[{startIndex:0,blockId:r}]},len:1})),i!==l){const v=Ve(s,t),I=u.editOp(o.serialize(),v);g.push(I)}}else{l>0&&o.push({t:Y.RETAIN,len:l}),o.push({t:Y.DELETE,len:1});let v=Ve(s,t),I=u.editOp(o.serialize(),v);g.push(I),o.empty(),i>0&&o.push({t:Y.RETAIN,len:i}),o.push({t:Y.INSERT,body:{dataStream:"\b",customBlocks:[{startIndex:0,blockId:r}]},len:1}),v=Ve(s,e),I=u.editOp(o.serialize(),v),g.push(I),a.setSegment(e),a.setSegmentPage(n)}return g}}const pn={id:"doc.command.update-doc-drawing-wrapping-style",type:q.COMMAND,handler:(e,t)=>{var n,i;if(t==null)return!1;const{drawings:r,wrappingStyle:s,unitId:a}=t,c=e.get($),d=e.get(V),o=e.get(Q).getRenderById(a),u=o?.with(ie).getSkeleton().getSkeletonData(),g=o?.with(ie).getViewModel(),h=o?.scene,p=d.getCurrentUniverDocInstance();if(p==null||u==null||h==null||g==null)return!1;const l=g.getEditArea(),v=h.getTransformerByCreate(),{pages:I,skeHeaders:O,skeFooters:w}=u,y=H.getInstance(),b=[],{drawings:S={}}=p.getSnapshot();for(const E of r){const{drawingId:f}=E,R=S[f].layoutType,F=Ui[s];if(R!==F){const x=y.replaceOp(["drawings",f,"layoutType"],R,F);b.push(x)}if(s==="behindText"||s==="inFrontOfText"){const x=S[f].behindDoc,D=s==="behindText"?oe.TRUE:oe.FALSE;if(x!==D){const T=y.replaceOp(["drawings",f,"behindDoc"],x,D);b.push(T)}}if(s==="inline")continue;let C=null,B=0,_=0;for(const x of I){const{headerId:D,footerId:T,marginTop:N,marginLeft:P,marginBottom:W,pageWidth:U,pageHeight:A}=x;switch(l){case ke.HEADER:{const k=(n=O.get(D))==null?void 0:n.get(U);k!=null&&k.skeDrawings.has(f)&&(C=k.skeDrawings.get(f),B=k.marginTop,_=P);break}case ke.FOOTER:{const k=(i=w.get(T))==null?void 0:i.get(U);k!=null&&k.skeDrawings.has(f)&&(C=k.skeDrawings.get(f),B=A-W+k.marginTop,_=P);break}case ke.BODY:{x.skeDrawings.has(f)&&(C=x.skeDrawings.get(f),B=N,_=P);break}}if(C!=null)break}if(C!=null){const{aTop:x,aLeft:D}=C,T=S[f].docTransform.positionH;let N=D;T.relativeFrom===ee.MARGIN?N-=_:T.relativeFrom===ee.COLUMN&&(N-=C.columnLeft);const P={relativeFrom:T.relativeFrom,posOffset:N};if(T.posOffset!==P.posOffset){const k=y.replaceOp(["drawings",f,"docTransform","positionH"],T,P);b.push(k)}const W=S[f].docTransform.positionV;let U=x;W.relativeFrom===G.PAGE?U+=B:W.relativeFrom===G.LINE?U-=C.lineTop:W.relativeFrom===G.PARAGRAPH&&(U-=C.blockAnchorTop);const A={relativeFrom:W.relativeFrom,posOffset:U};if(W.posOffset!==A.posOffset){const k=y.replaceOp(["drawings",f,"docTransform","positionV"],W,A);b.push(k)}}}const M={id:te.id,params:{unitId:a,actions:[],textRanges:null}};M.params.actions=b.reduce((E,f)=>H.compose(E,f),null);const L=c.syncExecuteCommand(M.id,M.params);return v.refreshControls(),!!L}},fn={id:"doc.command.update-doc-drawing-distance",type:q.COMMAND,handler:(e,t)=>{if(t==null)return!1;const n=e.get($),i=e.get(V).getCurrentUniverDocInstance();if(i==null)return!1;const{drawings:r,dist:s,unitId:a}=t,c=H.getInstance(),d=[],{drawings:o={}}=i.getSnapshot();for(const g of r){const{drawingId:h}=g;for(const[p,l]of Object.entries(s)){const v=o[h][p];if(v!==l){const I=c.replaceOp(["drawings",h,p],v,l);d.push(I)}}}const u={id:te.id,params:{unitId:a,actions:[],textRanges:null}};return u.params.actions=d.reduce((g,h)=>H.compose(g,h),null),!!n.syncExecuteCommand(u.id,u.params)}},mn={id:"doc.command.update-doc-drawing-wrap-text",type:q.COMMAND,handler:(e,t)=>{if(t==null)return!1;const n=e.get($),i=e.get(V).getCurrentUniverDocInstance();if(i==null)return!1;const{drawings:r,wrapText:s,unitId:a}=t,c=H.getInstance(),d=[],{drawings:o={}}=i.getSnapshot();for(const g of r){const{drawingId:h}=g,p=o[h].wrapText;if(p!==s){const l=c.replaceOp(["drawings",h,"wrapText"],p,s);d.push(l)}}const u={id:te.id,params:{unitId:a,actions:[],textRanges:null}};return u.params.actions=d.reduce((g,h)=>H.compose(g,h),null),!!n.syncExecuteCommand(u.id,u.params)}},ze={id:"doc.command.update-drawing-doc-transform",type:q.COMMAND,handler:(e,t)=>{if(t==null)return!1;const n=e.get($),i=e.get(V),r=e.get(Q).getRenderById(t.unitId),s=r?.scene;if(s==null)return!1;const a=s.getTransformerByCreate(),c=i.getCurrentUniverDocInstance();if(c==null)return!1;const{drawings:d,unitId:o}=t,u=H.getInstance(),g=[],{drawings:h={}}=c.getSnapshot();for(const v of d){const{drawingId:I,key:O,value:w}=v,y=h[I].docTransform[O];if(!Ce.diffValue(y,w)){const b=u.replaceOp(["drawings",I,"docTransform",O],y,w);g.push(b)}}const p={id:te.id,params:{unitId:o,actions:[],textRanges:null,debounce:!0}};p.params.actions=g.reduce((v,I)=>H.compose(v,I),null);const l=n.syncExecuteCommand(p.id,p.params);return a.refreshControls(),!!l}},vn={id:"doc.command.move-inline-drawing",type:q.COMMAND,handler:(e,t)=>{var n,i;if(t==null)return!1;const r=e.get(Q),s=(n=r.getRenderById(t.unitId))==null?void 0:n.with(Oe),a=e.get(lt),c=r.getRenderById(t.unitId),d=c?.scene,o=c?.with(ie).getSkeleton();if(d==null||s==null)return!1;const u=d.getTransformerByCreate(),g=e.get($),h=e.get(V).getCurrentUniverDocInstance();if(h==null)return!1;const{drawing:p,unitId:l,offset:v,segmentId:I,segmentPage:O,needRefreshDrawings:w}=t;if(w)return a.refreshDrawings(o),u.refreshControls(),!0;const y=[],{drawingId:b}=p,S=(i=s.getSegment())!=null?i:"",M=hn(I,S,O,v,b,h,s);if(M==null||M.length===0)return a.refreshDrawings(o),u.refreshControls(),!1;y.push(...M);const L={id:te.id,params:{unitId:l,actions:[],textRanges:null}};L.params.actions=y.reduce((f,R)=>H.compose(f,R),null);const E=g.syncExecuteCommand(L.id,L.params);return u.refreshControls(),!!E}},In={id:"doc.command.transform-non-inline-drawing",type:q.COMMAND,handler:(e,t)=>{var n,i;if(t==null)return!1;const r=e.get(Q),s=(n=r.getRenderById(t.unitId))==null?void 0:n.with(Oe),a=r.getRenderById(t.unitId),c=a?.scene;if(c==null||s==null)return!1;const d=c.getTransformerByCreate(),o=e.get($),u=e.get(V).getCurrentUniverDocInstance();if(u==null)return!1;const{drawing:g,unitId:h,offset:p,docTransform:l,segmentId:v,segmentPage:I}=t,O=[],{drawingId:w}=g,y=(i=s.getSegment())!=null?i:"",b=hn(v,y,I,p,w,u,s);if(b==null)return!1;b.length>0&&O.push(...b);const S=H.getInstance(),{drawings:M={}}=u.getSnapshot(),L=M[w].docTransform,{positionH:E,positionV:f,size:R,angle:F}=L;if(!Ce.diffValue(E,l.positionH)){const _=S.replaceOp(["drawings",w,"docTransform","positionH"],E,l.positionH);O.push(_)}if(!Ce.diffValue(f,l.positionV)){const _=S.replaceOp(["drawings",w,"docTransform","positionV"],f,l.positionV);O.push(_)}if(!Ce.diffValue(R,l.size)){const _=S.replaceOp(["drawings",w,"docTransform","size"],R,l.size);O.push(_)}if(!Ce.diffValue(F,l.angle)){const _=S.replaceOp(["drawings",w,"docTransform","angle"],F,l.angle);O.push(_)}const C={id:te.id,params:{unitId:h,actions:[],textRanges:null,debounce:!0}};C.params.actions=O.reduce((_,x)=>H.compose(_,x),null);const B=o.syncExecuteCommand(C.id,C.params);return d.refreshControls(),!!B}},qe={id:"doc.command.move-drawing",type:q.COMMAND,handler:(e,t)=>{const n=e.get($),i=e.get(Ne),r=e.get(V),s=e.get(Q),{direction:a}=t,c=i.getFocusDrawings();if(c.length===0)return!1;const d=c[0].unitId,o=s.getRenderById(d),u=o?.scene;if(u==null)return!1;const g=u.getTransformerByCreate(),h=r.getUniverDocInstance(d),p=c.map(v=>{var I,O,w,y,b;const{drawingId:S}=v,M=(I=h?.getSnapshot().drawings)==null?void 0:I[S];if(M==null||M.layoutType===j.INLINE)return null;const{positionH:L,positionV:E}=M.docTransform,f={...L},R={...E};return a===le.UP?R.posOffset=((O=R.posOffset)!=null?O:0)-2:a===le.DOWN?R.posOffset=((w=R.posOffset)!=null?w:0)+2:a===le.LEFT?f.posOffset=((y=f.posOffset)!=null?y:0)-2:a===le.RIGHT&&(f.posOffset=((b=f.posOffset)!=null?b:0)+2),{drawingId:S,key:a===le.UP||a===le.DOWN?"positionV":"positionH",value:a===le.UP||a===le.DOWN?R:f}}).filter(v=>v!=null);if(p.length===0)return!1;const l=n.syncExecuteCommand(ze.id,{unitId:d,subUnitId:d,drawings:p});return g.refreshControls(),!!l}},ki={id:"doc.operation.clear-drawing-transformer",type:q.MUTATION,handler:(e,t)=>{const n=e.get(Q);return t.forEach(i=>{var r,s;(s=(r=n.getRenderById(i))==null?void 0:r.scene.getTransformer())==null||s.debounceRefreshControls()}),!0}},wn="COMPONENT_DOC_DRAWING_PANEL",_n={id:"sidebar.operation.doc-image",type:q.COMMAND,handler:async(e,t)=>{const n=e.get(mi),i=e.get(ct),r=e.get(ue);return t.value==="open"?n.open({header:{title:i.t("docImage.panel.title")},children:{label:wn},onClose:()=>{r.focusDrawing(null)},width:360}):n.close(),!0}},Sn={id:"doc.operation.edit-doc-image",type:q.OPERATION,handler:(e,t)=>{const n=e.get(ue),i=e.get($);return t==null?!1:(n.focusDrawing([t]),i.executeCommand(_n.id,{value:"open"}),!0)}};var Li=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},Pe=(e,t)=>(n,i)=>t(n,i,e);function Dn(e,t,n=1,i=0){const{top:r,left:s,bottom:a,right:c}=e,d=c-s,o=a-r,u=t.getViewport(en.VIEW_MAIN),{viewportScrollX:g,viewportScrollY:h}=u,{scaleX:p,scaleY:l}=t.getAncestorScale();return{startX:(s-g)*p,startY:(r-h)*l,endX:(s+d-g)*p,endY:(r+o-h)*l,width:d*p,height:o*l,rotate:i,absolute:{left:!1,top:!1},opacity:n??1}}function ft(e,t){const{top:n,left:i,width:r,height:s,angle:a,opacity:c}=e;return Dn({top:n,left:i,bottom:n+s,right:i+r},t.scene,c,a)}let nt=class extends Ae{constructor(e,t,n,i,r,s){super(),we(this,"_domLayerInfoMap",new Map),this._renderManagerService=e,this._drawingManagerService=t,this._drawingRenderService=n,this._canvasFloatDomService=i,this._univerInstanceService=r,this._commandService=s,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddRemoveListener(),this._initScrollAndZoomEvent()}_getSceneAndTransformerByDrawingSearch(e){if(e==null)return;const t=this._renderManagerService.getRenderById(e);if(t==null)return null;const n=t.scene,i=n.getTransformerByCreate();return{scene:n,transformer:i,renderUnit:t,canvas:t.engine.getCanvasElement()}}_drawingAddRemoveListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{this._insertRects(e)})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(t=>{this._removeDom(t.drawingId)})}))}_insertRects(e){e.forEach(async t=>{const{unitId:n}=t;if(!this._univerInstanceService.getUnit(n,me.UNIVER_DOC))return;const i=this._getSceneAndTransformerByDrawingSearch(n);if(i==null)return;const r=this._drawingManagerService.getDrawingByParam(t);if(r==null)return;const s=await this._drawingRenderService.renderFloatDom(r,i.scene);if(!(s==null||s.length===0))for(const a of s){this._addHoverForRect(a);const c=new En,d=ft(a,i.renderUnit),o=new It(d),u=i.canvas,g=r.data,h={dispose:c,rect:a,position$:o,unitId:n};this._canvasFloatDomService.addFloatDom({position$:o,id:r.drawingId,componentKey:r.componentKey,onPointerDown:l=>{u.dispatchEvent(new PointerEvent(l.type,l))},onPointerMove:l=>{u.dispatchEvent(new PointerEvent(l.type,l))},onPointerUp:l=>{u.dispatchEvent(new PointerEvent(l.type,l))},onWheel:l=>{u.dispatchEvent(new WheelEvent(l.type,l))},data:g,unitId:n});const p=a.onTransformChange$.subscribeEvent(()=>{const l=ft(a,i.renderUnit);o.next(l)});c.add(()=>{this._canvasFloatDomService.removeFloatDom(r.drawingId)}),p&&c.add(p),this._domLayerInfoMap.set(r.drawingId,h)}})}_addHoverForRect(e){this.disposeWithMe(He(e.onPointerEnter$.subscribeEvent(()=>{e.cursor=At.GRAB}))),this.disposeWithMe(He(e.onPointerLeave$.subscribeEvent(()=>{e.cursor=At.DEFAULT})))}_removeDom(e){const t=this._domLayerInfoMap.get(e);if(!t)return;const{unitId:n}=t;this._domLayerInfoMap.delete(e),t.dispose.dispose();const i=this._getSceneAndTransformerByDrawingSearch(n);i&&i.scene.removeObject(t.rect)}_initScrollAndZoomEvent(){const e=t=>{const n=this._getSceneAndTransformerByDrawingSearch(t);n&&this._domLayerInfoMap.forEach(i=>{if(i.unitId!==t)return;const r=ft(i.rect,n.renderUnit);i.position$.next(r)})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(me.UNIVER_DOC).pipe(Ot(t=>{if(!t)return null;const n=t.getUnitId(),i=this._renderManagerService.getRenderById(n);return i?{render:i,unitId:n}:null}),fi(t=>t?Xt(t.render.scene.getViewport(en.VIEW_MAIN).onScrollAfter$).pipe(Ot(()=>({unitId:t.unitId}))):Hn(null))).subscribe(t=>{if(!t)return;const{unitId:n}=t;e(n)})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===Qt.id){const n=t.params,{unitId:i}=n;e(i)}}))}insertFloatDom(e,t){var n,i,r;const s=this._univerInstanceService.getCurrentUnitOfType(me.UNIVER_DOC);if(!s)return!1;const a=this._getSceneAndTransformerByDrawingSearch(s.getUnitId());if(!a)return!1;const c=(n=a.renderUnit.with(ie).getSkeleton().getSkeletonData())==null?void 0:n.pages[0];if(!c)return!1;const{pageWidth:d,marginLeft:o,marginRight:u}=c,g=d-o-u,h={size:{width:(i=t.width)!=null?i:g,height:t.height},positionH:{relativeFrom:ee.PAGE,posOffset:0},positionV:{relativeFrom:G.PAGE,posOffset:0},angle:0},p=(r=t.drawingId)!=null?r:zt(),l={unitId:s.getUnitId(),drawings:[{drawingId:p,drawingType:Re.DRAWING_DOM,subUnitId:s.getUnitId(),unitId:s.getUnitId(),...e,title:"",description:"",docTransform:h,layoutType:j.INLINE,transform:Zt(h)}]};return this._commandService.syncExecuteCommand(yt.id,l),p}};nt=Li([Pe(0,Q),Pe(1,ue),Pe(2,J(on)),Pe(3,J(yi)),Pe(4,V),Pe(5,$)],nt);const Bi="docs-drawing-ui.config",Gt={},$t=-1e3,Ht=1e3,ji=e=>{const t=fe($),n=fe(ct),i=fe(ue),r=fe(Q),s=fe(V),{drawings:a}=e,c=a[0];if(c==null)return;const{unitId:d}=c,o=s.getUniverDocInstance(d),u=o?.getSnapshot().documentStyle.documentFlavor,g=r.getRenderById(d),h=g?.scene;if(h==null)return;const p=h.getTransformerByCreate(),l=[{label:n.t("image-position.column"),value:String(ee.COLUMN)},{label:n.t("image-position.page"),value:String(ee.PAGE)},{label:n.t("image-position.margin"),value:String(ee.MARGIN)}],v=[{label:n.t("image-position.line"),value:String(G.LINE),disabled:u===pt.MODERN},{label:n.t("image-position.page"),value:String(G.PAGE),disabled:u===pt.MODERN},{label:n.t("image-position.margin"),value:String(G.MARGIN),disabled:u===pt.MODERN},{label:n.t("image-position.paragraph"),value:String(G.PARAGRAPH)}],[I,O]=z.useState(!0),[w,y]=z.useState({relativeFrom:ee.PAGE,posOffset:0}),[b,S]=z.useState({relativeFrom:G.PAGE,posOffset:0}),[M,L]=z.useState(!0),[E,f]=z.useState(!0);function R(D,T){var N;D==="positionH"?y(T):S(T);const P=i.getFocusDrawings();if(P.length===0)return;const W=P.map(A=>({unitId:A.unitId,subUnitId:A.subUnitId,drawingId:A.drawingId}));t.executeCommand(ze.id,{unitId:P[0].unitId,subUnitId:P[0].unitId,drawings:W.map(A=>({drawingId:A.drawingId,key:D,value:T}))});const U=(N=r.getRenderById(d))==null?void 0:N.with(Oe);U&&U.blur(),p.refreshControls()}function F(D){var T,N,P;const W=w.relativeFrom,U=w.posOffset,A=Number(D);if(W===A)return;const k=i.getFocusDrawings();if(k.length===0)return;const re=k[0].drawingId,K=k[0].unitId;let ge=null,_e=0;const Se=(T=r.getRenderById(K))==null?void 0:T.with(ie).getSkeleton(),De=Se?.getSkeletonData();if(De==null)return;const{pages:xe,skeHeaders:Z,skeFooters:se}=De;for(const Be of xe){const{marginLeft:pe,skeDrawings:ae,headerId:Ie,footerId:Me,pageWidth:be}=Be;if(ae.has(re)){ge=ae.get(re),_e=pe;break}const ne=(N=Z.get(Ie))==null?void 0:N.get(be);if(ne!=null&&ne.skeDrawings.has(re)){ge=ne?.skeDrawings.get(re),_e=pe;break}const ye=(P=se.get(Me))==null?void 0:P.get(be);if(ye!=null&&ye.skeDrawings.has(re)){ge=ye?.skeDrawings.get(re),_e=pe;break}}if(ge==null)return;let he=0;W===ee.COLUMN?he-=ge.columnLeft:W===ee.MARGIN&&(he-=_e),A===ee.COLUMN?he+=ge.columnLeft:A===ee.MARGIN?he+=_e:ee.PAGE;const ve={relativeFrom:A,posOffset:(U??0)-he};R("positionH",ve)}function C(D){var T,N,P,W,U,A;const k=b.relativeFrom,re=b.posOffset,K=Number(D);if(k===K)return;const ge=i.getFocusDrawings();if(ge.length===0)return;const{drawingId:_e,unitId:Se}=ge[0],De=s.getUniverDocInstance(Se),xe=(T=r.getRenderById(Se))==null?void 0:T.with(ie).getSkeleton(),Z=(N=r.getRenderById(Se))==null?void 0:N.with(Oe),se=Z?.getSegment(),he=Z?.getSegmentPage(),ve=(W=(P=De?.getSelfOrHeaderFooterModel(se).getBody())==null?void 0:P.customBlocks)==null?void 0:W.find(X=>X.blockId===_e);if(ve==null||xe==null||Z==null)return;const{startIndex:Be}=ve,pe=xe.findNodeByCharIndex(Be,se,he),ae=(U=pe?.parent)==null?void 0:U.parent,Ie=ae?.parent,Me=Ie?.lines.find(X=>X.paragraphIndex===ae?.paragraphIndex&&X.paragraphStart),be=(A=Ie?.parent)==null?void 0:A.parent;if(pe==null||ae==null||Me==null||Ie==null||be==null)return;let ne=0;k===G.PARAGRAPH?ne-=Me.top:k===G.LINE?ne-=ae.top:k===G.PAGE&&(ne+=be.marginTop),K===G.PARAGRAPH?ne+=Me.top:K===G.LINE?ne+=ae.top:K===G.PAGE&&(ne-=be.marginTop);const ye={relativeFrom:K,posOffset:(re??0)-ne};R("positionV",ye)}function B(D){var T;const N=o?.getSnapshot(),P=(T=N?.drawings)==null?void 0:T[D.drawingId];if(P==null)return;const{layoutType:W}=P,{positionH:U,positionV:A}=P.docTransform;y(U),S(A),O(W===j.INLINE),L(A.relativeFrom===G.PARAGRAPH||A.relativeFrom===G.LINE)}function _(){const D=i.getFocusDrawings();D.length!==0&&B(D[0])}function x(D){L(D),C(String(D?G.PARAGRAPH:G.PAGE))}return z.useEffect(()=>{_();const D=i.focus$.subscribe(N=>{if(N.length===0){f(!1);return}f(!0),B(N[0])}),T=t.onCommandExecuted(async N=>{N.id===te.id&&_()});return()=>{D.unsubscribe(),T.dispose()}},[]),m.jsxs("div",{className:nn("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!E}),children:[m.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-position.title")})}),m.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-position.horizontal")})}),m.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-position.absolutePosition")}),m.jsx(Ue,{min:$t,max:Ht,precision:1,disabled:I,value:w.posOffset,onChange:D=>{R("positionH",{relativeFrom:w.relativeFrom,posOffset:D})}})]}),m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-position.toTheRightOf")}),m.jsx(Lt,{value:String(w.relativeFrom),disabled:I,options:l,onChange:F})]})]}),m.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-position.vertical")})}),m.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-position.absolutePosition")}),m.jsx(Ue,{min:$t,max:Ht,precision:1,disabled:I,value:b.posOffset,onChange:D=>{R("positionV",{relativeFrom:b.relativeFrom,posOffset:D})}})]}),m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-position.bellow")}),m.jsx(Lt,{disabled:I,value:String(b.relativeFrom),options:v,onChange:C})]})]}),m.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-position.options")})}),m.jsx("div",{children:m.jsx(ci,{disabled:I,checked:M,onChange:x,children:n.t("image-position.moveObjectWithText")})})]})},Ye=0,Je=100,Fi=e=>{const t=fe($),n=fe(ct),i=fe(ue),r=fe(Q),s=fe(V),{drawings:a}=e,c=a[0];if(c==null)return null;const{unitId:d}=c,o=s.getUniverDocInstance(d),u=r.getRenderById(d);if(u?.scene==null)return null;const[g,h]=z.useState(!0),[p,l]=z.useState(!0),[v,I]=z.useState(!0),[O,w]=z.useState(ce.INLINE),[y,b]=z.useState(""),[S,M]=z.useState({distT:0,distL:0,distB:0,distR:0}),[L,E]=z.useState(!0);function f(_){w(_);const x=i.getFocusDrawings();if(x.length===0)return;const{unitId:D,subUnitId:T}=x[0],N=x.map(({unitId:P,subUnitId:W,drawingId:U})=>({unitId:P,subUnitId:W,drawingId:U}));t.executeCommand(pn.id,{unitId:D,subUnitId:T,drawings:N,wrappingStyle:_})}function R(_){b(_);const x=i.getFocusDrawings();if(x.length===0)return;const D=x.map(T=>({unitId:T.unitId,subUnitId:T.subUnitId,drawingId:T.drawingId}));t.executeCommand(mn.id,{unitId:x[0].unitId,subUnitId:x[0].unitId,drawings:D,wrapText:_})}function F(_,x){if(_==null)return;const D={...S,[x]:_};M(D);const T=i.getFocusDrawings();if(T.length===0)return;const N=T.map(P=>({unitId:P.unitId,subUnitId:P.subUnitId,drawingId:P.drawingId}));t.executeCommand(fn.id,{unitId:T[0].unitId,subUnitId:T[0].unitId,drawings:N,dist:{[x]:_}})}function C(){const _=i.getFocusDrawings();_.length!==0&&B(_[0])}function B(_){var x,D;const T=(D=(x=o?.getSnapshot())==null?void 0:x.drawings)==null?void 0:D[_.drawingId];if(T==null)return;const{distT:N=0,distL:P=0,distB:W=0,distR:U=0,layoutType:A=j.INLINE,behindDoc:k=oe.FALSE,wrapText:re=$e.BOTH_SIDES}=T;if(M({distT:N,distL:P,distB:W,distR:U}),b(re),h(A!==j.WRAP_SQUARE),A===j.WRAP_NONE||A===j.INLINE?l(!0):l(!1),A===j.WRAP_NONE||A===j.INLINE||A===j.WRAP_TOP_AND_BOTTOM?I(!0):I(!1),A===j.WRAP_NONE)k===oe.TRUE?w(ce.BEHIND_TEXT):w(ce.IN_FRONT_OF_TEXT);else switch(A){case j.INLINE:w(ce.INLINE);break;case j.WRAP_SQUARE:w(ce.WRAP_SQUARE);break;case j.WRAP_TOP_AND_BOTTOM:w(ce.WRAP_TOP_AND_BOTTOM);break;default:throw new Error(`Unsupported layout type: ${A}`)}}return z.useEffect(()=>{C();const _=i.focus$.subscribe(D=>{if(D.length===0){E(!1);return}E(!0),B(D[0])}),x=t.onCommandExecuted(async D=>{D.id===te.id&&C()});return()=>{_.unsubscribe(),x.dispose()}},[]),m.jsxs("div",{className:nn("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!L}),children:[m.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-text-wrap.title")})}),m.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-text-wrap.wrappingStyle")})}),m.jsx("div",{children:m.jsxs(kt,{value:O,onChange:f,direction:"vertical",children:[m.jsx(Te,{value:ce.INLINE,children:n.t("image-text-wrap.inline")}),m.jsx(Te,{value:ce.WRAP_SQUARE,children:n.t("image-text-wrap.square")}),m.jsx(Te,{value:ce.WRAP_TOP_AND_BOTTOM,children:n.t("image-text-wrap.topAndBottom")}),m.jsx(Te,{value:ce.BEHIND_TEXT,children:n.t("image-text-wrap.behindText")}),m.jsx(Te,{value:ce.IN_FRONT_OF_TEXT,children:n.t("image-text-wrap.inFrontText")})]})}),m.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-text-wrap.wrapText")})}),m.jsx("div",{children:m.jsxs(kt,{disabled:g,value:y,onChange:R,direction:"horizontal",children:[m.jsx(Te,{value:$e.BOTH_SIDES,children:n.t("image-text-wrap.bothSide")}),m.jsx(Te,{value:$e.LEFT,children:n.t("image-text-wrap.leftOnly")}),m.jsx(Te,{value:$e.RIGHT,children:n.t("image-text-wrap.rightOnly")})]})}),m.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:m.jsx("div",{children:n.t("image-text-wrap.distanceFromText")})}),m.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-text-wrap.top")}),m.jsx(Ue,{min:Ye,max:Je,disabled:p,precision:1,value:S.distT,onChange:_=>{F(_,"distT")}})]}),m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-text-wrap.left")}),m.jsx(Ue,{min:Ye,max:Je,disabled:v,precision:1,value:S.distL,onChange:_=>{F(_,"distL")}})]})]}),m.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-text-wrap.bottom")}),m.jsx(Ue,{min:Ye,max:Je,disabled:p,precision:1,value:S.distB,onChange:_=>{F(_,"distB")}})]}),m.jsxs("div",{children:[m.jsx("span",{children:n.t("image-text-wrap.right")}),m.jsx(Ue,{min:Ye,max:Je,disabled:v,precision:1,value:S.distR,onChange:_=>{F(_,"distR")}})]})]})]})},Wi=()=>{const e=fe(ue),t=e.getFocusDrawings(),[n,i]=z.useState(t);return z.useEffect(()=>{const r=e.focus$.subscribe(s=>{i(s)});return()=>{r.unsubscribe()}},[]),!!(n!=null&&n.length)&&m.jsxs("div",{className:"univer-text-sm",children:[m.jsx(Ri,{drawings:n,hasAlign:!1,hasCropper:!1,hasGroup:!1,hasTransform:!1}),m.jsx(Fi,{drawings:n}),m.jsx(ji,{drawings:n})]})},yn="doc.menu.image",bn=gn.id,Gi=e=>{const t=e.get(St),n=e.get(V);return new Gn(i=>{const r=t.textSelection$.subscribe(()=>{var s;const a=t.getActiveTextRange();if(a){const{segmentId:c,startOffset:d,endOffset:o}=a,u=n.getCurrentUniverDocInstance(),g=(s=u?.getSelfOrHeaderFooterModel(c).getBody())==null?void 0:s.tables;if(g&&g.length&&g.some(h=>{const{startIndex:p,endIndex:l}=h;return d>=p&&d<l||o>=p&&o<l})){i.next(!0);return}}else{i.next(!0);return}i.next(!1)});return()=>r.unsubscribe()})};function $i(e){return{id:yn,type:rn.SUBITEMS,icon:"AddImageIcon",tooltip:"docImage.title",disabled$:Gi(e),hidden$:sn(e,me.UNIVER_DOC,void 0,_t)}}function Hi(e){return{id:bn,title:"docImage.upload.float",type:rn.BUTTON,hidden$:sn(e,me.UNIVER_DOC,void 0,_t)}}const Vi={[Ii.MEDIA]:{[yn]:{order:0,menuItemFactory:$i,[bn]:{order:0,menuItemFactory:Hi}}}};function Ke(e){return e.getContextValue(Fn)&&e.getContextValue(Wn)&&e.getContextValue(et)}const zi={id:qe.id,description:"shortcut.drawing-move-down",group:"4_drawing-view",binding:Le.ARROW_DOWN,priority:100,preconditions:Ke,staticParameters:{direction:le.DOWN}},qi={id:qe.id,description:"shortcut.drawing-move-up",group:"4_drawing-view",binding:Le.ARROW_UP,priority:100,preconditions:Ke,staticParameters:{direction:le.UP}},Ki={id:qe.id,description:"shortcut.drawing-move-left",group:"4_drawing-view",binding:Le.ARROW_LEFT,priority:100,preconditions:Ke,staticParameters:{direction:le.LEFT}},Xi={id:qe.id,description:"shortcut.drawing-move-right",group:"4_drawing-view",binding:Le.ARROW_RIGHT,priority:100,preconditions:Ke,staticParameters:{direction:le.RIGHT}},Yi={id:dn.id,description:"shortcut.drawing-delete",group:"4_drawing-view",preconditions:Ke,binding:Le.DELETE,mac:Le.BACKSPACE};var Ji=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},Qe=(e,t)=>(n,i)=>t(n,i,e);let it=class extends Ae{constructor(e,t,n,i){super(),this._componentManager=e,this._menuManagerService=t,this._commandService=n,this._shortcutService=i,this._init()}_initCustomComponents(){const e=this._componentManager;this.disposeWithMe(e.register(wn,Wi))}_initMenus(){this._menuManagerService.mergeMenu(Vi)}_initCommands(){[gn,yt,pn,fn,mn,ze,vn,In,Dt,_n,ki,Sn,cn,un,qe,dn,ln].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_initShortcuts(){[zi,qi,Ki,Xi,Yi].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};it=Ji([Qe(0,J(an)),Qe(1,bi),Qe(2,$),Qe(3,Ti)],it);var Qi=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},Fe=(e,t)=>(n,i)=>t(n,i,e);function Zi(e){var t,n,i,r;if(H.isNoop(e)||!Array.isArray(e))return null;const s=e.find(c=>Array.isArray(c)&&c?.[0]==="drawings");if(s==null||!Array.isArray(s)||s.length<3||typeof s[1]=="string"&&typeof s[2]!="object"||Array.isArray(s[1])&&typeof s[1][1]!="object")return null;const a=[];if(Array.isArray(s?.[1]))for(const c of s)Array.isArray(c)&&a.push({type:(t=c?.[1])!=null&&t.i?"add":"remove",drawingId:c?.[0],drawing:(n=c?.[1])==null?void 0:n.i});else a.push({type:(i=s[2])!=null&&i.i?"add":"remove",drawingId:s[1],drawing:(r=s[2])==null?void 0:r.i});return a}function er(e){if(!Array.isArray(e)||e.length<3||e[0]!=="drawingsOrder")return[];const t=[];for(let n=1;n<e.length;n++){const i=e[n];if(Array.isArray(i)&&typeof i[0]=="number"&&typeof i[1]=="object")t.push(i[0]);else{t.length=0;break}}return t}let rt=class extends Ae{constructor(e,t,n,i,r){super(),this._univerInstanceService=e,this._commandService=t,this._drawingManagerService=n,this._docDrawingService=i,this._renderManagerService=r,this._initialize()}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{if(e.id!==te.id)return;const t=e.params,{unitId:n,actions:i}=t,r=Zi(i);if(r!=null)for(const{type:s,drawingId:a,drawing:c}of r)s==="add"?this._addDrawings(n,[c]):this._removeDrawings(n,[a])})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==te.id)return;const t=e.params,{unitId:n,actions:i}=t;er(i).length>0&&this._updateDrawingsOrder(n)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var t;if(e.id!==Ln.id&&e.id!==Bn.id)return;const n=(t=this._univerInstanceService.getCurrentUniverDocInstance())==null?void 0:t.getUnitId(),i=this._drawingManagerService.getFocusDrawings();if(n==null||i.length===0)return;const r=this._renderManagerService.getRenderById(n),s=r?.scene;if(s==null)return!1;s.getTransformerByCreate().refreshControls()}))}_addDrawings(e,t){const n=this._drawingManagerService,i=this._docDrawingService,r=this._docDrawingService.getBatchAddOp(t),{subUnitId:s,redo:a,objects:c}=r;n.applyJson1(e,s,a),i.applyJson1(e,s,a),n.addNotification(c),i.addNotification(c)}_removeDrawings(e,t){const n=this._drawingManagerService,i=this._docDrawingService,r=this._docDrawingService.getBatchRemoveOp(t.map(d=>({unitId:e,subUnitId:e,drawingId:d}))),{subUnitId:s,redo:a,objects:c}=r;n.applyJson1(e,s,a),i.applyJson1(e,s,a),n.removeNotification(c),i.removeNotification(c)}_updateDrawingsOrder(e){const t=this._univerInstanceService.getUniverDocInstance(e);if(t==null)return;const n=t.getSnapshot().drawingsOrder;if(n==null)return;const i=this._drawingManagerService,r=this._docDrawingService;i.setDrawingOrder(e,e,n),r.setDrawingOrder(e,e,n);const s={unitId:e,subUnitId:e,drawingIds:n};i.orderNotification(s),r.orderNotification(s)}};rt=Qi([Fe(0,V),Fe(1,$),Fe(2,ue),Fe(3,Ne),Fe(4,Q)],rt);const tr=e=>{const{floatDomInfos:t,scene:n,offset:i,bound:r}=e,s=r.right-r.left,a=r.bottom-r.top,c=z.useMemo(()=>t.map(d=>{const{width:o=0,height:u=0,left:g=0,top:h=0}=d.transform,p=Dn({left:g,right:g+o,top:h,bottom:h+u},n),l={position$:new It(p),position:p,id:d.drawingId,componentKey:d.componentKey,onPointerMove:()=>{},onPointerDown:()=>{},onPointerUp:()=>{},onWheel:()=>{},unitId:d.unitId,data:d.data};return[d.drawingId,l]}).filter(([d,o])=>!(o.position.endX<0||o.position.endY<0||o.position.startX>s||o.position.startY>a)),[t,n,i,s,a]);return m.jsx("div",{className:"univer-absolute univer-left-0 univer-top-0",children:c.map(([d,o])=>m.jsx(wi,{layer:o,id:d,position:o.position},d))})};var nr=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},We=(e,t)=>(n,i)=>t(n,i,e);let st=class extends Ae{constructor(e,t,n,i,r){super(),this._docPrintInterceptorService=e,this._drawingRenderService=t,this._drawingManagerService=n,this._componetManager=i,this._injector=r,this._initPrinting(),this._initPrintingDom()}_initPrinting(){this.disposeWithMe(this._docPrintInterceptorService.interceptor.intercept(this._docPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(e,t,n)=>{const{unitId:i,scene:r}=t,s=this._drawingManagerService.getDrawingDataForUnit(i),a=s?.[i];return a&&a.order.forEach(c=>{const d=a.data[c];d.drawingType!==Re.DRAWING_CHART&&d.drawingType!==Re.DRAWING_DOM&&this._drawingRenderService.renderDrawing(d,r)}),n()}}))}_initPrintingDom(){this.disposeWithMe(this._docPrintInterceptorService.interceptor.intercept(this._docPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_DOM_COLLECT,{handler:(e,t,n)=>{const{unitId:i}=t,r=this._drawingManagerService.getDrawingDataForUnit(i),s=r?.[i];if(s){const a=s.order.map(d=>{const o=s.data[d];if(o.drawingType===Re.DRAWING_CHART)return{...o,componentKey:this._componetManager.get(jn)};if(o.drawingType===Re.DRAWING_DOM){const u=this._docPrintInterceptorService.getPrintComponent(o.componentKey);return{...o,componentKey:this._componetManager.get(u||o.componentKey)}}return null}).filter(Boolean),c=vi(tr,this._injector);return oi(m.jsx(c,{unitId:i,floatDomInfos:a,scene:t.scene,skeleton:t.skeleton,offset:t.offset,bound:t.bound}),t.root),e?.add(()=>{di(t.root)}),n(e)}}}))}};st=nr([We(0,J(Zn)),We(1,J(on)),We(2,ue),We(3,J(an)),We(4,J(Yt))],st);var ir=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},Ze=(e,t)=>(n,i)=>t(n,i,e);const rr="__InlineDrawingAnchor__";function Vt(e){const{path:t}=e;return t.some(n=>n==="cells")}let at=class extends Ae{constructor(e,t,n,i){super(),we(this,"_liquid",new tn),we(this,"_listenerOnImageMap",new Set),we(this,"_transformerCache",new Map),we(this,"_anchorShape"),this._commandService=e,this._univerInstanceService=t,this._drawingManagerService=n,this._renderManagerService=i,this._init()}_init(){this._listenDrawingFocus()}_listenDrawingFocus(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{if(e.length!==0)for(const t of e){const{unitId:n}=t;this._listenerOnImageMap.has(n)||(this._listenTransformerChange(n),this._listenerOnImageMap.add(n))}}))}_listenTransformerChange(e){var t;const n=(t=this._getSceneAndTransformerByDrawingSearch(e))==null?void 0:t.transformer;if(n==null)return;this.disposeWithMe(He(n.changeStart$.subscribe(r=>{var s;this._transformerCache.clear();const{objects:a}=r;for(const c of a.values()){const{oKey:d,width:o,height:u,left:g,top:h,angle:p}=c,l=this._drawingManagerService.getDrawingOKey(d);if(l==null)continue;const v=this._univerInstanceService.getUniverDocInstance(l.unitId),I=(s=v?.getSnapshot().drawings)==null?void 0:s[l.drawingId];if(I?.layoutType===j.INLINE)try{c.setOpacity(.2)}catch{}I!=null&&this._transformerCache.set(l.drawingId,{drawing:I,top:h,left:g,width:o,height:u,angle:p})}})));const i=xt(this._updateMultipleDrawingDocTransform.bind(this),50);xt(this._nonInlineDrawingTransform.bind(this),50),this.disposeWithMe(He(n.changing$.subscribe(r=>{const{objects:s,offsetX:a,offsetY:c}=r;if(s.size>1)i(s);else if(s.size===1){const d=this._transformerCache.values().next().value,o=s.values().next().value,{width:u,height:g,top:h,left:p,angle:l}=o;if(d&&u===d.width&&g===d.height&&h===d.top&&p===d.left&&l===d.angle)return;d&&(d.drawing.layoutType,j.INLINE),d&&d.drawing.layoutType===j.INLINE&&a!=null&&c!=null&&this._updateInlineDrawingAnchor(d.drawing,a,c)}}))),this.disposeWithMe(He(n.changeEnd$.subscribe(r=>{const{objects:s,offsetX:a,offsetY:c}=r;for(const d of s.values()){const o=this._drawingManagerService.getDrawingOKey(d.oKey);if(o==null)continue;const u=this._transformerCache.get(o?.drawingId);if(u?.drawing.layoutType===j.INLINE)try{d.setOpacity(1)}catch{}}if(this._anchorShape&&this._anchorShape.hide(),s.size>1)this._updateMultipleDrawingDocTransform(s);else if(s.size===1){const d=this._transformerCache.values().next().value,o=s.values().next().value,{width:u,height:g,top:h,left:p,angle:l}=o;if(d&&u===d.width&&g===d.height&&h===d.top&&p===d.left&&l===d.angle)return;d&&d.drawing.layoutType===j.INLINE?u!==d.width||g!==d.height||l!==d.angle?this._updateDrawingSize(d,o):a!=null&&c!=null&&this._moveInlineDrawing(d.drawing,a,c):d&&this._nonInlineDrawingTransform(d.drawing,o)}this._transformerCache.clear()})))}_updateMultipleDrawingDocTransform(e){if(e.size<1)return;const t=[];let n,i;for(const r of e.values()){const{oKey:s,left:a,top:c,angle:d}=r;let{width:o,height:u}=r;const g=this._drawingManagerService.getDrawingOKey(s);if(g==null)continue;n==null&&(n=g.unitId),i==null&&(i=g.subUnitId);const h=this._transformerCache.get(g.drawingId);if(h==null)continue;const{drawing:p,top:l,left:v,width:I,height:O,angle:w}=h,{width:y,height:b}=this._getPageContentSize(p);if(o=Math.min(o,y),u=Math.min(u,b),(I!==o||O!==u)&&t.push({drawingId:g.drawingId,key:"size",value:{width:o,height:u}}),w!==d&&t.push({drawingId:g.drawingId,key:"angle",value:d}),l!==c||v!==a){const S=c-l,M=a-v;S!==0&&t.push({drawingId:g.drawingId,key:"positionV",value:{relativeFrom:p.docTransform.positionV.relativeFrom,posOffset:p.docTransform.positionV.posOffset+S}}),M!==0&&t.push({drawingId:g.drawingId,key:"positionH",value:{relativeFrom:p.docTransform.positionH.relativeFrom,posOffset:p.docTransform.positionH.posOffset+M}})}}t.length>0&&n&&i&&this._commandService.executeCommand(ze.id,{unitId:n,subUnitId:i,drawings:t})}_updateDrawingAnchor(e){if(this._transformerCache.size!==1)return;const t=this._transformerCache.values().next().value,n=e.values().next().value;this._getDrawingAnchor(t.drawing,n)}_updateInlineDrawingAnchor(e,t,n){var i;if(this._transformerCache.size!==1)return;const{contentBoxPointGroup:r}=(i=this._getInlineDrawingAnchor(e,t,n))!=null?i:{};r!=null&&this._createOrUpdateInlineAnchor(e.unitId,r)}_getInlineDrawingAnchor(e,t,n){var i,r;const s=this._renderManagerService.getRenderById(e.unitId),a=s?.with(ie).getSkeleton();if(s==null)return;const{mainComponent:c,scene:d}=s,o=c,u=d.getViewports()[0],{pageLayoutType:g=Nt.VERTICAL,pageMarginLeft:h,pageMarginTop:p}=o.getOffsetConfig();let l=null,v=!1,I=-1,O="";const w=.5,y=this._getTransformCoordForDocumentOffset(o,u,t,n);if(y==null)return;const b=(i=this._renderManagerService.getRenderById(e.unitId))==null?void 0:i.with(Oe);if(b==null)return;const S=a?.findNodeByCoord(y,g,h,p,{strict:!1,segmentId:b.getSegment(),segmentPage:b.getSegmentPage()});if(S){const{node:_,ratioX:x,segmentPage:D,segmentId:T}=S;v=x<w,l=_,I=D,O=T}if(l==null)return;const M=a?.findPositionByGlyph(l,I),L=this._getDocObject();if(M==null||a==null||L==null||Vt(M))return;const E={...M,isBack:v},f=L.document.getOffsetConfig(),R=new Rt(f,a),{cursorList:F,contentBoxPointGroup:C}=R.getRangePointData(E,E),{startOffset:B}=(r=Ct(F))!=null?r:{};if(B!=null)return{offset:B,contentBoxPointGroup:C,segmentId:O,segmentPage:I}}_getDrawingAnchor(e,t){var n,i,r,s,a,c,d,o,u,g,h;const p=this._renderManagerService.getRenderById(e.unitId),l=p?.with(ie).getSkeleton(),v=l?.getSkeletonData();if(v==null||p==null)return;const{pages:I,skeHeaders:O,skeFooters:w}=v,{mainComponent:y,scene:b}=p,S=y,M=b.getViewports()[0],{pageLayoutType:L=Nt.VERTICAL,pageMarginLeft:E,pageMarginTop:f,docsLeft:R,docsTop:F}=S.getOffsetConfig(),{left:C,top:B,angle:_}=t;let{width:x,height:D}=t;const{positionV:T,positionH:N}=e.docTransform,{width:P,height:W}=this._getPageContentSize(e);x=Math.min(x,P),D=Math.min(D,W);let U=null,A="",k=-1;const re=!1,K={...e.docTransform,size:{width:x,height:D},angle:_},{x:ge,y:_e}=b.getViewportScrollXY(M),Se=this._getTransformCoordForDocumentOffset(S,M,C-ge,B-_e);if(Se==null)return;const De=(n=this._renderManagerService.getRenderById(e.unitId))==null?void 0:n.with(Oe);if(De==null)return;const xe=l?.findNodeByCoord(Se,L,E,f,{strict:!1,segmentId:De.getSegment(),segmentPage:De.getSegmentPage()});if(xe){const{node:X,segmentPage:ut,segmentId:gt}=xe;U=X,k=ut,A=gt}if(U==null)return;const Z=(i=U.parent)==null?void 0:i.parent,se=Z?.parent,he=(r=se?.lines.find(X=>X.paragraphIndex===Z?.paragraphIndex&&X.paragraphStart))!=null?r:se?.lines[0],ve=(s=se?.parent)==null?void 0:s.parent;if(Z==null||se==null||he==null||ve==null)return;this._liquid.reset();const Be=ve.type;for(const X of I){const{headerId:ut,footerId:gt,pageHeight:On,pageWidth:bt,marginLeft:Tt,marginBottom:xn}=X,Mn=I.indexOf(X);if(k>-1&&Mn===k){switch(Be){case Pt.HEADER:{const je=(a=O.get(ut))==null?void 0:a.get(bt);if(je)this._liquid.translatePagePadding({marginTop:je.marginTop,marginLeft:Tt});else throw new Error("header skeleton not found");break}case Pt.FOOTER:{const je=(c=w.get(gt))==null?void 0:c.get(bt);if(je)this._liquid.translatePagePadding({marginTop:On-xn+je.marginTop,marginLeft:Tt});else throw new Error("footer skeleton not found");break}}break}if(this._liquid.translatePagePadding(X),X===ve)break;this._liquid.restorePagePadding(X),this._liquid.translatePage(X,L,E,f)}switch(T.relativeFrom===G.LINE?U=Z.divides[0].glyphGroup[0]:U=(g=(u=(o=(d=he.divides)==null?void 0:d[0])==null?void 0:o.glyphGroup)==null?void 0:u[0])!=null?g:U,K.positionH={relativeFrom:N.relativeFrom,posOffset:C-this._liquid.x-R},N.relativeFrom){case ee.MARGIN:{K.positionH.posOffset=C-this._liquid.x-R-ve.marginLeft;break}case ee.COLUMN:{K.positionH.posOffset=C-this._liquid.x-R-se.left;break}}switch(K.positionV={relativeFrom:T.relativeFrom,posOffset:B-this._liquid.y-F},T.relativeFrom){case G.PAGE:{K.positionV.posOffset=B-this._liquid.y-F-ve.marginTop;break}case G.LINE:{K.positionV.posOffset=B-this._liquid.y-F-Z.top;break}case G.PARAGRAPH:{K.positionV.posOffset=B-this._liquid.y-F-he.top;break}}if(U==null)return;const pe=l?.findPositionByGlyph(U,k),ae=this._getDocObject();if(pe==null||l==null||ae==null||Vt(pe))return;const Ie={...pe,isBack:re},Me=ae.document.getOffsetConfig(),be=new Rt(Me,l),{cursorList:ne}=be.getRangePointData(Ie,Ie),{startOffset:ye}=(h=Ct(ne))!=null?h:{};if(ye!=null)return{offset:ye,docTransform:K,segmentId:A,segmentPage:k}}_updateDrawingSize(e,t){const n=[],{drawing:i,width:r,height:s,angle:a}=e,{unitId:c,subUnitId:d}=i;let{width:o,height:u,angle:g}=t;const{width:h,height:p}=this._getPageContentSize(i);o=Math.min(h,o),u=Math.min(p,u),(o!==r||u!==s)&&n.push({drawingId:i.drawingId,key:"size",value:{width:o,height:u}}),g!==a&&n.push({drawingId:i.drawingId,key:"angle",value:g}),n.length>0&&c&&d&&this._commandService.executeCommand(ze.id,{unitId:c,subUnitId:d,drawings:n})}_moveInlineDrawing(e,t,n){const i=this._getInlineDrawingAnchor(e,t,n),{offset:r,segmentId:s,segmentPage:a}=i??{};return this._commandService.executeCommand(vn.id,{unitId:e.unitId,subUnitId:e.unitId,drawing:e,offset:r,segmentId:s,segmentPage:a,needRefreshDrawings:r==null})}_limitDrawingInPage(e,t){const n=this._renderManagerService.getRenderById(e.unitId),{left:i,top:r,width:s,height:a,angle:c}=t,d=n?.with(ie).getSkeleton(),o=d?.getSkeletonData(),{pages:u}=o??{};if(o==null||n==null||u==null)return{left:i,top:r,width:s,height:a,angle:c};const{mainComponent:g}=n,h=g,{top:p,pageLayoutType:l,pageMarginLeft:v,pageMarginTop:I}=h;let O=r;this._liquid.reset();for(const w of u){const{marginBottom:y,pageHeight:b}=w,S=u.indexOf(w),M=u[S+1];if(M!=null){if(Ce.hasIntersectionBetweenTwoRanges(r,r+a,this._liquid.y+p+b-y,this._liquid.y+p+b+I+M.marginTop)){const L=r+a/2,E=this._liquid.y+p+b+I/2;L<E?O=Math.min(r,this._liquid.y+p+b-y-a):O=Math.max(r,this._liquid.y+p+b+I+M.marginTop)}this._liquid.translatePage(w,l,v,I)}}return{left:i,top:O,width:s,height:a,angle:c}}_nonInlineDrawingTransform(e,t,n=!1){const i=e.isMultiTransform===oe.TRUE?t:this._limitDrawingInPage(e,t);if(n&&i.top!==t.top)return;const r=this._getDrawingAnchor(e,i),{offset:s,docTransform:a,segmentId:c,segmentPage:d}=r??{};return s==null||a==null?this._updateMultipleDrawingDocTransform(new Map([[e.drawingId,t]])):this._commandService.executeCommand(In.id,{unitId:e.unitId,subUnitId:e.unitId,drawing:e,offset:s,docTransform:a,segmentId:c,segmentPage:d})}_getSceneAndTransformerByDrawingSearch(e){if(e==null)return;const t=this._renderManagerService.getRenderById(e),n=t?.scene;if(n==null)return;const i=n.getTransformerByCreate();return{scene:n,transformer:i}}_getTransformCoordForDocumentOffset(e,t,n,i){const{documentTransform:r}=e.getOffsetConfig(),s=t.transformVector2SceneCoord(ii.FromArray([n,i]));if(s)return r.clone().invert().applyPoint(s)}_createOrUpdateInlineAnchor(e,t){const n=this._renderManagerService.getRenderById(e);if(n==null)return;const{mainComponent:i,scene:r}=n,s=i,{docsLeft:a,docsTop:c}=s.getOffsetConfig(),d=Yn(t),{left:o,top:u,height:g}=d,h=o+a,p=u+c;if(this._anchorShape){this._anchorShape.transformByState({left:h,top:p,height:g}),this._anchorShape.show();return}const l=6,v=new ri(rr+zt(l),{left:h,top:p,height:g,strokeWidth:2,stroke:si(kn.darkgray,1),evented:!1});this._anchorShape=v,r.addObject(v,Jn)}_getDocObject(){return Qn(this._univerInstanceService,this._renderManagerService)}_getPageContentSize(e){const t=this._renderManagerService.getRenderById(e.unitId),n=t?.with(ie).getSkeleton(),i=500,r=500,s=n?.getSkeletonData();if(s==null||t==null)return{width:i,height:r};const{pages:a}=s;let c=null;for(const d of a){const{skeDrawings:o}=d;if(o.has(e.drawingId)){c=d;break}}if(c){const{pageWidth:d,pageHeight:o,marginLeft:u,marginBottom:g,marginRight:h,marginTop:p}=c;return{width:Math.max(i,d-u-h),height:Math.max(r,o-p-g)}}else return{width:i,height:r}}};at=ir([Ze(0,$),Ze(1,V),Ze(2,ue),Ze(3,Q)],at);var sr=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},Ge=(e,t)=>(n,i)=>t(n,i,e);let ot=class extends Pn{constructor(e,t,n,i,r){super(),we(this,"_initImagePopupMenu",new Set),we(this,"_disposePopups",[]),this._drawingManagerService=e,this._canvasPopManagerService=t,this._renderManagerService=n,this._univerInstanceService=i,this._contextService=r,this._init()}_init(){this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(me.UNIVER_DOC).pipe(Wt(this.dispose$)).subscribe(e=>this._create(e))),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(me.UNIVER_DOC).pipe(Wt(this.dispose$)).subscribe(e=>this._dispose(e))),this._univerInstanceService.getAllUnitsForType(me.UNIVER_DOC).forEach(e=>this._create(e))}_dispose(e){const t=e.getUnitId();this._disposePopups.length&&(this._disposePopups.forEach(n=>n.dispose()),this._disposePopups.length=0),this._renderManagerService.removeRender(t)}_create(e){if(!e)return;const t=e.getUnitId();Un(t)||this._renderManagerService.has(t)&&!this._initImagePopupMenu.has(t)&&(this._popupMenuListener(t),this._initImagePopupMenu.add(t))}_hasCropObject(e){const t=e.getAllObjects();for(const n of t)if(n instanceof Oi)return!0;return!1}_popupMenuListener(e){var t;const n=(t=this._renderManagerService.getRenderById(e))==null?void 0:t.scene;if(!n)return;const i=n.getTransformerByCreate();if(!i)return;const r=this._disposePopups;this.disposeWithMe(i.createControl$.subscribe(()=>{if(this._hasCropObject(n))return;const s=i.getSelectedObjectMap();if(r.forEach(l=>l.dispose()),r.length=0,s.size>1)return;const a=s.values().next().value;if(!a)return;const c=a.oKey,d=this._drawingManagerService.getDrawingOKey(c);if(!d||d.drawingType===Re.DRAWING_DOM)return;const{unitId:o,subUnitId:u,drawingId:g,drawingType:h}=d,p=this._canvasPopManagerService.attachPopupToObject(a,{componentKey:xi,direction:"horizontal",offset:[2,0],extraProps:{menuItems:this._getImageMenuItems(o,u,g,h)}},o);r.push(this.disposeWithMe(p)),!this._drawingManagerService.getFocusDrawings().find(l=>l.unitId===o&&l.subUnitId===u&&l.drawingId===g)&&this._drawingManagerService.focusDrawing([{unitId:o,subUnitId:u,drawingId:g}])})),this.disposeWithMe(i.clearControl$.subscribe(()=>{r.forEach(s=>s.dispose()),r.length=0,this._contextService.setContextValue(et,!1),this._drawingManagerService.focusDrawing(null)})),this.disposeWithMe(i.changing$.subscribe(()=>{r.forEach(s=>s.dispose()),r.length=0})),this.disposeWithMe(i.changeStart$.subscribe(()=>{r.forEach(s=>s.dispose()),r.length=0}))}_getImageMenuItems(e,t,n,i){return[{label:"image-popup.edit",index:0,commandId:Sn.id,commandParams:{unitId:e,subUnitId:t,drawingId:n},disable:!0},{label:"image-popup.delete",index:1,commandId:Dt.id,commandParams:{unitId:e,drawings:[{unitId:e,subUnitId:t,drawingId:n}]},disable:!1},{label:"image-popup.crop",index:2,commandId:Mi.id,commandParams:{unitId:e,subUnitId:t,drawingId:n},disable:!0},{label:"image-popup.reset",index:3,commandId:Ei.id,commandParams:[{unitId:e,subUnitId:t,drawingId:n}],disable:!0}]}};ot=sr([Ge(0,ue),Ge(1,J(ei)),Ge(2,Q),Ge(3,V),Ge(4,Jt)],ot);var ar=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},Ee=(e,t)=>(n,i)=>t(n,i,e);let vt=class extends Ae{constructor(e,t,n,i,r,s,a,c){super(),we(this,"_liquid",new tn),this._context=e,this._docSkeletonManagerService=t,this._commandService=n,this._editorService=i,this._drawingManagerService=r,this._docRefreshDrawingsService=s,this._univerInstanceService=a,this._lifecycleService=c,this._initialize(),this._commandExecutedListener()}_initialize(){this._initialRenderRefresh(),this._drawingInitializeListener(),this._initResize()}_initialRenderRefresh(){this.disposeWithMe(this._docSkeletonManagerService.currentSkeleton$.subscribe(e=>{e!=null&&this._refreshDrawing(e)})),this.disposeWithMe(this._docRefreshDrawingsService.refreshDrawings$.subscribe(e=>{e!=null&&this._refreshDrawing(e)}))}_commandExecutedListener(){const e=[te.id,Qt.id];this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(e.includes(t.id)){const n=t.params,{unitId:i}=n,{unitId:r,mainComponent:s}=this._context;if(i!==r)return;const a=this._docSkeletonManagerService.getSkeleton();if(a==null)return;if(this._editorService.isEditor(r)&&r!==_t){s?.makeDirty();return}this._refreshDrawing(a)}}))}_initResize(){this.disposeWithMe(Xt(this._context.engine.onTransformChange$).pipe(Mt(e=>e.type===ai.resize),Kt(16)).subscribe(()=>{var e;const t=this._docSkeletonManagerService.getSkeleton(),{scene:n}=this._context;(e=n.getTransformer())==null||e.refreshControls(),this._refreshDrawing(t)}))}_refreshDrawing(e){var t,n;const i=e?.getSkeletonData(),{mainComponent:r,unitId:s}=this._context,a=r;if(!i)return;const{left:c,top:d,pageLayoutType:o,pageMarginLeft:u,pageMarginTop:g}=a,{pages:h,skeHeaders:p,skeFooters:l}=i,v={};this._liquid.reset();for(let y=0,b=h.length;y<b;y++){const S=h[y],{headerId:M,footerId:L,pageWidth:E}=S;if(M){const f=(t=p.get(M))==null?void 0:t.get(E);f&&this._calculateDrawingPosition(s,f,c,d,v,f.marginTop,S.marginLeft)}if(L){const f=(n=l.get(L))==null?void 0:n.get(E);f&&this._calculateDrawingPosition(s,f,c,d,v,S.pageHeight-S.marginBottom+f.marginTop,S.marginLeft)}this._calculateDrawingPosition(s,S,c,d,v,S.marginTop,S.marginLeft),this._liquid.translatePage(S,o,u,g)}const I=Object.values(v),O=I.filter(y=>!y.isMultiTransform),w=I.filter(y=>y.isMultiTransform);O.length>0&&this._drawingManagerService.refreshTransform(O),this._handleMultiDrawingsTransform(w)}_handleMultiDrawingsTransform(e){const{scene:t,unitId:n}=this._context,i=t.getTransformerByCreate();e.forEach(a=>{const c=this._drawingManagerService.getDrawingByParam(a);c!=null&&(c.transform=a.transform,c.transforms=a.transforms,c.isMultiTransform=a.isMultiTransform)});const r=[...i.getSelectedObjectMap().keys()],s=Object.values(this._drawingManagerService.getDrawingData(n,n)).filter(a=>a.isMultiTransform===oe.TRUE);this._drawingManagerService.removeNotification(s),e.length>0&&this._drawingManagerService.addNotification(e);for(const a of r){const c=t.getObject(a);c&&i.setSelectedControl(c)}}_calculateDrawingPosition(e,t,n,i,r,s,a){const{skeDrawings:c}=t;this._liquid.translatePagePadding({marginTop:s,marginLeft:a}),c.forEach(d=>{const{aLeft:o,aTop:u,height:g,width:h,angle:p,drawingId:l,drawingOrigin:v}=d,I=v.layoutType===j.WRAP_NONE&&v.behindDoc===oe.TRUE,{isMultiTransform:O=oe.FALSE}=v,w={left:o+n+this._liquid.x,top:u+i+this._liquid.y,width:h,height:g,angle:p};r[l]==null?r[l]={unitId:e,subUnitId:e,drawingId:l,behindText:I,transform:w,transforms:[w],isMultiTransform:O}:O===oe.TRUE&&r[l].transforms.push(w)}),this._liquid.restorePagePadding({marginTop:s,marginLeft:a})}_drawingInitializeListener(){const e=()=>{const t=this._docSkeletonManagerService.getSkeleton();t!=null&&(this._refreshDrawing(t),this._drawingManagerService.initializeNotification(this._context.unitId))};this._lifecycleService.stage>=Et.Rendered?this._docSkeletonManagerService.getSkeleton()?e():setTimeout(e,500):this.disposeWithMe(this._lifecycleService.lifecycle$.pipe(Mt(t=>t===Et.Rendered)).subscribe(e))}};vt=ar([Ee(1,J(ie)),Ee(2,$),Ee(3,ti),Ee(4,ue),Ee(5,J(lt)),Ee(6,V),Ee(7,J(qn))],vt);var or=Object.defineProperty,dr=(e,t,n)=>t in e?or(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,cr=(e,t,n,i)=>{for(var r=t,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},mt=(e,t)=>(n,i)=>t(n,i,e),Tn=(e,t,n)=>dr(e,typeof t!="symbol"?t+"":t,n);const lr="DOC_DRAWING_UI_PLUGIN";let dt=class extends An{constructor(e=Gt,t,n,i){super(),this._config=e,this._injector=t,this._renderManagerSrv=n,this._configService=i;const{...r}=Nn({},Gt,this._config);this._configService.setConfig(Bi,r)}onStarting(){[[it],[ot],[at],[rt],[lt],[nt],[st]].forEach(e=>this._injector.add(e))}onReady(){[[tt],[vt]].forEach(e=>this._renderManagerSrv.registerRenderModule(me.UNIVER_DOC,e)),this._injector.get(rt),this._injector.get(it),this._injector.get(at),this._injector.get(st)}onRendered(){this._injector.get(ot),this._injector.get(nt)}};Tn(dt,"type",me.UNIVER_DOC);Tn(dt,"pluginName",lr);dt=cr([$n(Ci,pi,Kn,_i),mt(1,J(Yt)),mt(2,Q),mt(3,Vn)],dt);export{ki as ClearDocDrawingTransformerOperation,yn as DOCS_IMAGE_MENU_ID,dn as DeleteDocDrawingsCommand,nt as DocFloatDomController,Sn as EditDocDrawingOperation,cn as GroupDocDrawingCommand,yt as InsertDocDrawingCommand,gn as InsertDocImageCommand,qe as MoveDocDrawingsCommand,Dt as RemoveDocDrawingCommand,ln as SetDocDrawingArrangeCommand,_n as SidebarDocDrawingOperation,un as UngroupDocDrawingCommand,dt as UniverDocsDrawingUIPlugin};
