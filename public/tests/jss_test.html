<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATAI - JSS v5 Absolute Perfection Sandbox</title>

    <!-- MANDATORY: Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- JSS v5 CE Dependencies (Pinned Versions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@5.0.4/dist/jspreadsheet.min.css"
        type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsuites@5.12.0/dist/jsuites.min.css" type="text/css" />

    <script src="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@5.0.4/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsuites@5.12.0/dist/jsuites.min.js"></script>

    <style>
        :root {
            --primary: #1a73e8;
            --border: #ccc;
            --header-bg: #f8f9fa;
        }

        body,
        html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f1f3f4;
            overflow: hidden;
        }

        .workspace {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            box-sizing: border-box;
            background: #fff;
        }

        header {
            background: #fff;
            padding: 8px 16px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #444;
        }

        /* Formula Bar Area */
        .formula-bar {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 4px 12px;
            border-bottom: 1px solid #eee;
            gap: 8px;
            height: 32px;
        }

        .fx {
            font-weight: bold;
            color: var(--primary);
            font-style: italic;
            font-size: 16px;
            width: 24px;
            text-align: center;
            user-select: none;
        }

        #formula-input {
            flex: 1;
            border: 1px solid transparent;
            outline: none;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            padding: 2px 8px;
            background: #f1f3f4;
            border-radius: 4px;
            transition: all 0.2s;
        }

        #formula-input:focus {
            background: #fff;
            border: 1px solid var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        /* 
           ABSOLUTE FIX FOR "LOCKED FRAME":
           The grid-container must NOT have overflow hidden if handles are being clipped.
           We use overflow: visible on the wrapper and let JSS handle internal scrolls.
        */
        .grid-container {
            flex: 1;
            width: 100%;
            position: relative;
            background: #fff;
            overflow: visible;
            /* CRITICAL: Enables resizer handles to be grab-able */
        }

        /* JSS Overrides for "Professional" DATAI Feel */
        .jss_toolbar {
            background-color: #fff !important;
            padding: 8px 16px !important;
            border-bottom: 1px solid #ddd !important;
            display: flex !important;
            gap: 2px !important;
        }

        .jss_toolbar i.material-icons {
            font-size: 18px !important;
            color: #555 !important;
        }

        .jss_toolbar div:hover {
            background-color: #f0f0f0 !important;
            border-radius: 4px !important;
        }

        .jss_worksheet thead td {
            background-color: var(--header-bg) !important;
            font-weight: 600 !important;
            padding: 8px !important;
            border: 1px solid #ccc !important;
            color: #333 !important;
            user-select: none;
        }

        .jss_worksheet tbody td {
            padding: 8px !important;
            border: 1px solid #e0e0e0 !important;
            font-size: 13px !important;
        }

        .jss_about {
            display: none !important;
        }

        /* Resizer Handles: Make them more visible and easier to grab */
        .jss_column_resizer {
            width: 4px !important;
            z-index: 10 !important;
        }

        .jss_row_resizer {
            height: 4px !important;
            z-index: 10 !important;
        }

        /* Tabs Styling */
        .jss_tabs {
            border-top: 1px solid #ddd !important;
            background: #f8f9fa !important;
        }
    </style>
</head>

<body>
    <div class="workspace">
        <header>
            <h1><i class="material-icons" style="color:var(--primary)">fact_check</i> DATAI Power Sheets (Absolute
                Perfection)</h1>
            <div>
                <button onclick="window.location.reload()"
                    style="cursor:pointer; border:1px solid #ccc; background:#fff; padding:4px 12px; border-radius:4px; font-size:12px;">Reset</button>
            </div>
        </header>

        <div class="formula-bar">
            <span class="fx">fx</span>
            <input type="text" id="formula-input" placeholder="Select a cell...">
        </div>

        <div class="grid-container">
            <div id="spreadsheet"></div>
        </div>
    </div>

    <script>
        // CLEAN NUMERIC DATA - PREVENTS #ERROR
        const initialData = [
            ['Project Alpha', 5000.00, 2, '=B1*C1'],
            ['Compliance Audit', 2500.00, 1, '=B2*C2'],
            ['Research Phase', 1200.50, 3, '=B3*C3'],
            ['', '', '', ''],
            ['GRAND TOTAL', '', '', '=SUM(D1:D3)']
        ];

        const initialColumns = [
            { type: 'text', title: 'Task Name', width: 250 },
            { type: 'number', title: 'Unit Price', width: 140, mask: '$ #.##0,00', decimal: '.' },
            { type: 'number', title: 'Quantity', width: 80 },
            { type: 'number', title: 'Line Total', width: 160, mask: '$ #.##0,00', decimal: '.', readOnly: true }
        ];

        try {
            const spreadsheetEl = document.getElementById('spreadsheet');
            const formulaInput = document.getElementById('formula-input');

            // HELPER: Get active worksheet
            const getActive = () => jss[0];

            const jss = jspreadsheet(spreadsheetEl, {
                tabs: true,
                toolbar: [
                    { content: 'undo', onclick: () => getActive().undo() },
                    { content: 'redo', onclick: () => getActive().redo() },
                    { type: 'divisor' },
                    { content: 'add', title: 'Add Row', onclick: () => getActive().insertRow() },
                    {
                        content: 'delete', title: 'Delete Row', onclick: () => {
                            const rows = getActive().rows.length;
                            if (rows > 1) getActive().deleteRow();
                        }
                    },
                    { type: 'divisor' },
                    { content: 'view_column', title: 'Add Column', onclick: () => getActive().insertColumn() },
                    { type: 'divisor' },
                    {
                        content: 'format_bold', onclick: () => {
                            // V5 API: getSelected() returns coordinates or names
                            const selection = getActive().getSelected();
                            if (selection && selection.length) {
                                getActive().setStyle(selection, 'font-weight', 'bold');
                            }
                        }
                    },
                    {
                        content: 'format_align_left', onclick: () => {
                            const selection = getActive().getSelected();
                            if (selection && selection.length) {
                                getActive().setStyle(selection, 'text-align', 'left');
                            }
                        }
                    },
                    {
                        content: 'format_align_center', onclick: () => {
                            const selection = getActive().getSelected();
                            if (selection && selection.length) {
                                getActive().setStyle(selection, 'text-align', 'center');
                            }
                        }
                    },
                ],
                worksheets: [{
                    sheetName: 'Sales Data',
                    data: initialData,
                    columns: initialColumns,
                    columnResize: true,
                    rowResize: true,
                    columnDrag: true,
                    rowDrag: true,
                    contextMenu: true,
                    allowFormulas: true,
                    tableOverflow: true,
                    tableHeight: '100%',
                    freezeColumns: 1,

                    // V5 STABLE EVENTS
                    onselection: function (instance, x, y) {
                        try {
                            // FORENSIC V5 API: Use getCellNameFromCoords
                            if (jspreadsheet.helpers && jspreadsheet.helpers.getCellNameFromCoords) {
                                const name = jspreadsheet.helpers.getCellNameFromCoords(x, y);
                                const rawValue = instance.getValue(name);
                                formulaInput.value = rawValue || '';
                                formulaInput.setAttribute('data-current-cell', name);
                            }
                        } catch (err) { console.error("Selection Error:", err); }
                    },

                    onchange: function (instance, cell, x, y, value) {
                        try {
                            const current = formulaInput.getAttribute('data-current-cell');
                            const changed = jspreadsheet.helpers.getCellNameFromCoords(x, y);
                            if (current === changed) {
                                formulaInput.value = value || '';
                            }
                        } catch (err) { console.error("Change Error:", err); }
                    }
                },
                {
                    sheetName: 'Secondary Sheet',
                    data: [['Empty', 'Sheet']],
                    columns: [{ width: 200 }, { width: 200 }]
                }]
            });

            // Formula Bar Input Sync
            formulaInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    const target = this.getAttribute('data-current-cell');
                    if (target) {
                        getActive().setValue(target, this.value);
                        this.blur();
                    }
                }
            });

            console.log("DATAI: Absolute Perfection Sandbox Initialized.");
        } catch (e) {
            console.error("DATAI Forensic Failure:", e);
            document.body.innerHTML = `<div style="padding:20px; color:red;"><h1>Forensic Failure</h1><pre>${e.stack}</pre></div>`;
        }
    </script>
</body>

</html>